<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Train Bétail Mobile</title>
  <style>
    body {
      background: black;
      color: #0ff;
      font-family: 'Orbitron', monospace;
      text-align: center;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    #gameContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    canvas {
      border: 3px solid #0ff;
      background: black;
    }
    #controls {
      margin-top: 10px;
      display: grid;
      grid-template-columns: 60px 60px 60px;
      grid-template-rows: 60px 60px;
      gap: 5px;
      justify-content: center;
    }
    .btn {
      background: #000;
      color: #0ff;
      font-size: 24px;
      border: 2px solid #0ff;
      border-radius: 10px;
      user-select: none;
    }
    #info {
      font-size: 16px;
      max-width: 400px;
      margin: 10px;
    }
    #gameOverMessage {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #0ff;
      font-family: 'Orbitron', monospace;
      font-size: 32px;
      text-shadow: 0 0 5px #0ff, 0 0 10px #0ff, 0 0 20px #0ff;
      background: rgba(0,0,0,0.8);
      padding: 20px 40px;
      border: 3px solid #0ff;
      border-radius: 10px;
      display: none;
      z-index: 1000;
    }
    #restartBtn {
      margin-top: 10px;
      font-size: 20px;
      padding: 10px 30px;
      border-radius: 10px;
      border: 2px solid #0ff;
      background: black;
      color: #0ff;
      cursor: pointer;
      display: none;
    }
  </style>
</head>
<body>

<div id="gameContainer">
  <h1>Train Bétail - Mobile</h1>
  <canvas id="gameCanvas"></canvas>
  <div id="controls">
    <div></div>
    <button class="btn" id="upBtn">⬆️</button>
    <div></div>
    <button class="btn" id="leftBtn">⬅️</button>
    <button class="btn" id="downBtn">⬇️</button>
    <button class="btn" id="rightBtn">➡️</button>
  </div>
</div>

<div id="info">
  Score : <span id="score">0</span> | Record : <span id="highscore">0</span>
</div>

<div id="gameOverMessage"></div>
<button id="restartBtn">Rejouer</button>

<script>
(() => {
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");

  // Ajustement dynamique du canvas carré
  function resizeCanvas() {
    const size = Math.min(window.innerWidth, window.innerHeight * 0.6);
    canvas.width = size;
    canvas.height = size;
  }
  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();

  const gridSize = 20, cols = Math.floor(canvas.width / gridSize), rows = Math.floor(canvas.height / gridSize);
  let train, direction, nextDirection, score, highscore = 0;
  let baseSpeed = 200, speedModifier = 0, betail, suppressions, oranges, vaches, vacheFrequency, gameStopped;
  const messagesSuppression = ["Supprimé : panne", "Supprimé : grève", "Supprimé : hérisson"];

  function initGame() {
    train = [{x: 10, y: 10}];
    direction = {x: 1, y: 0};
    nextDirection = direction;
    score = 0;
    document.getElementById("score").textContent = score;
    suppressions = []; oranges = []; vaches = [];
    vacheFrequency = 15000;
    gameStopped = false;
    speedModifier = 0;
    for (let i = 0; i < 10; i++) suppressions.push(randomFreePosition());
    for (let i = 0; i < 5; i++) oranges.push(randomFreePosition());
    betail = randomFreePosition();
    gameLoop();
    setTimeout(() => { scheduleVaches(); increaseVacheFrequency(); }, 60000);
  }

  function randomFreePosition() {
    let pos;
    do {
      pos = {x: Math.floor(Math.random() * cols), y: Math.floor(Math.random() * rows)};
    } while (isOccupied(pos));
    return pos;
  }

  function isOccupied(pos) {
    return train.some(p => p.x === pos.x && p.y === pos.y)
      || suppressions.some(p => p.x === pos.x && p.y === pos.y)
      || oranges.some(p => p.x === pos.x && p.y === pos.y)
      || (betail && betail.x === pos.x && betail.y === pos.y);
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    suppressions.forEach(p => { ctx.fillStyle = "red"; ctx.fillRect(p.x * gridSize, p.y * gridSize, gridSize, gridSize); });
    oranges.forEach(p => { ctx.fillStyle = "orange"; ctx.fillRect(p.x * gridSize, p.y * gridSize, gridSize, gridSize); });
    ctx.fillStyle = "yellow";
    ctx.beginPath();
    ctx.arc(betail.x * gridSize + gridSize/2, betail.y * gridSize + gridSize/2, gridSize/3, 0, 2*Math.PI);
    ctx.fill();
    train.forEach((pos, i) => {
      ctx.fillStyle = (i === 0) ? "#0ff" : "#088";
      ctx.fillRect(pos.x * gridSize, pos.y * gridSize, gridSize, gridSize);
    });
  }

  function update() {
    if (gameStopped) return;
    direction = nextDirection;
    let newHead = { x: train[0].x + direction.x, y: train[0].y + direction.y };
    if (newHead.x < 0) newHead.x = cols - 1;
    if (newHead.x >= cols) newHead.x = 0;
    if (newHead.y < 0) newHead.y = rows - 1;
    if (newHead.y >= rows) newHead.y = 0;

    if (train.some(p => p.x === newHead.x && p.y === newHead.y)) return gameOver("Collision avec soi-même");
    if (suppressions.some(p => p.x === newHead.x && p.y === newHead.y)) return gameOver(messagesSuppression[Math.floor(Math.random() * messagesSuppression.length)]);
    train.unshift(newHead);
    if (betail.x === newHead.x && betail.y === newHead.y) {
      score++;
      document.getElementById("score").textContent = score;
      if (score > highscore) {
        highscore = score;
        document.getElementById("highscore").textContent = highscore;
        localStorage.setItem("highscore", highscore);
      }
      betail = randomFreePosition();
    } else {
      train.pop();
    }
  }

  function gameLoop() {
    update();
    draw();
    if (!gameStopped) setTimeout(gameLoop, Math.max(50, baseSpeed + speedModifier));
  }

  function gameOver(message) {
    gameStopped = true;
    document.getElementById("gameOverMessage").textContent = message + "\nScore: " + score;
    document.getElementById("gameOverMessage").style.display = "block";
    document.getElementById("restartBtn").style.display = "inline-block";
  }

  document.getElementById("restartBtn").addEventListener("click", () => {
    document.getElementById("gameOverMessage").style.display = "none";
    document.getElementById("restartBtn").style.display = "none";
    initGame();
  });

  window.addEventListener("keydown", e => {
    switch(e.key) {
      case "ArrowUp": if(direction.y !== 1) nextDirection = {x: 0, y: -1}; break;
      case "ArrowDown": if(direction.y !== -1) nextDirection = {x: 0, y: 1}; break;
      case "ArrowLeft": if(direction.x !== 1) nextDirection = {x: -1, y: 0}; break;
      case "ArrowRight": if(direction.x !== -1) nextDirection = {x: 1, y: 0}; break;
    }
  });

  document.getElementById("upBtn").addEventListener("click", () => { if(direction.y !== 1) nextDirection = {x: 0, y: -1}; });
  document.getElementById("downBtn").addEventListener("click", () => { if(direction.y !== -1) nextDirection = {x: 0, y: 1}; });
  document.getElementById("leftBtn").addEventListener("click", () => { if(direction.x !== 1) nextDirection = {x: -1, y: 0}; });
  document.getElementById("rightBtn").addEventListener("click", () => { if(direction.x !== -1) nextDirection = {x: 1, y: 0}; });

  if (localStorage.getItem("highscore")) {
    highscore = parseInt(localStorage.getItem("highscore"));
    document.getElementById("highscore").textContent = highscore;
  }
  
  initGame();
})();
</script>
</body>
</html>
