<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mon compte ‚Äî La B√©taill√®re</title>
  <meta name="description" content="Connexion et espace personnel La B√©taill√®re" />

  <style>
    :root{
      --bg:#0b0f14;
      --card:#111826;
      --card2:#0b1220;
      --border:rgba(255,255,255,.10);
      --text:#e9eef5;
      --muted:#aab6c8;
      --accent:#ff3b3b;
      --accent2:#2a3446;
      --ok:#3ddc84;
      --warn:#ffcc66;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
      background:radial-gradient(1200px 600px at 20% -10%, rgba(255,59,59,.18), transparent 55%),
                 radial-gradient(900px 500px at 90% 10%, rgba(61,220,132,.12), transparent 55%),
                 var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px; margin:0 auto; padding:24px;}
    header{display:flex; align-items:flex-end; justify-content:space-between; gap:16px; margin-bottom:10px;}
    h1{margin:0; font-size:34px; letter-spacing:.2px}
    .sub{margin:6px 0 0; color:var(--muted); line-height:1.4}
    .toplinks{display:flex; gap:10px; flex-wrap:wrap}
    .toplinks a{
      color:var(--muted); text-decoration:none; font-weight:600;
      border:1px solid var(--border); padding:8px 10px; border-radius:10px;
      background:rgba(17,24,38,.35)
    }
    .toplinks a:hover{border-color:rgba(255,255,255,.2); color:var(--text)}

    .grid{display:grid; grid-template-columns:1.2fr .8fr; gap:14px; margin-top:14px;}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}

    .card{
      background:linear-gradient(180deg, rgba(17,24,38,.9), rgba(17,24,38,.65));
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
      box-shadow:0 12px 30px rgba(0,0,0,.28);
    }
    .card h2{margin:0 0 10px; font-size:20px}
    .card h3{margin:14px 0 8px; font-size:16px; color:var(--muted); font-weight:700}

    label{display:block; margin:10px 0 6px; color:var(--muted); font-size:14px}
    input{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:var(--card2);
      color:var(--text);
      outline:none;
    }
    input:focus{border-color:rgba(255,59,59,.55); box-shadow:0 0 0 3px rgba(255,59,59,.12)}
    .row{display:flex; gap:12px; flex-wrap:wrap;}
    .row > *{flex:1; min-width:220px;}

    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    button{
      padding:11px 14px;
      border-radius:12px;
      border:0;
      background:var(--accent);
      color:#fff;
      font-weight:800;
      cursor:pointer;
    }
    button.secondary{background:var(--accent2); color:var(--text)}
    button.ghost{background:transparent; border:1px solid var(--border); color:var(--text)}
    button:disabled{opacity:.55; cursor:not-allowed}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px; border:1px solid var(--border);
      background:rgba(11,18,32,.55); color:var(--muted); font-weight:700; font-size:13px;
    }
    .dot{width:10px; height:10px; border-radius:99px; background:var(--warn)}
    .dot.ok{background:var(--ok)}
    .statusLine{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}

    .list{margin-top:8px; display:flex; flex-direction:column; gap:8px;}
    .item{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(11,18,32,.55);
    }
    .item .left{display:flex; flex-direction:column; gap:2px}
    .item .title{font-weight:900}
    .item .meta{color:var(--muted); font-size:13px}
    .item .actions{display:flex; gap:8px}
    .danger{background:#a51e1e}
    .small{padding:9px 10px; border-radius:10px; font-weight:800}
    .hint{color:var(--muted); font-size:14px; line-height:1.45}
    .divider{height:1px; background:rgba(255,255,255,.08); margin:14px 0}
    .error{color:#ffaaaa}
    .ok{color:#b6ffd6}

    footer{margin-top:16px; color:var(--muted); font-size:13px}
    code{background:rgba(11,18,32,.6); padding:3px 6px; border-radius:8px; border:1px solid rgba(255,255,255,.10)}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>üêÑ Mon compte</h1>
        <div class="sub">
          Connecte-toi pour acc√©der √† tes donn√©es personnalis√©es (tes trains, tes stats, tes alertes).
        </div>
      </div>
      <div class="toplinks">
        <a href="/">‚Üê Retour au site</a>
        <a href="https://vps.labetaillere.fr/stats/" target="_blank" rel="noopener">Stats publiques</a>
      </div>
    </header>

    <div class="grid">
      <!-- Colonne gauche -->
      <div class="card">
        <h2>Statut</h2>

        <div class="statusLine">
          <div class="pill" id="pillStatus">
            <span class="dot" id="dotStatus"></span>
            <span id="txtStatus">Chargement‚Ä¶</span>
          </div>

          <div class="btns" style="margin:0">
            <button class="secondary" id="btnRefresh" type="button">Rafra√Æchir</button>
            <button class="secondary" id="btnLogout" type="button">Se d√©connecter</button>
          </div>
        </div>

        <div class="divider"></div>

        <h3>Mes trains</h3>

        <div class="row">
          <div>
            <label>Num√©ro de train</label>
            <input id="trainNumber" inputmode="numeric" placeholder="ex : 2872" />
          </div>
          <div>
            <label>Alias (optionnel)</label>
            <input id="trainAlias" placeholder="ex : BER du soir" />
          </div>
        </div>

        <div class="btns">
          <button id="btnAddTrain" type="button">Ajouter</button>
          <button class="ghost" id="btnReloadTrains" type="button">Recharger</button>
        </div>

        <div class="hint" style="margin-top:10px">
          Astuce : commence par 3‚Äì5 trains ‚Äúcritiques‚Äù (heures de pointe).  
          Ensuite on branchera les statuts temps r√©el + l‚Äôhistorique.
        </div>

        <div class="list" id="trainList" aria-live="polite"></div>
        <div class="hint" id="trainEmpty" style="display:none; margin-top:8px">
          Aucun train enregistr√© pour le moment.
        </div>
      </div>

      <!-- Colonne droite -->
      <div class="card">
        <h2>Connexion / Inscription</h2>

        <div class="row">
          <div>
            <label>Email</label>
            <input id="email" type="email" placeholder="ton@email.fr" autocomplete="email" />
          </div>
          <div>
            <label>Mot de passe</label>
            <input id="password" type="password" placeholder="min. 10 caract√®res" autocomplete="current-password" />
          </div>
        </div>

        <div class="btns">
          <button id="btnLogin" type="button">Se connecter</button>
          <button class="secondary" id="btnRegister" type="button">Cr√©er un compte</button>
        </div>

        <div class="divider"></div>

        <div class="hint">
          üîí Les mots de passe sont stock√©s sous forme de <b>hash</b> c√¥t√© serveur (jamais en clair).  
          La session est un cookie <b>HttpOnly + Secure</b> (invisible au JavaScript).
        </div>

        <div class="divider"></div>

        <h3>Messages</h3>
        <div id="msg" class="hint mono">(rien)</div>

        <footer>
          API utilis√©e : <code>https://vps.labetaillere.fr/api</code><br/>
          Si tu utilises la version sans <code>www</code>, dis-le : on ajuste le CORS.
        </footer>
      </div>
    </div>
  </div>

<script>
  // ---- CONFIG ----
  const API = "https://vps.labetaillere.fr/api";

  // ---- HELPERS ----
  const $ = (id) => document.getElementById(id);
  const setMsg = (txt, kind="") => {
    const el = $("msg");
    el.textContent = txt;
    el.classList.remove("error","ok");
    if (kind) el.classList.add(kind);
  };

  async function api(path, opts = {}) {
    const res = await fetch(API + path, {
      ...opts,
      headers: { "Content-Type": "application/json", ...(opts.headers || {}) },
      credentials: "include" // indispensable pour cookie session
    });

    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch { data = { raw: text }; }

    if (!res.ok) {
      const msg = data?.error || data?.message || `Erreur HTTP ${res.status}`;
      throw { status: res.status, data, msg };
    }
    return data;
  }

  function setConnected(user) {
    $("dotStatus").classList.add("ok");
    $("txtStatus").innerHTML = `Connect√© : <b>${user.email}</b><br><span class="muted">Cr√©√© le ${user.created_at}</span>`;
    $("btnLogout").disabled = false;
    $("btnAddTrain").disabled = false;
    $("btnReloadTrains").disabled = false;
  }

  function setDisconnected() {
    $("dotStatus").classList.remove("ok");
    $("txtStatus").textContent = "Non connect√©";
    $("btnLogout").disabled = true;
    $("btnAddTrain").disabled = true;
    $("btnReloadTrains").disabled = true;
    $("trainList").innerHTML = "";
    $("trainEmpty").style.display = "none";
  }

  // ---- STATUS ----
  async function refreshStatus() {
    try {
      const me = await api("/me");
      setConnected(me.user);
      setMsg("‚úÖ Session OK", "ok");
      await loadTrains();
    } catch (e) {
      setDisconnected();
      setMsg("‚ÑπÔ∏è Pas connect√© (ou session expir√©e).", "");
    }
  }

  // ---- TRAINS ----
  function renderTrains(trains) {
    const list = $("trainList");
    list.innerHTML = "";

    if (!trains || trains.length === 0) {
      $("trainEmpty").style.display = "block";
      return;
    }
    $("trainEmpty").style.display = "none";

    for (const t of trains) {
      const div = document.createElement("div");
      div.className = "item";

      const alias = t.alias ? ` ‚Äî ${t.alias}` : "";
      div.innerHTML = `
        <div class="left">
          <div class="title">Train <span class="mono">${escapeHtml(t.train_number)}</span>${escapeHtml(alias)}</div>
          <div class="meta">Ajout√© le ${escapeHtml(t.created_at || "")}</div>
        </div>
        <div class="actions">
          <button class="small danger" data-del="${t.id}" type="button">Supprimer</button>
        </div>
      `;
      list.appendChild(div);
    }

    list.querySelectorAll("button[data-del]").forEach(btn => {
      btn.onclick = async () => {
        const id = btn.getAttribute("data-del");
        if (!confirm("Supprimer ce train ?")) return;
        try {
          await api(`/me/trains/${id}`, { method: "DELETE" });
          setMsg("‚úÖ Train supprim√©", "ok");
          await loadTrains();
        } catch (e) {
          setMsg("‚ùå " + (e.msg || "Erreur suppression"), "error");
        }
      };
    });
  }

  async function loadTrains() {
    try {
      const out = await api("/me/trains");
      renderTrains(out.trains);
    } catch (e) {
      // si pas connect√©, rien
      renderTrains([]);
    }
  }

  async function addTrain() {
    const train_number = $("trainNumber").value.trim();
    const alias = $("trainAlias").value.trim();
    if (!train_number) {
      setMsg("‚ùå Entre un num√©ro de train.", "error");
      return;
    }

    try {
      await api("/me/trains", {
        method: "POST",
        body: JSON.stringify({ train_number, alias: alias || null })
      });
      $("trainNumber").value = "";
      $("trainAlias").value = "";
      setMsg("‚úÖ Train ajout√©", "ok");
      await loadTrains();
    } catch (e) {
      setMsg("‚ùå " + (e.data?.error || e.msg || "Erreur ajout"), "error");
    }
  }

  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[s]));
  }

  // ---- AUTH ----
  $("btnRegister").onclick = async () => {
    try {
      const email = $("email").value.trim();
      const password = $("password").value;
      if (!email || !password) return setMsg("‚ùå Email et mot de passe requis.", "error");
      const out = await api("/auth/register", { method: "POST", body: JSON.stringify({ email, password }) });
      setMsg("‚úÖ Compte cr√©√©", "ok");
      await refreshStatus();
    } catch (e) {
      setMsg("‚ùå " + (e.data?.error || e.msg || "Erreur inscription"), "error");
    }
  };

  $("btnLogin").onclick = async () => {
    try {
      const email = $("email").value.trim();
      const password = $("password").value;
      if (!email || !password) return setMsg("‚ùå Email et mot de passe requis.", "error");
      const out = await api("/auth/login", { method: "POST", body: JSON.stringify({ email, password }) });
      setMsg("‚úÖ Connect√©", "ok");
      await refreshStatus();
    } catch (e) {
      setMsg("‚ùå " + (e.data?.error || e.msg || "Erreur connexion"), "error");
    }
  };

  $("btnLogout").onclick = async () => {
    try {
      await api("/auth/logout", { method: "POST", body: "{}" });
      setMsg("‚úÖ D√©connect√©", "ok");
      await refreshStatus();
    } catch (e) {
      setMsg("‚ùå " + (e.data?.error || e.msg || "Erreur logout"), "error");
    }
  };

  $("btnRefresh").onclick = refreshStatus;
  $("btnAddTrain").onclick = addTrain;
  $("btnReloadTrains").onclick = loadTrains;

  // d√©sactive trains tant qu'on n'a pas la session
  setDisconnected();
  refreshStatus();
</script>

</body>
</html>
