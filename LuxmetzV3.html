<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Tableau horaires trains avec retards GTFS-RT</title>
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      border: 1px solid #333;
      padding: 6px 10px;
      text-align: center;
    }
    th {
      background-color: #eee;
    }
    .retard {
      color: red;
      font-size: 0.8em;
      margin-top: 4px;
    }
  </style>
</head>
<body>

  <table>
    <thead>
      <tr>
        <th>Gare</th>
        <!-- Exemple d’en-têtes avec data-train-number -->
        <th data-train-number="12345">Train 12345</th>
        <th data-train-number="67890">Train 67890</th>
        <th data-train-number="54321">Train 54321</th>
      </tr>
    </thead>
    <tbody>
      <tr><td>Luxembourg</td><td>08:00</td><td>08:15</td><td>08:30</td></tr>
      <tr><td>Howald</td><td>08:05</td><td>08:20</td><td>08:35</td></tr>
      <tr><td>Bettembourg</td><td>08:10</td><td>08:25</td><td>08:40</td></tr>
      <tr><td>Hettange-Grande</td><td>08:20</td><td>08:35</td><td>08:50</td></tr>
      <tr><td>Thionville</td><td>08:30</td><td>08:45</td><td>09:00</td></tr>
      <tr><td>Uckange</td><td>08:35</td><td>08:50</td><td>09:05</td></tr>
      <tr><td>Hagondange</td><td>08:40</td><td>08:55</td><td>09:10</td></tr>
      <tr><td>Maizières-lès-Metz</td><td>08:45</td><td>09:00</td><td>09:15</td></tr>
      <tr><td>Woippy</td><td>08:50</td><td>09:05</td><td>09:20</td></tr>
      <tr><td>Metz Nord</td><td>08:55</td><td>09:10</td><td>09:25</td></tr>
      <tr><td>Metz</td><td>09:00</td><td>09:15</td><td>09:30</td></tr>
      <tr><td>Pagny-sur-Moselle</td><td>09:05</td><td>09:20</td><td>09:35</td></tr>
      <tr><td>Pont-à-Mousson</td><td>09:10</td><td>09:25</td><td>09:40</td></tr>
      <tr><td>Nancy</td><td>09:20</td><td>09:35</td><td>09:50</td></tr>
    </tbody>
  </table>

  <script>
    // Partie 1 & 2 (adaptée à ton code) : ici on simule un chargement d’un JSON retards (externe)
    // Pour l’exemple, on simule le JSON localement, tu peux remplacer par fetch

    // Exemple de structure JSON (à adapter avec ton vrai fichier)
    /*
    {
      "12345": {
        "Luxembourg": 3,
        "Thionville": 0,
        "Metz": 5,
        "Nancy": 0
      },
      "67890": {
        "Howald": 2,
        "Bettembourg": 0,
        "Metz": 0,
        "Nancy": 10
      }
    }
    */

    // Fonction pour appliquer les retards dans le tableau
    function applyRetardsFromGTFS(retardsGTFS) {
      const table = document.querySelector("table");
      if (!table) {
        console.warn("Le tableau n'est pas encore généré !");
        return;
      }

      // Récupérer toutes les lignes du tbody
      const rows = table.tBodies[0].rows;

      // Récupérer les en-têtes (colonnes trains)
      const trainHeaders = table.tHead.rows[0].cells;

      // Parcours ligne par ligne
      for (let row of rows) {
        const gare = row.cells[0].textContent.trim();

        // Pour chaque colonne de train (en partant de 1 car 0 = gare)
        for (let colIndex = 1; colIndex < row.cells.length; colIndex++) {
          const trainHeader = trainHeaders[colIndex];
          if (!trainHeader) continue;

          const trainNumber = trainHeader.dataset.trainNumber?.trim();
          if (!trainNumber) continue;

          // Nettoyer tout retard affiché avant d’appliquer à nouveau
          // Supprime le div retard s’il existe déjà
          const existingRetard = row.cells[colIndex].querySelector(".retard");
          if (existingRetard) {
            existingRetard.remove();
          }

          // Vérifier si retard disponible pour ce train à cette gare
          if (retardsGTFS[trainNumber] && retardsGTFS[trainNumber][gare] != null) {
            const retardMinutes = retardsGTFS[trainNumber][gare];

            if (retardMinutes > 0) {
              // Ajouter un petit div rouge avec le retard
              const retardDiv = document.createElement("div");
              retardDiv.classList.add("retard");
              retardDiv.textContent = `+${retardMinutes} min`;
              row.cells[colIndex].appendChild(retardDiv);
            }
          }
        }
      }
    }

    // Chargement du fichier JSON externe et application
    fetch("https://raw.githubusercontent.com/TekMaTe-lux/Assistant-train/main/Assistant-train/retards_nancymetzlux.json")
      .then(response => response.json())
      .then(retardsGTFS => {
        applyRetardsFromGTFS(retardsGTFS);
      })
      .catch(err => {
        console.error("Erreur lors du chargement des retards GTFS-RT :", err);
      });
  </script>

</body>
</html>
