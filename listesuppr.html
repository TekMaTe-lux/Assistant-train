<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recherche des Trains Annulés</title>
  <script>
    // Liste des numéros de trains
    const trainNumbers = [
      "88700", "88702", "88704", "88706", "88708", "88710", "88802", "88712", "88501", "88804",
      "88714", "88503", "88806", "88716", "88505", "88718", "88571", "88722", "88724", "88726",
      "88730", "88720", "88734", "88509", "88736", "88738", "88511", "837680", "837682", "88513",
      "88740", "88727", "88729"
    ];

    const apiKey = '242fac11-6d98-45fb-93df-28174d362447';  // Ta clé API
    const encodedApiKey = btoa(apiKey + ":");

    // Fonction pour rechercher si un train est annulé
    async function checkTrainCancellation(trainNumber) {
      const now = new Date(Date.now() - (61 * 60 * 1000));  // Heure actuelle moins 61 minutes
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const dd = String(now.getDate()).padStart(2, '0');
      const hh = String(now.getHours()).padStart(2, '0');
      const min = String(now.getMinutes()).padStart(2, '0');
      const ss = String(now.getSeconds()).padStart(2, '0');

      const datetime = `${yyyy}${mm}${dd}T${hh}${min}${ss}`;
      const url = `https://api.sncf.com/v1/coverage/sncf/vehicle_journeys?filter=vehicle_journey_name=${trainNumber}&datetime=${datetime}`;

      try {
        const response = await fetch(url, {
          method: 'GET',
          headers: {
            "Authorization": "Basic " + encodedApiKey
          }
        });
        const data = await response.json();

        // Si le train est annulé
        if (data.disruptions && data.disruptions.length > 0) {
          const disruptions = data.disruptions.filter(disruption => disruption.severity.effect === 'NO_SERVICE');
          if (disruptions.length > 0) {
            disruptions.forEach(disruption => {
              console.log(`Train ${trainNumber} annulé : ${disruption.severity.name}`);
              console.log(`Cause : ${disruption.messages[0]?.text || "Aucune cause spécifiée"}`);
            });
          }
        }
      } catch (error) {
        console.error(`Erreur pour le train ${trainNumber}:`, error);
      }
    }

    // Fonction pour vérifier tous les trains de la liste
    async function checkAllTrainCancellations() {
      const resultDiv = document.getElementById("results");
      resultDiv.innerHTML = "<h3>Trains annulés ou no service :</h3>";

      for (const trainNumber of trainNumbers) {
        const result = await checkTrainCancellation(trainNumber);
        if (result) {
          resultDiv.innerHTML += `<p>Train ${trainNumber} annulé ou No Service</p>`;
        }
      }
    }

    // Lancer la vérification au chargement de la page
    window.onload = checkAllTrainCancellations;
  </script>
</head>
<body>
  <h1>Recherche des Trains Annulés ou No Service</h1>
  <div id="results"></div>
</body>
</html>
