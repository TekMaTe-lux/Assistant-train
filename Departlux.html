<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Départs Bettembourg</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #eee; padding: 20px; }
    h1 { color: #4cafef; }
    .controls { margin-bottom: 20px; }
    label { margin-right: 10px; }
    button { margin: 5px; padding: 6px 12px; cursor: pointer; }
    .train { background: #222; margin: 8px 0; padding: 10px; border-radius: 6px; }
    .train strong { color: #4cafef; }
  </style>
</head>
<body>
  <h1>Départs depuis Bettembourg</h1>

  <div class="controls">
    <button onclick="fetchNow()">Maintenant</button>
    <button onclick="fetchTwoHours()">Prochaines 2 heures</button>
    <br><br>
    <label>Date : <input type="date" id="dateInput"></label>
    <label>Heure : <input type="time" id="timeInput"></label>
    <label>Durée (minutes) : <input type="number" id="durationInput" value="120"></label>
    <button onclick="fetchCustom()">Chercher</button>
  </div>

  <div id="results">Chargement...</div>

  <script>
    const API_URL = "https://cdt.hafas.de/opendata/apiserver/departureBoard";
    const ACCESS_ID = "58ef9a71-6837-4405-bd5d-23beaf92864c";
    const STOP_ID = "220102018"; // Bettembourg

    async function fetchDepartures(date, time, duration = 120) {
      const url = `${API_URL}?accessId=${ACCESS_ID}&id=${STOP_ID}&date=${date}&time=${time}&duration=${duration}&maxJourneys=50&format=json`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        displayResults(data);
      } catch (e) {
        document.getElementById("results").innerHTML = "Erreur de chargement : " + e;
      }
    }

    function displayResults(data) {
      const container = document.getElementById("results");
      container.innerHTML = "";

      if (!data.Departure || data.Departure.length === 0) {
        container.innerHTML = "<p>Aucun départ trouvé.</p>";
        return;
      }

      data.Departure.forEach(dep => {
        let statut = "À l'heure";
        if (dep.rtTime && dep.rtTime !== dep.time) {
          statut = `Retardé à ${dep.rtTime}`;
        }

        const div = document.createElement("div");
        div.className = "train";
        div.innerHTML = `
          <strong>${dep.name || "Train"}</strong> vers <strong>${dep.direction}</strong><br>
          Départ prévu : ${dep.time} (${dep.date})<br>
          Voie : ${dep.track || "?"}<br>
          Catégorie : ${dep.category || "?"}<br>
          Statut : ${statut}
        `;
        container.appendChild(div);
      });
    }

    function fetchNow() {
      const now = new Date();
      const date = now.toISOString().slice(0,10);
      const time = now.toTimeString().slice(0,8);
      fetchDepartures(date, time, 60); // par défaut 1h
    }

    function fetchTwoHours() {
      const now = new Date();
      const date = now.toISOString().slice(0,10);
      const time = now.toTimeString().slice(0,8);
      fetchDepartures(date, time, 120);
    }

    function fetchCustom() {
      const date = document.getElementById("dateInput").value;
      const timeRaw = document.getElementById("timeInput").value;
      const duration = document.getElementById("durationInput").value || 120;

      if (!date || !timeRaw) {
        alert("Choisis une date et une heure !");
        return;
      }

      const time = timeRaw.length === 5 ? timeRaw + ":00" : timeRaw;
      fetchDepartures(date, time, duration);
    }

    // Charger par défaut maintenant
    fetchNow();
  </script>
</body>
</html>
