<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Départs CFL</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  label { margin-right: 10px; }
  select, input { margin: 5px 0; padding: 5px; width: 100%; max-width: 300px; }
  .results { margin-top: 20px; }
  li { margin-bottom: 10px; }
  .btn { padding: 8px 12px; margin: 5px 0; cursor: pointer; background-color: #D10074; color: white; border: none; border-radius: 5px; }
  .btn:hover { background-color: #b0005c; }
  .hidden { display: none; }
</style>
</head>
<body>

<h2>Départs CFL</h2>

<label for="station">Choisir une gare :</label>
<select id="station" onchange="loadDepartures()">
  <option value="">-- Sélectionner --</option>
  <option value="220102018">Bettembourg</option>
  <option value="200405060">Luxembourg Gare Centrale</option>
  <option value="220402046">Esch-sur-Alzette</option>
  <option value="220201021">Differdange</option>
  <option value="140701022">Ettelbruck</option>
  <option value="200304014">Howald</option>
  <option value="200417051">Pfaffenthal-Kirchberg</option>
  <option value="220903011">Rodange</option>
</select>
<br>

<!-- Intervalle -->
<label for="interval">Intervalle :</label>
<select id="interval" onchange="loadDepartures()">
  <option value="30">30 min</option>
  <option value="60">1 heure</option>
  <option value="120" selected>2 heures</option>
  <option value="180">3 heures</option>
</select>
<br>

<!-- Menu date/heure pour autre horaire -->
<div id="otherTimeMenu" class="hidden">
  <label for="datetime">Date et heure :</label>
  <input type="datetime-local" id="datetime">
  <br>
  <button class="btn" onclick="loadDepartures(true)">Afficher départs</button>
  <button class="btn" onclick="showNextDepartures()">Retour aux prochains départs</button>
</div>

<!-- Bouton pour changer horaire -->
<button id="changeTimeBtn" class="btn" onclick="toggleOtherTimeMenu()">Changer horaire</button>

<div class="results" id="results">Sélectionnez une gare pour afficher les départs...</div>

<script>
const API_KEY = "58ef9a71-6837-4405-bd5d-23beaf92864c";

// Affiche le menu date/heure
function toggleOtherTimeMenu() {
  document.getElementById("otherTimeMenu").classList.toggle("hidden");
}

// Revenir aux prochains départs
function showNextDepartures() {
  document.getElementById("otherTimeMenu").classList.add("hidden");
  document.getElementById("datetime").value = "";
  loadDepartures();
}

// Fonction principale
async function loadDepartures(isOtherTime=false) {
  const stationId = document.getElementById("station").value;
  const interval = document.getElementById("interval").value;
  const datetime = document.getElementById("datetime").value;

  if (!stationId) {
    document.getElementById("results").innerHTML = "Veuillez choisir une gare.";
    return;
  }

  // Date et heure
  let now = new Date();
  let dateStr = now.toISOString().split("T")[0];       // YYYY-MM-DD
  let timeStr = now.toTimeString().slice(0,8);         // HH:MM:SS

  if (isOtherTime && datetime) {
    const d = new Date(datetime);
    dateStr = d.toISOString().split("T")[0];
    timeStr = d.toTimeString().slice(0,8);
  }

  const url = `https://cdt.hafas.de/opendata/apiserver/departureBoard?accessId=${API_KEY}&id=${stationId}&date=${dateStr}&time=${timeStr}&duration=${interval}&maxJourneys=200&format=json`;

  try {
    const response = await fetch(url);
    const data = await response.json();

    if (!data.Departure || data.Departure.length === 0) {
      document.getElementById("results").innerHTML = "Aucun départ trouvé.";
      return;
    }

    let html = `<h3>Prochains départs depuis ${document.getElementById("station").selectedOptions[0].text} :</h3><ul>`;
    data.Departure.forEach(dep => {
      let depTime = dep.rtTime || dep.time; // heure retardée si dispo
      let diffMin = 0;
      if (dep.rtTime && dep.rtTime !== dep.time) {
        const t1 = dep.time.split(":").map(Number);
        const t2 = dep.rtTime.split(":").map(Number);
        diffMin = (t2[0]*60 + t2[1]) - (t1[0]*60 + t1[1]);
      }

      html += `<li>
        <b>${dep.name}</b> vers ${dep.direction}<br>
        Départ : ${depTime} (${dep.date}) ${diffMin>0 ? `( + ${diffMin} min)` : ''}<br>
        Voie : ${dep.rtTrack ? dep.rtTrack : "?"}<br>
        Catégorie : ${dep.ProductAtStop?.line || "?"}<br>
        Statut : ${dep.rtTime && dep.rtTime !== dep.time ? "Retardé" : "À l'heure"}<br>
      </li>`;
    });
    html += "</ul>";

    document.getElementById("results").innerHTML = html;
  } catch(e) {
    console.error(e);
    document.getElementById("results").innerHTML = "Erreur de chargement des données.";
  }
}

// Initialisation : prochains départs pour la gare sélectionnée
document.getElementById("station").addEventListener("change", showNextDepartures);
</script>
</body>
</html>
