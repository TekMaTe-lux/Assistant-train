<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Informations Train SNCF - Horaires Départ</title>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style>
    body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f9f9f9;
        color: #222;
        margin: 0;
        padding: 20px;
        max-width: 720px;
        margin-left: auto;
        margin-right: auto;
    }
    h1 {
        text-align: center;
        color: #0055a5;
        margin-bottom: 1rem;
    }

    .input-container {
        background-color: #fff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 85, 165, 0.1);
        margin-bottom: 30px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 16px;
    }
    .input-group {
        display: flex;
        flex-direction: column;
        width: 100%;
        max-width: 300px;
    }
    label {
        font-weight: 600;
        margin-bottom: 4px;
        color: #004080;
    }
    input[type="text"], input[type="date"] {
        width: 100%;
        padding: 10px 12px;
        border: 1.5px solid #ccc;
        border-radius: 8px;
        transition: border-color 0.3s ease;
        font-size: 1rem;
        background-color: #fdfdfd;
    }
    input[type="text"]:focus, input[type="date"]:focus {
        border-color: #0077cc;
        outline: none;
    }
    button {
        margin-top: 8px;
        background-color: #0077cc;
        color: white;
        border: none;
        padding: 12px 24px;
        font-size: 1.1rem;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    button:hover {
        background-color: #005999;
    }

    #trainInfo {
        margin-top: 30px;
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 3px 10px rgb(0 0 0 / 0.1);
        min-height: 100px;
    }
    h2 {
        border-bottom: 2px solid #0077cc;
        padding-bottom: 6px;
        margin-bottom: 14px;
        color: #004080;
    }
    h3 {
        margin-bottom: 10px;
    }
    p {
        margin: 6px 0;
        line-height: 1.35;
    }
    .deleted {
        color: #cc0000;
        text-decoration: line-through;
        font-weight: 600;
    }
    .delayed {
        color: #ff6600;
        font-weight: 600;
    }
    .delay-strike {
        color: #444;
        text-decoration: line-through;
    }
    .new-start, .new-end {
        color: #0055cc;
        font-weight: 700;
    }
    .small-gray {
        color: #888;
        font-size: 0.9rem;
        margin-left: 6px;
    }

    .disruption-box {
        border-radius: 8px;
        padding: 15px 20px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 600;
    }
    .disruption-box.red {
        background-color: #ffe6e6;
        border: 2px solid #cc0000;
        color: #cc0000;
    }
    .disruption-box.orange {
        background-color: #fff4e5;
        border: 2px solid #ff6600;
        color: #ff6600;
    }
    .disruption-icon {
        font-size: 24px;
        flex-shrink: 0;
    }

    /* Ligne d'arrêt en flex, gare à gauche, horaires à droite sur même ligne */
    .stop-line {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
        gap: 12px;
        font-size: 1rem;
    }
    .stop-name {
        flex-shrink: 1;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        max-width: 65%;
    }
    .stop-time {
        white-space: nowrap;
        flex-shrink: 0;
        color: #222;
    }
    /* Horaires retardés affichés sur la même ligne */
    .stop-time .delay-strike {
        color: #444;
        text-decoration: line-through;
        margin-right: 8px;
    }
    .stop-time .delayed {
        color: #ff6600;
        font-weight: 600;
        margin-right: 6px;
    }
    .stop-time .small-gray {
        color: #888;
        font-size: 0.9rem;
        margin-left: 0;
    }
    /* Style suppression */
    .stop-line.deleted {
        color: #cc0000;
        text-decoration: line-through;
        font-weight: 600;
    }
    /* Style nouvelles gares départ/terminus */
    .stop-line.new-start .stop-name,
    .stop-line.new-end .stop-name,
    .stop-line.new-start .stop-time,
    .stop-line.new-end .stop-time {
        color: #0055cc;
        font-weight: 700;
    }
</style>
</head>
<body>
<h1>Informations sur votre bétaillère</h1>

<div class="input-container">
    <div class="input-group">
        <label for="trainNumber">Numéro de votre Bétaillère :</label>
        <input type="text" id="trainNumber" value="88534" />
    </div>
    <div class="input-group">
        <label for="trainDate">Date (YYYY-MM-DD) :</label>
        <input type="date" id="trainDate" />
    </div>
    <button id="getTrainData">Obtenir les données</button>
</div>

<div id="trainInfo"></div>

<script>
$(document).ready(function () {
    $('#getTrainData').click(function () {
        const trainNumber = $('#trainNumber').val().trim();
        const trainDate = $('#trainDate').val();
        if (!trainNumber) {
            $('#trainInfo').html('<p class="deleted">Veuillez entrer un numéro de train valide.</p>');
            return;
        }
        if (!trainDate) {
            $('#trainInfo').html('<p class="deleted">Veuillez sélectionner une date valide.</p>');
            return;
        }

        $('#trainInfo').html('<p>Chargement des données...</p>');

        const apiKey = '242fac11-6d98-45fb-93df-28174d362447';
        const encodedApiKey = btoa(apiKey + ":");
        const url = `https://api.sncf.com/v1/coverage/sncf/vehicle_journeys/vehicle_journey:SNCF:${trainDate}:${trainNumber}:1187:Train`;

        $.ajax({
            url: url,
            method: 'GET',
            headers: { 'Authorization': 'Basic ' + encodedApiKey },
            success: function (response) {
                if (!response.vehicle_journeys || response.vehicle_journeys.length === 0) {
                    $('#trainInfo').html('<p class="deleted">Aucun train trouvé avec ce numéro et cette date.</p>');
                    return;
                }
                const train = response.vehicle_journeys[0];
                const disruptions = response.disruptions || [];
                let effect = null;
                let impactedStopsMap = {};
                if (disruptions.length > 0) {
                    const disruption = disruptions[0];
                    effect = disruption.severity?.effect || null;
                    disruption.impacted_objects?.forEach(obj => {
                        obj.impacted_stops?.forEach(stop => {
                            impactedStopsMap[stop.stop_point.id] = {
                                arrival_status: stop.arrival_status,
                                departure_status: stop.departure_status,
                                stop_time_effect: stop.stop_time_effect,
                                amended_arrival_time: stop.amended_arrival_time,
                                amended_departure_time: stop.amended_departure_time
                            };
                        });
                    });
                }

                const stops = train.stop_times;
                let firstRealDepartureIndex = -1;
                let lastRealArrivalIndex = -1;
                stops.forEach((stop, index) => {
                    const impact = impactedStopsMap[stop.stop_point.id];
                    if (!impact || impact.departure_status !== "deleted") {
                        if (firstRealDepartureIndex === -1) firstRealDepartureIndex = index;
                    }
                    if (!impact || impact.arrival_status !== "deleted") {
                        lastRealArrivalIndex = index;
                    }
                });

                function formatTime(t) {
                    if (!t) return '-';
                    return t.substring(0, 2) + ':' + t.substring(2, 4);
                }

                function computeDelay(baseTime, amendedTime) {
                    const base = parseInt(baseTime.substring(0, 2)) * 60 + parseInt(baseTime.substring(2, 4));
                    const amended = parseInt(amendedTime.substring(0, 2)) * 60 + parseInt(amendedTime.substring(2, 4));
                    return amended - base;
                }

                const stopHtml = stops.map((stop, index) => {
                    const id = stop.stop_point.id;
                    const name = stop.stop_point.name;
                    const baseArrival = stop.arrival_time ? formatTime(stop.arrival_time) : '';
                    const baseDeparture = stop.departure_time ? formatTime(stop.departure_time) : '';
                    const impact = impactedStopsMap[id];

                    let isDeleted = false;
                    if (impact) {
                        if (impact.arrival_status === "deleted" && impact.departure_status === "deleted") {
                            isDeleted = true;
                        }
                    }

                    // Style suppression
                    let lineClass = '';
                    if (isDeleted) {
                        lineClass = 'deleted';
                    } else if (index === firstRealDepartureIndex && index === lastRealArrivalIndex) {
                        lineClass = 'new-start new-end';
                    } else if (index === firstRealDepartureIndex) {
                        lineClass = 'new-start';
                    } else if (index === lastRealArrivalIndex) {
                        lineClass = 'new-end';
                    }

                    // Préparation affichage horaires départ + retard à droite, même ligne
                    let departureDisplay = '';
                    if (baseDeparture) {
                        if (impact && impact.departure_status === "cancelled") {
                            departureDisplay = `<span class="deleted">${baseDeparture}</span>`;
                        } else if (impact && impact.amended_departure_time && impact.amended_departure_time !== stop.departure_time) {
                            const delay = computeDelay(stop.departure_time, impact.amended_departure_time);
                            const amendedTime = formatTime(impact.amended_departure_time);
                            const delayStr = (delay > 0) ? `(+${delay}min)` : `(${delay}min)`;
                            departureDisplay = `<span class="delay-strike">${baseDeparture}</span> ➔ <span class="delayed">${amendedTime} <span class="small-gray">${delayStr}</span></span>`;
                        } else {
                            departureDisplay = baseDeparture;
                        }
                    }

                    return `<div class="stop-line ${lineClass}">
                        <div class="stop-name" title="${name}">${name}</div>
                        <div class="stop-time">${departureDisplay}</div>
                    </div>`;
                }).join('');

                let disruptionHtml = '';
                if (effect === "NO_SERVICE") {
                    disruptionHtml = `<div class="disruption-box red"><div class="disruption-icon">⛔</div><div>Le train est supprimé.</div></div>`;
                } else if (effect === "REDUCED_SERVICE") {
                    disruptionHtml = `<div class="disruption-box orange"><div class="disruption-icon">⚠️</div><div>Service réduit - perturbations sur certaines gares.</div></div>`;
                }

                const html = `
                    <h2>Train n°${trainNumber} - Date ${trainDate}</h2>
                    ${disruptionHtml}
                    <div>${stopHtml}</div>
                    <p><small>Heures en HH:mm, horaires barrés = horaires initiaux remplacés</small></p>
                `;
                $('#trainInfo').html(html);
            },
            error: function () {
                $('#trainInfo').html('<p class="deleted">Erreur lors de la récupération des données. Veuillez réessayer plus tard.</p>');
            }
        });
    });
});
</script>

</body>
</html>
