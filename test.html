<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Informations train SNCF</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #aaa;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
    }
    .deleted {
      text-decoration: line-through;
      color: red;
    }
    .new-start, .new-end {
      background-color: #ffffcc;
    }
    .status-info {
      margin-top: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Infos Train SNCF</h1>
  <label for="trainId">Num√©ro du train :</label>
  <input type="text" id="trainId" placeholder="Ex: 891725">
  <label for="date">Date :</label>
  <input type="date" id="date">
  <button onclick="fetchTrain()">Afficher</button>

  <div id="results"></div>

  <script>
    async function fetchTrain() {
      const trainId = document.getElementById('trainId').value.trim();
      const date = document.getElementById('date').value;
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';

      if (!trainId || !date) {
        resultsDiv.innerText = 'Veuillez entrer un num√©ro de train et une date.';
        return;
      }

      const apiKey = '242fac11-6d98-45fb-93df-28174d362447'; // Remplace par ta cl√©
      const formattedDate = date.replace(/-/g, '') + 'T000000';
      const url = `https://api.sncf.com/v1/coverage/sncf/journeys?train_number=${trainId}&datetime=${formattedDate}&count=1`;

      try {
        const response = await fetch(url, {
          headers: { Authorization: `Basic ${btoa(apiKey + ':')}` }
        });
        const data = await response.json();

        const journey = data.journeys[0];
        if (!journey) {
          resultsDiv.innerText = 'Aucun trajet trouv√©.';
          return;
        }

        const publicSection = journey.sections.find(sec => sec.type === "public_transport");
        if (!publicSection || !publicSection.display_informations) {
          resultsDiv.innerText = 'Aucune section publique trouv√©e.';
          return;
        }

        const stops = publicSection.stop_date_times;
        const start = stops.find(s => s.departure_status !== 'deleted');
        const end = [...stops].reverse().find(s => s.arrival_status !== 'deleted');

        const table = document.createElement('table');
        const header = document.createElement('tr');
        header.innerHTML = `
          <th>Gare</th>
          <th>Arriv√©e</th>
          <th>D√©part</th>
          <th>Statut</th>
        `;
        table.appendChild(header);

        for (const stop of stops) {
          const row = document.createElement('tr');
          const isDeleted = (stop.departure_status === 'deleted' && stop.arrival_status === 'deleted');
          const isNewStart = stop.stop_point.label === start.stop_point.label && stops[0].stop_point.label !== start.stop_point.label;
          const isNewEnd = stop.stop_point.label === end.stop_point.label && stops[stops.length - 1].stop_point.label !== end.stop_point.label;

          let status = '';
          if (isDeleted) status = 'Supprim√©';
          else if (isNewStart) status = 'Nouveau d√©part';
          else if (isNewEnd) status = 'Nouveau terminus';

          row.className = `${isDeleted ? 'deleted' : ''} ${isNewStart ? 'new-start' : ''} ${isNewEnd ? 'new-end' : ''}`;
          row.innerHTML = `
            <td>${stop.stop_point.label}</td>
            <td>${stop.arrival_date_time ? formatHour(stop.arrival_date_time) : '-'}</td>
            <td>${stop.departure_date_time ? formatHour(stop.departure_date_time) : '-'}</td>
            <td>${status}</td>
          `;
          table.appendChild(row);
        }

        resultsDiv.appendChild(table);

        // Statut global
        let statusText = '';
        if (journey.status === 'cancelled') {
          statusText = '‚ö†Ô∏è Train supprim√©.';
        } else if (journey.durations?.departure_delay || journey.durations?.arrival_delay) {
          const delay = journey.durations.departure_delay || journey.durations.arrival_delay;
          statusText = `üö® Retard estim√© : ${Math.round(delay / 60)} min.`;
        }

        // Cause perturbation
        const causes = publicSection.display_informations.links?.filter(link => link.type === 'cause');
        if (causes?.length) {
          statusText += `<br>üí¨ Cause : ${causes.map(c => c.value).join(', ')}`;
        }

        if (statusText) {
          const statusDiv = document.createElement('div');
          statusDiv.className = 'status-info';
          statusDiv.innerHTML = statusText;
          resultsDiv.appendChild(statusDiv);
        }

      } catch (error) {
        console.error(error);
        resultsDiv.innerText = 'Erreur lors de la r√©cup√©ration des donn√©es.';
      }
    }

    function formatHour(dateTime) {
      return dateTime?.substring(9, 11) + 'h' + dateTime?.substring(11, 13);
    }
  </script>
</body>
</html>
