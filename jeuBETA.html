<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>La Bétaillère Express • BERNancyMetzLux</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Rajdhani:wght@400;600&display=swap');

    :root {
      --neon-cyan: #10f2ff;
      --neon-blue: #2c71ff;
      --dark: #020410;
      --panel: rgba(10, 18, 38, 0.8);
      --text: #e6f7ff;
      --accent: #ffeb3b;
    }

    * {
      box-sizing: border-box;
    }


    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      min-height: 100vh;
      background: radial-gradient(circle at top, #071021 0%, #010106 55%, #000 100%);
      color: var(--text);
      font-family: 'Rajdhani', 'Orbitron', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      text-align: center;
      overflow: hidden;
      overscroll-behavior: none;
      touch-action: none;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: url('data:image/svg+xml,%3Csvg width="120" height="120" xmlns="http://www.w3.org/2000/svg"%3E%3Ccircle cx="2" cy="2" r="1" fill="%230ff" opacity="0.2"/%3E%3C/svg%3E');
      mix-blend-mode: screen;
      opacity: 0.4;
      pointer-events: none;
      animation: drift 18s linear infinite;
    }

    @keyframes drift {
      from { transform: translateY(0); }
      to { transform: translateY(-120px); }
    }

    #container {
         width: min(92vw, 520px);
      margin: clamp(14px, 4vh, 28px) auto clamp(120px, 22vh, 200px);
      padding: clamp(16px, 3vw, 24px);
      background: linear-gradient(160deg, rgba(5, 12, 26, 0.92), rgba(0, 0, 0, 0.82));
      border: 2px solid rgba(16, 242, 255, 0.35);
      border-radius: 22px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.45), 0 0 35px rgba(16, 242, 255, 0.18);
      position: relative;
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: clamp(14px, 3vh, 24px);
    }

    #topSection {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    h1 {
      font-family: 'Orbitron', sans-serif;
      text-transform: uppercase;
      font-size: clamp(1.8rem, 5vw, 2.6rem);
      letter-spacing: 2px;
      margin-bottom: 6px;
      color: var(--neon-cyan);
      text-shadow: 0 0 18px rgba(16, 242, 255, 0.7);
    }

   .tagline {
      margin: 0 0 20px;
      font-size: 1rem;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.65);
    }
   #hud {
      width: 100%;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 12px;     
    }

    .panel {
      background: var(--panel);
      border: 1px solid rgba(16, 242, 255, 0.25);
      border-radius: 12px;
      padding: 10px 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-shadow: inset 0 0 12px rgba(16, 242, 255, 0.12);
    }
    .panel .label {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: rgba(230, 247, 255, 0.65);
    }
    .panel .value {
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--accent);
      text-shadow: 0 0 10px rgba(255, 235, 59, 0.5);
    }

    #musicToggle {
      position: absolute;
      top: 18px;
      right: 18px;
      width: 42px;
      height: 42px;
      background: rgba(16, 242, 255, 0.15);
      border: 1px solid rgba(16, 242, 255, 0.6);
      border-radius: 12px;
      color: var(--neon-cyan);
      font-size: 1.2rem;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 0 12px rgba(16, 242, 255, 0.25);
    }
    #musicToggle:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 18px rgba(16, 242, 255, 0.35);
    }
    #canvasWrap {
      width: 100%;
      display: flex;
      justify-content: center;
      position: relative;
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 14px 45px rgba(0, 0, 0, 0.35);
      border: 1px solid rgba(16, 242, 255, 0.3);
    }

    canvas {
      display: block;
      width: min(82vw, 460px);
      height: auto;
      image-rendering: pixelated;
      background: rgba(2, 4, 12, 0.95);
    }

    #instructions {
      width: 100%;
      background: var(--panel);
      border: 1px solid rgba(16, 242, 255, 0.25);
      border-radius: 16px;
      padding: 12px 16px;
      text-align: left;
      line-height: 1.5;
      font-size: 0.95rem;
      color: rgba(230, 247, 255, 0.78);
      touch-action: pan-y;
      overscroll-behavior: contain;
    }

    #instructions summary {
      cursor: pointer;
      list-style: none;
      outline: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      font-size: 1.05rem;
      text-transform: uppercase;
      color: var(--neon-cyan);
      letter-spacing: 1px;
    }

    #instructions summary::-webkit-details-marker {
      display: none;
    }

    #instructions summary::after {
      content: '▾';
      font-size: 1rem;
      color: var(--accent);
      transition: transform 0.2s ease;
    }

    #instructions[open] summary::after {
      transform: rotate(180deg);
    }

    #instructions summary span {
      margin-left: auto;
      font-size: 0.85rem;
      text-transform: none;
      color: rgba(230, 247, 255, 0.65);
      letter-spacing: normal;
    }

    #instructions ul {
      margin: 12px 0 0;
      padding-left: 18px;
      list-style: square;
    }   

    #touchControls {
      position: fixed;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      z-index: 1000;
      padding: 12px 18px;
      border-radius: 18px;
      background: rgba(5, 12, 26, 0.82);
      border: 1px solid rgba(16, 242, 255, 0.2);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
      width: min(360px, 92vw);
    }

    #touchControls button {
      width: 68px;
      height: 68px;
      font-size: 24px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.35);
      background: rgba(10, 14, 28, 0.88);
      color: #fff;
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.35);
      touch-action: manipulation;
    }

    .up-row, .middle-row {
      display: flex;
      gap: 12px;
    }

        .middle-row {
      justify-content: center;
    }

    #touchControls button:active {
      transform: translateY(2px);
    }

    #startOverlay, #overlay {
      position: fixed;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      background: rgba(0, 0, 0, 0.82);
      backdrop-filter: blur(6px);
      z-index: 1200;
    }

    #startOverlay { display: flex; }

    #startMessage, #gameOverMessage {
      background: linear-gradient(160deg, rgba(6, 10, 22, 0.96), rgba(0, 0, 0, 0.92));
      border: 1px solid rgba(16, 242, 255, 0.4);
      border-radius: 18px;
      padding: 26px 30px;
      width: min(88vw, 420px);
      text-align: center;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.55), 0 0 25px rgba(16, 242, 255, 0.25);
    }

    #startMessage h2 {
      margin: 0 0 12px;
      font-size: 1.5rem;
      color: var(--accent);
    }

    #startMessage p {
      margin: 0 0 16px;
      line-height: 1.5;
    }

    .cta-button {
      background: linear-gradient(120deg, rgba(16, 242, 255, 0.9), rgba(44, 113, 255, 0.9));
      border: none;
      color: #001828;
      font-weight: 700;
      font-size: 1.1rem;
      padding: 12px 26px;
      border-radius: 12px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .cta-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(16, 242, 255, 0.32);
    }

    #overlay {
      display: none;
    }

    #gameOverMessage {
      display: none;
    }

    #gameOverMessage p {
      margin: 8px 0;
    }

    #gameOverMessage button {
      font-size: 1rem;
      padding: 10px 20px;
      margin: 10px 8px 0 8px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      background: rgba(16, 242, 255, 0.85);
      color: #02121d;
      font-weight: 600;
      box-shadow: 0 6px 18px rgba(16, 242, 255, 0.3);
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }

    @media (max-width: 900px) {
      body {
        padding-bottom: 200px;
      }

      #touchControls button {
        width: 60px;
        height: 60px;
        font-size: 22px;
      }

      #container {
        margin-bottom: clamp(120px, 24vh, 200px);
      }
    }

    @media (max-width: 600px) {
      #topSection {
        gap: 10px;
      }

      h1 {
        font-size: clamp(1.4rem, 7vw, 1.9rem);
      }

      .tagline {
        font-size: 0.75rem;
        margin-bottom: 0;
      }

      #hud {
        gap: 8px;
        grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
      }

      .panel {
        padding: 8px 10px;
      }

      .panel .label {
        font-size: 0.72rem;
      }

      .panel .value {
        font-size: 1.15rem;
      }

      #musicToggle {
        width: 36px;
        height: 36px;
        font-size: 1rem;
      }

      #instructions {
        font-size: 0.9rem;
        padding: 10px 14px;
        max-height: 30vh;
        overflow-y: auto;
        padding-right: 6px;
      }

      #instructions summary {
        font-size: 0.95rem;
      }

      #instructions::-webkit-scrollbar {
        width: 4px;
      }

      #instructions::-webkit-scrollbar-thumb {
        background: rgba(16, 242, 255, 0.35);
        border-radius: 2px;
      }
    }

    @media (min-width: 901px) {
      body {
        justify-content: center;
      }

      #touchControls {
        display: none;
      }

      #container {
        margin-bottom: clamp(40px, 8vh, 80px);
      }

      #instructions summary span {
        display: none;
      }
    }
  </style>
</head>
<body>
  
  <div id="startOverlay">
    <div id="startMessage">
      <h2>Bienvenue à bord !</h2>
      <p>Le convoi BERNancyMetzLux doit atteindre son quota de bêtaillères sans croiser la moindre suppression. Collectez les wagons jaunes, évitez les carrés rouges et méfiez-vous des vaches qui envahissent la voie.</p>
      <p>Après 3 minutes, un TGV prioritaire transfrontalier déboule verticalement : gardez une voie de dégagement !</p>
      <p><strong>Commandes :</strong> flèches du clavier ou pavé tactile. Bon voyage conducteur !</p>
      <button id="startBtn" class="cta-button">Embarquer</button>
    </div>
  </div>

  <div id="container">
    <button id="musicToggle" aria-label="Activer ou couper la musique" title="Activer ou couper la musique">🔊</button>

<div id="topSection">
      <h1>La Bétaillère Express</h1>
      <p class="tagline">BERNancyMetzLux Connection</p>

      <section id="hud" aria-live="polite">
        <div class="panel">
          <span class="label">Score</span>
          <span id="score" class="value">0</span>
        </div>
        <div class="panel">
          <span class="label">Record</span>
          <span id="highscore" class="value">0</span>
        </div>
        <div class="panel">
          <span class="label">Temps</span>
          <span id="timer" class="value">00:00</span>
        </div>
        <div class="panel">
          <span class="label">Vaches</span>
          <span id="cowTimer" class="value">--</span>
        </div>
        <div class="panel">
          <span class="label">TGV prioritaire</span>
          <span id="priorityTimer" class="value">03:00</span>
        </div>
      </section>
    </div>
    
    <div id="canvasWrap">
      <canvas id="gameCanvas" width="400" height="400"></canvas>
    </div>
    
    <details id="instructions" open>
      <summary>Briefing conducteur <span>touchez pour afficher / masquer</span></summary>
      <ul>
        <li><strong>BER</strong> pour Bettembourg, <strong>Nancy</strong>, <strong>Metz</strong> et <strong>Lux</strong> : restez aligné sur la ligne internationale.</li>
        <li>Collectez les wagons jaunes pour allonger votre convoi et faire vibrer la région.</li>
        <li>Les carrés rouges = annonces de suppressions : ils mettent fin au service immédiatement.</li>
        <li>Les carrés oranges accélèrent ou ralentissent temporairement votre rame.</li>
        <li>Les vaches arrivent d'abord après 30 s puis de plus en plus vite : gardez la voie libre !</li>
        <li>À partir de 3 minutes, des TGV prioritaires coupent la ligne du haut vers le bas et accélèrent progressivement.</li>
      </ul>
    </details>
  </div>

  <div id="touchControls" aria-hidden="true">
    <div class="up-row">
      <button id="up">▲</button>
    </div>
    <div class="middle-row">
      <button id="left">◀</button>
      <button id="down">▼</button>
      <button id="right">▶</button>
    </div>
  </div>
    
  <div id="overlay">
    <div id="gameOverMessage">
      <div id="gameOverText"></div>
      <button id="restartBtn">Rejouer</button>
      <button id="returnBtn">Retour</button>
    </div>
  </div>

 <audio id="gameMusic" loop>
    <source src="https://raw.githubusercontent.com/TekMaTe-lux/Assistant-train/main/Tek'Ma'Te%20-%20Power%20of%20the%20SNCF%20jingle.mp3" type="audio/mpeg">
    Votre navigateur ne supporte pas l’audio.
  </audio>

  <script>
    (() => {
      const canvas = document.getElementById('gameCanvas');
      const ctx = canvas.getContext('2d');
      const scoreEl = document.getElementById('score');
      const highscoreEl = document.getElementById('highscore');
      const timerEl = document.getElementById('timer');
      const cowTimerEl = document.getElementById('cowTimer');
      const priorityTimerEl = document.getElementById('priorityTimer');
      const music = document.getElementById('gameMusic');
      const musicToggle = document.getElementById('musicToggle');

      let gridSize = 20, cols, rows;
      let train, direction, nextDirection, score, highscore = 0;
      const baseSpeed = 200;
      let speedModifier = 0;
      let betail, suppressions, oranges, vaches, prioritaires;
      let scheduleVachesTimeoutId, schedulePrioritaireTimeoutId, lateDifficultyTimeoutId;
      let gameStopped, hudInterval, startTime;
      let vacheFrequency, nextVacheTime;
      let prioritaireFrequency, nextPrioritaireTime;
      let lateDifficultyDeadline, prioritaireActive;
      const minVacheFrequency = 12000; // 12 secondes minimum pour rester jouable
      const vacheStep = 1000; // diminution de 1 seconde à chaque passage
      const lateDifficultyDelay = 180000; // 3 minutes
      const prioritaireInitialFrequency = 16000;
      const prioritaireMinFrequency = 6000;
      const prioritaireStep = 1000;

      const messagesSuppression = [
        "Supprimé : signal défectueux entre Thionville et Luxembourg.",
        "Supprimé : travaux imprévus sur la voie à Metz.",
        "Supprimé : passage à niveau bloqué par un tracteur rebelle.",
        "Supprimé : intempéries, pluie diluvienne sur la ligne.",
        "Supprimé : incident voyageur à la gare de Nancy.",
        "Supprimé : panne électrique dans le tunnel de Bettembourg.",
        "Supprimé : circulation perturbée par un arbre tombé.",
        "Supprimé : problème technique au niveau du matériel roulant.",
        "Supprimé : intervention d’urgence sur la caténaire.",
        "Supprimé : personnel malade, service réduit.",
        "Supprimé : contrôle aléatoire des billets ralenti le départ.",
        "Supprimé : le sable du Sahara obstrue la voie.",
        "Supprimé : dérangement lié aux opérations de déneigement.",
        "Supprimé : problème de coordination transfrontalière.",
        "Supprimé : retard lié à un incident dans le spa du train.",
        "Supprimé : fuite de fonte en fusion à PAM.",
        "Supprimé : l'agent de conduite a une urgence explosive.",
        "Supprimé : le TGV avec Thibault, Franck et David était prioritaire."
      ];

         const instructionsDetails = document.getElementById('instructions');

      function resizeCanvas() {
        const containerEl = document.getElementById('container');
        const topSection = document.getElementById('topSection');
        const touchControls = document.getElementById('touchControls');

        const containerStyles = containerEl ? window.getComputedStyle(containerEl) : null;
        const safeParse = (value) => {
          const parsed = parseFloat(value);
          return Number.isFinite(parsed) ? parsed : 0;
        };
        const paddingTop = containerStyles ? safeParse(containerStyles.paddingTop) : 0;
        const paddingBottom = containerStyles ? safeParse(containerStyles.paddingBottom) : 0;
        const rawGap = containerStyles ? safeParse(containerStyles.rowGap || containerStyles.gap) : 0;
        const gap = rawGap * 2;

        const topHeight = topSection ? topSection.getBoundingClientRect().height : 0;
        const instructionsHeight = instructionsDetails ? instructionsDetails.getBoundingClientRect().height : 0;
        const controlsHeight = window.innerWidth <= 900 && touchControls
          ? touchControls.getBoundingClientRect().height + 24
          : 0;

        const reservedSpace = topHeight + instructionsHeight + paddingTop + paddingBottom + gap + controlsHeight;
        const maxWidth = Math.min(window.innerWidth * 0.92, 520);
        const availableHeight = window.innerHeight - reservedSpace;
        const idealMin = window.innerWidth <= 480 ? 180 : 220;
        let size;

        if (availableHeight > 0) {
          size = Math.min(maxWidth, availableHeight);
          if (availableHeight >= idealMin) {
            size = Math.max(size, Math.min(idealMin, maxWidth));
          }
        } else {
          size = Math.min(maxWidth, idealMin);
        }

        size = Math.floor(Math.max(size, 150));
        
        canvas.width = canvas.height = size;
        canvas.style.width = `${size}px`;
        canvas.style.height = `${size}px`;
        gridSize = size / 20;
        cols = rows = 20;
      }

       function handleResize() {
        if (instructionsDetails) {
          const compact = window.innerWidth <= 720 || window.innerHeight <= 760;
          if (compact) {
            if (instructionsDetails.dataset.autoCollapsed !== 'false') {
              instructionsDetails.removeAttribute('open');
              instructionsDetails.dataset.autoCollapsed = 'true';
            }
          } else {
            instructionsDetails.setAttribute('open', '');
          }
        }
        resizeCanvas();
      }

      if (instructionsDetails) {
        if (window.innerWidth <= 720 || window.innerHeight <= 760) {
          instructionsDetails.removeAttribute('open');
          instructionsDetails.dataset.autoCollapsed = 'true';
        }
        instructionsDetails.addEventListener('toggle', () => {
          instructionsDetails.dataset.autoCollapsed = 'false';
          setTimeout(resizeCanvas, 60);
        });
      }

      window.addEventListener('resize', handleResize);
      handleResize();
      
      function initGame() {
        train = [{ x: 10, y: 10 }];
        direction = { x: 1, y: 0 };
        nextDirection = direction;
        score = 0;
        suppressions = [];
        oranges = [];
        vaches = [];
        prioritaires = [];
        betail = null;
        vacheFrequency = 30000; // première vache après 30 s
        nextVacheTime = null;
        prioritaireFrequency = prioritaireInitialFrequency;
        nextPrioritaireTime = null;
        lateDifficultyDeadline = Date.now() + lateDifficultyDelay;
        prioritaireActive = false;
        gameStopped = false;
        speedModifier = 0;

        scoreEl.textContent = score;
        cowTimerEl.textContent = '--';
        priorityTimerEl.textContent = formatTime(Math.floor(lateDifficultyDelay / 1000));
        document.getElementById('gameOverMessage').style.display = 'none';
        document.getElementById('overlay').style.display = 'none';

        if (scheduleVachesTimeoutId) clearTimeout(scheduleVachesTimeoutId);
        if (schedulePrioritaireTimeoutId) clearTimeout(schedulePrioritaireTimeoutId);
        if (lateDifficultyTimeoutId) clearTimeout(lateDifficultyTimeoutId);
        if (hudInterval) clearInterval(hudInterval);

        scheduleNextVache();
        scheduleLateDifficulties();
        placePerturbations();
        generateBetail();
        gameLoop();

        startTime = Date.now();
        timerEl.textContent = '00:00';
        updateHud();
        hudInterval = setInterval(updateHud, 500);
      }

      function placePerturbations() {
        for (let i = 0; i < 10; i++) suppressions.push(randomFreePosition());
        for (let i = 0; i < 5; i++) oranges.push(randomFreePosition());
      }

      function randomFreePosition() {
        let pos;
        do {
          pos = { x: Math.floor(Math.random() * cols), y: Math.floor(Math.random() * rows) };
        } while (isOccupied(pos));
        return pos;
      }

      function isOccupied(pos) {
        return train.some(p => p.x === pos.x && p.y === pos.y)
          || suppressions.some(p => p.x === pos.x && p.y === pos.y)
          || oranges.some(p => p.x === pos.x && p.y === pos.y)
          || (betail && betail.x === pos.x && betail.y === pos.y)
          || vaches.some(band => band.some(p => p.x === pos.x && p.y === pos.y))
          || prioritaires.some(trainBloc => trainBloc.some(p => p.x === pos.x && p.y === pos.y));
      }

      function drawBackground() {
        ctx.fillStyle = '#040812';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = 'rgba(16, 242, 255, 0.08)';
        ctx.lineWidth = 1;
        for (let i = 0; i <= cols; i++) {
          ctx.beginPath();
          ctx.moveTo(i * gridSize, 0);
          ctx.lineTo(i * gridSize, canvas.height);
          ctx.stroke();
        }
        for (let j = 0; j <= rows; j++) {
          ctx.beginPath();
          ctx.moveTo(0, j * gridSize);
          ctx.lineTo(canvas.width, j * gridSize);
          ctx.stroke();
        }
      }

      function draw() {
        drawBackground();

        suppressions.forEach(p => {
          ctx.fillStyle = 'rgba(255, 65, 54, 0.95)';
          ctx.shadowColor = 'rgba(255, 65, 54, 0.6)';
          ctx.shadowBlur = 18;
          ctx.fillRect(p.x * gridSize + 1, p.y * gridSize + 1, gridSize - 2, gridSize - 2);
          ctx.shadowBlur = 0;
        });

        oranges.forEach(p => {
          ctx.fillStyle = 'rgba(255, 179, 0, 0.9)';
          ctx.shadowColor = 'rgba(255, 179, 0, 0.6)';
          ctx.shadowBlur = 12;
          ctx.fillRect(p.x * gridSize + 4, p.y * gridSize + 4, gridSize - 8, gridSize - 8);
          ctx.shadowBlur = 0;
        });

        if (betail) {
          ctx.fillStyle = '#ffee58';
          ctx.shadowColor = 'rgba(255, 238, 88, 0.6)';
          ctx.shadowBlur = 15;
          ctx.beginPath();
          ctx.arc(betail.x * gridSize + gridSize / 2, betail.y * gridSize + gridSize / 2, gridSize / 3, 0, 2 * Math.PI);
          ctx.fill();
          ctx.shadowBlur = 0;
        }

        vaches.forEach(band => {
          band.forEach(p => {
            ctx.fillStyle = '#f7f7f7';
            ctx.shadowColor = 'rgba(255, 255, 255, 0.6)';
            ctx.shadowBlur = 10;
            ctx.beginPath();
            ctx.arc(p.x * gridSize + gridSize / 2, p.y * gridSize + gridSize / 2, gridSize / 3, 0, 2 * Math.PI);
            ctx.fill();
            ctx.shadowBlur = 0;
          });
        });

        prioritaires.forEach(trainBloc => {
          trainBloc.forEach(p => {
            ctx.fillStyle = '#7c4dff';
            ctx.shadowColor = 'rgba(124, 77, 255, 0.6)';
            ctx.shadowBlur = 14;
            ctx.fillRect(p.x * gridSize + 1, p.y * gridSize + 1, gridSize - 2, gridSize - 2);
            ctx.shadowBlur = 0;
          });
        });

        train.forEach((pos, i) => {
          ctx.fillStyle = i === 0 ? '#10f2ff' : '#0a5d7a';
          ctx.shadowColor = 'rgba(16, 242, 255, 0.65)';
          ctx.shadowBlur = i === 0 ? 16 : 6;
          ctx.fillRect(pos.x * gridSize + 1, pos.y * gridSize + 1, gridSize - 2, gridSize - 2);
          ctx.shadowBlur = 0;
        });
      }

      function update() {
        if (gameStopped) return;

        direction = nextDirection;
        const newHead = { x: train[0].x + direction.x, y: train[0].y + direction.y };

        if (newHead.x < 0) newHead.x = cols - 1;
        if (newHead.x >= cols) newHead.x = 0;
        if (newHead.y < 0) newHead.y = rows - 1;
        if (newHead.y >= rows) newHead.y = 0;

        if (train.some(p => p.x === newHead.x && p.y === newHead.y)) return gameOver('Auto collision !');
        if (vaches.some(band => band.some(p => p.x === newHead.x && p.y === newHead.y))) return gameOver('Votre train a percuté des vaches !');
        if (prioritaires.some(trainBloc => trainBloc.some(p => p.x === newHead.x && p.y === newHead.y))) return gameOver('Collision avec un TGV prioritaire !');
        if (suppressions.some(p => p.x === newHead.x && p.y === newHead.y)) {
          const msg = messagesSuppression[Math.floor(Math.random() * messagesSuppression.length)];
          return gameOver(msg);
        }

        train.unshift(newHead);

        if (betail && newHead.x === betail.x && newHead.y === betail.y) {
          score++;
          scoreEl.textContent = score;
          if (score > highscore) {
            highscore = score;
            highscoreEl.textContent = highscore;
            localStorage.setItem('highscore', highscore);
          }
          generateBetail();
        } else {
          train.pop();
        }

        if (oranges.some(p => p.x === newHead.x && p.y === newHead.y)) {
          speedModifier = (Math.random() < 0.5) ? -150 : 150;
          setTimeout(() => { speedModifier = 0; }, 2000);
        }

        moveVaches();
        movePrioritaires();
      }

      function moveVaches() {
        vaches.forEach(band => band.forEach(v => v.x--));
        vaches = vaches.filter(band => band.some(v => v.x >= 0));
      }

      function movePrioritaires() {
        prioritaires.forEach(trainBloc => trainBloc.forEach(v => v.y++));
        prioritaires = prioritaires.filter(trainBloc => trainBloc.some(v => v.y < rows));
      }

      function scheduleNextVache() {
        if (gameStopped) return;
        nextVacheTime = Date.now() + vacheFrequency;
        scheduleVachesTimeoutId = setTimeout(() => {
          if (gameStopped) return;
          spawnVache();
          vacheFrequency = Math.max(minVacheFrequency, vacheFrequency - vacheStep);
          scheduleNextVache();
        }, vacheFrequency);
      }

      function scheduleLateDifficulties() {
        if (lateDifficultyTimeoutId) clearTimeout(lateDifficultyTimeoutId);
        lateDifficultyTimeoutId = setTimeout(() => {
          if (gameStopped) return;
          lateDifficultyDeadline = null;
          prioritaireActive = true;
          scheduleNextPrioritaire();
        }, lateDifficultyDelay);
      }

      function spawnVache() {
        const size = Math.floor(Math.random() * 4) + 1;
        const maxStart = Math.max(0, rows - size);
        const yStart = Math.floor(Math.random() * (maxStart + 1));
        const band = Array.from({ length: size }, (_, i) => ({ x: cols - 1, y: yStart + i }));
        vaches.push(band);
      }

      function scheduleNextPrioritaire() {
        if (gameStopped) return;
        nextPrioritaireTime = Date.now() + prioritaireFrequency;
        schedulePrioritaireTimeoutId = setTimeout(() => {
          if (gameStopped) return;
          spawnPrioritaire();
          prioritaireFrequency = Math.max(prioritaireMinFrequency, prioritaireFrequency - prioritaireStep);
          scheduleNextPrioritaire();
        }, prioritaireFrequency);
      }

      function spawnPrioritaire() {
        const width = Math.floor(Math.random() * 3) + 1;
        const maxStart = Math.max(0, cols - width);
        const xStart = Math.floor(Math.random() * (maxStart + 1));
        const bloc = Array.from({ length: width }, (_, i) => ({ x: xStart + i, y: 0 }));
        prioritaires.push(bloc);
      }

      function gameOver(message) {
        gameStopped = true;
        clearInterval(hudInterval);
        clearTimeout(scheduleVachesTimeoutId);
        clearTimeout(schedulePrioritaireTimeoutId);
        clearTimeout(lateDifficultyTimeoutId);
        nextVacheTime = null;
        nextPrioritaireTime = null;
        prioritaireActive = false;
        lateDifficultyDeadline = null;
        updateHud();

        const elapsedTime = Math.floor((Date.now() - startTime) / 1000);
        const minutes = Math.floor(elapsedTime / 60).toString().padStart(2, '0');
        const seconds = (elapsedTime % 60).toString().padStart(2, '0');
        const textHTML = `<p>${message}</p><p>Score : ${score}</p><p>Temps : ${minutes}:${seconds}</p>`;
        document.getElementById('gameOverText').innerHTML = textHTML;
        document.getElementById('overlay').style.display = 'flex';
        document.getElementById('gameOverMessage').style.display = 'block';
      }

      function gameLoop() {
        update();
        draw();
        if (!gameStopped) setTimeout(gameLoop, Math.max(50, baseSpeed + speedModifier));
      }

      function generateBetail() {
        betail = randomFreePosition();
      }

      function formatTime(totalSeconds) {
        const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
        const seconds = (totalSeconds % 60).toString().padStart(2, '0');
        return `${minutes}:${seconds}`;
      }

      function updateHud() {
        if (gameStopped && !startTime) return;
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        timerEl.textContent = formatTime(elapsed);

        if (nextVacheTime) {
          const remaining = Math.max(0, Math.ceil((nextVacheTime - Date.now()) / 1000));
          cowTimerEl.textContent = remaining >= 60 ? formatTime(remaining) : `${remaining.toString().padStart(2, '0')}s`;
        } else {
          cowTimerEl.textContent = '--';
        }

        if (prioritaireActive) {
          if (nextPrioritaireTime) {
            const remaining = Math.max(0, Math.ceil((nextPrioritaireTime - Date.now()) / 1000));
            priorityTimerEl.textContent = remaining >= 60 ? formatTime(remaining) : `${remaining.toString().padStart(2, '0')}s`;
          } else {
            priorityTimerEl.textContent = '--';
          }
        } else if (lateDifficultyDeadline) {
          const remaining = Math.max(0, Math.ceil((lateDifficultyDeadline - Date.now()) / 1000));
          priorityTimerEl.textContent = formatTime(remaining);
        } else {
          priorityTimerEl.textContent = '--';
        }
      }

      window.addEventListener('keydown', e => {
        if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
          e.preventDefault();
          handleDirection(e.key);
        }
      });

      const controlBindings = {
        up: 'ArrowUp',
        down: 'ArrowDown',
        left: 'ArrowLeft',
        right: 'ArrowRight'
      };

      Object.entries(controlBindings).forEach(([id, key]) => {
        const button = document.getElementById(id);
        const trigger = () => handleDirection(key);
        button.addEventListener('click', trigger);
        button.addEventListener('touchstart', event => {
          event.preventDefault();
          trigger();
        }, { passive: false });
      });

      document.getElementById('touchControls').addEventListener('touchmove', event => {
        event.preventDefault();
      }, { passive: false });                              
    
      function handleDirection(key) {
         if (gameStopped) return;
        switch (key) {
          case 'ArrowUp': if (direction.y !== 1) nextDirection = { x: 0, y: -1 }; break;
          case 'ArrowDown': if (direction.y !== -1) nextDirection = { x: 0, y: 1 }; break;
          case 'ArrowLeft': if (direction.x !== 1) nextDirection = { x: -1, y: 0 }; break;
          case 'ArrowRight': if (direction.x !== -1) nextDirection = { x: 1, y: 0 }; break;
        }
      }

      document.getElementById('restartBtn').addEventListener('click', () => initGame());
      document.getElementById('returnBtn').addEventListener('click', () => {
        window.location.href = 'index.html';  
      });

      if (localStorage.getItem('highscore')) {
        highscore = parseInt(localStorage.getItem('highscore'), 10) || 0;
        highscoreEl.textContent = highscore;
      }
      const startOverlay = document.getElementById('startOverlay');
      document.getElementById('startBtn').addEventListener('click', () => {
        startOverlay.style.display = 'none';
        initGame();
        if (music.paused) music.play();
      });

      document.addEventListener('DOMContentLoaded', () => {
        document.body.addEventListener('click', () => {
          if (music.paused) music.play();
        }, { once: true });
      });

      musicToggle.addEventListener('click', () => {
        if (music.paused) {
          music.play();
          musicToggle.textContent = '🔊';
        } else {
          music.pause();
          musicToggle.textContent = '🔈';
        }
      });
    })();
  </script>
</body>
</html>
