<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>La B√©taill√®re Express ‚Ä¢ BERNancyMetzLux</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Rajdhani:wght@400;600&display=swap');

    :root {
      --neon-cyan: #10f2ff;
      --neon-blue: #2c71ff;
      --dark: #020410;
      --panel: rgba(10, 18, 38, 0.8);
      --text: #e6f7ff;
      --accent: #ffeb3b;
    }

    * {
      box-sizing: border-box;
    }


    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      min-height: 100vh;
      background: radial-gradient(circle at top, #071021 0%, #010106 55%, #000 100%);
      color: var(--text);
      font-family: 'Rajdhani', 'Orbitron', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      text-align: center;
      overflow: hidden;
      overscroll-behavior: none;
      touch-action: none;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: url('data:image/svg+xml,%3Csvg width="120" height="120" xmlns="http://www.w3.org/2000/svg"%3E%3Ccircle cx="2" cy="2" r="1" fill="%230ff" opacity="0.2"/%3E%3C/svg%3E');
      mix-blend-mode: screen;
      opacity: 0.4;
      pointer-events: none;
      animation: drift 18s linear infinite;
    }

    @keyframes drift {
      from { transform: translateY(0); }
      to { transform: translateY(-120px); }
    }

    #container {
      width: min(100vw, 640px);
      max-width: 100vw;      
      height: 100vh;
      padding: clamp(12px, 3vw, 20px) clamp(14px, 4vw, 28px);
      background: linear-gradient(160deg, rgba(5, 12, 26, 0.92), rgba(0, 0, 0, 0.82));
      border: 2px solid rgba(16, 242, 255, 0.35);
      border-radius: 22px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.45), 0 0 35px rgba(16, 242, 255, 0.18);
      backdrop-filter: blur(10px);
      display: grid;
      grid-template-rows: auto minmax(0, 1fr) auto;
      align-items: stretch;
      justify-items: center;
      row-gap: clamp(8px, 2vh, 16px);
    }

    #hudBar {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
     gap: 10px;
    }

    .hud-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    
        .titleBlock {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 2px;
    }

    h1 {
      font-family: 'Orbitron', sans-serif;
      text-transform: uppercase;
      font-size: clamp(1.8rem, 5vw, 2.6rem);
      letter-spacing: 2px;
      margin-bottom: 6px;
      color: var(--neon-cyan);
      text-shadow: 0 0 18px rgba(16, 242, 255, 0.7);
    }

   .tagline {
      margin: 0;
      font-size: 0.85rem;
      letter-spacing: 1.2px;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.55);  
    }

   .hud-buttons {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .ghost-btn {
      background: rgba(16, 242, 255, 0.12);
      border: 1px solid rgba(16, 242, 255, 0.45);
      border-radius: 10px;
      padding: 8px 14px;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--neon-cyan);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .ghost-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 18px rgba(16, 242, 255, 0.25);
    }

    .ghost-btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      box-shadow: none;
    }

    #musicToggle {
      width: 40px;
      height: 40px;
      background: rgba(16, 242, 255, 0.15);
      border: 1px solid rgba(16, 242, 255, 0.45);
      border-radius: 50%;
      color: var(--neon-cyan);
      font-size: 1.1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 12px rgba(16, 242, 255, 0.18);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    #musicToggle:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 18px rgba(16, 242, 255, 0.3);
    }

    #hudMini {
      width: 100%;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
      gap: 10px;
    }

    .mini-panel {
      background: rgba(5, 12, 26, 0.72);
      border: 1px solid rgba(16, 242, 255, 0.22);
      border-radius: 12px;
      padding: 6px 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      box-shadow: inset 0 0 10px rgba(16, 242, 255, 0.1);
    }

    .mini-panel .label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: rgba(230, 247, 255, 0.6);
    }

    .mini-panel .value {
      font-size: 1.05rem;
      font-weight: 600;
      color: var(--accent);
      text-shadow: 0 0 6px rgba(255, 235, 59, 0.45);
    }
    #canvasWrap {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      border-radius: 18px;
      overflow: hidden;
      padding: clamp(4px, 1.5vw, 12px);
      box-shadow: 0 14px 45px rgba(0, 0, 0, 0.35);
      border: 1px solid rgba(16, 242, 255, 0.3);
      background: rgba(2, 4, 12, 0.95);
      min-height: 0;
    }

    canvas {
      display: block;
      max-width: 100%;
      max-height: 100%;
      width: 100%;
      height: auto;
      image-rendering: pixelated;
      background: transparent;
    }
    
    #briefingOverlay[aria-hidden="false"] {
      display: flex;
    }

    #briefingContent {
      width: min(92vw, 420px);
      background: linear-gradient(160deg, rgba(6, 10, 22, 0.96), rgba(0, 0, 0, 0.92));
      border: 1px solid rgba(16, 242, 255, 0.4);
      border-radius: 18px;
      padding: 24px 26px 20px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.55), 0 0 25px rgba(16, 242, 255, 0.25);
      text-align: left;
      line-height: 1.5;
      color: rgba(230, 247, 255, 0.82);
      position: relative;
    }

    #briefingContent h2 {
      margin-top: 0;
      font-size: 1.4rem;
      color: var(--accent);
      text-align: center;
    }

    #briefingContent ul {
      padding-left: 18px;
      margin: 16px 0 0;
      list-style: square;
    }

       #closeBriefing {
      position: absolute;
      top: 18px;
      right: 18px;
      background: rgba(16, 242, 255, 0.2);
      border: 1px solid rgba(16, 242, 255, 0.45);
      color: var(--neon-cyan);
      border-radius: 50%;
      width: 36px;
      height: 36px;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 10px rgba(16, 242, 255, 0.25);
    } 
    
    #touchControls {
      width: 100%;
      max-width: 420px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      padding: clamp(10px, 3vw, 16px) clamp(16px, 6vw, 24px);
      padding-bottom: calc(clamp(12px, 4vw, 18px) + env(safe-area-inset-bottom, 0px));
      border-radius: 18px;
      background: rgba(5, 12, 26, 0.82);
      border: 1px solid rgba(16, 242, 255, 0.2);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
    }
    
     #touchControls[aria-hidden="true"] {
      display: none;
    }   

    #touchControls button {
      width: 58px;
      height: 58px;
      font-size: 24px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.35);
      background: rgba(10, 14, 28, 0.88);
      color: #fff;
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.35);
      touch-action: manipulation;
    }

    .up-row, .middle-row {
      display: flex;
      gap: 10px;
    }

        .middle-row {
      justify-content: center;
    }

    #touchControls button:active {
      transform: translateY(2px);
    }

    #startOverlay, #overlay {
      position: fixed;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      background: rgba(0, 0, 0, 0.82);
      backdrop-filter: blur(6px);
      z-index: 1200;
    }

    #startOverlay { display: flex; }

    #startMessage, #gameOverMessage {
      background: linear-gradient(160deg, rgba(6, 10, 22, 0.96), rgba(0, 0, 0, 0.92));
      border: 1px solid rgba(16, 242, 255, 0.4);
      border-radius: 18px;
      padding: 26px 30px;
      width: min(88vw, 420px);
      text-align: center;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.55), 0 0 25px rgba(16, 242, 255, 0.25);
    }

    #startMessage h2 {
      margin: 0 0 12px;
      font-size: 1.5rem;
      color: var(--accent);
    }

    #startMessage p {
      margin: 0 0 16px;
      line-height: 1.5;
    }

    .cta-button {
      background: linear-gradient(120deg, rgba(16, 242, 255, 0.9), rgba(44, 113, 255, 0.9));
      border: none;
      color: #001828;
      font-weight: 700;
      font-size: 1.1rem;
      padding: 12px 26px;
      border-radius: 12px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .cta-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(16, 242, 255, 0.32);
    }

    #overlay {
      display: none;
    }

    #gameOverMessage {
      display: none;
    }

    #gameOverMessage p {
      margin: 8px 0;
    }

    #gameOverMessage button {
      font-size: 1rem;
      padding: 10px 20px;
      margin: 10px 8px 0 8px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      background: rgba(16, 242, 255, 0.85);
      color: #02121d;
      font-weight: 600;
      box-shadow: 0 6px 18px rgba(16, 242, 255, 0.3);
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }

    @media (max-width: 900px) {
      body {
        justify-content: flex-start;
      }
      
      #container {
        width: 100vw;
        border-radius: 0;
        padding: clamp(10px, 4vw, 18px) clamp(12px, 5vw, 20px) clamp(14px, 6vw, 24px);
        grid-template-rows: auto minmax(0, 1fr) auto;
      }

       .hud-top {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
        text-align: center;
      }
      
      .titleBlock {
        align-items: center;
      }

      .hud-buttons {
        justify-content: center;
        flex-wrap: wrap;
      }
  
      #touchControls button {
        width: 54px;
        height: 54px;
        font-size: 22px;
      }
    }

    @media (max-width: 720px) {
      #hudMini {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }
    
    @media (max-width: 600px) {
      h1 {
        font-size: clamp(1.4rem, 7vw, 1.9rem);
        text-align: center;
      }
      
      .tagline {
        font-size: 0.72rem;
      }

      .ghost-btn {
        padding: 7px 12px;
        font-size: 0.72rem;
      }

      #musicToggle {
        width: 34px;
        height: 34px;
        font-size: 0.95rem;
      }
      
      #hudMini {
        gap: 8px;
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }

      .mini-panel {
        padding: 6px 6px;
      }

      .mini-panel .label {
        font-size: 0.62rem;
      }
      
      .mini-panel .value {
        font-size: 0.95rem;
      }
    }

       @media (max-width: 420px) {
      #hudMini {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      #touchControls button {
        width: 52px;
        height: 52px;
        font-size: 20px;
      }
    } 

    @media (min-width: 901px) {
      body {
        justify-content: center;
      }

      #container {
        width: min(92vw, 640px);
        height: auto;
        border-radius: 22px;
        padding: clamp(20px, 3vw, 32px);
        grid-template-rows: auto minmax(0, 1fr);        
      }

      .hud-top {
        flex-direction: row;
        align-items: flex-end;
      }

      .titleBlock {
        align-items: flex-start;
        text-align: left;
      }
    }
  </style>
</head>
<body>
  
  <div id="startOverlay">
    <div id="startMessage">
      <h2>Bienvenue √† bord !</h2>
      <p>Le convoi BERNancyMetzLux doit atteindre son quota de b√™taill√®res sans croiser la moindre suppression. Collectez les wagons jaunes, √©vitez les carr√©s rouges et m√©fiez-vous des vaches qui envahissent la voie.</p>
      <p>Apr√®s 3 minutes, un TGV prioritaire transfrontalier d√©boule verticalement : gardez une voie de d√©gagement !</p>
      <p><strong>Commandes :</strong> fl√®ches du clavier ou pav√© tactile. Bon voyage conducteur !</p>
      <button id="startBtn" class="cta-button">Embarquer</button>
    </div>
  </div>

  <div id="container">
    <header id="hudBar">
      <div class="hud-top">
        <div class="titleBlock">
          <h1>La B√©taill√®re Express</h1>
          <p class="tagline">BERNancyMetzLux Connection</p>
        </div>
        <div class="hud-buttons">
          <button id="briefingBtn" class="ghost-btn" type="button">Briefing</button>
          <button id="pauseBtn" class="ghost-btn" type="button" disabled>Pause</button>
          <button id="musicToggle" type="button" aria-label="Activer ou couper la musique" title="Activer ou couper la musique">üîä</button>
        </div>
      </div>
      <section id="hudMini" aria-live="polite">
        <div class="mini-panel">
          <span class="label">Score</span>
          <span id="score" class="value">0</span>
        </div>
        <div class="mini-panel">
          <span class="label">Record</span>
          <span id="highscore" class="value">0</span>
        </div>
        <div class="mini-panel">
          <span class="label">Temps</span>
          <span id="timer" class="value">00:00</span>
        </div>
        <div class="mini-panel">
          <span class="label">Vaches</span>
          <span id="cowTimer" class="value">--</span>
        </div>
        <div class="mini-panel">
          <span class="label">TGV prioritaire</span>
          <span id="priorityTimer" class="value">03:00</span>
        </div>
      </section>
    </header>
    
    <div id="canvasWrap">
      <canvas id="gameCanvas" width="400" height="400"></canvas>
    </div>
  <div id="touchControls" aria-hidden="true">
      <div class="up-row">
        <button id="up">‚ñ≤</button>
      </div>
      <div class="middle-row">
        <button id="left">‚óÄ</button>
        <button id="down">‚ñº</button>
        <button id="right">‚ñ∂</button>
      </div>
    </div>
  </div>
    
  <div id="overlay">
    <div id="gameOverMessage">
      <div id="gameOverText"></div>
      <button id="restartBtn">Rejouer</button>
      <button id="returnBtn">Retour</button>
    </div>
  </div>

    <div id="briefingOverlay" aria-hidden="true" role="dialog" aria-modal="true">
    <div id="briefingContent">
      <button id="closeBriefing" type="button" aria-label="Fermer le briefing">√ó</button>
      <h2>Briefing conducteur</h2>
      <ul>
        <li><strong>BER</strong> pour Bettembourg, <strong>Nancy</strong>, <strong>Metz</strong> et <strong>Lux</strong> : restez align√© sur la ligne internationale.</li>
        <li>Collectez les wagons jaunes pour allonger votre convoi et faire vibrer la r√©gion.</li>
        <li>Les carr√©s rouges annoncent une suppression imm√©diate de votre circulation.</li>
        <li>Les carr√©s oranges acc√©l√®rent ou ralentissent temporairement votre rame.</li>
        <li>Les vaches arrivent d'abord apr√®s 30 s puis de plus en plus vite : gardez la voie libre !</li>
        <li>Apr√®s 3 minutes, des TGV prioritaires coupent la ligne du haut vers le bas et acc√©l√®rent progressivement.</li>
      </ul>
    </div>
  </div>

 <audio id="gameMusic" loop>
    <source src="https://raw.githubusercontent.com/TekMaTe-lux/Assistant-train/main/Tek'Ma'Te%20-%20Power%20of%20the%20SNCF%20jingle.mp3" type="audio/mpeg">
    Votre navigateur ne supporte pas l‚Äôaudio.
  </audio>

  <script>
    (() => {
      const canvas = document.getElementById('gameCanvas');
      const canvasWrap = document.getElementById('canvasWrap');
      const ctx = canvas.getContext('2d');
      const scoreEl = document.getElementById('score');
      const highscoreEl = document.getElementById('highscore');
      const timerEl = document.getElementById('timer');
      const cowTimerEl = document.getElementById('cowTimer');
      const priorityTimerEl = document.getElementById('priorityTimer');
      const music = document.getElementById('gameMusic');
      const musicToggle = document.getElementById('musicToggle');
      const pauseBtn = document.getElementById('pauseBtn');
      const briefingBtn = document.getElementById('briefingBtn');
      const briefingOverlay = document.getElementById('briefingOverlay');
      const closeBriefing = document.getElementById('closeBriefing');
      const touchControls = document.getElementById('touchControls');

      let gridSize = 20, cols, rows;
      let train, direction, nextDirection, score, highscore = 0;
      const baseSpeed = 200;
      let speedModifier = 0;
      let betail, suppressions, oranges, vaches, prioritaires;
      let scheduleVachesTimeoutId, schedulePrioritaireTimeoutId, lateDifficultyTimeoutId, loopTimeoutId;
      let gameStopped, hudInterval, startTime;
      let vacheFrequency, nextVacheTime;
      let prioritaireFrequency, nextPrioritaireTime;
      let lateDifficultyDeadline, prioritaireActive;
      let paused = false, pauseTimestamp = 0;
      let pausedVacheRemaining = null, pausedPrioritaireRemaining = null, pausedLateRemaining = null;
      let resumeAfterBriefing = false;
      const minVacheFrequency = 9000; // 9 secondes minimum pour rester jouable
      const vacheStep = 1000; // diminution de 1 seconde √† chaque passage
      const lateDifficultyDelay = 120000; // 2 minutes
      const prioritaireInitialFrequency = 16000;
      const prioritaireMinFrequency = 6000;
      const prioritaireStep = 1000;

      const messagesSuppression = [
        "Supprim√© : signal d√©fectueux entre Thionville et Luxembourg.",
        "Supprim√© : travaux impr√©vus sur la voie √† Metz.",
        "Supprim√© : passage √† niveau bloqu√© par un tracteur rebelle.",
        "Supprim√© : intemp√©ries, pluie diluvienne sur la ligne.",
        "Supprim√© : incident voyageur √† la gare de Nancy.",
        "Supprim√© : panne √©lectrique dans le tunnel de Bettembourg.",
        "Supprim√© : circulation perturb√©e par un arbre tomb√©.",
        "Supprim√© : probl√®me technique au niveau du mat√©riel roulant.",
        "Supprim√© : intervention d‚Äôurgence sur la cat√©naire.",
        "Supprim√© : personnel malade, service r√©duit.",
        "Supprim√© : contr√¥le al√©atoire des billets ralenti le d√©part.",
        "Supprim√© : le sable du Sahara obstrue la voie.",
        "Supprim√© : d√©rangement li√© aux op√©rations de d√©neigement.",
        "Supprim√© : probl√®me de coordination transfrontali√®re.",
        "Supprim√© : retard li√© √† un incident dans le spa du train.",
        "Supprim√© : fuite de fonte en fusion √† PAM.",
        "Supprim√© : l'agent de conduite a une urgence explosive.",
        "Supprim√© : le TGV avec Thibault, Franck et David √©tait prioritaire."
      ];

      function resizeCanvas() {
       const wrapRect = canvasWrap ? canvasWrap.getBoundingClientRect() : null;
        const rawLimit = wrapRect ? Math.floor(Math.min(wrapRect.width, wrapRect.height)) : 0;
        const fallbackLimit = Math.floor(Math.min(window.innerWidth, window.innerHeight));
        const maxAvailable = rawLimit > 0 ? rawLimit : fallbackLimit;
        const widthCap = window.innerWidth > 900 && maxAvailable > 0
          ? Math.min(maxAvailable, 560)
          : maxAvailable;
        let candidate = widthCap > 0 ? widthCap : 320;
        const minPlayable = 200;
        let finalSize = Math.floor(candidate / 20) * 20;

        if (rawLimit > 0) {
          const rawMultiple = Math.floor(rawLimit / 20) * 20;
          if (rawMultiple > 0) {
            finalSize = Math.min(finalSize, rawMultiple);
          } else {
            finalSize = Math.min(finalSize, rawLimit);
          }     
        }

        if (rawLimit >= minPlayable && finalSize < minPlayable) {
          finalSize = Math.floor(minPlayable / 20) * 20;
        }

        if (!Number.isFinite(finalSize) || finalSize <= 0) {
          finalSize = 200;        
        }

        canvas.width = canvas.height = finalSize;
        canvas.style.width = `${finalSize}px`;
        canvas.style.height = `${finalSize}px`;
        gridSize = finalSize / 20;        
        cols = rows = 20;
      }
      
      function updateTouchControlsVisibility() {
        if (!touchControls) return;
        const showTouch = window.innerWidth <= 900;
        touchControls.setAttribute('aria-hidden', showTouch ? 'false' : 'true');
      }
      
       function handleResize() {
        updateTouchControlsVisibility();         
        resizeCanvas();
      }

      window.addEventListener('resize', handleResize);
      handleResize();
      
      function initGame() {
        train = [{ x: 10, y: 10 }];
        direction = { x: 1, y: 0 };
        nextDirection = direction;
        score = 0;
        suppressions = [];
        oranges = [];
        vaches = [];
        prioritaires = [];
        betail = null;
        vacheFrequency = 30000; // premi√®re vache apr√®s 30 s
        nextVacheTime = null;
        prioritaireFrequency = prioritaireInitialFrequency;
        nextPrioritaireTime = null;
        lateDifficultyDeadline = Date.now() + lateDifficultyDelay;
        prioritaireActive = false;
        gameStopped = false;
        speedModifier = 0;

        paused = false;
        resumeAfterBriefing = false;
        pauseTimestamp = 0;
        pausedVacheRemaining = null;
        pausedPrioritaireRemaining = null;
        pausedLateRemaining = null;
        if (pauseBtn) {
          pauseBtn.textContent = 'Pause';
          pauseBtn.dataset.state = 'playing';
          pauseBtn.disabled = false;
        }

        if (briefingOverlay) {
          briefingOverlay.setAttribute('aria-hidden', 'true');
        }

        if (loopTimeoutId) clearTimeout(loopTimeoutId);
        loopTimeoutId = null;
   
        scoreEl.textContent = score;
        cowTimerEl.textContent = '--';
        priorityTimerEl.textContent = formatTime(Math.floor(lateDifficultyDelay / 1000));
        document.getElementById('gameOverMessage').style.display = 'none';
        document.getElementById('overlay').style.display = 'none';

        if (scheduleVachesTimeoutId) clearTimeout(scheduleVachesTimeoutId);
        if (schedulePrioritaireTimeoutId) clearTimeout(schedulePrioritaireTimeoutId);
        if (lateDifficultyTimeoutId) clearTimeout(lateDifficultyTimeoutId);
        if (hudInterval) clearInterval(hudInterval);

        hudInterval = null;    
        
        placePerturbations();
        generateBetail();

        startTime = Date.now();
        timerEl.textContent = '00:00';
        updateHud();
        hudInterval = setInterval(updateHud, 500);

        scheduleNextVache();
        scheduleLateDifficulties();
        gameLoop();
      }

      function placePerturbations() {
        for (let i = 0; i < 10; i++) suppressions.push(randomFreePosition());
        for (let i = 0; i < 5; i++) oranges.push(randomFreePosition());
      }

      function randomFreePosition() {
        let pos;
        do {
          pos = { x: Math.floor(Math.random() * cols), y: Math.floor(Math.random() * rows) };
        } while (isOccupied(pos));
        return pos;
      }

      function isOccupied(pos) {
        return train.some(p => p.x === pos.x && p.y === pos.y)
          || suppressions.some(p => p.x === pos.x && p.y === pos.y)
          || oranges.some(p => p.x === pos.x && p.y === pos.y)
          || (betail && betail.x === pos.x && betail.y === pos.y)
          || vaches.some(band => band.some(p => p.x === pos.x && p.y === pos.y))
          || prioritaires.some(trainBloc => trainBloc.some(p => p.x === pos.x && p.y === pos.y));
      }

      function drawBackground() {
        ctx.fillStyle = '#040812';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = 'rgba(16, 242, 255, 0.08)';
        ctx.lineWidth = 1;
        for (let i = 0; i <= cols; i++) {
          ctx.beginPath();
          ctx.moveTo(i * gridSize, 0);
          ctx.lineTo(i * gridSize, canvas.height);
          ctx.stroke();
        }
        for (let j = 0; j <= rows; j++) {
          ctx.beginPath();
          ctx.moveTo(0, j * gridSize);
          ctx.lineTo(canvas.width, j * gridSize);
          ctx.stroke();
        }
      }

      function draw() {
        drawBackground();

        suppressions.forEach(p => {
          ctx.fillStyle = 'rgba(255, 65, 54, 0.95)';
          ctx.shadowColor = 'rgba(255, 65, 54, 0.6)';
          ctx.shadowBlur = 18;
          ctx.fillRect(p.x * gridSize + 1, p.y * gridSize + 1, gridSize - 2, gridSize - 2);
          ctx.shadowBlur = 0;
        });

        oranges.forEach(p => {
          ctx.fillStyle = 'rgba(255, 179, 0, 0.9)';
          ctx.shadowColor = 'rgba(255, 179, 0, 0.6)';
          ctx.shadowBlur = 12;
          ctx.fillRect(p.x * gridSize + 4, p.y * gridSize + 4, gridSize - 8, gridSize - 8);
          ctx.shadowBlur = 0;
        });

        if (betail) {
          ctx.fillStyle = '#ffee58';
          ctx.shadowColor = 'rgba(255, 238, 88, 0.6)';
          ctx.shadowBlur = 15;
          ctx.beginPath();
          ctx.arc(betail.x * gridSize + gridSize / 2, betail.y * gridSize + gridSize / 2, gridSize / 3, 0, 2 * Math.PI);
          ctx.fill();
          ctx.shadowBlur = 0;
        }

        vaches.forEach(band => {
          band.forEach(p => {
            ctx.fillStyle = '#f7f7f7';
            ctx.shadowColor = 'rgba(255, 255, 255, 0.6)';
            ctx.shadowBlur = 10;
            ctx.beginPath();
            ctx.arc(p.x * gridSize + gridSize / 2, p.y * gridSize + gridSize / 2, gridSize / 3, 0, 2 * Math.PI);
            ctx.fill();
            ctx.shadowBlur = 0;
          });
        });

        prioritaires.forEach(trainBloc => {
          trainBloc.forEach(p => {
            ctx.fillStyle = '#7c4dff';
            ctx.shadowColor = 'rgba(124, 77, 255, 0.6)';
            ctx.shadowBlur = 14;
            ctx.fillRect(p.x * gridSize + 1, p.y * gridSize + 1, gridSize - 2, gridSize - 2);
            ctx.shadowBlur = 0;
          });
        });

        train.forEach((pos, i) => {
          ctx.fillStyle = i === 0 ? '#10f2ff' : '#0a5d7a';
          ctx.shadowColor = 'rgba(16, 242, 255, 0.65)';
          ctx.shadowBlur = i === 0 ? 16 : 6;
          ctx.fillRect(pos.x * gridSize + 1, pos.y * gridSize + 1, gridSize - 2, gridSize - 2);
          ctx.shadowBlur = 0;
        });
      }

      function update() {
        if (gameStopped || paused) return;

        direction = nextDirection;
        const newHead = { x: train[0].x + direction.x, y: train[0].y + direction.y };

        if (newHead.x < 0) newHead.x = cols - 1;
        if (newHead.x >= cols) newHead.x = 0;
        if (newHead.y < 0) newHead.y = rows - 1;
        if (newHead.y >= rows) newHead.y = 0;

        if (train.some(p => p.x === newHead.x && p.y === newHead.y)) return gameOver('Auto collision !');
        if (vaches.some(band => band.some(p => p.x === newHead.x && p.y === newHead.y))) return gameOver('Votre train a percut√© des vaches !');
        if (prioritaires.some(trainBloc => trainBloc.some(p => p.x === newHead.x && p.y === newHead.y))) return gameOver('Collision avec un TGV prioritaire !');
        if (suppressions.some(p => p.x === newHead.x && p.y === newHead.y)) {
          const msg = messagesSuppression[Math.floor(Math.random() * messagesSuppression.length)];
          return gameOver(msg);
        }

        train.unshift(newHead);

        if (betail && newHead.x === betail.x && newHead.y === betail.y) {
          score++;
          scoreEl.textContent = score;
          if (score > highscore) {
            highscore = score;
            highscoreEl.textContent = highscore;
            localStorage.setItem('highscore', highscore);
          }
          generateBetail();
        } else {
          train.pop();
        }

        if (oranges.some(p => p.x === newHead.x && p.y === newHead.y)) {
          speedModifier = (Math.random() < 0.5) ? -150 : 150;
          setTimeout(() => { speedModifier = 0; }, 2000);
        }

        moveVaches();
        movePrioritaires();
      }

      function moveVaches() {
        vaches.forEach(band => band.forEach(v => v.x--));
        vaches = vaches.filter(band => band.some(v => v.x >= 0));
      }

      function movePrioritaires() {
        prioritaires.forEach(trainBloc => trainBloc.forEach(v => v.y++));
        prioritaires = prioritaires.filter(trainBloc => trainBloc.some(v => v.y < rows));
      }

      function scheduleNextVache(delay) {
        if (gameStopped) return;
        const interval = typeof delay === 'number' ? Math.max(0, delay) : vacheFrequency;
        nextVacheTime = Date.now() + interval;
        scheduleVachesTimeoutId = setTimeout(() => {
        if (gameStopped || paused) return;
          spawnVache();
          vacheFrequency = Math.max(minVacheFrequency, vacheFrequency - vacheStep);
          scheduleNextVache();
     }, interval);
      }

      function scheduleLateDifficulties(delay) {
         if (gameStopped) return;
        if (lateDifficultyTimeoutId) clearTimeout(lateDifficultyTimeoutId);
         const interval = typeof delay === 'number' ? Math.max(0, delay) : lateDifficultyDelay;
        lateDifficultyDeadline = Date.now() + interval;       
        lateDifficultyTimeoutId = setTimeout(() => {
         if (gameStopped || paused) return;
          lateDifficultyDeadline = null;
          prioritaireActive = true;
          scheduleNextPrioritaire();
        }, interval);
      }

      function spawnVache() {
        const size = Math.floor(Math.random() * 4) + 1;
        const maxStart = Math.max(0, rows - size);
        const yStart = Math.floor(Math.random() * (maxStart + 1));
        const band = Array.from({ length: size }, (_, i) => ({ x: cols - 1, y: yStart + i }));
        vaches.push(band);
      }

      function scheduleNextPrioritaire(delay) {
        if (gameStopped) return;
        const interval = typeof delay === 'number' ? Math.max(0, delay) : prioritaireFrequency;
        nextPrioritaireTime = Date.now() + interval;
        schedulePrioritaireTimeoutId = setTimeout(() => {
        if (gameStopped || paused) return;
          spawnPrioritaire();
          prioritaireFrequency = Math.max(prioritaireMinFrequency, prioritaireFrequency - prioritaireStep);
          scheduleNextPrioritaire();
        }, interval);
      }

      function setPaused(shouldPause) {
        if (gameStopped) return;

        if (shouldPause) {
          if (paused) return;
          paused = true;
          pauseTimestamp = Date.now();
          if (pauseBtn) {
            pauseBtn.textContent = 'Reprendre';
            pauseBtn.dataset.state = 'paused';
          }
          if (loopTimeoutId) {
            clearTimeout(loopTimeoutId);
            loopTimeoutId = null;
          }
          if (hudInterval) {
            clearInterval(hudInterval);
            hudInterval = null;
          }
          if (scheduleVachesTimeoutId && nextVacheTime) {
            pausedVacheRemaining = Math.max(0, nextVacheTime - Date.now());
            clearTimeout(scheduleVachesTimeoutId);
            scheduleVachesTimeoutId = null;
          } else {
            pausedVacheRemaining = null;
          }
          if (schedulePrioritaireTimeoutId && nextPrioritaireTime) {
            pausedPrioritaireRemaining = Math.max(0, nextPrioritaireTime - Date.now());
            clearTimeout(schedulePrioritaireTimeoutId);
            schedulePrioritaireTimeoutId = null;
          } else {
            pausedPrioritaireRemaining = null;
          }
          if (lateDifficultyTimeoutId && lateDifficultyDeadline) {
            pausedLateRemaining = Math.max(0, lateDifficultyDeadline - Date.now());
            clearTimeout(lateDifficultyTimeoutId);
            lateDifficultyTimeoutId = null;
          } else {
            pausedLateRemaining = null;
          }
          return;
        }

        if (!paused) return;
        paused = false;
        const pausedDuration = Date.now() - pauseTimestamp;
        pauseTimestamp = 0;
        if (typeof startTime === 'number') {
          startTime += pausedDuration;
        }
        if (pauseBtn) {
          pauseBtn.textContent = 'Pause';
          pauseBtn.dataset.state = 'playing';
        }

        if (pausedVacheRemaining !== null) {
          scheduleNextVache(pausedVacheRemaining);
          pausedVacheRemaining = null;
        } else if (!scheduleVachesTimeoutId && nextVacheTime) {
          const remaining = Math.max(0, nextVacheTime - Date.now());
          scheduleNextVache(remaining);
        }

        if (prioritaireActive) {
          if (pausedPrioritaireRemaining !== null) {
            scheduleNextPrioritaire(pausedPrioritaireRemaining);
            pausedPrioritaireRemaining = null;
          } else if (!schedulePrioritaireTimeoutId && nextPrioritaireTime) {
            const remaining = Math.max(0, nextPrioritaireTime - Date.now());
            scheduleNextPrioritaire(remaining);
          }
          pausedLateRemaining = null;
        } else {
          if (pausedLateRemaining !== null) {
            scheduleLateDifficulties(pausedLateRemaining);
            pausedLateRemaining = null;
          } else if (lateDifficultyDeadline) {
            const remaining = Math.max(0, lateDifficultyDeadline - Date.now());
            scheduleLateDifficulties(remaining);
          }
        }

        if (!hudInterval) {
          hudInterval = setInterval(updateHud, 500);
        }
        updateHud();
        gameLoop();
      }

      function togglePause() {
        setPaused(!paused);
      }

      function openBriefing() {
        if (!briefingOverlay) return;
        const isHidden = briefingOverlay.getAttribute('aria-hidden') !== 'false';
        if (!isHidden) return;
        briefingOverlay.setAttribute('aria-hidden', 'false');
        const canAutoPause = !gameStopped && typeof startTime === 'number' && !(pauseBtn && pauseBtn.disabled);
        if (canAutoPause && !paused) {
          resumeAfterBriefing = true;
          setPaused(true);
        } else {
          resumeAfterBriefing = false;
        }
      }

      function closeBriefingOverlay() {
        if (!briefingOverlay) return;
        if (briefingOverlay.getAttribute('aria-hidden') === 'true') return;
        briefingOverlay.setAttribute('aria-hidden', 'true');
        if (resumeAfterBriefing && !gameStopped) {
          resumeAfterBriefing = false;
          setPaused(false);
        } else {
          resumeAfterBriefing = false;
        }
      }

      function spawnPrioritaire() {
        const width = Math.floor(Math.random() * 3) + 1;
        const maxStart = Math.max(0, cols - width);
        const xStart = Math.floor(Math.random() * (maxStart + 1));
        const bloc = Array.from({ length: width }, (_, i) => ({ x: xStart + i, y: 0 }));
        prioritaires.push(bloc);
      }

      function gameOver(message) {
        gameStopped = true;
        clearInterval(hudInterval);
        hudInterval = null;        
        clearTimeout(scheduleVachesTimeoutId);
        clearTimeout(schedulePrioritaireTimeoutId);
        clearTimeout(lateDifficultyTimeoutId);
        scheduleVachesTimeoutId = null;
        schedulePrioritaireTimeoutId = null;
        lateDifficultyTimeoutId = null;
        if (loopTimeoutId) {
          clearTimeout(loopTimeoutId);
          loopTimeoutId = null;
        }        
        nextVacheTime = null;
        nextPrioritaireTime = null;
        prioritaireActive = false;
        lateDifficultyDeadline = null;
        paused = false;
        pauseTimestamp = 0;
        pausedVacheRemaining = null;
        pausedPrioritaireRemaining = null;
        pausedLateRemaining = null;
        resumeAfterBriefing = false;
        if (pauseBtn) {
          pauseBtn.textContent = 'Pause';
          pauseBtn.dataset.state = 'playing';
          pauseBtn.disabled = true;
        }
        if (briefingOverlay) {
          briefingOverlay.setAttribute('aria-hidden', 'true');
        }       
        updateHud();

        const elapsedTime = Math.floor((Date.now() - startTime) / 1000);
        const minutes = Math.floor(elapsedTime / 60).toString().padStart(2, '0');
        const seconds = (elapsedTime % 60).toString().padStart(2, '0');
        const textHTML = `<p>${message}</p><p>Score : ${score}</p><p>Temps : ${minutes}:${seconds}</p>`;
        document.getElementById('gameOverText').innerHTML = textHTML;
        document.getElementById('overlay').style.display = 'flex';
        document.getElementById('gameOverMessage').style.display = 'block';
      }

      function gameLoop() {
          if (gameStopped || paused) return;      
        update();
        draw();
        loopTimeoutId = setTimeout(gameLoop, Math.max(50, baseSpeed + speedModifier));
      }

      function generateBetail() {
        betail = randomFreePosition();
      }

      function formatTime(totalSeconds) {
        const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
        const seconds = (totalSeconds % 60).toString().padStart(2, '0');
        return `${minutes}:${seconds}`;
      }

      function updateHud() {
        if (gameStopped && !startTime) return;
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        timerEl.textContent = formatTime(elapsed);

        if (nextVacheTime) {
          const remaining = Math.max(0, Math.ceil((nextVacheTime - Date.now()) / 1000));
          cowTimerEl.textContent = remaining >= 60 ? formatTime(remaining) : `${remaining.toString().padStart(2, '0')}s`;
        } else {
          cowTimerEl.textContent = '--';
        }

        if (prioritaireActive) {
          if (nextPrioritaireTime) {
            const remaining = Math.max(0, Math.ceil((nextPrioritaireTime - Date.now()) / 1000));
            priorityTimerEl.textContent = remaining >= 60 ? formatTime(remaining) : `${remaining.toString().padStart(2, '0')}s`;
          } else {
            priorityTimerEl.textContent = '--';
          }
        } else if (lateDifficultyDeadline) {
          const remaining = Math.max(0, Math.ceil((lateDifficultyDeadline - Date.now()) / 1000));
          priorityTimerEl.textContent = formatTime(remaining);
        } else {
          priorityTimerEl.textContent = '--';
        }
      }

      if (pauseBtn) {
        pauseBtn.addEventListener('click', () => {
          if (pauseBtn.disabled || gameStopped) return;
          resumeAfterBriefing = false;
          togglePause();
        });
      }

      if (briefingBtn) {
        briefingBtn.addEventListener('click', () => {
          if (!briefingOverlay) return;
          if (briefingOverlay.getAttribute('aria-hidden') === 'false') {
            closeBriefingOverlay();
          } else {
            openBriefing();
          }
        });
      }

      if (closeBriefing) {
        closeBriefing.addEventListener('click', closeBriefingOverlay);
      }

      if (briefingOverlay) {
        briefingOverlay.addEventListener('click', event => {
          if (event.target === briefingOverlay) closeBriefingOverlay();
        });
      }

      document.addEventListener('keydown', event => {
        if (event.key === 'Escape' && briefingOverlay && briefingOverlay.getAttribute('aria-hidden') === 'false') {
          event.preventDefault();
          closeBriefingOverlay();
        }
      });
     
      window.addEventListener('keydown', e => {
        if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
          e.preventDefault();
          handleDirection(e.key);
        }
      });

      const controlBindings = {
        up: 'ArrowUp',
        down: 'ArrowDown',
        left: 'ArrowLeft',
        right: 'ArrowRight'
      };

      Object.entries(controlBindings).forEach(([id, key]) => {
        const button = document.getElementById(id);
        const trigger = () => handleDirection(key);
        button.addEventListener('click', trigger);
        button.addEventListener('touchstart', event => {
          event.preventDefault();
          trigger();
        }, { passive: false });
      });

       if (touchControls) {
        touchControls.addEventListener('touchmove', event => {
          event.preventDefault();
        }, { passive: false });
      }     
    
      function handleDirection(key) {
        if (gameStopped || paused) return;
        switch (key) {
          case 'ArrowUp': if (direction.y !== 1) nextDirection = { x: 0, y: -1 }; break;
          case 'ArrowDown': if (direction.y !== -1) nextDirection = { x: 0, y: 1 }; break;
          case 'ArrowLeft': if (direction.x !== 1) nextDirection = { x: -1, y: 0 }; break;
          case 'ArrowRight': if (direction.x !== -1) nextDirection = { x: 1, y: 0 }; break;
        }
      }

      document.getElementById('restartBtn').addEventListener('click', () => initGame());
      document.getElementById('returnBtn').addEventListener('click', () => {
        window.location.href = 'index.html';  
      });

      if (localStorage.getItem('highscore')) {
        highscore = parseInt(localStorage.getItem('highscore'), 10) || 0;
        highscoreEl.textContent = highscore;
      }
      const startOverlay = document.getElementById('startOverlay');
      document.getElementById('startBtn').addEventListener('click', () => {
        startOverlay.style.display = 'none';
        initGame();
        if (music.paused) music.play();
      });

      document.addEventListener('DOMContentLoaded', () => {
        document.body.addEventListener('click', () => {
          if (music.paused) music.play();
        }, { once: true });
      });

      musicToggle.addEventListener('click', () => {
        if (music.paused) {
          music.play();
          musicToggle.textContent = 'üîä';
        } else {
          music.pause();
          musicToggle.textContent = 'üîà';
        }
      });
    })();
  </script>
</body>
</html>
