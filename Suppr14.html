<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Informations Train SNCF - Horaires D√©part</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #f9f9f9;
      color: #222;
      margin: 0;
      padding: 20px;
      max-width: 720px;
      margin-left: auto;
      margin-right: auto;
    }
    h1 {
      text-align: center;
      color: #0055a5;
      margin-bottom: 1rem;
    }
    .input-container {
      background-color: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 85, 165, 0.1);
      margin-bottom: 30px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }
    .input-group {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 300px;
    }
    label {
      font-weight: 600;
      margin-bottom: 4px;
      color: #004080;
    }
    input[type="text"], input[type="date"] {
      width: 100%;
      padding: 10px 12px;
      border: 1.5px solid #ccc;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    input[type="text"]:focus, input[type="date"]:focus {
      border-color: #0077cc;
      outline: none;
    }
    button {
      margin-top: 8px;
      background-color: #0077cc;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 1.1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s;
      box-shadow: 0 4px 8px rgb(0 119 204 / 0.4);
    }
    button:hover {
      background-color: #005999;
      box-shadow: 0 6px 14px rgb(0 89 153 / 0.6);
    }
    #trainInfo {
      margin-top: 30px;
      background: white;
      border-radius: 12px;
      padding: 25px 20px;
      box-shadow: 0 6px 20px rgb(0 0 0 / 0.12);
    }
    .status-summary {
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      color: #ff6600;
    }
    .status-summary.red {
      color: #cc0000;
    }
    .status-icon {
      font-size: 24px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 1rem;
    }
    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }
    th {
      background-color: #f0f7ff;
      color: #004080;
      font-weight: 700;
    }
    tbody tr:hover {
      background-color: #f9faff;
    }
    .deleted {
      color: #cc0000;
      text-decoration: line-through;
      font-weight: 600;
      opacity: 0.75;
    }
    .delayed {
      color: #ff6600;
      font-weight: 600;
    }
    .delay-strike {
      color: #999;
      text-decoration: line-through;
    }
    .new-start, .new-end {
      color: #0055cc;
      font-weight: 700;
    }
    .origin, .terminus {
      font-weight: 800;
      color: #003366;
    }
    @media (max-width: 480px) {
      table, thead, tbody, th, td, tr {
        display: block;
      }
      th {
        position: absolute;
        top: -9999px;
        left: -9999px;
      }
      tr {
        margin-bottom: 1.2rem;
        border-bottom: 1px solid #ccc;
      }
      td {
        border: none;
        padding-left: 50%;
        position: relative;
      }
      td::before {
        position: absolute;
        top: 10px;
        left: 12px;
        width: 45%;
        padding-right: 10px;
        white-space: nowrap;
        font-weight: 700;
        color: #004080;
      }
      td:nth-of-type(1)::before { content: "Gare"; }
      td:nth-of-type(2)::before { content: "Horaire normal"; }
      td:nth-of-type(3)::before { content: "Horaire modifi√©"; }
      td:nth-of-type(4)::before { content: "Retard"; }
      td:nth-of-type(5)::before { content: "Statut"; }
    }
  </style>
</head>
<body>
<h1>Informations sur votre b√©taill√®re</h1>

<div class="input-container">
  <div class="input-group">
    <label for="trainNumber">Num√©ro de votre B√©taill√®re :</label>
    <input type="text" id="trainNumber" value="88534" />
  </div>
  <div class="input-group">
    <label for="trainDate">Date (YYYY-MM-DD) :</label>
    <input type="date" id="trainDate" />
  </div>
  <button id="getTrainData">Obtenir les donn√©es</button>
</div>

<div id="trainInfo"></div>

<script>
$(document).ready(function () {
  $('#getTrainData').click(function () {
    const trainNumber = $('#trainNumber').val().trim();
    const trainDate = $('#trainDate').val();
    if (!trainNumber || !trainDate) {
      $('#trainInfo').html('<p class="deleted">Veuillez entrer un num√©ro et une date valides.</p>');
      return;
    }

    $('#trainInfo').html('<p>Chargement des donn√©es...</p>');

    const apiKey = '242fac11-6d98-45fb-93df-28174d362447';
    const encodedApiKey = btoa(apiKey + ":");
    const url = `https://api.sncf.com/v1/coverage/sncf/vehicle_journeys/vehicle_journey:SNCF:${trainDate}:${trainNumber}:1187:Train`;

    $.ajax({
      url: url,
      method: 'GET',
      headers: { 'Authorization': 'Basic ' + encodedApiKey },
      success: function (response) {
        if (!response.vehicle_journeys?.length) {
          $('#trainInfo').html('<p class="deleted">Aucun train trouv√© avec ce num√©ro et cette date.</p>');
          return;
        }

        const train = response.vehicle_journeys[0];
        const disruptions = response.disruptions || [];
        let impactedStopsMap = {};
        const effect = disruptions[0]?.severity?.effect || null;
        if (disruptions.length > 0) {
          disruptions[0].impacted_objects?.forEach(obj => {
            obj.impacted_stops?.forEach(stop => {
              impactedStopsMap[stop.stop_point.id] = stop;
            });
          });
        }

        const stops = train.stop_times;
        const originStopId = stops[0]?.stop_point?.id;
        const finalStopId = stops[stops.length - 1]?.stop_point?.id;

        // D√©tecter la premi√®re et la derni√®re gare NON supprim√©e
        let firstRealDepartureIndex = -1;
        let lastRealArrivalIndex = -1;
        stops.forEach((stop, i) => {
          const impact = impactedStopsMap[stop.stop_point.id];
          const notDeleted = !impact || impact.stop_time_effect !== "deleted";
          if (notDeleted && firstRealDepartureIndex === -1) firstRealDepartureIndex = i;
          if (notDeleted) lastRealArrivalIndex = i;
        });

        function formatTime(t) {
          return t ? t.slice(0,2) + ':' + t.slice(2,4) : '-';
        }

        function computeDelay(base, amended) {
          const b = parseInt(base.slice(0,2)) * 60 + parseInt(base.slice(2,4));
          const a = parseInt(amended.slice(0,2)) * 60 + parseInt(amended.slice(2,4));
          return a - b;
        }

        // Statut g√©n√©ral + ic√¥ne + couleur
        const icons = {
          NO_SERVICE: '‚ùå',
          REDUCED_SERVICE: '‚ö†Ô∏è',
          SIGNIFICANT_DELAYS: '‚è∞'
        };
        const colors = {
          NO_SERVICE: 'red',
          REDUCED_SERVICE: 'orange',
          SIGNIFICANT_DELAYS: 'orange'
        };
        const effectText = {
          NO_SERVICE: 'Suppression totale',
          REDUCED_SERVICE: 'Service r√©duit',
          SIGNIFICANT_DELAYS: 'Retard important'
        };

        // R√©sum√© statut
        const disruptionBox = effect ? `
          <div class="status-summary ${colors[effect]}">
            <div class="status-icon">${icons[effect] || '‚ÑπÔ∏è'}</div>
            <div><strong>Statut g√©n√©ral :</strong> ${effectText[effect] || effect}</div>
          </div>` : '';

        // Cause
        const cause = disruptions[0]?.messages?.[0]?.text || 'Non pr√©cis√©e';

        // Construction tableau
        const rowsHtml = stops.map((stop, i) => {
          const id = stop.stop_point.id;
          const name = stop.stop_point.name;
          const impact = impactedStopsMap[id];
          const isDeleted = impact?.stop_time_effect === "deleted";

          // Heures normales et modifi√©es
          let baseTime = '';
          let amendedTime = '';
          let delay = null;
          let statusText = '';
          let rowClass = '';

          // Choix horaire affich√©
          if (i === 0) {
            baseTime = stop.departure_time;
            amendedTime = impact?.amended_departure_time;
          } else {
            baseTime = stop.arrival_time;
            amendedTime = impact?.amended_arrival_time;
          }

          if (!baseTime) baseTime = '-';

          if (isDeleted) {
            statusText = 'Suppression';
            rowClass = 'deleted';
          } else if (amendedTime && amendedTime !== baseTime) {
            delay = computeDelay(baseTime, amendedTime);
            if (delay > 0) {
              statusText = `Retard +${delay} min`;
              rowClass = 'delayed';
            }
          } else {
            statusText = '√Ä l\'heure';
          }

          // D√©tection gare origine et terminus r√©elle
          let nameDisplay = name;
          if (i === firstRealDepartureIndex) {
            nameDisplay = `<span class="origin">${name} (D√©part)</span>`;
          }
          if (i === lastRealArrivalIndex) {
            nameDisplay = `<span class="terminus">${name} (Terminus)</span>`;
          }

          // Si nouvelle gare de d√©part/terminus
          if (i === 0 && firstRealDepartureIndex > 0) {
            nameDisplay += ` <span class="new-start" title="Nouvelle gare de d√©part">üõ§Ô∏è</span>`;
          }
          if (i === stops.length - 1 && lastRealArrivalIndex < stops.length - 1) {
            nameDisplay += ` <span class="new-end" title="Nouveau terminus">üèÅ</span>`;
          }

          return `<tr class="${rowClass}">
            <td>${nameDisplay}</td>
            <td>${i === 0 ? formatTime(baseTime) : '-'}</td>
            <td>${formatTime(amendedTime)}</td>
            <td>${delay !== null ? delay + ' min' : '-'}</td>
            <td>${statusText}</td>
          </tr>`;
        }).join('');

        const finalHtml = `
          ${disruptionBox}
          <p><strong>Cause :</strong> ${cause}</p>
          <table>
            <thead>
              <tr>
                <th>Gare</th>
                <th>Horaire normal</th>
                <th>Horaire modifi√©</th>
                <th>Retard</th>
                <th>Statut</th>
              </tr>
            </thead>
            <tbody>
              ${rowsHtml}
            </tbody>
          </table>`;

        $('#trainInfo').html(finalHtml);

      },
      error: function () {
        $('#trainInfo').html('<p class="deleted">Erreur lors de la r√©cup√©ration des donn√©es.</p>');
      }
    });
  });
});
</script>

</body>
</html>
