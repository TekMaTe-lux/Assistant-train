<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bétaillère SNCF - Horaires & perturbations</title>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style>
    body { font-family: Arial, sans-serif; max-width: 720px; margin: 20px auto; background: #fafafa; }
    h1 { text-align: center; color: #004080; }
    label, input, button { font-size: 1rem; }
    input, button { padding: 8px; margin: 5px 0; border-radius: 6px; border: 1px solid #ccc; }
    button { background-color: #0077cc; color: white; border: none; cursor: pointer; }
    button:hover { background-color: #005a99; }
    #trainInfo { background: white; padding: 20px; border-radius: 10px; margin-top: 20px; box-shadow: 0 0 8px #aaa; }
    p { margin: 6px 0; }
    .delay { color: orange; font-weight: bold; }
    .deleted { color: red; font-weight: bold; text-decoration: line-through; }
    .new-start { color: blue; font-weight: bold; }
    .new-end { color: blue; font-weight: bold; }
</style>
</head>
<body>

<h1>Informations Bétaillère SNCF</h1>

<label for="trainNumber">Numéro Bétaillère :</label><br/>
<input type="text" id="trainNumber" value="88534" /><br/>

<label for="trainDate">Date :</label><br/>
<input type="date" id="trainDate" /><br/>

<button id="getTrainData">Afficher les infos</button>

<div id="trainInfo"></div>

<script>
$(function() {
    // Remplit automatiquement la date aujourd'hui au format YYYY-MM-DD
    let today = new Date().toISOString().slice(0,10);
    $('#trainDate').val(today);

    $('#getTrainData').click(function() {
        let trainNumber = $('#trainNumber').val().trim();
        let trainDate = $('#trainDate').val();

        if (!trainNumber) {
            $('#trainInfo').html('<p class="deleted">Merci de saisir un numéro de bétaillère.</p>');
            return;
        }
        if (!trainDate) {
            $('#trainInfo').html('<p class="deleted">Merci de choisir une date valide.</p>');
            return;
        }

        $('#trainInfo').html('<p>Chargement des données...</p>');

        const apiKey = '242fac11-6d98-45fb-93df-28174d362447';
        const encodedKey = btoa(apiKey + ':');
        const url = `https://api.sncf.com/v1/coverage/sncf/vehicle_journeys/vehicle_journey:SNCF:${trainDate}:${trainNumber}:1187:Train`;

        $.ajax({
            url: url,
            method: 'GET',
            headers: {
                'Authorization': 'Basic ' + encodedKey
            },
            success: function(data) {
                if(!data.vehicle_journeys || data.vehicle_journeys.length === 0) {
                    $('#trainInfo').html('<p class="deleted">Aucun train trouvé pour ce numéro et cette date.</p>');
                    return;
                }
                let train = data.vehicle_journeys[0];
                let stops = train.stop_times;

                // Préparation des perturbations par stop_point id
                let impactedStops = {};
                if (data.disruptions && data.disruptions.length > 0) {
                    data.disruptions.forEach(disruption => {
                        disruption.impacted_objects.forEach(obj => {
                            if(obj.impacted_stops) {
                                obj.impacted_stops.forEach(s => {
                                    impactedStops[s.stop_point.id] = s;
                                });
                            }
                        });
                    });
                }

                let html = `<h2>Horaires pour la bétaillère n°${trainNumber} le ${trainDate}</h2>`;

                stops.forEach((stop, i) => {
                    let spId = stop.stop_point.id;
                    let name = stop.stop_point.name;
                    let dep = stop.departure_time ? stop.departure_time.substring(0,2) + ':' + stop.departure_time.substring(2,4) : '-';
                    let arr = stop.arrival_time ? stop.arrival_time.substring(0,2) + ':' + stop.arrival_time.substring(2,4) : '-';

                    let impact = impactedStops[spId];
                    let lineClass = '';
                    let note = '';

                    if (impact) {
                        // suppression arrêt
                        if (impact.stop_time_effect === 'deleted') {
                            lineClass = 'deleted';
                            note = ' (Suppression)';
                        } else {
                            // retard ou modification
                            if(impact.amended_departure_time && impact.amended_departure_time !== stop.departure_time) {
                                let depAmended = impact.amended_departure_time.substring(0,2) + ':' + impact.amended_departure_time.substring(2,4);
                                let delay = (parseInt(impact.amended_departure_time.substring(0,2)) * 60 + parseInt(impact.amended_departure_time.substring(2,4))) - (parseInt(stop.departure_time.substring(0,2)) * 60 + parseInt(stop.departure_time.substring(2,4)));
                                lineClass = 'delay';
                                note = ` (Départ retardé: ${depAmended} +${delay}min)`;
                                dep = depAmended;
                            }
                            if(impact.amended_arrival_time && impact.amended_arrival_time !== stop.arrival_time) {
                                let arrAmended = impact.amended_arrival_time.substring(0,2) + ':' + impact.amended_arrival_time.substring(2,4);
                                let delay = (parseInt(impact.amended_arrival_time.substring(0,2)) * 60 + parseInt(impact.amended_arrival_time.substring(2,4))) - (parseInt(stop.arrival_time.substring(0,2)) * 60 + parseInt(stop.arrival_time.substring(2,4)));
                                // pour simplifier on affiche l'arrivée modifiée en note
                                note += ` (Arrivée retardée: ${arrAmended} +${delay}min)`;
                                arr = arrAmended;
                            }
                        }
                    }

                    // Afficher horaires départ sauf à la dernière station
                    if(i === stops.length - 1) {
                        html += `<p class="${lineClass}">${name} - Arrivée: ${arr}${note}</p>`;
                    } else {
                        html += `<p class="${lineClass}">${name} - Départ: ${dep}${note}</p>`;
                    }
                });

                $('#trainInfo').html(html);
            },
            error: function() {
                $('#trainInfo').html('<p class="deleted">Erreur lors de la récupération des données.</p>');
            }
        });

    });
});
</script>

</body>
</html>
