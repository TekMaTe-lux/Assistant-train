<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Retards Bettembourg Gare</title>
  <style>
    body { font-family: Arial, sans-serif; }
    #sidebar {
      position: fixed;
      top: 0;
      right: 0;
      width: 280px;
      height: 100%;
      background: #111;
      color: #0f0;
      padding: 1rem;
      overflow-y: auto;
      box-shadow: -4px 0 8px rgba(0,0,0,0.8);
      font-size: 14px;
      z-index: 1000;
    }
    #sidebar h2 {
      margin-top: 0;
      border-bottom: 1px solid #0f0;
      padding-bottom: 0.5rem;
      font-size: 1.2rem;
    }
    .train {
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #0f0;
    }
    .on-time { color: #0f0; }
    .delayed { color: #ff3300; font-weight: bold; }
  </style>
</head>
<body>

<div id="sidebar">
  <h2>Retards – Bettembourg Gare</h2>
  <div id="list">Chargement…</div>
</div>

<script>
  const API_KEY = "58ef9a71-6837-4405-bd5d-23beaf92864c";
  const STATION_ID = "220102018";

  async function fetchAndShow() {
    const now = new Date();
    const date = now.toISOString().split("T")[0];
    const time = now.toTimeString().slice(0,8);

    const url = `https://cdt.hafas.de/opendata/apiserver/departureBoard?accessId=${API_KEY}&id=${STATION_ID}&date=${date}&time=${time}&duration=120&maxJourneys=50&format=json`;
    const res = await fetch(url);
    const data = await res.json();

    const container = document.getElementById("list");
    container.innerHTML = "";

    if (!data.Departure || data.Departure.length === 0) {
      container.textContent = "Aucun départ.";
      return;
    }

    data.Departure.forEach(dep => {
      const prod = dep.ProductAtStop?.name || "";
      if (!prod.startsWith("ICE") && !prod.startsWith("RE") && !prod.startsWith("RB") && !prod.startsWith("TER") && !prod.startsWith("IC")) {
        // ignore buses, etc.
        return;
      }

      const scheduled = dep.time;
      const real = dep.rtTime || scheduled;
      const diff = ((new Date(`${dep.date}T${real}`) - new Date(`${dep.date}T${scheduled}`)) / 60000) || 0;

      const elem = document.createElement("div");
      elem.className = "train";
      elem.innerHTML = `
        <div><b>${prod}</b> → ${dep.direction}</div>
        <div>Prévu : ${scheduled}</div>
        <div>Statut : <span class="${diff > 0 ? 'delayed' : 'on-time'}">
          ${diff > 0 ? `Retardé (+${diff} min)` : "À l'heure"}
        </span></div>
      `;
      container.appendChild(elem);
    });

    if (!container.innerHTML.trim()) {
      container.textContent = "Aucun train en retard détecté.";
    }
  }

  fetchAndShow();
  setInterval(fetchAndShow, 60000); // actualisation toutes les minutes
</script>

</body>
</html>
