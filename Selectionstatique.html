<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>S√©lecteur TER Nancy - Luxembourg corrig√© (GTFS pr√©par√©)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.css" />
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      max-width: 700px;
      margin: 2em auto;
      padding: 0 1em;
      background: #f9f9f9;
    }
    label {
      font-weight: bold;
      margin-top: 1em;
      display: block;
    }
    select, button, input[type="date"] {
      margin-top: 0.3em;
      padding: 6px 12px;
      font-size: 1rem;
      width: 100%;
      max-width: 320px;
      box-sizing: border-box;
    }
    #slider {
      margin: 30px 0;
    }
    .range-output {
      font-weight: bold;
      margin-top: 1em;
      font-size: 1.1rem;
    }
    #resultatsTrains {
      margin-top: 1.5em;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1em;
    }
    .carte-train {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgb(0 0 0 / 0.15);
      padding: 1em 1.2em;
      transition: box-shadow 0.3s ease, background-color 0.3s ease;
      cursor: pointer;
      user-select: none;
    }
    .carte-train:hover {
      box-shadow: 0 6px 12px rgb(0 0 0 / 0.3);
    }
    .carte-train.selected {
      background-color: #1a73e8;
      color: white;
      box-shadow: 0 6px 16px rgb(26 115 232 / 0.7);
    }
    .train-num {
      font-size: 1.4rem;
      font-weight: 700;
      color: inherit;
      margin-bottom: 0.4em;
    }
    .horaires {
      font-size: 1rem;
      color: inherit;
    }
    .horaires span {
      font-weight: 600;
    }
    #zoneSelection {
      margin-top: 2em;
      background: #e3e3e3;
      border-radius: 6px;
      padding: 1em;
    }
    #zoneSelection h3 {
      margin-top: 0;
    }
    #zoneSelection ul {
      list-style: none;
      padding-left: 0;
      display: flex;
      flex-wrap: wrap;
      gap: 0.7em;
    }
    #zoneSelection li {
      background: #1a73e8;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-weight: 600;
      cursor: default;
    }
    select option.principal {
      font-weight: 700;
    }
  </style>
</head>
<body>

  <h1>üöÜ S√©lecteur TER Nancy - Luxembourg corrig√© (GTFS pr√©par√©)</h1>

  <label for="gareDepart">Gare de d√©part :</label>
  <select id="gareDepart">
    <option value="">-- Choisissez --</option>
  </select>

  <label for="gareArrivee">Gare d‚Äôarriv√©e :</label>
  <select id="gareArrivee" disabled>
    <option value="">-- Choisissez --</option>
  </select>

  <label for="dateTrain">Date :</label>
  <input type="date" id="dateTrain" />

  <div id="slider"></div>
  <div class="range-output">
    Plage horaire : <span id="heure-selection">06:00 ‚Üí 11:00</span>
  </div>

  <button id="btnRechercher" disabled>üîç Rechercher</button>

  <h2>R√©sultats :</h2>
  <div id="resultatsTrains"></div>

  <div id="zoneSelection">
    <h3>Trains s√©lectionn√©s :</h3>
    <ul id="trainsSelectionnes"><li>Aucun train s√©lectionn√©</li></ul>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.js"></script>
  <script>
    // --- Variables globales ---
    let trains = [];         // Liste des trains construite dynamiquement
    let calendarDates = [];  // Calendrier des services (dates d‚Äôexception)

    // Liste statique des gares pour les selects (dans l'ordre Luxembourg->Nancy)
    const garesParLigne = [
      { code: "87190000", nom: "Luxembourg", principal: true },
      { code: "XXXX01", nom: "Howald", principal: false },
      { code: "XXXX02", nom: "Bettembourg", principal: true },
      { code: "XXXX03", nom: "Hettange-Grande", principal: false },
      { code: "87191163", nom: "Thionville", principal: true },
      { code: "XXXX04", nom: "Uckange", principal: false },
      { code: "XXXX05", nom: "Hagondange", principal: false },
      { code: "XXXX06", nom: "Maizi√®res-l√®s-Metz", principal: false },
      { code: "XXXX07", nom: "Woippy", principal: false },
      { code: "XXXX08", nom: "Metz Nord", principal: false },
      { code: "87192039", nom: "Metz", principal: true },
      { code: "XXXX09", nom: "Ars-sur-Moselle", principal: false },
      { code: "XXXX10", nom: "Nov√©ant-sur-Moselle", principal: false },
      { code: "XXXX11", nom: "Pagny-sur-Moselle", principal: false },
      { code: "XXXX12", nom: "Vandi√®res", principal: false },
      { code: "XXXX13", nom: "Pont-√†-Mousson", principal: false },
      { code: "XXXX14", nom: "Dieulouard", principal: false },
      { code: "XXXX15", nom: "Belleville", principal: false },
      { code: "XXXX16", nom: "Marbache", principal: false },
      { code: "XXXX17", nom: "Pompey", principal: false },
      { code: "XXXX18", nom: "Frouard", principal: false },
      { code: "87141002", nom: "Nancy", principal: true }
    ];

    const gareDepartEl = document.getElementById("gareDepart");
    const gareArriveeEl = document.getElementById("gareArrivee");
    const dateTrainEl = document.getElementById("dateTrain");
    const btnRechercher = document.getElementById("btnRechercher");
    const heureText = document.getElementById("heure-selection");
    const slider = document.getElementById("slider");
    const resultatsEl = document.getElementById("resultatsTrains");
    const trainsSelectionnesEl = document.getElementById("trainsSelectionnes");

    // --- Fonctions utilitaires pour parsing CSV GTFS ---
    async function chargerCsvGTFS(url) {
      return new Promise((resolve, reject) => {
        Papa.parse(url, {
          download: true,
          header: true,
          skipEmptyLines: true,
          complete: results => resolve(results.data),
          error: err => reject(err)
        });
      });
    }

    // --- Tri et remplissage des selects ---
    function trierGaresPourSelect(gares) {
      const principales = gares.filter(g => g.principal).sort((a,b) => a.nom.localeCompare(b.nom));
      const autres = gares.filter(g => !g.principal).sort((a,b) => a.nom.localeCompare(b.nom));
      return [...principales, ...autres];
    }

    function remplirSelectGares(selectEl, options = [], exclureCode = "") {
      const ancienneValeur = selectEl.value;
      selectEl.innerHTML = `<option value="">-- Choisissez --</option>`;
      options.forEach(({ code, nom, principal }) => {
        if (code === exclureCode) return;
        const opt = document.createElement("option");
        opt.value = code;
        opt.textContent = nom;
        if (principal) opt.classList.add("principal");
        selectEl.appendChild(opt);
      });
      if (ancienneValeur && ancienneValeur !== exclureCode) {
        selectEl.value = ancienneValeur;
      } else {
        selectEl.value = "";
      }
    }

    // --- Fonction pour construire la liste des trains √† partir des donn√©es GTFS ---
    function construireTrains(trips, stopTimes, stops) {
      const stopsMap = {};
      stops.forEach(s => stopsMap[s.stop_id] = s.stop_name);

      // Regrouper stop_times par trip_id
      const stopTimesParTrip = {};
      stopTimes.forEach(st => {
        if (!stopTimesParTrip[st.trip_id]) stopTimesParTrip[st.trip_id] = [];
        stopTimesParTrip[st.trip_id].push(st);
      });

      // Trier par stop_sequence
      for (const tripId in stopTimesParTrip) {
        stopTimesParTrip[tripId].sort((a,b) => parseInt(a.stop_sequence) - parseInt(b.stop_sequence));
      }

      // Construire tableau trains
      return trips.map(trip => {
        const stopsInfo = stopTimesParTrip[trip.trip_id];
        if (!stopsInfo) return null;
        const stopsCodes = stopsInfo.map(s => s.stop_id);
        const horaires = {};
        stopsInfo.forEach(s => {
          horaires[s.stop_id] = s.departure_time;
        });
        return {
          num: trip.trip_headsign || trip.trip_id,
          service_id: trip.service_id,
          trip_id: trip.trip_id,
          direction_id: trip.direction_id,
          stops: stopsCodes,
          horaires,
        };
      }).filter(t => t !== null);
    }

    // --- V√©rifier si service actif selon calendar_dates ---
    function estServiceActif(service_id, dateStr) {
      const dateCompare = dateStr.replace(/-/g, "");
      const exceptions = calendarDates.filter(e => e.service_id === service_id && e.date === dateCompare);
      if (exceptions.length === 0) return true;
      if (exceptions.some(e => e.exception_type === "1")) return true;
      if (exceptions.some(e => e.exception_type === "2")) return false;
      return true;
    }

    // --- Variables de s√©lection de trains ---
    const selectionTrains = new Set();

    // --- Rechercher les trains selon crit√®res ---
    function rechercherTrains() {
      const gareDepart = gareDepartEl.value;
      const gareArrivee = gareArriveeEl.value;
      const [min, max] = slider.noUiSlider.get().map(v => parseInt(v));
      const dateChoisie = dateTrainEl.value;

      const resultats = trains.filter(train => {
        const idxDepart = train.stops.indexOf(gareDepart);
        const idxArrivee = train.stops.indexOf(gareArrivee);
        if (idxDepart === -1 || idxArrivee === -1) return false;
        if (idxDepart >= idxArrivee) return false; // sens correct
        if (!estServiceActif(train.service_id, dateChoisie)) return false;

        const hDepart = train.horaires[gareDepart];
        if (!hDepart) return false;
        const [hH, hM] = hDepart.split(":").map(Number);
        const minutes = hH * 60 + hM;
        if (minutes < min || minutes > max) return false;

        return true;
      });

      afficherResultats(resultats);
    }

    // --- Affichage r√©sultats ---
    function afficherResultats(trains) {
      resultatsEl.innerHTML = "";
      if (trains.length === 0) {
        resultatsEl.innerHTML = "<p>Aucun train trouv√© pour cette recherche.</p>";
        return;
      }
      trains.forEach(train => {
        const div = document.createElement("div");
        div.className = "carte-train";
        if (selectionTrains.has(train.num)) div.classList.add("selected");
        div.innerHTML = `
          <div class="train-num">Train n¬∞${train.num}</div>
          <div class="horaires">
            <span>D√©part:</span> ${train.horaires[gareDepartEl.value]}<br/>
            <span>Arriv√©e:</span> ${train.horaires[gareArriveeEl.value]}
          </div>
        `;
        div.addEventListener("click", () => {
          if (selectionTrains.has(train.num)) {
            selectionTrains.delete(train.num);
            div.classList.remove("selected");
          } else {
            selectionTrains.add(train.num);
            div.classList.add("selected");
          }
          afficherSelection();
        });
        resultatsEl.appendChild(div);
      });
    }

    // --- Afficher s√©lection ---
    function afficherSelection() {
      trainsSelectionnesEl.innerHTML = "";
      if (selectionTrains.size === 0) {
        trainsSelectionnesEl.innerHTML = "<li>Aucun train s√©lectionn√©</li>";
        return;
      }
      selectionTrains.forEach(num => {
        const li = document.createElement("li");
        li.textContent = num;
        trainsSelectionnesEl.appendChild(li);
      });
    }

    // --- Gestion des selects ---
    function verifierBouton() {
      btnRechercher.disabled = !(gareDepartEl.value && gareArriveeEl.value && dateTrainEl.value);
    }

    gareDepartEl.addEventListener("change", () => {
      const departCode = gareDepartEl.value;
      if (!departCode) {
        gareArriveeEl.disabled = true;
        gareArriveeEl.innerHTML = `<option value="">-- Choisissez --</option>`;
      } else {
        gareArriveeEl.disabled = false;
        remplirSelectGares(gareArriveeEl, garesTriees, departCode);
      }
      verifierBouton();
    });

    gareArriveeEl.addEventListener("change", verifierBouton);
    dateTrainEl.addEventListener("change", verifierBouton);

    btnRechercher.addEventListener("click", () => {
      rechercherTrains();
    });

    // --- Slider noUiSlider ---
    noUiSlider.create(slider, {
      start: [360, 660], // 06:00 ‚Üí 11:00
      connect: true,
      step: 5,
      range: { min: 0, max: 1439 },
      format: {
        to: v => Math.round(v),
        from: v => Number(v)
      }
    });

    slider.noUiSlider.on("update", values => {
      const [min, max] = values.map(v => parseInt(v));
      heureText.textContent = `${formatTime(min)} ‚Üí ${formatTime(max)}`;
    });

    function formatTime(mins) {
      const h = String(Math.floor(mins / 60)).padStart(2, "0");
      const m = String(mins % 60).padStart(2, "0");
      return `${h}:${m}`;
    }

    // --- Initialisation ---

    const garesTriees = trierGaresPourSelect(garesParLigne);
    remplirSelectGares(gareDepartEl, garesTriees);
    gareArriveeEl.innerHTML = `<option value="">-- Choisissez --</option>`;
    gareArriveeEl.disabled = true;

    // Met la date √† aujourd'hui
    function setDateAujourdhui() {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      dateTrainEl.value = `${yyyy}-${mm}-${dd}`;
    }
    setDateAujourdhui();
    verifierBouton();

    // --- Chargement des fichiers GTFS ---
    async function chargerToutesDonneesGTFS() {
      try {
        const [trips, stops, stopTimes, calendar] = await Promise.all([
          chargerCsvGTFS("https://raw.githubusercontent.com/TekMaTe-lux/Assistant-train/main/data/trips.txt"),
          chargerCsvGTFS("https://raw.githubusercontent.com/TekMaTe-lux/Assistant-train/main/data/stops.txt"),
          chargerCsvGTFS("https://raw.githubusercontent.com/TekMaTe-lux/Assistant-train/main/data/stop_times.txt"),
          chargerCsvGTFS("https://raw.githubusercontent.com/TekMaTe-lux/Assistant-train/main/data/calendar_dates.txt"),
        ]);
        calendarDates = calendar;
        trains = construireTrains(trips, stopTimes, stops);
        console.log("Donn√©es GTFS charg√©es, trains construits :", trains.length);
      } catch (err) {
        console.error("Erreur chargement GTFS :", err);
      }
    }

    // D√©marre le chargement au lancement de la page
    chargerToutesDonneesGTFS();

  </script>

</body>
</html>
