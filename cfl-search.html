<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Recherche CFL (horaires directs)</title>
<style>
  :root {
    color-scheme: dark;
    --bg: #0b0f1a;
    --panel: #161b2b;
    --text: #e0f0ff;
    --accent: #4ade80;
    --accent-dim: #244a2f;
    --border: #2a324d;
    --muted: #94a3b8;
    --card: #1f253b;
    --radius: 12px;
    --radius-lg: 20px;
    --font: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }

  body {
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family:var(--font);
    display:flex;
    flex-direction:column;
    min-height:100vh;
  }

  header {
    background:linear-gradient(90deg,#1e263f 0%,#111726 60%);
    padding:16px 20px;
    border-bottom:1px solid var(--border);
  }
  header h1 {
    margin:0;
    font-size:1.1rem;
    font-weight:600;
    color:var(--text);
    line-height:1.3;
  }
  header p {
    margin:4px 0 0;
    font-size:0.8rem;
    color:var(--muted);
  }

  main {
    flex:1;
    display:grid;
    grid-template-columns:minmax(260px,320px) 1fr;
    gap:20px;
    padding:20px;
  }

  @media(max-width:800px){
    main { grid-template-columns:1fr; }
  }

  /* panneau recherche */
  .panel {
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:var(--radius-lg);
    padding:16px 16px 12px;
    box-shadow:0 30px 80px #0008;
  }
  .panel h2 {
    margin:0 0 12px;
    font-size:0.9rem;
    font-weight:600;
    color:var(--text);
    display:flex;
    align-items:center;
    gap:8px;
  }
  .panel h2 .dot {
    display:inline-block;
    width:8px;
    height:8px;
    border-radius:999px;
    background:var(--accent);
    box-shadow:0 0 12px var(--accent);
  }

  .field {
    display:flex;
    flex-direction:column;
    margin-bottom:12px;
  }
  .field label {
    font-size:0.75rem;
    color:var(--muted);
    margin-bottom:4px;
  }
  .field select,
  .field input[type="time"],
  .field input[type="date"] {
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:10px 12px;
    font-size:0.9rem;
    color:var(--text);
    outline:none;
  }
  .field select:focus,
  .field input:focus {
    border-color:var(--accent);
    box-shadow:0 0 8px var(--accent);
  }

  .actions {
    display:flex;
    justify-content:flex-end;
  }
  .btn {
    appearance:none;
    border:0;
    border-radius:var(--radius);
    padding:10px 14px;
    font-size:0.9rem;
    font-weight:600;
    cursor:pointer;
    line-height:1.2;
    color:var(--text);
    background:var(--accent-dim);
    border:1px solid var(--accent);
    box-shadow:0 16px 40px #000d;
  }
  .btn:hover {
    filter:brightness(1.15);
  }

  /* résultats */
  .results-panel {
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:var(--radius-lg);
    box-shadow:0 30px 80px #0008;
    display:flex;
    flex-direction:column;
    min-height:300px;
  }

  .results-header {
    padding:16px;
    border-bottom:1px solid var(--border);
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    flex-wrap:wrap;
    row-gap:8px;
  }
  .results-header-left {
    max-width:70%;
  }
  .results-header h3 {
    margin:0;
    font-size:0.9rem;
    font-weight:600;
    color:var(--text);
  }
  .results-header p {
    margin:4px 0 0;
    font-size:0.75rem;
    color:var(--muted);
    line-height:1.4;
  }
  .status-chip {
    background:#1e293b;
    border:1px solid var(--border);
    border-radius:999px;
    padding:4px 8px;
    font-size:0.7rem;
    color:var(--muted);
  }

  .results-body {
    padding:16px;
    flex:1;
  }

  .trip-card {
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:12px 14px;
    font-size:0.8rem;
    line-height:1.4;
    color:var(--text);
    box-shadow:0 20px 40px #000a;
    margin-bottom:12px;
  }
  .trip-mainline {
    font-size:0.9rem;
    font-weight:600;
    color:var(--text);
    display:flex;
    flex-wrap:wrap;
    gap:6px 10px;
    align-items:baseline;
  }
  .time-badge {
    background:#0004;
    border:1px solid var(--border);
    border-radius:8px;
    padding:2px 6px;
    font-weight:500;
    font-size:0.8rem;
    line-height:1.2;
  }
  .trip-subline {
    font-size:0.75rem;
    color:var(--muted);
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    margin-top:4px;
  }
  .trip-id-pill {
    background:#0000;
    border:1px solid var(--border);
    border-radius:999px;
    padding:2px 6px;
    font-size:0.7rem;
    font-weight:500;
    color:var(--muted);
  }

  .no-result {
    font-size:0.85rem;
    color:var(--muted);
    text-align:center;
    padding:40px 10px;
  }

  footer {
    text-align:center;
    padding:16px;
    font-size:0.7rem;
    color:var(--muted);
    border-top:1px solid var(--border);
    background:#0d1220;
  }
</style>
</head>
<body>

<header>
  <h1>Horaires CFL (beta)</h1>
  <p>Recherche de trains directs entre deux gares CFL, données GTFS statiques.</p>
</header>

<main>
  <!-- COLONNE GAUCHE = FORM -->
  <section class="panel">
    <h2><span class="dot"></span> Paramètres trajet</h2>

    <div class="field">
      <label for="fromStation">Gare de départ</label>
      <select id="fromStation"></select>
    </div>

    <div class="field">
      <label for="toStation">Gare d'arrivée</label>
      <select id="toStation"></select>
    </div>

    <div class="field">
      <label for="travelDate">Date du voyage</label>
      <input id="travelDate" type="date"/>
    </div>

    <div class="field">
      <label for="minTime">Heure minimale de départ</label>
      <input id="minTime" type="time" value="06:00"/>
    </div>

    <div class="actions">
      <button class="btn" id="searchBtn">Rechercher</button>
    </div>
  </section>

  <!-- COLONNE DROITE = RESULTATS -->
  <section class="results-panel">
    <div class="results-header">
      <div class="results-header-left">
        <h3>Prochains trains directs</h3>
        <p id="criteriaText">En attente de recherche...</p>
      </div>
      <div class="status-chip" id="dataStatus">Chargement données…</div>
    </div>

    <div class="results-body" id="resultsBody">
      <div class="no-result">Patientez, données CFL en cours de chargement…</div>
    </div>
  </section>
</main>

<footer>
  Données GTFS CFL — affichage beta. Pas (encore) de retards temps réel.
</footer>

<script>
// =========================
// 0. CONFIG
// =========================
const BASE_URL = '/CFL'; // adapter si besoin

// =========================
// 1. OUTILS
// =========================
function parseSimpleCsv(text) {
  // parse CSV sans guillemets imbriqués
  const lines = text.trim().split(/\r?\n/);
  const header = lines[0].split(',');
  const rows = [];
  for (let i=1;i<lines.length;i++) {
    const cols = lines[i].split(',');
    const obj = {};
    for (let c=0;c<header.length;c++) {
      obj[header[c]] = cols[c];
    }
    rows.push(obj);
  }
  return rows;
}

async function loadCsv(url) {
  const res = await fetch(url);
  if (!res.ok) {
    console.error('Erreur chargement', url, res.status);
    throw new Error('loadCsv failed '+url);
  }
  const text = await res.text();
  return parseSimpleCsv(text);
}

function timeToSec(t) {
  if (!t) return null;
  const parts = t.split(':');
  const H = parseInt(parts[0],10);
  const M = parseInt(parts[1],10);
  const S = parseInt(parts[2]||'0',10);
  return H*3600 + M*60 + S;
}
function secToTime(sec) {
  const H = Math.floor(sec/3600);
  const m = Math.floor((sec%3600)/60);
  const s = sec%60;
  const pad = n=>String(n).padStart(2,'0');
  return pad(H)+':'+pad(m)+':'+pad(s);
}

// =========================
// 2. DONNÉES GTFS EN MÉMOIRE
// =========================
let stopsCfl = [];          // {stop_id,stop_name,...}
let tripsCfl = [];          // {route_id,service_id,trip_id,...}
let calendarCfl = [];       // {service_id,monday,...,start_date,end_date}
let calendarDatesCfl = [];  // {service_id,date,exception_type}
const stopTimesByTrip = new Map(); // trip_id -> [ {stop_id,depSec,arrSec,dep,arr,seq} ]

let dataReady = false;

// =========================
// 3. CALENDRIER (roule aujourd'hui ?)
// =========================
function serviceRunsThatDay(service_id, dateObj) {
  const y = dateObj.getFullYear();
  const m = (dateObj.getMonth()+1).toString().padStart(2,'0');
  const d = dateObj.getDate().toString().padStart(2,'0');
  const dateStr = `${y}${m}${d}`;

  const weekday = dateObj.getDay(); // 0=dim,1=lun,...6=sam
  const cal = calendarCfl.find(c => c.service_id === service_id);
  let baseRuns = false;

  if (cal) {
    if (dateStr >= cal.start_date && dateStr <= cal.end_date) {
      const mapW = {
        0: cal.sunday,
        1: cal.monday,
        2: cal.tuesday,
        3: cal.wednesday,
        4: cal.thursday,
        5: cal.friday,
        6: cal.saturday
      };
      baseRuns = (mapW[weekday] === '1');
    }
  }

  // exceptions calendar_dates
  const exc = calendarDatesCfl.filter(e => e.service_id === service_id && e.date === dateStr);
  for (const e of exc) {
    if (e.exception_type === '1') baseRuns = true;  // ajouté
    if (e.exception_type === '2') baseRuns = false; // supprimé
  }

  return baseRuns;
}

// =========================
// 4. RECHERCHE TRAJETS DIRECTS
// =========================
function findDirectItineraries(fromStopId, toStopId, minSec, dayDate) {
  const results = [];

  for (const trip of tripsCfl) {
    if (!serviceRunsThatDay(trip.service_id, dayDate)) continue;

    const seqs = stopTimesByTrip.get(trip.trip_id);
    if (!seqs) continue;

    // cherche les 2 arrêts
    const depStop = seqs.find(s => s.stop_id === fromStopId);
    const arrStop = seqs.find(s => s.stop_id === toStopId);
    if (!depStop || !arrStop) continue;

    // bon ordre ?
    if (depStop.seq >= arrStop.seq) continue;

    // respect heure min ?
    if (depStop.depSec < minSec) continue;

    results.push({
      trip_id: trip.trip_id,
      depart_stop: fromStopId,
      arrive_stop: toStopId,
      depart_time: depStop.dep,
      arrive_time: arrStop.arr,
      depart_sec: depStop.depSec,
      arrive_sec: arrStop.arrSec
    });
  }

  // trier par heure de départ
  results.sort((a,b)=>a.depart_sec - b.depart_sec);
  return results;
}

// =========================
// 5. RENDU UI
// =========================
function renderResults(trips, fromStopId, toStopId, dayDate) {
  const wrap = document.getElementById('resultsBody');
  wrap.innerHTML = '';

  const fromName = stopNameById(fromStopId);
  const toName   = stopNameById(toStopId);

  if (!trips.length) {
    wrap.innerHTML = `<div class="no-result">
      Aucun train direct trouvé après cette heure.<br/>
      (${fromName} → ${toName}, ${dayDate.toLocaleDateString('fr-FR')})
    </div>`;
    return;
  }

  for (const t of trips.slice(0,30)) {
    const durMin = Math.round((t.arrive_sec - t.depart_sec)/60);
    const card = document.createElement('div');
    card.className = 'trip-card';
    card.innerHTML = `
      <div class="trip-mainline">
        <span class="time-badge">Départ ${t.depart_time}</span>
        <span class="time-badge">Arrivée ${t.arrive_time}</span>
        <span style="font-size:0.8rem;font-weight:500;color:var(--accent);">
          ${durMin} min
        </span>
      </div>
      <div class="trip-subline">
        <span>${fromName} → ${toName}</span>
        <span class="trip-id-pill">trip ${t.trip_id}</span>
      </div>
    `;
    wrap.appendChild(card);
  }
}

function stopNameById(id) {
  const s = stopsCfl.find(x=>x.stop_id===id);
  return s ? s.stop_name || s.stop_desc || id : id;
}

// =========================
// 6. UI helpers
// =========================
function fillStationsSelects() {
  // On trie les gares par nom pour l'UX
  const sortedStops = [...stopsCfl].sort((a,b)=>{
    return (a.stop_name||'').localeCompare(b.stop_name||'');
  });

  const fromSel = document.getElementById('fromStation');
  const toSel   = document.getElementById('toStation');

  fromSel.innerHTML = '';
  toSel.innerHTML   = '';

  for (const st of sortedStops) {
    // On ignore les "stops" qui ne sont pas des gares réelles si besoin ?
    // Pour l'instant on garde tout.
    const opt1 = document.createElement('option');
    opt1.value = st.stop_id;
    opt1.textContent = st.stop_name || st.stop_id;
    fromSel.appendChild(opt1);

    const opt2 = document.createElement('option');
    opt2.value = st.stop_id;
    opt2.textContent = st.stop_name || st.stop_id;
    toSel.appendChild(opt2);
  }
}

function updateCriteriaText() {
  const crit = document.getElementById('criteriaText');
  const fromStopId = document.getElementById('fromStation').value;
  const toStopId   = document.getElementById('toStation').value;
  const dateStr    = document.getElementById('travelDate').value;
  const minT       = document.getElementById('minTime').value;

  const fromName = stopNameById(fromStopId) || '—';
  const toName   = stopNameById(toStopId) || '—';

  crit.textContent = `${fromName} → ${toName}, le ${dateStr || '??'} après ${minT || '??'}`;
}

// =========================
// 7. CHARGEMENT INITIAL
// =========================
async function initData() {
  const statusEl = document.getElementById('dataStatus');
  statusEl.textContent = 'Chargement…';

  // 7.1 charge les CSV de base
  [
    stopsCfl,
    tripsCfl,
    calendarCfl,
    calendarDatesCfl
  ] = await Promise.all([
    loadCsv(`${BASE_URL}/stops[1].txt`),
    loadCsv(`${BASE_URL}/trips[1].txt`),
    loadCsv(`${BASE_URL}/calendar[1].txt`),
    loadCsv(`${BASE_URL}/calendar_dates[1].txt`)
  ]);

  // 7.2 charge stop_times[1] & stop_times[2] puis fusion
  const [st1, st2] = await Promise.all([
    loadCsv(`${BASE_URL}/stop_times[1].txt`),
    loadCsv(`${BASE_URL}/stop_times[2].txt`)
  ]);

  function ingestStopTimes(rows) {
    for (const r of rows) {
      const trip_id = r.trip_id;
      if (!stopTimesByTrip.has(trip_id)) {
        stopTimesByTrip.set(trip_id, []);
      }
      stopTimesByTrip.get(trip_id).push({
        stop_id: r.stop_id,
        arr: r.arrival_time,
        dep: r.departure_time,
        arrSec: timeToSec(r.arrival_time),
        depSec: timeToSec(r.departure_time),
        seq: parseInt(r.stop_sequence,10)
      });
    }
  }
  ingestStopTimes(st1);
  ingestStopTimes(st2);

  // 7.3 trie chaque trip par stop_sequence
  for (const [tid, arr] of stopTimesByTrip.entries()) {
    arr.sort((a,b)=>a.seq - b.seq);
  }

  // 7.4 remplir les selects
  fillStationsSelects();

  // 7.5 mettre la date du jour par défaut
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,'0');
  const dd = String(today.getDate()).padStart(2,'0');
  document.getElementById('travelDate').value = `${yyyy}-${mm}-${dd}`;

  // OK
  dataReady = true;
  statusEl.textContent = 'Données CFL prêtes';
  document.getElementById('resultsBody').innerHTML =
    '<div class="no-result">Choisis départ / arrivée puis clique "Rechercher".</div>';

  updateCriteriaText();
}

// =========================
// 8. ACTION RECHERCHE
// =========================
function onSearchClick() {
  updateCriteriaText();
  if (!dataReady) return;

  const fromStopId = document.getElementById('fromStation').value;
  const toStopId   = document.getElementById('toStation').value;
  const dateStr    = document.getElementById('travelDate').value; // "2025-10-28"
  const timeStr    = document.getElementById('minTime').value || '00:00';

  // construire Date locale pour la recherche
  // On prend la date demandée, on met 00:00 locale
  const [Y,M,D] = dateStr.split('-').map(x=>parseInt(x,10));
  const dayDate = new Date(Y, M-1, D, 0,0,0,0);

  // convertir minTime en secondes depuis minuit
  const [hStr,mStr] = timeStr.split(':');
  const minSec = (parseInt(hStr,10)*3600) + (parseInt(mStr,10)*60);

  const trips = findDirectItineraries(fromStopId, toStopId, minSec, dayDate);

  renderResults(trips, fromStopId, toStopId, dayDate);
}

// =========================
// 9. EVENT LISTENERS
// =========================
document.getElementById('searchBtn').addEventListener('click', onSearchClick);
document.getElementById('fromStation').addEventListener('change', updateCriteriaText);
document.getElementById('toStation').addEventListener('change', updateCriteriaText);
document.getElementById('travelDate').addEventListener('change', updateCriteriaText);
document.getElementById('minTime').addEventListener('input', updateCriteriaText);

// =========================
// 10. LANCEMENT
// =========================
initData();
</script>

</body>
</html>
