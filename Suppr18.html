<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Informations Train SNCF - Horaires Départ</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background: #f9f9f9;
            color: #222;
            margin: 0;
            padding: 20px;
            max-width: 720px;
            margin-left: auto;
            margin-right: auto;
        }
        h1 {
            text-align: center;
            color: #0055a5;
            margin-bottom: 1rem;
        }
        label {
            font-weight: 600;
            margin-top: 12px;
            display: inline-block;
        }
        input[type="text"], input[type="date"] {
            width: 100%;
            max-width: 200px;
            padding: 8px 10px;
            margin-top: 4px;
            border: 1.5px solid #ccc;
            border-radius: 4px;
            transition: border-color 0.3s ease;
            font-size: 1rem;
        }
        input[type="text"]:focus, input[type="date"]:focus {
            border-color: #0077cc;
            outline: none;
        }
        button {
            margin-top: 16px;
            background-color: #0077cc;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1.1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: block;
        }
        button:hover {
            background-color: #005999;
        }
        #trainInfo {
            margin-top: 30px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 3px 10px rgb(0 0 0 / 0.1);
            min-height: 100px;
        }
        h2 {
            border-bottom: 2px solid #0077cc;
            padding-bottom: 6px;
            margin-bottom: 14px;
            color: #004080;
        }
        h3 {
            color: #cc3300;
            margin-bottom: 10px;
        }
        p {
            margin: 6px 0;
            line-height: 1.35;
        }
        .deleted {
            color: #cc0000;
            text-decoration: line-through;
            font-weight: 600;
        }
        .delayed {
            color: #ff6600;
            font-weight: 600;
        }
        .delay-strike {
            color: #444;
            text-decoration: line-through;
        }
        .new-start, .new-end {
            color: #0055cc; /* bleu */
            font-weight: 700;
        }
        .small-gray {
            color: #888;
            font-size: 0.9rem;
            margin-left: 6px;
        }
        /* Styles pour les encarts perturbations */
        .disruption-box {
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 600;
        }
        .disruption-box.red {
            background-color: #ffdddd;
            border: 2px solid #cc0000;
            color: #cc0000;
        }
        .disruption-box.orange {
            background-color: #fff4e5;
            border: 2px solid #ff6600;
            color: #ff6600;
        }
        .disruption-icon {
            font-size: 2.2rem;
            user-select: none;
        }
    </style>
</head>
<body>
    <h1>Les aventures ferroviaires façon @BERNancyMetzLux (ou comment attendre avec style)</h1>
    <label for="trainNumber">Numéro du train :</label>
    <input type="text" id="trainNumber" value="88534" />
    <label for="trainDate">Date (YYYY-MM-DD) :</label>
    <input type="date" id="trainDate" value="2025-05-13" />
    <button id="getTrainData">Obtenir les données</button>

    <div id="trainInfo"></div>
    <script>
$(document).ready(function() {
    $('#getTrainData').click(function() {
        const trainNumber = $('#trainNumber').val().trim();
        const trainDate = $('#trainDate').val().trim();
        if (!trainNumber || !trainDate) {
            alert('Merci de remplir les deux champs.');
            return;
        }

        $('#trainInfo').html('<p>Chargement des données du train...</p>');

        // Format date pour API SNCF : YYYYMMDD
        const dateAPI = trainDate.replace(/-/g, '');

        // Appel API SNCF (endpoint trajet)
        const url = `https://api.sncf.com/v1/coverage/sncf/journeys?from=stop_area:OCE:SA:87391003&to=stop_area:OCE:SA:87391013&datetime=${dateAPI}T000000&count=10&filter=network:TER&direct_paths=true&filter=line.name!=TGV&filter=vehicle.mode=train&query=${trainNumber}`;

        // Ici pour l'exemple on simule l'API car la vraie nécessite clé API
        // Remplace cette partie par ton appel réel avec clé API via fetch/ajax

        // Pour l'exemple, on appelle une fonction fictive getTrainDataSim
        getTrainDataSim(trainNumber, trainDate).then(data => {
            if (!data || !data.journeys || data.journeys.length === 0) {
                $('#trainInfo').html('<p>Aucun résultat trouvé pour ce train à cette date.</p>');
                return;
            }

            // Trouver le train exact
            let train = data.journeys.find(j => j.sections.some(s => s.display_informations && s.display_informations.headsign && s.display_informations.headsign.includes(trainNumber)));
            if (!train) train = data.journeys[0]; // fallback

            // Construire l'affichage des arrêts
            let html = `<h2>Train n°${trainNumber} - ${trainDate}</h2>`;

            // Affichage des perturbations globales
            if (data.disruptions && data.disruptions.length > 0) {
                data.disruptions.forEach(disr => {
                    const severity = disr.severity ? disr.severity.name.toLowerCase() : '';
                    let boxClass = '';
                    let icon = '';
                    if (severity.includes('critical') || severity.includes('major') || severity.includes('severe')) {
                        boxClass = 'red';
                        icon = '⚠️';
                    } else if (severity.includes('moderate') || severity.includes('minor')) {
                        boxClass = 'orange';
                        icon = 'ℹ️';
                    } else {
                        boxClass = 'orange';
                        icon = 'ℹ️';
                    }
                    html += `<div class="disruption-box ${boxClass}"><div class="disruption-icon">${icon}</div>${disr.title}</div>`;
                });
            }

            // Affichage des arrêts du train
            html += '<h3>Arrêts :</h3><ul>';
            train.sections.forEach(section => {
                if (section.type === 'stop' && section.stop_date_time) {
                    const sdt = section.stop_date_time;
                    const stopName = section.stop_point ? section.stop_point.name : 'Inconnu';
                    const baseArrival = sdt.arrival_date_time ? sdt.arrival_date_time.slice(11,16) : null;
                    const baseDeparture = sdt.departure_date_time ? sdt.departure_date_time.slice(11,16) : null;

                    let displayTime = '';
                    if (baseDeparture && baseArrival && baseDeparture === baseArrival) {
                        displayTime = baseDeparture;
                    } else if (baseArrival && !baseDeparture) {
                        displayTime = baseArrival;
                    } else if (baseDeparture && !baseArrival) {
                        displayTime = baseDeparture;
                    } else {
                        displayTime = baseDeparture || baseArrival || '';
                    }

                    // Gestion suppressions
                    const isCancelled = sdt.cancelled || false;

                    // Gestion retard
                    const delayArrival = sdt.arrival_date_time && sdt.base_arrival_date_time ? timeDiffMinutes(sdt.base_arrival_date_time, sdt.arrival_date_time) : 0;
                    const delayDeparture = sdt.departure_date_time && sdt.base_departure_date_time ? timeDiffMinutes(sdt.base_departure_date_time, sdt.departure_date_time) : 0;
                    const delayMax = Math.max(delayArrival, delayDeparture);

                    // Gestion nouvelles gares départ ou terminus
                    const isNewStart = section.is_new_start || false;
                    const isNewEnd = section.is_new_end || false;

                    html += '<li>';
                    if (isCancelled) {
                        html += `<span class="deleted">${stopName} (supprimé)</span>`;
                    } else {
                        html += `<strong>${stopName}</strong> - <span>${displayTime}</span>`;
                        if (delayMax > 0) {
                            html += ` <span class="delayed">(+${delayMax} min)</span>`;
                        }
                        if (isNewStart) {
                            html += ' <span class="new-start">(Nouvelle gare de départ)</span>';
                        }
                        if (isNewEnd) {
                            html += ' <span class="new-end">(Nouvelle gare terminus)</span>';
                        }
                    }
                    html += '</li>';
                }
            });
            html += '</ul>';

            $('#trainInfo').html(html);
        }).catch(() => {
            $('#trainInfo').html('<p>Erreur lors de la récupération des données.</p>');
        });
    });

    // Fonction pour calculer différence en minutes entre deux horaires format ISO
    function timeDiffMinutes(base, actual) {
        const d1 = new Date(base);
        const d2 = new Date(actual);
        const diffMs = d2 - d1;
        return Math.round(diffMs / 60000);
    }

    // Fonction simulée pour exemple (à remplacer par vrai fetch)
    function getTrainDataSim(trainNumber, trainDate) {
        return new Promise((resolve) => {
            // Simulé : données minimales
            const exampleData = {
                journeys: [
                    {
                        sections: [
                            {
                                type: "stop",
                                stop_point: { name: "Nancy" },
                                stop_date_time: {
                                    arrival_date_time: null,
                                    departure_date_time: trainDate + "T08:00:00",
                                    base_arrival_date_time: null,
                                    base_departure_date_time: trainDate + "T07:55:00",
                                    cancelled: false
                                },
                                is_new_start: true,
                                is_new_end: false
                            },
                            {
                                type: "stop",
                                stop_point: { name: "Metz" },
                                stop_date_time: {
                                    arrival_date_time: trainDate + "T08:45:00",
                                    departure_date_time: trainDate + "T08:47:00",
                                    base_arrival_date_time: trainDate + "T08:40:00",
                                    base_departure_date_time: trainDate + "T08:42:00",
                                    cancelled: false
                                },
                                is_new_start: false,
                                is_new_end: false
                            },
                            {
                                type: "stop",
                                stop_point: { name: "Luxembourg" },
                                stop_date_time: {
                                    arrival_date_time: trainDate + "T09:30:00",
                                    departure_date_time: null,
                                    base_arrival_date_time: trainDate + "T09:25:00",
                                    base_departure_date_time: null,
                                    cancelled: false
                                },
                                is_new_start: false,
                                is_new_end: true
                            }
                        ]
                    }
                ],
                disruptions: [
                    { title: "Travaux sur la ligne Metz-Luxembourg", severity: { name: "Major" } },
                    { title: "Retards attendus à Nancy", severity: { name: "Moderate" } }
                ]
            };
            setTimeout(() => resolve(exampleData), 1000);
        });
    }
});
</script>
</body>
</html>
