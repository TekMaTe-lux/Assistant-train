<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>Informations Train SNCF</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f9fafb;
            color: #222;
            margin: 20px auto;
            max-width: 720px;
            padding: 10px 20px;
        }
        h1 {
            color: #2a2f45;
            border-bottom: 2px solid #2a2f45;
            padding-bottom: 6px;
            margin-bottom: 20px;
        }
        label {
            display: inline-block;
            width: 120px;
            font-weight: 600;
            margin-top: 10px;
        }
        input[type="text"], input[type="date"] {
            padding: 6px 8px;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 180px;
        }
        button {
            margin-top: 15px;
            background-color: #2a2f45;
            color: #fff;
            border: none;
            padding: 10px 18px;
            font-size: 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #444a6a;
        }
        #trainInfo {
            margin-top: 30px;
            background: #fff;
            border-radius: 6px;
            padding: 20px;
            box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
        }
        h2 {
            border-bottom: 1px solid #ddd;
            padding-bottom: 6px;
            margin-bottom: 15px;
            color: #2a2f45;
        }
        p {
            margin: 6px 0;
            line-height: 1.3;
        }
        /* Perturbations */
        .perturbation-box {
            border-left: 6px solid #f0ad4e;
            background-color: #fff8e1;
            padding: 15px 20px;
            margin-bottom: 25px;
            border-radius: 5px;
            color: #665200;
            box-shadow: 0 1px 4px rgb(0 0 0 / 0.05);
        }
        .perturbation-suppression {
            border-left-color: #d9534f;
            background-color: #fdecea;
            color: #842029;
        }
        .perturbation-retard {
            border-left-color: #f0ad4e;
            background-color: #fff8e1;
            color: #665200;
        }
        .perturbation-header {
            font-weight: 700;
            font-size: 1.25rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        .perturbation-header svg {
            margin-right: 10px;
        }
        .cause-box {
            background-color: #eee9d9;
            padding: 10px 12px;
            margin: 8px 0 10px 0;
            border-radius: 4px;
            font-style: italic;
            color: #4a463a;
        }
        .status-label {
            font-weight: 600;
        }
        /* Liste des arrêts */
        .stop {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .stop:last-child {
            border-bottom: none;
        }
        .stop-name {
            font-weight: 600;
            color: #2a2f45;
        }
        .stop-time {
            margin-left: 12px;
            font-size: 0.9rem;
        }
        .deleted {
            color: #d9534f;
            text-decoration: line-through;
        }
        .delayed {
            color: #f0ad4e;
            font-weight: 600;
        }
        .new-departure, .new-terminus {
            color: #f0ad4e;
            font-weight: 700;
        }
    </style>
</head>
<body>
    <h1>Informations sur un Train SNCF</h1>
    <label for="trainNumber">Numéro du train :</label>
    <input type="text" id="trainNumber" value="88534" />
    <br />
    <label for="trainDate">Date (YYYY-MM-DD) :</label>
    <input type="date" id="trainDate" value="2025-05-13" />
    <br />
    <button id="getTrainData">Obtenir les données</button>
    <div id="trainInfo"></div>

    <script>
        $(document).ready(function () {
            $('#getTrainData').click(function () {
                const trainNumber = $('#trainNumber').val();
                const trainDate = $('#trainDate').val();
                const apiKey = '242fac11-6d98-45fb-93df-28174d362447';
                const encodedApiKey = btoa(apiKey + ":");
                const url = `https://api.sncf.com/v1/coverage/sncf/vehicle_journeys/vehicle_journey:SNCF:${trainDate}:${trainNumber}:1187:Train`;

                // Traduction des statuts en français
                function translateStatus(status) {
                    const map = {
                        'past': 'Terminé',
                        'ongoing': 'En cours',
                        'upcoming': 'À venir',
                        'cancelled': 'Annulé',
                        'unknown': 'Inconnu'
                    };
                    return map[status] || status;
                }

                $.ajax({
                    url: url,
                    method: 'GET',
                    headers: {
                        'Authorization': 'Basic ' + encodedApiKey
                    },
                    success: function (response) {
                        if(!response.vehicle_journeys || response.vehicle_journeys.length === 0) {
                            $('#trainInfo').html('<p>Aucun train trouvé pour ce numéro et cette date.</p>');
                            return;
                        }
                        const train = response.vehicle_journeys[0];
                        const disruptions = response.disruptions || [];
                        let effect = null;
                        let impactedStopsMap = {};
                        if (disruptions.length > 0) {
                            const disruption = disruptions[0];
                            effect = disruption.severity?.effect || null;
                            disruption.impacted_objects?.forEach(obj => {
                                obj.impacted_stops?.forEach(stop => {
                                    impactedStopsMap[stop.stop_point.id] = {
                                        arrival_status: stop.arrival_status,
                                        departure_status: stop.departure_status,
                                        stop_time_effect: stop.stop_time_effect,
                                        amended_arrival_time: stop.amended_arrival_time,
                                        amended_departure_time: stop.amended_departure_time
                                    };
                                });
                            });
                        }

                        // Trouver indices premières et dernières gares effectives
                        const stops = train.stop_times;
                        let firstRealDepartureIndex = -1;
                        let lastRealArrivalIndex = -1;
                        stops.forEach((stop, index) => {
                            const impact = impactedStopsMap[stop.stop_point.id];
                            if (!impact || impact.departure_status !== "deleted") {
                                if (firstRealDepartureIndex === -1) firstRealDepartureIndex = index;
                            }
                            if (!impact || impact.arrival_status !== "deleted") {
                                lastRealArrivalIndex = index;
                            }
                        });

                        // Format heure hh:mm
                        function formatTime(t) {
                            if (!t) return '-';
                            return t.substring(0, 2) + ':' + t.substring(2, 4);
                        }

                        // Calcul retard en minutes
                        function computeDelay(baseTime, amendedTime) {
                            const base = parseInt(baseTime.substring(0, 2)) * 60 + parseInt(baseTime.substring(2, 4));
                            const amended = parseInt(amendedTime.substring(0, 2)) * 60 + parseInt(amendedTime.substring(2, 4));
                            return amended - base;
                        }

                        // Construction de la liste des arrêts
                        const stopHtml = stops.map((stop, index) => {
                            const id = stop.stop_point.id;
                            const name = stop.stop_point.name;
                            const baseArrival = formatTime(stop.arrival_time);
                            const baseDeparture = formatTime(stop.departure_time);
                            let arrival = baseArrival;
                            let departure = baseDeparture;

                            const impact = impactedStopsMap[id];
                            let barrerLigne = false;
                            let barrerArrivee = false;
                            let barrerDepart = false;
                            const estSupprime = impact && impact.stop_time_effect === "deleted";
                            const aDel = impact?.arrival_status === "deleted";
                            const dDel = impact?.departure_status === "deleted";
                            const dUnchanged = impact?.departure_status === "unchanged";
                            const aUnchanged = impact?.arrival_status === "unchanged";

                            if (effect === "NO_SERVICE") {
                                barrerLigne = true;
                            } else if (effect === "REDUCED_SERVICE") {
                                if (estSupprime && aDel && dUnchanged && index === firstRealDepartureIndex && index !== 0) {
                                    let amendedDeparture = impact?.amended_departure_time ? formatTime(impact.amended_departure_time) : departure;
                                    let delay = impact?.amended_departure_time ? computeDelay(stop.departure_time, impact.amended_departure_time) : null;
                                    let retard = delay ? ` <span class="delayed">(+${delay}min)</span>` : '';
                                    return `<p class="stop new-departure">${name} - Départ: <strong>${amendedDeparture}</strong>${retard} (Nouvelle gare de départ)</p>`;
                                }
                                if (estSupprime && dDel && aUnchanged && index === lastRealArrivalIndex && index !== stops.length - 1) {
                                    let amendedArrival = impact?.amended_arrival_time ? formatTime(impact.amended_arrival_time) : arrival;
                                    let delay = impact?.amended_arrival_time ? computeDelay(stop.arrival_time, impact.amended_arrival_time) : null;
                                    let retard = delay ? ` <span class="delayed">(+${delay}min)</span>` : '';
                                    return `<p class="stop new-terminus">${name} - Arrivée: <strong>${amendedArrival}</strong>${retard} (Nouveau terminus)</p>`;
                                }
                                if (index < firstRealDepartureIndex || index > lastRealArrivalIndex || estSupprime) {
                                    barrerLigne = true;
                                } else {
                                    if (aDel) barrerArrivee = true;
                                    if (dDel) barrerDepart = true;
                                }
                            }

                            let arrivalDisplay = arrival;
                            let departureDisplay = departure;

                            if (impact && impact.amended_arrival_time && impact.amended_arrival_time !== stop.arrival_time) {
                                const amendedArrival = formatTime(impact.amended_arrival_time);
                                const delay = computeDelay(stop.arrival_time, impact.amended_arrival_time);
                                arrivalDisplay = `<span class="deleted">${arrival}</span> ➔ <strong class="delayed">${amendedArrival}</strong> <span class="delayed">(+${delay}min)</span>`;
                            }
                            if (impact && impact.amended_departure_time && impact.amended_departure_time !== stop.departure_time) {
                                const amendedDeparture = formatTime(impact.amended_departure_time);
                                const delay = computeDelay(stop.departure_time, impact.amended_departure_time);
                                departureDisplay = `<span class="deleted">${departure}</span> ➔ <strong class="delayed">${amendedDeparture}</strong> <span class="delayed">(+${delay}min)</span>`;
                            }

                            if (barrerLigne) {
                                return `<p class="stop deleted">${name} - Arrivée: ${arrival} - Départ: ${departure}</p>`;
                            } else {
                                if (barrerArrivee) arrivalDisplay = `<span class="deleted">${arrivalDisplay}</span>`;
                                if (barrerDepart) departureDisplay = `<span class="deleted">${departureDisplay}</span>`;
                            }

                            // Affichage selon gare départ/arrivée réelle
                            if (index === firstRealDepartureIndex && index === lastRealArrivalIndex) {
                                return `<p class="stop">${name}</p>`;
                            } else if (index === firstRealDepartureIndex) {
                                return `<p class="stop">${name} - Départ: ${departureDisplay}</p>`;
                            } else if (index === lastRealArrivalIndex) {
                                return `<p class="stop">${name} - Arrivée: ${arrivalDisplay}</p>`;
                            } else {
                                return `<p class="stop">${name} - Arrivée: ${arrivalDisplay} - Départ: ${departureDisplay}</p>`;
                            }
                        }).join('');

                        // Traduction effet perturbation
                        let effetTraduit = effect;
                        if (effect === 'NO_SERVICE') effetTraduit = 'Suppression';
                        else if (effect === 'REDUCED_SERVICE') effetTraduit = 'Suppression partielle';
                        else if (effect === 'SIGNIFICANT_DELAYS') effetTraduit = 'Retard important';

                        // Construction de la partie perturbations
                        let disruptionHtml = '';
                        if (effect) {
                            const disruption = disruptions[0];
                            const cause = disruption.messages?.[0]?.text || 'Non précisée';
                            const statut = translateStatus(disruption.status || 'inconnu');

                            let classePerturbation = 'perturbation-retard';
                            if (effect === "NO_SERVICE" || effect === "REDUCED_SERVICE") {
                                classePerturbation = 'perturbation-suppression';
                            }

                            let retardHtml = '';
                            if (disruption.severity?.delay) {
                                const delay = disruption.severity.delay;
                                retardHtml = `<p><strong>Retard :</strong> <span class="delayed">⚠️ +${delay} min</span></p>`;
                            }

                            disruptionHtml = `
                                <
