<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Infos Train SNCF - Horaires Départ</title>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style>
    body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f9f9f9;
        color: #222;
        margin: 0;
        padding: 20px;
        max-width: 720px;
        margin-left: auto;
        margin-right: auto;
    }
    h1 {
        text-align: center;
        color: #0055a5;
        margin-bottom: 1rem;
    }
    label {
        font-weight: 600;
        margin-top: 12px;
        display: inline-block;
    }
    input[type="text"], input[type="date"] {
        width: 100%;
        max-width: 200px;
        padding: 8px 10px;
        margin-top: 4px;
        border: 1.5px solid #ccc;
        border-radius: 4px;
        transition: border-color 0.3s ease;
        font-size: 1rem;
    }
    input[type="text"]:focus, input[type="date"]:focus {
        border-color: #0077cc;
        outline: none;
    }
    button {
        margin-top: 16px;
        background-color: #0077cc;
        color: white;
        border: none;
        padding: 12px 24px;
        font-size: 1.1rem;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        display: block;
    }
    button:hover {
        background-color: #005999;
    }
    #trainInfo {
        margin-top: 30px;
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 3px 10px rgb(0 0 0 / 0.1);
        min-height: 100px;
    }
    h2 {
        border-bottom: 2px solid #0077cc;
        padding-bottom: 6px;
        margin-bottom: 14px;
        color: #004080;
    }
    p {
        margin: 6px 0;
        line-height: 1.35;
        font-size: 1rem;
    }
    .deleted {
        color: #cc0000;
        text-decoration: line-through;
        font-weight: 600;
    }
    .delay-strike {
        color: #444;
        text-decoration: line-through;
        font-weight: 600;
    }
    .delayed {
        color: #ff6600;
        font-weight: 600;
    }
    .new-start, .new-end {
        color: #0055cc; /* bleu */
        font-weight: 700;
    }
    .small-gray {
        color: #888;
        font-size: 0.9rem;
        margin-left: 6px;
    }
    .disruption {
        border-radius: 8px;
        padding: 12px 16px;
        margin-bottom: 18px;
        font-weight: 600;
        display: flex;
        gap: 12px;
        align-items: center;
        font-size: 1rem;
    }
    .disruption-icon {
        font-size: 1.8rem;
        user-select: none;
    }
    .disruption.no_service {
        background-color: #f8d7da;
        color: #721c24;
        border: 1.5px solid #f5c6cb;
    }
    .disruption.reduced_service {
        background-color: #f8d7da;
        color: #721c24;
        border: 1.5px solid #f5c6cb;
    }
    .disruption.significant_delays {
        background-color: #fff3cd;
        color: #856404;
        border: 1.5px solid #ffeeba;
    }
</style>
</head>
<body>
<h1>Informations sur un Train SNCF</h1>
<label for="trainNumber">Numéro du train :</label>
<input type="text" id="trainNumber" value="88534" />
<label for="trainDate">Date (YYYY-MM-DD) :</label>
<input type="date" id="trainDate" value="2025-05-13" />
<button id="getTrainData">Obtenir les données</button>

<div id="trainInfo"></div>

<script>
$(document).ready(function () {
    $('#getTrainData').click(function () {
        const trainNumber = $('#trainNumber').val().trim();
        const trainDate = $('#trainDate').val();
        if (!trainNumber) {
            $('#trainInfo').html('<p class="deleted">Veuillez entrer un numéro de train valide.</p>');
            return;
        }
        if (!trainDate) {
            $('#trainInfo').html('<p class="deleted">Veuillez sélectionner une date valide.</p>');
            return;
        }

        $('#trainInfo').html('<p>Chargement des données...</p>');

        const apiKey = '242fac11-6d98-45fb-93df-28174d362447';
        const encodedApiKey = btoa(apiKey + ":");
        const url = `https://api.sncf.com/v1/coverage/sncf/vehicle_journeys/vehicle_journey:SNCF:${trainDate}:${trainNumber}:1187:Train`;

        $.ajax({
            url: url,
            method: 'GET',
            headers: { 'Authorization': 'Basic ' + encodedApiKey },
            success: function (response) {
                if (!response.vehicle_journeys || response.vehicle_journeys.length === 0) {
                    $('#trainInfo').html('<p class="deleted">Aucun train trouvé avec ce numéro et cette date.</p>');
                    return;
                }

                const train = response.vehicle_journeys[0];
                const disruptions = response.disruptions || [];
                let effect = null;
                let impactedStopsMap = {};
                if (disruptions.length > 0) {
                    const disruption = disruptions[0];
                    effect = disruption.severity?.effect || null;
                    disruption.impacted_objects?.forEach(obj => {
                        obj.impacted_stops?.forEach(stop => {
                            impactedStopsMap[stop.stop_point.id] = {
                                arrival_status: stop.arrival_status,
                                departure_status: stop.departure_status,
                                stop_time_effect: stop.stop_time_effect,
                                amended_arrival_time: stop.amended_arrival_time,
                                amended_departure_time: stop.amended_departure_time
                            };
                        });
                    });
                }

                const stops = train.stop_times;

                // Trouver premier arrêt de départ réel (non supprimé en départ)
                let firstRealDepartureIndex = stops.findIndex((stop) => {
                    const impact = impactedStopsMap[stop.stop_point.id];
                    return !impact || impact.departure_status !== "deleted";
                });

                // Trouver dernier arrêt d'arrivée réel (non supprimé en arrivée)
                let lastRealArrivalIndex = [...stops].reverse().findIndex((stop) => {
                    const impact = impactedStopsMap[stop.stop_point.id];
                    return !impact || impact.arrival_status !== "deleted";
                });
                lastRealArrivalIndex = lastRealArrivalIndex === -1 ? stops.length - 1 : stops.length - 1 - lastRealArrivalIndex;

                function formatTime(t) {
                    if (!t) return '-';
                    return t.substring(0, 2) + ':' + t.substring(2, 4);
                }

                function computeDelay(baseTime, amendedTime) {
                    const base = parseInt(baseTime.substring(0, 2)) * 60 + parseInt(baseTime.substring(2, 4));
                    const amended = parseInt(amendedTime.substring(0, 2)) * 60 + parseInt(amendedTime.substring(2, 4));
                    return amended - base;
                }

                const stopHtml = stops.map((stop, index) => {
                    const id = stop.stop_point.id;
                    const name = stop.stop_point.name;
                    const baseDeparture = formatTime(stop.departure_time);

                    const impact = impactedStopsMap[id];
                    const estSupprime = impact && impact.stop_time_effect === "deleted";
                    const dDel = impact?.departure_status === "deleted";
                    const amendedDeparture = impact?.amended_departure_time ? formatTime(impact.amended_departure_time) : null;
                    const delayDeparture = (impact && impact.amended_departure_time) ? computeDelay(stop.departure_time, impact.amended_departure_time) : null;

                    // On affiche uniquement l'horaire de départ (base ou modifié)

                    // Nouvelles gares de départ
                    if (index === firstRealDepartureIndex) {
                        let retardTexte = '';
                        if (delayDeparture !== null && delayDeparture > 0) {
                            // retard barré (pas rouge)
                            retardTexte = ` <span class="delay-strike">( +${delayDeparture} min )</span>`;
                        }
                        // Si suppression sur ce départ, en rouge barré
                        if (estSupprime || dDel) {
                            return `<p class="new-start deleted"><strong>${name}</strong> - <strong>${amendedDeparture || baseDeparture}</strong>${retardTexte} (Nouvelle gare de départ)</p>`;
                        }
                        return `<p class="new-start"><strong>${name}</strong> - <strong>${amendedDeparture || baseDeparture}</strong>${retardTexte} (Nouvelle gare de départ)</p>`;
                    }

                    // Nouveau terminus (dernier arrêt réel), même si suppression ou retard
                    if (index === lastRealArrivalIndex) {
                        let retardTexte = '';
                        if (delayDeparture !== null && delayDeparture > 0) {
                            retardTexte = ` <span class="delay-strike">( +${delayDeparture} min )</span>`;
                        }
                        if (estSupprime || dDel) {
                            return `<p class="new-end deleted"><strong>${name}</strong> - <strong>${amendedDeparture || baseDeparture}</strong>${retardTexte} (Nouveau terminus)</p>`;
                        }
                        return `<p class="new-end"><strong>${name}</strong> - <strong>${amendedDeparture || baseDeparture}</strong>${retardTexte} (Nouveau terminus)</p>`;
                    }

                    // Arrêts hors plage (avant premier départ réel ou après dernier arrêt réel)
                    if (index < firstRealDepartureIndex || index > lastRealArrivalIndex) {
                        let texte = `${name} - ${baseDeparture}`;
                        if (delayDeparture !== null && delayDeparture > 0) {
                            texte += ` <span class="delay-strike">( +${delayDeparture} min )</span>`;
                        }
                        return `<p class="deleted">${texte}</p>`;
                    }

                    // Suppression totale ou partielle (en rouge barré)
                    if (effect === "NO_SERVICE" || effect === "REDUCED_SERVICE") {
                        if (estSupprime || dDel) {
                            let texte = `${name} - ${amendedDeparture || baseDeparture}`;
                            if (delayDeparture !== null && delayDeparture > 0) {
                                texte += ` <span class="small-gray">( +${delayDeparture} min )</span>`;
                            }
                            return `<p class="deleted">${texte}</p>`;
                        }
                    }

                    // Retard important (en orange, non barré)
                    if (effect === "SIGNIFICANT_DELAYS") {
                        if (delayDeparture !== null && delayDeparture >= 5) {
                            return `<p class="delayed">${name} - <strong>${amendedDeparture || baseDeparture}</strong> ( +${delayDeparture} min )</p>`;
                        }
                    }

                    // Cas normal, pas de suppression ni retard important
                    if (delayDeparture !== null && delayDeparture > 0) {
                        // Retard, barré le départ de base et affiché l'heure retardée
                        return `<p>${name} - <span class="delay-strike">${baseDeparture}</span> <strong>${amendedDeparture}</strong> ( +${delayDeparture} min )</p>`;
                    }

                    // Cas normal sans retard ni suppression
                    return `<p>${name} - <strong>${baseDeparture}</strong></p>`;
                });
                // Fin map des arrêts

                // Gestion des perturbations globales
                let disruptionHtml = '';
                if (disruptions.length > 0) {
                    disruptions.forEach(disp => {
                        let severity = disp.severity;
                        let effect = severity?.effect || '';
                        let desc = disp.message || disp.headlineText || "Perturbation inconnue";

                        if (effect === "NO_SERVICE") {
                            disruptionHtml += `<div class="disruption no_service"><span class="disruption-icon">⛔</span> Service totalement interrompu : ${desc}</div>`;
                        } else if (effect === "REDUCED_SERVICE") {
                            disruptionHtml += `<div class="disruption reduced_service"><span class="disruption-icon">⚠️</span> Service partiellement interrompu : ${desc}</div>`;
                        } else if (effect === "SIGNIFICANT_DELAYS") {
                            disruptionHtml += `<div class="disruption significant_delays"><span class="disruption-icon">⏰</span> Retards importants : ${desc}</div>`;
                        } else {
                            disruptionHtml += `<div class="disruption"><span class="disruption-icon">ℹ️</span> Info : ${desc}</div>`;
                        }
                    });
                }

                $('#trainInfo').html(`
                    <h2>Train n°${trainNumber} - ${trainDate}</h2>
                    ${disruptionHtml}
                    ${stopHtml.join('')}
                `);
            },
            error: function () {
                $('#trainInfo').html('<p class="deleted">Erreur lors de la récupération des données.</p>');
            }
        });
    });
});
</script>

</body>
</html>
