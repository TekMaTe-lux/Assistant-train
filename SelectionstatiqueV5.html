<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>S√©lecteur de vos b√©taill√®res NancyMetzLux</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.css" />
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      max-width: 700px;
      margin: 2em auto;
      padding: 0 1em;
      background: #f9f9f9;
    }
    label {
      font-weight: bold;
      margin-top: 1em;
      display: block;
    }
    select, button, input[type="date"] {
      margin-top: 0.3em;
      padding: 6px 12px;
      font-size: 1rem;
      width: 100%;
      max-width: 320px;
      box-sizing: border-box;
    }
    #slider {
      margin: 30px 0;
    }
    .range-output {
      font-weight: bold;
      margin-top: 1em;
      font-size: 1.1rem;
    }
    #resultatsTrains {
      margin-top: 1.5em;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1em;
    }
    .carte-train {
  padding: 0.5em 0.8em;
  font-size: 0.95rem;
  margin-bottom: 0.4em;
  border-radius: 6px;
  user-select: none;
  cursor: pointer;
  display: inline-block;
  width: auto;
  min-width: 150px;
  max-width: 280px;
}  
    .carte-train:hover {
      box-shadow: 0 6px 12px rgb(0 0 0 / 0.3);
    }
    .carte-train.selected {
      background-color: #1a73e8;
      color: white;
      box-shadow: 0 6px 16px rgb(26 115 232 / 0.7);
    }
    .train-num {
      font-size: 1.4rem;
      font-weight: 700;
      color: inherit;
      margin-bottom: 0.4em;
    }
    .horaires {
      font-size: 1rem;
      color: inherit;
    }
    .horaires span {
      font-weight: 600;
    }
    #zoneSelection {
      margin-top: 2em;
      background: #e3e3e3;
      border-radius: 6px;
      padding: 1em;
    }
    #zoneSelection h3 {
      margin-top: 0;
    }
    #zoneSelection ul {
      list-style: none;
      padding-left: 0;
      display: flex;
      flex-wrap: wrap;
      gap: 0.7em;
    }
    #zoneSelection li {
      background: #1a73e8;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-weight: 600;
      cursor: default;
    }
    select option.principal {
      font-weight: 700;
    }
  </style>
</head>
<body>

  <h1>üöÜ S√©lecteur de vos b√©taill√®res NancyMetzLux</h1>

  <label for="gareDepart">Gare de d√©part :</label>
  <select id="gareDepart">
    <option value="">-- Choisissez --</option>
  </select>

  <label for="gareArrivee">Gare d‚Äôarriv√©e :</label>
  <select id="gareArrivee" disabled>
    <option value="">-- Choisissez --</option>
  </select>

  <!-- Date masqu√©e (utilis√©e via URL) -->
  <input type="hidden" id="dateTrain" />

  <div id="slider"></div>
  <div class="range-output">
    Plage horaire : <span id="heure-selection">06:00 ‚Üí 11:00</span>
  </div>

  <button id="btnRechercher" disabled>üîç Rechercher</button>

  <h2>R√©sultats :</h2>
  <div id="resultatsTrains"></div>

  <div id="zoneSelection">
    <h3>B√©taill√®res s√©lectionn√©es :</h3>
    <ul id="trainsSelectionnes"><li>Aucune b√©taill√®re s√©lectionn√©e</li></ul>
  </div>

  <button id="btnValiderSelection" style="margin-top:1em; padding:8px 16px; font-size:1rem;">
    Valider la s√©lection
  </button>

  <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.js"></script>
  <script>

    // --- Lecture param√®tre URL ---
    function getParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }
    
    // --- Variables globales ---
    let trains = [];         // Liste des trains construite dynamiquement
    let calendarDates = [];  // Calendrier des services (dates d‚Äôexception)

    // Liste des gares avec codes num√©riques (correspondant aux codes extraits)
    const garesParLigne = [
      { code: "82001000", nom: "Luxembourg", principal: true },
      { code: "82002501", nom: "Howald", principal: false },
      { code: "82006030", nom: "Bettembourg", principal: true },
      { code: "87191163", nom: "Hettange-Grande", principal: false },
      { code: "87191007", nom: "Thionville", principal: true },
      { code: "87191130", nom: "Uckange", principal: false },
      { code: "87191114", nom: "Hagondange", principal: false },
      { code: "87191098", nom: "Walygator parc", principal: false },
      { code: "87191106", nom: "Maizi√®res-l√®s-Metz", principal: false },
      { code: "87192088", nom: "Woippy", principal: false },
      { code: "87192070", nom: "Metz Nord", principal: false },
      { code: "87192039", nom: "Metz", principal: true },
      { code: "87192401", nom: "Ars-sur-Moselle", principal: false },
      { code: "87192427", nom: "Nov√©ant-sur-Moselle", principal: false },
      { code: "87192468", nom: "Pagny-sur-Moselle", principal: false },
      { code: "87192476", nom: "Vandi√®res", principal: false },
      { code: "87141820", nom: "Pont-√†-Mousson", principal: false },
      { code: "87141812", nom: "Dieulouard", principal: false },
      { code: "87141804", nom: "Belleville", principal: false },
      { code: "87141796", nom: "Marbache", principal: false },
      { code: "87141788", nom: "Pompey", principal: false },
      { code: "87141077", nom: "Frouard", principal: false },
      { code: "87141002", nom: "Nancy", principal: true }
    ];

    const gareDepartEl = document.getElementById("gareDepart");
    const gareArriveeEl = document.getElementById("gareArrivee");
    const dateTrainEl = document.getElementById("dateTrain");
    const btnRechercher = document.getElementById("btnRechercher");
    const heureText = document.getElementById("heure-selection");
    const slider = document.getElementById("slider");
    const resultatsEl = document.getElementById("resultatsTrains");
    const trainsSelectionnesEl = document.getElementById("trainsSelectionnes");
    const dateTransmise = getParam('date');
  if (dateTransmise) {
    dateTrainEl.value = dateTransmise;
  }

    // --- Extraction du code num√©rique √† partir du stop_id complet ---
    function extraireCodeStop(stopIdComplet) {
      const match = stopIdComplet.match(/(\d+)$/);
      return match ? match[1] : null;
    }

    // --- Fonctions utilitaires pour parsing CSV GTFS ---
    async function chargerCsvGTFS(url) {
      const response = await fetch(url);
      if (!response.ok) throw new Error(`Erreur chargement ${url} : ${response.statusText}`);
      const texte = await response.text();
      return parseCsvGTFS(texte);
    }

    function parseCsvGTFS(csvText) {
      const lignes = csvText.trim().split("\n");
      const entetes = lignes.shift().split(",");
      return lignes.map(ligne => {
        const valeurs = splitCsvLine(ligne);
        const obj = {};
        entetes.forEach((key, i) => obj[key] = valeurs[i] || "");
        return obj;
      });
    }

    function splitCsvLine(line) {
      // split simple par ',' (pas robuste aux virgules entre guillemets)
      return line.split(",");
    }

    // --- Tri et remplissage des selects ---
    function trierGaresPourSelect(gares) {
      const principales = gares.filter(g => g.principal).sort((a,b) => a.nom.localeCompare(b.nom));
      const autres = gares.filter(g => !g.principal).sort((a,b) => a.nom.localeCompare(b.nom));
      return [...principales, ...autres];
    }

    function remplirSelectGares(selectEl, options = [], exclureCode = "") {
      const ancienneValeur = selectEl.value;
      selectEl.innerHTML = `<option value="">-- Choisissez --</option>`;
      options.forEach(({ code, nom, principal }) => {
        if (code === exclureCode) return;
        const opt = document.createElement("option");
        opt.value = code;
        opt.textContent = nom;
        if (principal) opt.classList.add("principal");
        selectEl.appendChild(opt);
      });
      if (ancienneValeur && ancienneValeur !== exclureCode) {
        selectEl.value = ancienneValeur;
      } else {
        selectEl.value = "";
      }
    }

    // --- Fonction pour construire la liste des trains √† partir des donn√©es GTFS ---
    function construireTrains(trips, stopTimes, stops) {
      const stopsMap = {};
      stops.forEach(s => stopsMap[s.stop_id] = s.stop_name);

      // Regrouper stop_times par trip_id
      const stopTimesParTrip = {};
      stopTimes.forEach(st => {
        if (!stopTimesParTrip[st.trip_id]) stopTimesParTrip[st.trip_id] = [];
        stopTimesParTrip[st.trip_id].push(st);
      });

      // Trier par stop_sequence
      for (const tripId in stopTimesParTrip) {
        stopTimesParTrip[tripId].sort((a,b) => parseInt(a.stop_sequence) - parseInt(b.stop_sequence));
      }

      // Construire tableau trains
      return trips.map(trip => {
        const stopsInfo = stopTimesParTrip[trip.trip_id];
        if (!stopsInfo) return null;
        // Extract codes simplifi√©s des stops
        const stopsCodes = stopsInfo.map(s => extraireCodeStop(s.stop_id)).filter(c => c !== null);
        const horaires = {};
        stopsInfo.forEach(s => {
          const code = extraireCodeStop(s.stop_id);
          if (code) horaires[code] = s.departure_time;
        });
        return {
          num: trip.trip_headsign || trip.trip_id,
          service_id: trip.service_id,
          trip_id: trip.trip_id,
          direction_id: trip.direction_id,
          stops: stopsCodes,
          horaires,
        };
      }).filter(t => t !== null);
    }

    // --- V√©rifier si service actif selon calendar_dates ---
    function estServiceActif(service_id, dateStr) {
  const dateCompare = dateStr.replace(/-/g, "");
  // Cherche si la date est list√©e pour ce service avec exception_type 1 (ajout)
  const exceptions = calendarDates.filter(e => e.service_id === service_id && e.date === dateCompare && e.exception_type === "1");
  // Service actif uniquement si exception_type=1 trouv√© pour cette date
  return exceptions.length > 0;
}

    // --- Variables de s√©lection de trains ---
    const selectionTrains = new Set();

    // Quand on clique sur un train dans les r√©sultats
function toggleSelection(trainNum, divElement) {
  if (selectionTrains.has(trainNum)) {
    selectionTrains.delete(trainNum);
    divElement.classList.remove("selected");
  } else {
    selectionTrains.add(trainNum);
    divElement.classList.add("selected");
  }
  afficherSelection();
}

    // --- Rechercher les trains selon crit√®res ---
    function rechercherTrains() {
  const gareDepart = gareDepartEl.value;
  const gareArrivee = gareArriveeEl.value;
  const [minRaw, maxRaw] = slider.noUiSlider.get();
  const min = Math.round(minRaw);
  const max = Math.round(maxRaw);
  const dateChoisie = dateTrainEl.value;

  if (!gareDepart || !gareArrivee || gareDepart === gareArrivee) {
    afficherResultats([]);
    return;
  }

  // --- Trains directs ---
  const resultatsDirects = [];
  trains.forEach(train => {
    if (!estServiceActif(train.service_id, dateChoisie)) return;
    const idxDep = train.stops.indexOf(gareDepart);
    const idxArr = train.stops.indexOf(gareArrivee);
    if (idxDep === -1 || idxArr === -1 || idxDep >= idxArr) return;

    const hDepart = train.horaires[gareDepart];
    if (!hDepart) return;
    const minutesDepart = convertirEnMinutes(hDepart);
    if (minutesDepart === null || minutesDepart < min || minutesDepart > max) return;

    resultatsDirects.push({ type: "direct", trains: [train] });
  });

  // --- Correspondances (1 changement) ---
  const resultatsCorrespondance = [];

  // Parcours trains A passant par gareDepart
  trains.forEach(trainA => {
    if (!estServiceActif(trainA.service_id, dateChoisie)) return;
    const idxDepA = trainA.stops.indexOf(gareDepart);
    if (idxDepA === -1) return;

    // Parcours arr√™ts possibles pour correspondance apr√®s gareDepart
    for (let i = idxDepA + 1; i < trainA.stops.length; i++) {
      const garePivot = trainA.stops[i];
      const hArriveePivot = trainA.horaires[garePivot];
      if (!hArriveePivot) continue;

      const minutesArriveePivot = convertirEnMinutes(hArriveePivot);
      if (minutesArriveePivot === null) continue;

      // Chercher trains B partant de garePivot vers gareArrivee
      trains.forEach(trainB => {
        if (!estServiceActif(trainB.service_id, dateChoisie)) return;
        if (trainB === trainA) return; // √©viter m√™me train

        const idxPivotB = trainB.stops.indexOf(garePivot);
        const idxArrB = trainB.stops.indexOf(gareArrivee);
        if (idxPivotB === -1 || idxArrB === -1 || idxPivotB >= idxArrB) return;

        const hDepartPivotB = trainB.horaires[garePivot];
        if (!hDepartPivotB) return;

        const minutesDepartPivotB = convertirEnMinutes(hDepartPivotB);
        if (minutesDepartPivotB === null) return;

        // Temps attente correspondance
        const attente = minutesDepartPivotB - minutesArriveePivot;

        if (attente >= 5 && attente <= 45 && minutesArriveePivot >= min && minutesArriveePivot <= max) {
          resultatsCorrespondance.push({
            type: "correspondance",
            trains: [trainA, trainB],
            garePivot,
            attente
          });
        }
      });
    }
  });

  // Combine r√©sultats
  const tousResultats = [...resultatsDirects, ...resultatsCorrespondance];

  afficherResultats(tousResultats);
}

    // --- Affichage r√©sultats ---
    function afficherResultats(resultats) {
  resultatsEl.innerHTML = "";

  if (resultats.length === 0) {
    resultatsEl.innerHTML = "<p>Aucun train trouv√© pour cette recherche.</p>";
    return;
  }

  resultats.forEach(item => {
    const div = document.createElement("div");
    div.className = "carte-train";

    if (item.type === "direct") {
      const train = item.trains[0];
      div.innerHTML = `
        <div class="train-num">Train n¬∞${train.num} (Direct)</div>
        <div class="horaires">
          <span>D√©part:</span> ${formatHoraire(train.horaires[gareDepartEl.value])}<br/>
          <span>Arriv√©e:</span> ${formatHoraire(train.horaires[gareArriveeEl.value])}
        </div>
      `;
      div.addEventListener("click", () => toggleSelection(train.num, div));
    } else if (item.type === "correspondance") {
      const trainA = item.trains[0];
      const trainB = item.trains[1];
      const garePivotNom = garesParLigne.find(g => g.code === item.garePivot)?.nom || item.garePivot;
      div.innerHTML = `
        <div class="train-num">Correspondance via ${garePivotNom} (attente ${item.attente} min)</div>
        <div class="horaires">
          <b>Train 1 (D√©part ‚Üí ${garePivotNom})</b><br/>
          <span>Train n¬∞${trainA.num}</span><br/>
          <span>D√©part:</span> ${formatHoraire(trainA.horaires[gareDepartEl.value])}<br/>
          <span>Arriv√©e:</span> ${formatHoraire(trainA.horaires[item.garePivot])}<br/><br/>

          <b>Train 2 (${garePivotNom} ‚Üí Arriv√©e)</b><br/>
          <span>Train n¬∞${trainB.num}</span><br/>
          <span>D√©part:</span> ${formatHoraire(trainB.horaires[item.garePivot])}<br/>
          <span>Arriv√©e:</span> ${formatHoraire(trainB.horaires[gareArriveeEl.value])}
        </div>
      `;
      // Pour la s√©lection, on peut stocker une cl√© combin√©e (exemple : "A_num|B_num")
      div.addEventListener("click", () => {
        const cl√© = `corr|${trainA.num}|${trainB.num}`;
        if (selectionTrains.has(cl√©)) {
          selectionTrains.delete(cl√©);
          div.classList.remove("selected");
        } else {
          selectionTrains.add(cl√©);
          div.classList.add("selected");
        }
        afficherSelection();
      });
    }

    // Colorer si s√©lectionn√©
    if (item.type === "direct" && selectionTrains.has(item.trains[0].num)) {
      div.classList.add("selected");
    } else if (item.type === "correspondance") {
      const cl√© = `corr|${item.trains[0].num}|${item.trains[1].num}`;
      if (selectionTrains.has(cl√©)) div.classList.add("selected");
    }

    resultatsEl.appendChild(div);
  });
}
    // --- Afficher s√©lection ---
    function afficherSelection() {
  trainsSelectionnesEl.innerHTML = "";
  if (selectionTrains.size === 0) {
    trainsSelectionnesEl.innerHTML = "<li>Aucun train s√©lectionn√©</li>";
    return;
  }
  selectionTrains.forEach(id => {
    const li = document.createElement("li");
    li.className = "carte-train selected";
    if (id.startsWith("corr|")) {
      const [_, numA, numB] = id.split("|");
      li.textContent = `Correspondance: Train n¬∞${numA} + Train n¬∞${numB}`;
    } else {
      li.textContent = `Train n¬∞${id}`;
    }
    li.style.cursor = "pointer";
    li.title = "Cliquez pour retirer de la s√©lection";
    li.addEventListener("click", () => {
      selectionTrains.delete(id);
      afficherSelection();

      // Mets aussi √† jour la s√©lection visuelle dans la liste des r√©sultats si besoin
      document.querySelectorAll(".carte-train").forEach(card => {
        if (card.querySelector(".train-num")?.textContent.includes(id)) {
          card.classList.remove("selected");
        }
      });
    });
    trainsSelectionnesEl.appendChild(li);
  });
}

    // --- Gestion des selects ---
    function verifierBouton() {
      btnRechercher.disabled = !(gareDepartEl.value && gareArriveeEl.value && dateTrainEl.value);
    }

    gareDepartEl.addEventListener("change", () => {
      const departCode = gareDepartEl.value;
      if (!departCode) {
        gareArriveeEl.disabled = true;
        gareArriveeEl.innerHTML = `<option value="">-- Choisissez --</option>`;
      } else {
        gareArriveeEl.disabled = false;
        remplirSelectGares(gareArriveeEl, garesTriees, departCode);
      }
      verifierBouton();
    });

    gareArriveeEl.addEventListener("change", verifierBouton);
    dateTrainEl.addEventListener("change", verifierBouton);

    btnRechercher.addEventListener("click", () => {
      rechercherTrains();
    });


    // --- Slider noUiSlider ---
    noUiSlider.create(slider, {
      start: [360, 660],
      connect: true,
      step: 5,
      range: { min: 0, max: 1439 },
      format: {
        to: v => Math.round(v),
        from: v => Number(v)
      }
    });

    slider.noUiSlider.on("update", values => {
      const [min, max] = values.map(v => parseInt(v));
      heureText.textContent = `${formatTime(min)} ‚Üí ${formatTime(max)}`;
    });

    function formatTime(mins) {
      const h = String(Math.floor(mins / 60)).padStart(2, "0");
      const m = String(mins % 60).padStart(2, "0");
      return `${h}:${m}`;
    }

    function formatHoraire(horaire) {
  if (!horaire) return "";
  const parts = horaire.split(":");
  if (parts.length < 2) return horaire;
  // parts[0] = heure, parts[1] = minutes
  return `${parts[0].padStart(2, "0")}:${parts[1].padStart(2, "0")}`;
}
    // --- Initialisation ---
    const garesTriees = trierGaresPourSelect(garesParLigne);
    remplirSelectGares(gareDepartEl, garesTriees);
    gareArriveeEl.innerHTML = `<option value="">-- Choisissez --</option>`;
    gareArriveeEl.disabled = true;

    function setDateAujourdhui() {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      dateTrainEl.value = `${yyyy}-${mm}-${dd}`;
    }
    setDateAujourdhui();
    verifierBouton();

    // --- Chargement des fichiers GTFS via GitHub Pages ---
    async function chargerToutesDonneesGTFS() {
      try {
        const [trips, stops, stopTimes, calendar] = await Promise.all([
          chargerCsvGTFS("https://tekmate-lux.github.io/Assistant-train/data/trips.txt"),
          chargerCsvGTFS("https://tekmate-lux.github.io/Assistant-train/data/stops.txt"),
          chargerCsvGTFS("https://tekmate-lux.github.io/Assistant-train/data/stop_times.txt"),
          chargerCsvGTFS("https://tekmate-lux.github.io/Assistant-train/data/calendar_dates.txt"),
        ]);
        calendarDates = calendar;
        trains = construireTrains(trips, stopTimes, stops);
        console.log("Donn√©es GTFS charg√©es, trains construits :", trains.length);
      } catch (err) {
        console.error("Erreur chargement GTFS :", err);
      }
    }

    chargerToutesDonneesGTFS();

    function getSelectedTrains() {
  const selectedTrains = [];
  document.querySelectorAll('#trainsSelectionnes li.selected').forEach(el => {
    const text = el.textContent || "";
    const match = text.match(/Train n¬∞(\S+)/);
    if (match) selectedTrains.push(match[1]);
  });
  return selectedTrains;
}

  // Quand on clique sur le bouton Valider
  document.getElementById('btnValiderSelection').addEventListener('click', () => {
  const trainsChoisis = getSelectedTrains();

  if (trainsChoisis.length === 0) {
    alert('Veuillez s√©lectionner au moins un train.');
    return;
  }

  if (window.opener && !window.opener.closed) {
    // Injecte les num√©ros de train dans le champ de la page parente
    window.opener.document.getElementById('trainNumbers').value = trainsChoisis.join(',');

    // üîÅ Clique automatiquement sur le bouton "Afficher" (ID = loadTrains)
    const boutonAfficher = window.opener.document.getElementById('loadTrains');
    if (boutonAfficher) boutonAfficher.click();

    // Fermer la popup
    window.close();
  } else {
    alert("La fen√™tre parente n'est pas disponible.");
  }
});

  </script>

</body>
</html>
