<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>Informations Train SNCF</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: auto;
            padding: 1em;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        p {
            margin: 0.2em 0;
        }
        .suppression {
            color: red;
            text-decoration: line-through;
        }
        .nouvelle-gare {
            color: orange;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Informations sur des Trains SNCF</h1>

    <label for="trainNumbers">Numéros des trains (séparés par des virgules) :</label>
    <input type="text" id="trainNumbers" value="88530,88531" />
    <br /><br />

    <label for="trainDate">Date (YYYY-MM-DD) :</label>
    <input type="date" id="trainDate" value="2025-05-13" />
    <br /><br />

    <button id="getTrainData">Obtenir les données</button>

    <div id="trainInfo"></div>

    <script>
        $(document).ready(function () {
            $('#getTrainData').click(function () {
                const trainNumbers = $('#trainNumbers').val().split(',').map(num => num.trim());
                const trainDate = $('#trainDate').val();
                const apiKey = '242fac11-6d98-45fb-93df-28174d362447';
                const encodedApiKey = btoa(apiKey + ":");

                $('#trainInfo').html('');

                trainNumbers.forEach(function (trainNumber) {
                    const url = `https://api.sncf.com/v1/coverage/sncf/vehicle_journeys/vehicle_journey:SNCF:${trainDate}:${trainNumber}:1187:Train`;

                    $.ajax({
                        url: url,
                        method: 'GET',
                        headers: { 'Authorization': 'Basic ' + encodedApiKey },
                        success: function (response) {
                            if (!response.vehicle_journeys || response.vehicle_journeys.length === 0) {
                                $('#trainInfo').append(`<p>Pas de données disponibles pour le train ${trainNumber} à la date ${trainDate}.</p>`);
                                return;
                            }
                            const train = response.vehicle_journeys[0];
                            const disruptions = response.disruptions || [];
                            let effect = null;
                            let impactedStopsMap = {};

                            if (disruptions.length > 0) {
                                const disruption = disruptions[0];
                                effect = disruption.severity?.effect || null;
                                disruption.impacted_objects?.forEach(obj => {
                                    obj.impacted_stops?.forEach(stop => {
                                        impactedStopsMap[stop.stop_point.id] = {
                                            arrival_status: stop.arrival_status,
                                            departure_status: stop.departure_status,
                                            stop_time_effect: stop.stop_time_effect
                                        };
                                    });
                                });
                            }

                            const stops = train.stop_times;

                            // Trouver les indices de la nouvelle gare de départ et du nouveau terminus en cas de service réduit
                            let firstRealDepartureIndex = -1;
                            let lastRealArrivalIndex = -1;
                            stops.forEach((stop, index) => {
                                const impact = impactedStopsMap[stop.stop_point.id];
                                if (!impact || impact.departure_status !== "deleted") {
                                    if (firstRealDepartureIndex === -1) firstRealDepartureIndex = index;
                                }
                                if (!impact || impact.arrival_status !== "deleted") {
                                    lastRealArrivalIndex = index;
                                }
                            });

                            // Construction du HTML des arrêts
                            const stopHtml = stops.map((stop, index) => {
                                const id = stop.stop_point.id;
                                const name = stop.stop_point.name;
                                const baseArrival = formatTime(stop.arrival_time);
                                const baseDeparture = formatTime(stop.departure_time);
                                let arrival = baseArrival;
                                let departure = baseDeparture;
                                const impact = impactedStopsMap[id];

                                // Définir l'état du texte (barré ou non) et la couleur
                                let barrerLigne = false;
                                let barrerArrivee = false;
                                let barrerDepart = false;
                                let couleur = '';

                                const estSupprime = impact && impact.stop_time_effect === "deleted";
                                const arriveeSupprimee = impact && impact.arrival_status === "deleted";
                                const departSupprime = impact && impact.departure_status === "deleted";
                                const aDel = arriveeSupprimee;
                                const dDel = departSupprime;
                                const dUnchanged = impact?.departure_status === "unchanged";
                                const aUnchanged = impact?.arrival_status === "unchanged";
                                const stopDel = estSupprime;

                                // Cas de perturbations majeures
                                if (effect === "NO_SERVICE") {
                                    barrerLigne = true;
                                    couleur = 'red';
                                } 
                                else if (effect === "REDUCED_SERVICE") {
                                    // Nouvelle gare de départ (premier arrêt actif)
                                    if (stopDel && aDel && dUnchanged && index === firstRealDepartureIndex && index !== 0) {
                                        return `<p class="nouvelle-gare">${name} - Départ: <strong>${departure}</strong> (Nouvelle gare de départ)</p>`;
                                    }
                                    // Nouveau terminus (dernier arrêt actif)
                                    if (stopDel && dDel && aUnchanged && index === lastRealArrivalIndex && index !== stops.length - 1) {
                                        return `<p class="nouvelle-gare">${name} - Arrivée: <strong>${arrival}</strong> (Nouveau terminus)</p>`;
                                    }
                                    // Barrer tous les arrêts avant la nouvelle gare de départ et après le nouveau terminus, ou supprimés
                                    if (index < firstRealDepartureIndex || index > lastRealArrivalIndex || estSupprime) {
                                        barrerLigne = true;
                                        couleur = 'red';
                                    } else {
                                        // Barrer uniquement l'arrivée ou le départ si supprimé
                                        if (aDel) barrerArrivee = true;
                                        if (dDel) barrerDepart = true;
                                    }
                                }

                                // Construction du texte barré ou normal
                                if (barrerLigne) {
                                    return `<p style="color:${couleur}; text-decoration:line-through;">${name} - Arrivée: ${arrival} - Départ: ${departure}</p>`;
                                } else {
                                    if (barrerArrivee) arrival = `<span class="suppression">${arrival}</span>`;
                                    if (barrerDepart) departure = `<span class="suppression">${departure}</span>`;
                                    return `<p>${name} - Arrivée: ${arrival} - Départ: ${departure}</p>`;
                                }
                            }).join('');

                        // --- Encadré perturbations avec couleurs et icônes (sans statut) ---
                        let disruptionHtml = '';
                        if (effect) {
                            const cause = disruptions[0].messages?.[0]?.text || 'Non précisée';
                            let effetTraduit = effect;
                            let boxClass = '';
                            let icon = '';

                            if (effect === 'NO_SERVICE') {
                                effetTraduit = 'Suppression totale';
                                boxClass = 'red';
                                icon = '❌';
                            } else if (effect === 'REDUCED_SERVICE') {
                                effetTraduit = 'Suppression partielle';
                                boxClass = 'red';
                                icon = '⚠️';
                            } else if (effect === 'SIGNIFICANT_DELAYS') {
                                effetTraduit = 'Retard important';
                                boxClass = 'orange';
                                icon = '⏰';
                            } else {
                                boxClass = 'orange';
                                icon = '⚠️';
                            }

                            $('#trainInfo').append(`
                                ${disruptionHtml}
                                <h2>Arrêts du train ${train.name} :</h2>
                                ${stopHtml}
                                <hr />
                            `);
                        },
                        error: function () {
                            $('#trainInfo').append(`<p>Erreur lors de la récupération des données pour le train ${trainNumber}. Vérifiez le numéro et la date.</p>`);
                        }
                    });
                });

                function formatTime(t) {
                    if (!t) return '-';
                    return t.substring(0, 2) + ':' + t.substring(2, 4);
                }
            });
        });
    </script>
</body>
</html>
