<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Détails du train SNCF</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 1rem;
    background: #f9f9f9;
  }
  form {
    margin-bottom: 1rem;
  }
  input, button {
    font-size: 1rem;
    padding: 0.3rem 0.6rem;
    margin-right: 0.5rem;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
  }
  th, td {
    padding: 0.5rem;
    border-bottom: 1px solid #ccc;
    text-align: left;
  }
  .gare-depart, .gare-terminus {
    color: #0055cc;
    font-weight: bold;
  }
  .deleted {
    color: #cc0000;
    text-decoration: line-through;
  }
  .deleted-row td {
    color: #cc0000;
    text-decoration: line-through;
  }
  .partial-row td {
    color: #cc0000;
    text-decoration: line-through;
  }
  .delay-text {
    color: #cc6600;
    font-weight: bold;
    text-align: right;
  }
  .delay-strike {
    text-decoration: line-through;
    color: #cc0000;
  }
</style>
</head>
<body>

<h1>Détails d’un train SNCF</h1>

<form id="trainForm">
  <label for="trainNumber">Numéro de train :</label>
  <input type="text" id="trainNumber" required placeholder="ex: 8651" />
  <label for="trainDate">Date :</label>
  <input type="date" id="trainDate" required />
  <button type="submit">Afficher</button>
</form>

<div id="result"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$('#trainForm').on('submit', function(e) {
  e.preventDefault();

  const trainNumber = $('#trainNumber').val().trim();
  const trainDate = $('#trainDate').val();

  if (!trainNumber || !trainDate) {
    alert("Merci de saisir le numéro de train et la date.");
    return;
  }

  // Fonction pour formater l'heure hh:mm depuis un timestamp ISO
  function formatTime(iso) {
    if (!iso) return '';
    const d = new Date(iso);
    if (isNaN(d)) return '';
    return d.toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});
  }

  // Effacer résultat précédent
  $('#result').html('<p>Chargement...</p>');

  // Requête vers l'API SNCF avec ta clé
  fetch(`https://api.sncf.com/v1/coverage/sncf/vehicle_journeys/sncf:${trainNumber}/stop_times?date=${trainDate}`, {
    headers: {
      'Authorization': 'Basic ' + btoa('242fac11-6d98-45fb-93df-28174d362447:')
    }
  })
  .then(resp => {
    if (!resp.ok) throw new Error('Erreur API');
    return resp.json();
  })
  .then(data => {
    const stopTimes = data.stop_times;
    if (!stopTimes || stopTimes.length === 0) {
      $('#result').html('<p>Aucun arrêt trouvé pour ce train à cette date.</p>');
      return;
    }

    let newDepartureIndex = 0;
    let partialService = false;

    for (let i = 0; i < stopTimes.length; i++) {
      const st = stopTimes[i];
      if (st.departure_status && st.departure_status !== 'deleted') {
        newDepartureIndex = i;
        break;
      }
    }
    partialService = stopTimes.slice(0, newDepartureIndex).some(st => st.departure_status === 'deleted');

    const firstStop = stopTimes[0];
    const lastStop = stopTimes[stopTimes.length -1];
    const originId = firstStop.stop_point && firstStop.stop_point.id;
    const terminusId = lastStop.stop_point && lastStop.stop_point.id;

    let html = '<table><thead><tr><th>Gare</th><th>Horaire</th><th>Retard</th></tr></thead><tbody>';

    stopTimes.forEach((st, index) => {
      const gareName = st.stop_point && st.stop_point.name ? st.stop_point.name : 'N/A';

      const isDeleted = st.departure_status === 'deleted';
      const isPartialDeleted = partialService && index < newDepartureIndex;
      const isNewDeparture = index === newDepartureIndex && partialService;
      const isOrigin = index === 0;
      const isTerminus = index === stopTimes.length -1;

      let rowClass = '';
      if (isDeleted || isPartialDeleted) rowClass = 'deleted-row';
      if (isPartialDeleted) rowClass = 'partial-row';

      let gareClass = '';
      if (isNewDeparture) gareClass = 'gare-depart';
      else if (isOrigin) gareClass = 'gare-depart';
      else if (isTerminus) gareClass = 'gare-terminus';

      let displayedTime = '';
      if (isOrigin) {
        displayedTime = formatTime(st.departure_time);
      } else if (isTerminus) {
        displayedTime = formatTime(st.arrival_time);
      } else {
        displayedTime = formatTime(st.arrival_time);
      }

      let delayMinutes = 0;
      let delayText = '';
      if (st.departure_delay && st.departure_delay !== 0) {
        delayMinutes = Math.round(st.departure_delay / 60);
        delayText = (delayMinutes > 0 ? '+' : '') + delayMinutes + ' min';
      } else if (st.arrival_delay && st.arrival_delay !== 0) {
        delayMinutes = Math.round(st.arrival_delay / 60);
        delayText = (delayMinutes > 0 ? '+' : '') + delayMinutes + ' min';
      }

      const tr = $('<tr></tr>').addClass(rowClass);
      const tdStation = $('<td></td>').text(gareName).addClass(gareClass);
      const tdTime = $('<td></td>').text(displayedTime);
      const tdDelay = $('<td></td>');

      if (delayText) {
        tdDelay.text(delayText).addClass('delay-text');
      }

      if (rowClass === 'deleted-row' || rowClass === 'partial-row') {
        tdStation.addClass('deleted');
        tdTime.addClass('delay-strike');
        tdDelay.addClass('delay-strike');
      }

      tr.append(tdStation, tdTime, tdDelay);
      html += $('<div>').append(tr).html();
    });

    html += '</tbody></table>';
    $('#result').html(html);

  })
  .catch(err => {
    console.error(err);
    $('#result').html('<p>Erreur lors de la récupération des données. Vérifiez le numéro de train, la date et votre connexion API.</p>');
  });

});
</script>

</body>
</html>
