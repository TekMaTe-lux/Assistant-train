<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Détails du Train</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f0f4f8;
      color: #333;
      padding: 2em;
      max-width: 900px;
      margin: auto;
    }
    h1 {
      text-align: center;
      color: #003366;
    }
    form {
      display: flex;
      justify-content: center;
      gap: 1em;
      margin-bottom: 2em;
      flex-wrap: wrap;
    }
    input, button {
      padding: 0.6em 1em;
      font-size: 1em;
      border-radius: 0.5em;
      border: 1px solid #ccc;
    }
    button {
      background-color: #0066cc;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #004999;
    }
    .retard {
      color: orange;
      font-weight: bold;
    }
    .supprime {
      text-decoration: line-through;
      color: red;
    }
    .nouveau-depart, .nouveau-terminus {
      font-weight: bold;
      color: #006600;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 2em;
      background-color: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 1em;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }
    th {
      background-color: #e6f0ff;
    }
  </style>
</head>
<body>
  <h1>Détails du Train</h1>
  <form id="trainForm">
    <input type="text" id="trainNumber" placeholder="Numéro de train" required>
    <input type="date" id="date" required>
    <button type="submit">Rechercher</button>
  </form>
  <div id="result"></div>

  <script>
    document.getElementById("trainForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const trainNumber = document.getElementById("trainNumber").value;
      const date = document.getElementById("date").value;
      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = "Chargement...";

      try {
        const response = await fetch(`/api/train?number=" + trainNumber + "&date=" + date);
        const data = await response.json();

        if (!data || !data.stop_times) {
          resultDiv.innerHTML = "Aucun résultat trouvé.";
          return;
        }

        const stops = data.stop_times;
        const status = data.status;
        const cause = data.cause;

        let html = "";

        if (status === "CANCELLED") {
          html += `<p class='supprime'>Train supprimé - ${cause || "cause inconnue"}</p>`;
        }

        if (status === "REDUCED_SERVICE") {
          html += `<p class='retard'>Service réduit - ${cause || "cause inconnue"}</p>`;
        }

        html += `<table><thead><tr><th>Gare</th><th>Arrivée</th><th>Départ</th><th>Retard</th></tr></thead><tbody>`;

        let nouvelleGareTrouvee = false;
        let nouvelleGareDepart = null;

        if (status === "REDUCED_SERVICE") {
          nouvelleGareDepart = stops.find(s => s.departure_status !== "deleted");
        }

        for (const stop of stops) {
          const isDeleted = stop.arrival_status === "deleted" && stop.departure_status === "deleted";
          const isNewStart = nouvelleGareDepart && stop.stop_id === nouvelleGareDepart.stop_id;

          html += `<tr class='${isDeleted ? "supprime" : ""}'>`;
          html += `<td class='${isNewStart ? "nouveau-depart" : ""}'>${stop.stop_name}</td>`;
          html += `<td>${stop.arrival_time || "-"}</td>`;
          html += `<td>${stop.departure_time || "-"}</td>`;
          html += `<td>${stop.arrival_delay ? `<span class='retard'>+${Math.round(stop.arrival_delay / 60)} min</span>` : "-"}</td>`;
          html += `</tr>`;
        }

        html += `</tbody></table>`;
        resultDiv.innerHTML = html;
      } catch (err) {
        console.error(err);
        resultDiv.innerHTML = "Erreur lors de la récupération des données.";
      }
    });
  </script>
</body>
</html>
