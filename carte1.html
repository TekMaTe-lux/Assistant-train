<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Carte des trains (GTFS statique CFL + SNCF)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root { color-scheme: dark; }
    body {
      margin: 0;
      background: radial-gradient(1200px 800px at 12% 16%, rgba(0, 240, 255, 0.1), transparent),
        radial-gradient(1000px 680px at 88% 10%, rgba(160, 255, 0, 0.08), transparent),
        linear-gradient(135deg, #050b15, #060c18 45%, #081222);
      color: #e6f1ff;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      min-height: 100vh;
    }
    header {
      position: sticky;
      top: 0;
      z-index: 1100;
      padding: 14px 16px;
      background: linear-gradient(135deg, rgba(10, 16, 28, 0.95), rgba(7, 12, 22, 0.9));
      border-bottom: 1px solid #1b2b42;
      box-shadow: 0 10px 26px rgba(0, 0, 0, 0.35);
    }
    .hero {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 12px;
      align-items: center;
    }
    .hero h1 {
      margin: 0;
      font-size: 20px;
      letter-spacing: 0.01em;
    }
    .hero p {
      margin: 2px 0 0;
      color: #9eb7d7;
      font-size: 13px;
    }
    .badges {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 6px;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid #2a3b55;
      background: rgba(12, 18, 30, 0.9);
      color: #d6e6ff;
      font-size: 12px;
    }
    .badge span { font-weight: 700; color: #a0ff00; }
    #map { height: calc(100vh - 120px); }
    .leaflet-popup-content-wrapper { background: #0c1422; color: #e6f1ff; border: 1px solid #20324b; }
    .leaflet-popup-tip { background: #0c1422; }
    .legend {
      position: fixed;
      bottom: 14px;
      right: 14px;
      z-index: 1200;
      padding: 10px 12px;
      background: rgba(10, 16, 28, 0.92);
      border: 1px solid #1f324b;
      border-radius: 10px;
      box-shadow: 0 10px 22px rgba(0, 0, 0, 0.35);
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 210px;
    }
    .legend-row { display: flex; align-items: center; gap: 8px; font-size: 13px; }
    .legend-dot { width: 12px; height: 12px; border-radius: 50%; }
    .dot-sncf { background: #00f0ff; box-shadow: 0 0 10px rgba(0, 240, 255, 0.5); }
    .dot-cfl { background: #ff5fc7; box-shadow: 0 0 10px rgba(255, 95, 199, 0.45); }
    .dot-stop { background: #a0ff00; box-shadow: 0 0 10px rgba(160, 255, 0, 0.45); }
    .controls { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
    .pill {
      padding: 8px 12px;
      border-radius: 12px;
      background: rgba(13, 20, 33, 0.92);
      border: 1px solid #23344f;
      color: #cfe0ff;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 10px 22px rgba(0,0,0,0.25);
    }
    .pill strong { color: #a0ff00; }
    @media (max-width: 800px) {
      header { position: static; }
      .hero { grid-template-columns: 1fr; }
      #map { height: calc(100vh - 220px); }
    }
  </style>
</head>
<body>
  <header>
    <div class="hero">
      <div>
        <h1>Carte des trains — horaires théoriques GTFS</h1>
        <p>Données statiques CFL & SNCF, positions interpolées entre deux arrêts sur la base des horaires du jour.</p>
        <div class="badges">
          <span class="badge">Mise à jour auto <span>30s</span></span>
          <span class="badge">Source GTFS <span>data/</span></span>
          <span class="badge">Basé sur la carte <span>labetaillere.fr</span></span>
        </div>
      </div>
      <div class="controls">
        <div class="pill" id="active-count">Trains en ligne : <strong>—</strong></div>
        <div class="pill" id="time-indicator">Heure locale : <strong>--:--:--</strong></div>
      </div>
    </div>
  </header>
  <div id="map"></div>
  <div class="legend">
    <div class="legend-row"><span class="legend-dot dot-sncf"></span><span>SNCF</span></div>
    <div class="legend-row"><span class="legend-dot dot-cfl"></span><span>CFL</span></div>
    <div class="legend-row"><span class="legend-dot dot-stop"></span><span>Gares & arrêts</span></div>
  </div>
  <script>
    const map = L.map('map', {
      worldCopyJump: true,
      zoomControl: true,
      attributionControl: true
    }).setView([48.7, 6.18], 7);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 17,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const stopsLayer = L.layerGroup().addTo(map);
    const trainsLayer = L.layerGroup().addTo(map);

    const files = ['stops', 'stop_times', 'trips', 'routes'];

    const parseCSVLine = (line) => {
      const cells = [];
      let current = '';
      let insideQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          if (insideQuotes && line[i + 1] === '"') { current += '"'; i++; }
          else { insideQuotes = !insideQuotes; }
        } else if (char === ',' && !insideQuotes) {
          cells.push(current); current = '';
        } else {
          current += char;
        }
      }
      cells.push(current);
      return cells;
    };

    const parseCSV = (text) => {
      const lines = text.trim().split(/\r?\n/);
      const headers = parseCSVLine(lines.shift());
      return lines.map(line => {
        const cols = parseCSVLine(line);
        const obj = {};
        headers.forEach((h, idx) => obj[h] = cols[idx]);
        return obj;
      });
    };

    const timeToSeconds = (t) => {
      if (!t) return null;
      const [h, m, s] = t.split(':').map(Number);
      return h * 3600 + m * 60 + s;
    };

    const stopsById = new Map();
    const routesById = new Map();
    const tripsById = new Map();
    const stopTimesByTrip = new Map();

    async function loadData() {
      const texts = await Promise.all(files.map(name => fetch(`data/${name}.txt`).then(r => r.text())));
      const [stopsRaw, stopTimesRaw, tripsRaw, routesRaw] = texts.map(parseCSV);

      stopsRaw.forEach(stop => {
        stopsById.set(stop.stop_id, {
          id: stop.stop_id,
          name: stop.stop_name,
          lat: parseFloat(stop.stop_lat),
          lon: parseFloat(stop.stop_lon)
        });
        L.circleMarker([stop.stop_lat, stop.stop_lon], {
          radius: 4,
          color: '#a0ff00',
          weight: 1,
          fillOpacity: 0.9,
          opacity: 0.7
        }).addTo(stopsLayer).bindPopup(`<strong>${stop.stop_name}</strong>`);
      });

      routesRaw.forEach(route => {
        routesById.set(route.route_id, {
          id: route.route_id,
          shortName: route.route_short_name || route.route_long_name,
          longName: route.route_long_name || route.route_short_name,
          agency: route.agency_id
        });
      });

      tripsRaw.forEach(trip => {
        tripsById.set(trip.trip_id, {
          id: trip.trip_id,
          routeId: trip.route_id,
          headsign: trip.trip_headsign || '',
          serviceId: trip.service_id
        });
      });

      stopTimesRaw.forEach(st => {
        const trip = stopTimesByTrip.get(st.trip_id) || [];
        trip.push({
          stopId: st.stop_id,
          arrival: timeToSeconds(st.arrival_time),
          departure: timeToSeconds(st.departure_time),
          sequence: Number(st.stop_sequence)
        });
        stopTimesByTrip.set(st.trip_id, trip);
      });

      stopTimesByTrip.forEach((stops, key) => stops.sort((a, b) => a.sequence - b.sequence));
      updateClock();
      updateTrains();
      setInterval(updateTrains, 30000);
      setInterval(updateClock, 1000);
    }

    function inferOperator(routeId, agencyId) {
      if (agencyId && String(agencyId).toLowerCase().includes('cfl')) return 'CFL';
      if (routeId && routeId.toLowerCase().includes('cfl')) return 'CFL';
      if (routeId && routeId.toLowerCase().includes('lux')) return 'CFL';
      return 'SNCF';
    }

    function formatTime(seconds) {
      if (seconds == null) return '--:--';
      const h = Math.floor(seconds / 3600) % 24;
      const m = Math.floor((seconds % 3600) / 60);
      const s = Math.floor(seconds % 60);
      return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }

    function updateClock() {
      const now = new Date();
      const text = now.toLocaleTimeString('fr-FR', { hour12: false });
      document.getElementById('time-indicator').querySelector('strong').textContent = text;
    }

    function updateTrains() {
      trainsLayer.clearLayers();
      const now = new Date();
      const nowSeconds = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
      let activeCount = 0;

      stopTimesByTrip.forEach((stops, tripId) => {
        if (!stops || stops.length < 2) return;
        for (let i = 0; i < stops.length - 1; i++) {
          const current = stops[i];
          const next = stops[i + 1];
          if (current.departure == null || next.arrival == null) continue;
          if (nowSeconds < current.departure || nowSeconds > next.arrival) continue;

          const elapsed = nowSeconds - current.departure;
          const segment = Math.max(next.arrival - current.departure, 1);
          const progress = Math.min(Math.max(elapsed / segment, 0), 1);

          const startStop = stopsById.get(current.stopId);
          const endStop = stopsById.get(next.stopId);
          if (!startStop || !endStop) continue;

          const lat = startStop.lat + (endStop.lat - startStop.lat) * progress;
          const lon = startStop.lon + (endStop.lon - startStop.lon) * progress;

          const trip = tripsById.get(tripId);
          const route = trip ? routesById.get(trip.routeId) : null;
          const operator = inferOperator(trip?.routeId, route?.agency);

          const color = operator === 'CFL' ? '#ff5fc7' : '#00f0ff';
          const icon = L.divIcon({
            className: 'train-marker',
            html: `<div style="display:flex;align-items:center;gap:6px;padding:6px 10px;border-radius:10px;border:1px solid ${color};background:rgba(12,18,30,0.92);color:${color};box-shadow:0 0 14px ${color}55;">
              <span style="font-weight:800;">${route?.shortName || 'Train'}</span>
              <span style="color:#e6f1ff;">${trip?.headsign || ''}</span>
            </div>`,
            iconSize: [1, 1],
            iconAnchor: [16, 16]
          });

          const popup = [`<strong>${route?.longName || route?.shortName || 'Train'}</strong>`,
            trip?.headsign ? `<div>${trip.headsign}</div>` : '',
            `<div>Opérateur : <strong>${operator}</strong></div>`,
            `<div>Segment : ${startStop.name} → ${endStop.name}</div>`,
            `<div>Heures : ${formatTime(current.departure)} → ${formatTime(next.arrival)}</div>`
          ].join('');

          L.marker([lat, lon], { icon }).addTo(trainsLayer).bindPopup(popup);
          activeCount++;
          break;
        }
      });

      document.getElementById('active-count').querySelector('strong').textContent = activeCount.toString();
    }

    loadData().catch(err => {
      console.error(err);
      alert("Impossible de charger les données GTFS. Vérifiez le dossier data/.");
    });
  </script>
</body>
</html>
