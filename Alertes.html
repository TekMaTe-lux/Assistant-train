<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Arrivées à Luxembourg</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    .train {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h1>Trains arrivant à Luxembourg</h1>
  <div id="trains">Chargement...</div>

  <script>
    const apiKey = "242fac11-6d98-45fb-93df-28174d362447";
    const luxId = "stop_area:SNCF:82001000";
    const date = new Date().toISOString().split("T")[0].replace(/-/g, '');
    const endpoint = `https://api.sncf.com/v1/coverage/sncf/stop_areas/82001000/arrivals?from_datetime=${date}T060000&duration=7200`;

    async function getStopAreaName(stopAreaId) {
      const url = `https://api.sncf.com/v1/coverage/sncf/${stopAreaId}`;
      const response = await fetch(url, {
        headers: { Authorization: `Basic ${btoa(apiKey + ":")}` }
      });
      if (!response.ok) return "Inconnu";
      const data = await response.json();
      return data.stop_area?.label || "Inconnu";
    }

    async function fetchArrivals() {
      const response = await fetch(endpoint, {
        headers: { Authorization: `Basic ${btoa(apiKey + ":")}` }
      });
      const data = await response.json();
      const arrivals = data.arrivals || [];
      const container = document.getElementById("trains");
      container.innerHTML = "";

      for (const train of arrivals) {
        const dt = train.stop_date_time?.arrival_date_time;
        const hour = dt ? `${dt.slice(9, 11)}h${dt.slice(11, 13)}` : "Heure inconnue";
        const num = train.display_informations?.headsign || "Numéro inconnu";

        const originLink = train.links?.find(l => l.rel === "origins" && l.type === "stop_area");
        let provenance = "Provenance inconnue";

        if (originLink) {
          provenance = await getStopAreaName(originLink.id);
        }

        const el = document.createElement("div");
        el.className = "train";
        el.textContent = `✅ ${num} à ${hour} — Provenance : ${provenance} — Statut : À l'heure`;
        container.appendChild(el);
      }
    }

    fetchArrivals();
  </script>
</body>
</html>
