<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>Détails Train</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #222;
            color: white;
            margin: 20px;
        }
        h2 {
            color: white;
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid white;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #555;
            color: white;
        }
        tr.deleted td {
            color: #ff5555;
            text-decoration: line-through;
            font-style: italic;
        }
        tr.new-start td {
            color: #44aaff;
            font-weight: bold;
        }
        tr.new-end td {
            color: #44aaff;
            font-weight: bold;
        }
        .delayed {
            color: orange;
            font-weight: bold;
            margin-left: 5px;
        }
        .delay-strike {
            text-decoration: line-through;
            color: #888;
        }
        .disruption-box {
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
        }
        .disruption-box.red {
            background-color: #aa2222;
            color: white;
        }
        .disruption-box.orange {
            background-color: #cc6600;
            color: white;
        }
        .disruption-icon {
            font-size: 1.5em;
        }
    </style>
</head>
<body>
    <div id="trainInfo"><em>Chargement des informations...</em></div>

    <script>
        // Fonction utilitaire pour calculer un retard en minutes (arrivée ou départ)
        function computeDelay(baseTime, amendedTime) {
            if (!baseTime || !amendedTime) return 0;
            const base = new Date(baseTime);
            const amended = new Date(amendedTime);
            const diffMs = amended - base;
            return Math.round(diffMs / 60000);
        }

        $(document).ready(function () {
            // Simulons ici la récupération des paramètres via URL ou autre (exemple statique)
            const trainNumber = '12345';
            const trainDate = '2023-05-15';

            // Exemple d'URL API SNCF (à adapter)
            const apiUrl = `https://api.sncf.com/v1/coverage/sncf/vehicle_journeys/${trainNumber}@${trainDate}/stop_times?` +
                'key=VOTRE_CLE_API';

            // Appel Ajax (simulation pour exemple ici)
            // Remplacer par $.ajax réel avec clé API valide
            $.ajax({
                url: apiUrl,
                dataType: 'json',
                success: function (data) {
                    // Extraction des arrêts
                    const stops = data.stop_times || [];
                    const disruptions = data.disruptions || [];

                    // Détection première nouvelle gare de départ (service réduit)
                    let firstRealDepartureIndex = 0;
                    stops.forEach((stop, i) => {
                        if (stop.departure_status && stop.departure_status !== 'deleted' && stop.is_new_departure) {
                            firstRealDepartureIndex = i;
                        }
                    });

                    // Construction des lignes du tableau
                    const rowsHtml = stops.map((stop, index) => {
                        const name = stop.stop_point?.name || "Inconnu";
                        const baseDeparture = stop.departure_time ? stop.departure_time.substring(11,16) : "";
                        const baseArrival = stop.arrival_time ? stop.arrival_time.substring(11,16) : "";
                        const impact = stop.impact || {};
                        const stopDel = stop.departure_status === 'deleted';

                        let departureDisplay = baseDeparture;
                        let arrivalDisplay = baseArrival;
                        let delayDisplay = "";
                        let statusDisplay = "";

                        // Gestion suppression avant nouvelle gare de départ
                        if (stopDel && index < firstRealDepartureIndex) {
                            return `<tr class="deleted"><td>${name}</td><td>${baseDeparture}</td><td></td><td>Supprimé</td></tr>`;
                        }

                        // Nouvelle gare de départ
                        if (stop.is_new_departure) {
                            statusDisplay = "Nouveau départ";
                            return `<tr class="new-start"><td>${name}</td><td>${baseDeparture}</td><td></td><td>${statusDisplay}</td></tr>`;
                        }

                        // Nouvelle gare de terminus
                        if (stop.is_new_terminus) {
                            statusDisplay = "Nouveau terminus";
                            return `<tr class="new-end"><td>${name}</td><td>${baseDeparture}</td><td></td><td>${statusDisplay}</td></tr>`;
                        }

                        // Retard calculé sur départ
                        if (impact.amended_departure_time && impact.amended_departure_time !== stop.departure_time) {
                            const delay = computeDelay(stop.departure_time, impact.amended_departure_time);
                            delayDisplay = `<span class="delayed">+${delay} min</span>`;
                            departureDisplay = `<span class="delay-strike">${baseDeparture}</span>`;
                        }

                        // Retard calculé sur arrivée (on pourrait l’afficher aussi si besoin)

                        // Si suppression simple (hors service réduit avant nouvelle gare)
                        if (stopDel) {
                            return `<tr class="deleted"><td>${name}</td><td>${baseDeparture}</td><td></td><td>Supprimé</td></tr>`;
                        }

                        return `<tr><td>${name}</td><td>${departureDisplay}</td><td>${delayDisplay}</td><td>${statusDisplay}</td></tr>`;
                    }).join("");

                    // Affichage perturbations globales
                    let disruptionHtml = "";
                    if (disruptions.length > 0) {
                        disruptions.forEach(d => {
                            const severity = d.severity?.effect || "INFORMATION";
                            let colorClass = "orange";
                            let icon = "⚠️";

                            if (severity === "NO_SERVICE") {
                                colorClass = "red";
                                icon = "❌";
                            } else if (severity === "REDUCED_SERVICE") {
                                colorClass = "orange";
                                icon = "⚠️";
                            }

                            disruptionHtml += `
                                <div class="disruption-box ${colorClass}">
                                    <div class="disruption-icon">${icon}</div>
                                    <div>
                                        <strong>${d.title || "Perturbation"}</strong><br/>
                                        ${d.description || ""}
                                    </div>
                                </div>
                            `;
                        });
                    }

                    const finalHtml = `
                        ${disruptionHtml}
                        <h2>Arrêts du train ${trainNumber} le ${trainDate}</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Gare</th>
                                    <th>Heure de départ</th>
                                    <th>Retard</th>
                                    <th>Statut</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rowsHtml}
                            </tbody>
                        </table>
                    `;
                    $('#trainInfo').html(finalHtml);
                },
                error: function () {
                    $('#trainInfo').html('<p class="deleted">Erreur lors de la récupération des données. Veuillez réessayer plus tard.</p>');
                }
            });
        });
    </script>
</body>
</html>
