<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Départs Bus CFL</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    label { margin-right: 10px; }
    select, input, button { margin: 5px 0; padding: 5px; }
    .results { margin-top: 20px; }
    li { margin-bottom: 12px; padding: 8px; border-bottom: 1px solid #ddd; }
    .retard { color: red; font-weight: bold; }
    .a-heure { color: green; font-weight: bold; }
    .datetime-container { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
  </style>
</head>
<body>
  <h2>Départs Bus CFL en temps réel</h2>

  <!-- Sélecteur de lignes de bus -->
  <label for="lines">Sélectionner les lignes :</label>
  <label><input type="checkbox" id="L60" checked>L60</label>
  <label><input type="checkbox" id="L61" checked>L61</label>
  <label><input type="checkbox" id="L62" checked>L62</label>
  <label><input type="checkbox" id="L90" checked>L90</label>
  <br><br>

  <!-- Intervalle -->
  <label for="interval">Intervalle :</label>
  <select id="interval" onchange="reloadDepartures()">
    <option value="30">30 min</option>
    <option value="60">1 heure</option>
    <option value="120" selected>2 heures</option>
    <option value="180">3 heures</option>
  </select>
  <br><br>

  <!-- Choix d'une date/heure avec boutons -->
  <div class="datetime-container">
    <label for="datetime">Date et heure :</label>
    <input type="datetime-local" id="datetime">
    <button onclick="loadDeparturesCustom()">Afficher</button>
    <button onclick="loadDeparturesNow()">Revenir aux prochains départs</button>
  </div>

  <div class="results" id="results">Sélectionnez une gare pour afficher les départs...</div>

  <script>
    const API_KEY = "58ef9a71-6837-4405-bd5d-23beaf92864c";
    const STATION_ID = "200405036"; // Gare routière de Luxembourg

    // Initialise la valeur par défaut de datetime-local
    function setDefaultDatetime() {
      const dtInput = document.getElementById('datetime');
      const now = new Date();
      const localISO = new Date(now.getTime() - now.getTimezoneOffset()*60000).toISOString().slice(0,16);
      dtInput.value = localISO;
    }

    setDefaultDatetime();

    async function loadDepartures(stationId, dateStr, timeStr) {
      const interval = document.getElementById("interval").value;
      const lines = [];
      if (document.getElementById("L60").checked) lines.push("L60");
      if (document.getElementById("L61").checked) lines.push("L61");
      if (document.getElementById("L62").checked) lines.push("L62");
      if (document.getElementById("L90").checked) lines.push("L90");

      if (!stationId || lines.length === 0) {
        document.getElementById("results").innerHTML = "Veuillez choisir au moins une ligne.";
        return;
      }

      const url = `https://cdt.hafas.de/opendata/apiserver/departureBoard?accessId=${API_KEY}&id=${stationId}&date=${dateStr}&time=${timeStr}&duration=${interval}&maxJourneys=200&format=json`;

      try {
        const response = await fetch(url);
        const data = await response.json();

        if (!data.Departure || data.Departure.length === 0) {
          document.getElementById("results").innerHTML = "Aucun départ trouvé.";
          return;
        }

        let html = "<h3>Départs :</h3><ul>";
        data.Departure.forEach(dep => {
          if (!lines.includes(dep.name)) return;

          let statut = `<span class="a-heure">À l'heure</span>`;
          let depTime = dep.time;

          if (dep.rtTime && dep.rtTime !== dep.time) {
            depTime = dep.rtTime;
            const scheduled = new Date(`${dep.date}T${dep.time}`);
            const real = new Date(`${dep.rtDate || dep.date}T${dep.rtTime}`);
            const diffMin = Math.round((real - scheduled) / 60000);
            statut = `<span class="retard">Retardé à ${dep.rtTime} (${diffMin > 0 ? '+'+diffMin+' min' : diffMin+' min'})</span>`;
          }

          html += `<li>
            <b>${dep.name}</b> vers ${dep.direction}<br>
            Départ prévu : ${dep.time} (${dep.date})<br>
            Voie : ${dep.rtTrack ? dep.rtTrack : "?"}<br>
            Catégorie : ${dep.ProductAtStop?.catOut || "?"}<br>
            Statut : ${statut}<br>
          </li>`;
        });
        html += "</ul>";

        document.getElementById("results").innerHTML = html;
      } catch (e) {
        console.error(e);
        document.getElementById("results").innerHTML = "Erreur de chargement des données.";
      }
    }

    // Prochains départs à partir de maintenant
    function loadDeparturesNow() {
      const now = new Date();
      const dateStr = now.toISOString().split("T")[0];
      const timeStr = now.toTimeString().slice(0,8);
      loadDepartures(STATION_ID, dateStr, timeStr);
      setDefaultDatetime();
    }

    // Départs à une date/heure choisie
    function loadDeparturesCustom() {
      const datetime = document.getElementById("datetime").value;
      if (!datetime) return loadDeparturesNow();

      const d = new Date(datetime);
      const dateStr = d.toISOString().split("T")[0];
      const timeStr = d.toTimeString().slice(0,8);
      loadDepartures(STATION_ID, dateStr, timeStr);
    }

    // Recharge les départs si l'intervalle change
    function reloadDepartures() {
      const datetimeVal = document.getElementById("datetime").value;
      if (datetimeVal) loadDeparturesCustom();
      else loadDeparturesNow();
    }

    // Initialisation
    document.getElementById("station").addEventListener("change", loadDeparturesNow);
  </script>
</body>
</html>
