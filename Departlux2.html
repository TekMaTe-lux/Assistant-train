<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Départs Bus L60, L61, L62, L90</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    label { margin-right: 10px; }
    select, input, button { margin: 5px 0; padding: 5px; }
    .results { margin-top: 20px; }
    li { margin-bottom: 12px; padding: 8px; border-bottom: 1px solid #ddd; }
    .retard { color: red; font-weight: bold; }
    .a-heure { color: green; font-weight: bold; }
    .datetime-container { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
  </style>
</head>
<body>
  <h2>Départs Bus L60, L61, L62, L90</h2>

  <!-- Sélecteur de ligne -->
  <label for="lines">Choisir les lignes :</label>
  <select id="lines" multiple size="4">
    <option value="L60" selected>L60</option>
    <option value="L61" selected>L61</option>
    <option value="L62" selected>L62</option>
    <option value="L90" selected>L90</option>
  </select>
  <br><br>

  <!-- Intervalle -->
  <label for="interval">Intervalle :</label>
  <select id="interval" onchange="reloadDepartures()">
    <option value="30">30 min</option>
    <option value="60">1 heure</option>
    <option value="120" selected>2 heures</option>
    <option value="180">3 heures</option>
  </select>
  <br><br>

  <!-- Choix d'une date/heure avec bouton -->
  <div class="datetime-container">
    <label for="datetime">Date et heure :</label>
    <input type="datetime-local" id="datetime" onchange="loadDeparturesCustom()">
    <button onclick="loadDeparturesNow()">Prochains départs</button>
  </div>
  <br>

  <div class="results" id="results">Sélectionnez une ligne pour afficher les départs...</div>

  <script>
    const API_KEY = "58ef9a71-6837-4405-bd5d-23beaf92864c";
    const STATION_ID = "200405036"; // Gare Centrale de Luxembourg

    function setDefaultDatetime() {
      const dtInput = document.getElementById('datetime');
      const now = new Date();
      const localISO = new Date(now.getTime() - now.getTimezoneOffset()*60000).toISOString().slice(0,16);
      dtInput.value = localISO;
    }

    setDefaultDatetime();

    async function loadDepartures(stationId, dateStr, timeStr, interval) {
      const selectedLines = Array.from(document.getElementById("lines").selectedOptions).map(option => option.value);

      if (!stationId) {
        document.getElementById("results").innerHTML = "Veuillez choisir une gare.";
        return;
      }

      const url = `https://cdt.hafas.de/opendata/apiserver/departureBoard?accessId=${API_KEY}&id=${stationId}&date=${dateStr}&time=${timeStr}&duration=${interval}&maxJourneys=200&format=json`;

      try {
        const response = await fetch(url);
        const data = await response.json();

        if (!data.Departure || data.Departure.length === 0) {
          document.getElementById("results").innerHTML = "Aucun départ trouvé.";
          return;
        }

        let html = "<h3>Départs sélectionnés :</h3><ul>";
        data.Departure.forEach(dep => {
          const busLine = dep.ProductAtStop.displayNumber;
          if (!selectedLines.includes(busLine)) return;

          let statut = `<span class="a-heure">À l'heure</span>`;
          if (dep.rtTime && dep.rtTime !== dep.time) {
            const scheduled = new Date(`${dep.date}T${dep.time}`);
            const real = new Date(`${dep.rtDate || dep.date}T${dep.rtTime}`);
            const diffMin = Math.round((real - scheduled) / 60000);
            statut = `<span class="retard">Retardé à ${dep.rtTime} (${diffMin > 0 ? '+'+diffMin+' min' : diffMin+' min'})</span>`;
          }

          html += `<li>
            <b>${busLine}</b> vers ${dep.direction}<br>
            Départ prévu : ${dep.time} (${dep.date})<br>
            Voie : ${dep.rtTrack ? dep.rtTrack : "?"}<br>
            Catégorie : ${dep.ProductAtStop?.catOut || "?"}<br>
            Statut : ${statut}<br>
          </li>`;
        });
        html += "</ul>";

        document.getElementById("results").innerHTML = html;
      } catch (e) {
        console.error(e);
        document.getElementById("results").innerHTML = "Erreur de chargement des données.";
      }
    }

    // Départs à partir de maintenant
    function loadDeparturesNow() {
      const now = new Date();
      const dateStr = now.toISOString().split("T")[0];
      const timeStr = now.toTimeString().slice(0,8);
      const interval = document.getElementById("interval").value;
      loadDepartures(STATION_ID, dateStr, timeStr, interval);
      setDefaultDatetime();
    }

    // Départs à une date/heure choisie
    function loadDeparturesCustom() {
      const datetime = document.getElementById("datetime").value;
      if (!datetime) return loadDeparturesNow();

      const d = new Date(datetime);
      const dateStr = d.toISOString().split("T")[0];
      const timeStr = d.toTimeString().slice(0,8);
      const interval = document.getElementById("interval").value;
      loadDepartures(STATION_ID, dateStr, timeStr, interval);
    }

    // Recharge les départs en fonction de l'intervalle actuel
    function reloadDepartures() {
      const datetimeVal = document.getElementById("datetime").value;
      if (datetimeVal) loadDeparturesCustom();
      else loadDeparturesNow();
    }
  </script>
</body>
</html>
