<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Départs et arrêts - Luxembourg Gare Centrale</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  table { border-collapse: collapse; width: 100%; margin-bottom: 40px; }
  th, td { border: 1px solid #ccc; padding: 6px 8px; text-align: center; }
  th { background: #D10074; color: white; }
  tbody tr:hover { background-color: #f0f0f0; cursor: pointer; }
  .cancelled { color: red; text-decoration: line-through; }
  .hidden { display: none; }
  .train-header { cursor: pointer; background: #f7f7f7; font-weight: bold; }
</style>
</head>
<body>

<h1>Départs de trains - Luxembourg, Gare Centrale</h1>

<table id="departuresTable">
  <thead>
    <tr>
      <th>Train</th>
      <th>Type</th>
      <th>Heure départ prévue</th>
      <th>Heure départ réelle</th>
      <th>Quai</th>
      <th>Statut</th>
      <th>Direction</th>
    </tr>
  </thead>
  <tbody>
    <tr><td colspan="7">Chargement des données...</td></tr>
  </tbody>
</table>

<div id="stopsContainer"></div>

<script>
  const accessId = '58ef9a71-6837-4405-bd5d-23beaf92864c';
  const stationId = 'A=1@O=Luxembourg,%20Gare%20Centrale@X=6134239@Y=49599969@u=0@U=82@L=200405060@';

  async function fetchDepartures() {
    const url = `https://cdt.hafas.de/opendata/apiserver/departureBoard?accessId=${accessId}&id=${encodeURIComponent(stationId)}&format=json&passlist=1`;
    try {
      const res = await fetch(url);
      if(!res.ok) throw new Error(`Erreur HTTP ${res.status}`);
      const data = await res.json();
      displayDepartures(data);
    } catch(err) {
      const tbody = document.querySelector('#departuresTable tbody');
      tbody.innerHTML = `<tr><td colspan="7">Erreur lors du chargement: ${err.message}</td></tr>`;
      console.error(err);
    }
  }

  function displayDepartures(data) {
    const tbody = document.querySelector('#departuresTable tbody');
    tbody.innerHTML = '';
    if(!data || !data.departure || data.departure.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7">Aucun train au départ trouvé.</td></tr>';
      return;
    }

    const stopsContainer = document.getElementById('stopsContainer');
    stopsContainer.innerHTML = '';

    data.departure.forEach((train, index) => {
      const prod = train.product || {};
      const trainName = prod.name || 'N/A';
      const trainType = prod.catOutL || prod.catOut || 'N/A';
      const depTime = train.time || '';
      const rtDepTime = train.rtTime || depTime;
      const platform = train.rtPlatform?.text || train.platform || '-';
      const cancelled = train.cancelled === true;
      const statut = cancelled ? 'Annulé' : 'OK';
      const direction = train.direction || '';

      // Ligne tableau départs
      const tr = document.createElement('tr');
      tr.classList.add('train-header');
      if(cancelled) tr.classList.add('cancelled');
      tr.dataset.index = index; // index pour toggle stops
      tr.innerHTML = `
        <td>${trainName}</td>
        <td>${trainType}</td>
        <td>${depTime}</td>
        <td>${rtDepTime}</td>
        <td>${platform}</td>
        <td>${statut}</td>
        <td>${direction}</td>
      `;
      tbody.appendChild(tr);

      // Création tableau des arrêts (initialement caché)
      const stopsTable = document.createElement('table');
      stopsTable.classList.add('hidden');
      stopsTable.innerHTML = `
        <thead>
          <tr>
            <th>Arrêt</th>
            <th>Heure Arrivée prévue</th>
            <th>Heure Arrivée réelle</th>
            <th>Heure Départ prévue</th>
            <th>Heure Départ réelle</th>
            <th>Quai</th>
            <th>Statut</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      `;
      stopsContainer.appendChild(stopsTable);

      const stopsTbody = stopsTable.querySelector('tbody');
      if(train.Stops && train.Stops.Stop && train.Stops.Stop.length > 0) {
        train.Stops.Stop.forEach(stop => {
          const cancelledStop = stop.cancelled === true;
          const trStop = document.createElement('tr');
          if(cancelledStop) trStop.classList.add('cancelled');
          trStop.innerHTML = `
            <td>${stop.name || ''}</td>
            <td>${stop.arrTime || '-'}</td>
            <td>${stop.rtArrTime || stop.arrTime || '-'}</td>
            <td>${stop.depTime || '-'}</td>
            <td>${stop.rtDepTime || stop.depTime || '-'}</td>
            <td>${stop.rtDepPlatform?.text || stop.platform || '-'}</td>
            <td>${cancelledStop ? 'Supprimé' : 'OK'}</td>
          `;
          stopsTbody.appendChild(trStop);
        });
      } else {
        stopsTbody.innerHTML = `<tr><td colspan="7">Pas d'information sur les arrêts.</td></tr>`;
      }
    });

    // Toggle affichage des arrêts au clic sur la ligne train
    document.querySelectorAll('.train-header').forEach(tr => {
      tr.addEventListener('click', () => {
        const idx = tr.dataset.index;
        const tables = stopsContainer.querySelectorAll('table');
        tables.forEach((t, i) => {
          if(i == idx) t.classList.toggle('hidden');
          else t.classList.add('hidden');
        });
        window.scrollTo({top: tr.offsetTop, behavior: 'smooth'});
      });
    });
  }

  fetchDepartures();
</script>

</body>
</html>
