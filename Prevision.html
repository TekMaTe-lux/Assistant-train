<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lab√©taill√®re ‚Äî Simulation fr√©quentation TER Nancy‚ÄìMetz‚ÄìLux</title>

  <style>
    :root{
      --bg:#0b1220;
      --card:#121b2f;
      --panel:#0e1730;
      --txt:#e9eefc;
      --muted:#a8b3d6;
      --line:#263455;
      --shadow: 0 10px 25px rgba(0,0,0,.25);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(79,70,229,.15), transparent 50%),
                  radial-gradient(900px 500px at 80% 10%, rgba(34,197,94,.10), transparent 55%),
                  var(--bg);
      color:var(--txt);
    }
    header{
      padding:18px 16px;
      border-bottom:1px solid var(--line);
      backdrop-filter: blur(6px);
      background: rgba(11,18,32,.75);
      position: sticky;
      top:0;
      z-index:10;
    }
    header h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .pill{
      font-size:12px;
      color:var(--muted);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(14,23,48,.6);
      padding:4px 10px;
      border-radius:999px;
    }
    header p{
      margin:6px 0 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }
    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:16px;
      display:grid;
      grid-template-columns: 410px 1fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .wrap{ grid-template-columns:1fr; }
      header{ position:relative; }
    }

    .card{
      background: linear-gradient(180deg, rgba(18,27,47,.95), rgba(18,27,47,.85));
      border:1px solid rgba(38,52,85,.9);
      border-radius:16px;
      padding:14px;
      box-shadow: var(--shadow);
    }
    .card h2{
      margin:0 0 10px;
      font-size:13px;
      color:var(--muted);
      font-weight:800;
      letter-spacing:.25px;
      text-transform: uppercase;
    }

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:10px 0 6px;
    }
    input, select{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(38,52,85,.9);
      background: rgba(14,23,48,.85);
      color:var(--txt);
      outline:none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
    }
    input[type="range"]{ padding:0; height: 28px; }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .small{
      font-size:11px;
      color:rgba(168,179,214,.9);
      margin-top:6px;
      line-height:1.35;
    }

    .btns{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    button{
      border:1px solid rgba(38,52,85,.9);
      background: rgba(14,23,48,.9);
      color:var(--txt);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:800;
      transition: transform .08s ease, filter .12s ease;
    }
    button:hover{ filter:brightness(1.18); }
    button:active{ transform: translateY(1px); }

    .kpi{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    .kpi .box{
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(38,52,85,.9);
      background: rgba(14,23,48,.85);
    }
    .kpi .v{
      font-size:18px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .kpi .t{
      font-size:11px;
      color:var(--muted);
      margin-top:4px;
      line-height:1.2;
    }

    .divider{
      height:1px;
      background: rgba(38,52,85,.9);
      margin:12px 0;
    }

    .note{
      font-size:12px;
      color:var(--muted);
      line-height:1.45;
      margin-top:10px;
    }

    canvas{ width:100%; max-height:340px; }

    /* Train viz */
    #trainVizWrap{
      border:1px solid rgba(38,52,85,.9);
      background: rgba(14,23,48,.65);
      border-radius:16px;
      padding:12px;
      overflow:auto;
    }
    #trainLegend{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
      align-items:center;
      color:var(--muted);
      font-size:12px;
    }
    .legendItem{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(14,23,48,.6);
    }
    .swatch{
      width:14px; height:14px;
      border-radius:4px;
      border:1px solid rgba(255,255,255,.20);
    }
  </style>
</head>

<body>
<header>
  <h1>
    Lab√©taill√®re ‚Äî Simulation fr√©quentation TER Nancy‚ÄìMetz‚ÄìLux
    <span class="pill">prototype (simu ‚Üí r√©el ensuite)</span>
  </h1>
  <p>
    Pointes: <b>06:00‚Äì09:00</b> et <b>16:00‚Äì19:30</b> ‚Ä¢ Compo: <b>US(3)</b> / <b>UM(6)</b> / <b>UM3(9)</b> voitures 2N.
    Couleur voiture = charge estim√©e. (Oui, on va calibrer √ßa au r√©el ensuite.)
  </p>
</header>

<div class="wrap">
  <!-- LEFT: controls -->
  <section class="card">
    <h2>Param√®tres</h2>

    <label>Heure de d√©part (HH:MM)</label>
    <input id="time" type="time" value="07:20" />

    <div class="row">
      <div>
        <label>Type de jour</label>
        <select id="dayType">
          <option value="weekday" selected>Semaine (lun‚Äìven)</option>
          <option value="saturday">Samedi</option>
          <option value="sunday">Dimanche</option>
          <option value="holiday">Jour f√©ri√©</option>
        </select>
      </div>
      <div>
        <label>Saison</label>
        <select id="season">
          <option value="normal" selected>Normal</option>
          <option value="vacances">Vacances</option>
        </select>
      </div>
    </div>

    <label>Composition (voitures 2 √©tages)</label>
    <select id="formation">
      <option value="3" selected>Unit√© simple (US) ‚Äî 3 voitures</option>
      <option value="6">Unit√© multiple (UM) ‚Äî 6 voitures</option>
      <option value="9">Unit√© multiple 3 (UM3) ‚Äî 9 voitures</option>
    </select>

    <div class="row">
      <div>
        <label>Capacit√© par voiture</label>
        <input id="capPerCar" type="number" min="80" max="260" value="160" />
        <div class="small">Mod√®le assises+debout. Ajustable au r√©el.</div>
      </div>
      <div>
        <label>Demande base (heure creuse)</label>
        <input id="baseDemand" type="number" min="0" max="4000" value="220" />
        <div class="small">Volume moyen √† calibrer (par train).</div>
      </div>
    </div>

    <label>Intensit√© des pointes (multiplicateur max)</label>
    <input id="peakBoost" type="range" min="1" max="6" step="0.1" value="3.2" />
    <div class="small">Valeur: <b><span id="peakBoostVal">3.2</span>x</b></div>

    <label>Al√©a (bruit) ¬± %</label>
    <input id="noisePct" type="range" min="0" max="30" step="1" value="12" />
    <div class="small">Valeur: <b>¬±<span id="noisePctVal">12</span>%</b></div>

    <div class="divider"></div>

    <label>R√©partition par tron√ßon (√† calibrer)</label>
    <div class="row">
      <div>
        <label>% ‚Äúplut√¥t‚Äù Nancy ‚Üí Metz</label>
        <input id="shareNM" type="number" min="0" max="100" value="55" />
      </div>
      <div>
        <label>% ‚Äúplut√¥t‚Äù Metz ‚Üí Luxembourg</label>
        <input id="shareML" type="number" min="0" max="100" value="45" />
      </div>
    </div>
    <div class="small">Le mod√®le normalise si le total ‚â† 100.</div>

    <div class="btns">
      <button id="runOnce">Simuler 1 fois</button>
      <button id="run100">Simuler 100 fois (moyenne)</button>
      <button id="randomize">Randomiser un peu</button>
    </div>

    <div class="kpi">
      <div class="box">
        <div class="v" id="kpiTotal">‚Äî</div>
        <div class="t">Demande totale estim√©e</div>
      </div>
      <div class="box">
        <div class="v" id="kpiMaxLoad">‚Äî</div>
        <div class="t">Charge max (segment le + charg√©)</div>
      </div>
    </div>

    <div class="note">
      Petit #ber: si tu mets <b>peakBoost=6</b> et <b>base=900</b>, c‚Äôest plus un TER‚Ä¶ c‚Äôest une
      bo√Æte de sardines premium en duplex.
    </div>
  </section>

  <!-- RIGHT: outputs -->
  <section class="card">
    <h2>Sch√©ma du train + graphiques</h2>

    <div id="trainVizWrap">
      <div id="trainViz"></div>
      <div id="trainLegend"></div>
    </div>

    <div style="height:12px"></div>
    <canvas id="lineChart"></canvas>
    <div style="height:12px"></div>
    <canvas id="barChart"></canvas>

    <div class="note" id="diagnostic">‚Äî</div>
  </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // ---------------- helpers ----------------
  function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }

  function randn() {
    // Box‚ÄìMuller
    let u = 0, v = 0;
    while(u === 0) u = Math.random();
    while(v === 0) v = Math.random();
    return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
  }

  function timeToMinutes(t){
    const [hh, mm] = t.split(":").map(Number);
    return hh*60 + mm;
  }

  function gaussian(x, mu, sigma){
    const z = (x - mu) / sigma;
    return Math.exp(-0.5 * z*z);
  }

  // ---------------- demand model ----------------
  function dayFactor(dayType){
    // √Ä calibrer
    switch(dayType){
      case "weekday": return 1.00;
      case "saturday": return 0.78;
      case "sunday": return 0.62;
      case "holiday": return 0.70;
      default: return 1.00;
    }
  }

  function seasonFactor(season){
    // Vacances : souvent baisse pendulaires, parfois hausse loisirs => mod√®le simple
    if(season === "vacances") return 0.85;
    return 1.00;
  }

  function hourFactor(minutes, peakBoost){
    // Deux pointes (matin ~07:30, soir ~17:30), + base creuse
    const morning = gaussian(minutes, 7*60 + 30, 55);
    const evening = gaussian(minutes, 17*60 + 30, 65);
    const base = 0.55;
    const peak = (morning + evening); // ~0 √† ~1
    const factor = base + (peakBoost - 1) * peak;
    return clamp(factor, 0.35, peakBoost);
  }

  function normalizeShares(shareNM, shareML){
    let a = Math.max(0, shareNM), b = Math.max(0, shareML);
    const s = a + b;
    if(s === 0) return { nm: 0.5, ml: 0.5 };
    return { nm: a/s, ml: b/s };
  }

  function simulateOnce(cfg){
    const minutes = timeToMinutes(cfg.time);
    const hf = hourFactor(minutes, cfg.peakBoost);
    const df = dayFactor(cfg.dayType);
    const sf = seasonFactor(cfg.season);

    // bruit multiplicatif (gaussien), born√©
    const noise = clamp(1 + (cfg.noisePct/100) * 0.45 * randn(), 0.70, 1.40);

    // demande totale
    const total = Math.max(0, Math.round(cfg.baseDemand * hf * df * sf * noise));

    // r√©partition tron√ßons
    const shares = normalizeShares(cfg.shareNM, cfg.shareML);
    const pNM = Math.round(total * shares.nm);
    const pML = Math.round(total * shares.ml);

    // pivot "Metz": un peu de renouvellement (descente/mont√©e)
    const renewal = clamp(0.12 + 0.10*Math.random(), 0.05, 0.30); // 5‚Äì30%
    const swap = Math.round(total * renewal);

    const onboardNM = pNM; // Nancy‚ÜíMetz
    // effet "Metz charge": (grossier mais utile en prototype)
    const onboardML = clamp(pML + swap - Math.round(swap*0.6), 0, 50000); // Metz‚ÜíLux

    // R√©partition par voiture : l√©ger d√©s√©quilibre (portes/habitudes)
    const cars = cfg.cars;
    const imbalance = [];
    let sum = 0;
    for(let i=0;i<cars;i++){
      const w = 1 + 0.10*randn();
      const bump = (i === 0 || i === cars-1) ? (1 + 0.05*Math.random()) : 1;
      const val = clamp(w*bump, 0.75, 1.35);
      imbalance.push(val);
      sum += val;
    }

    function perCar(onboard){
      const arr = [];
      for(let i=0;i<cars;i++){
        arr.push(Math.round(onboard * (imbalance[i]/sum)));
      }
      return arr;
    }

    const perCarNM = perCar(onboardNM);
    const perCarML = perCar(onboardML);

    // capacit√©
    const capTrain = cfg.capPerCar * cars;
    const loadMax = Math.max(onboardNM, onboardML);
    const loadPctMax = capTrain > 0 ? (100 * loadMax / capTrain) : 0;

    return { total, onboardNM, onboardML, perCarNM, perCarML, capTrain, loadPctMax };
  }

  function meanSim(cfg, n){
    const acc = {
      total:0, onboardNM:0, onboardML:0, loadPctMax:0,
      perCarNM: Array(cfg.cars).fill(0),
      perCarML: Array(cfg.cars).fill(0),
      capTrain: cfg.capPerCar * cfg.cars
    };

    for(let k=0;k<n;k++){
      const r = simulateOnce(cfg);
      acc.total += r.total;
      acc.onboardNM += r.onboardNM;
      acc.onboardML += r.onboardML;
      acc.loadPctMax += r.loadPctMax;
      for(let i=0;i<cfg.cars;i++){
        acc.perCarNM[i] += r.perCarNM[i];
        acc.perCarML[i] += r.perCarML[i];
      }
    }

    acc.total = Math.round(acc.total/n);
    acc.onboardNM = Math.round(acc.onboardNM/n);
    acc.onboardML = Math.round(acc.onboardML/n);
    acc.loadPctMax = acc.loadPctMax/n;
    acc.perCarNM = acc.perCarNM.map(x => Math.round(x/n));
    acc.perCarML = acc.perCarML.map(x => Math.round(x/n));
    return acc;
  }

  // ---------------- train SVG (couleur par voiture) ----------------
  function loadToColor(pct){
    const p = Math.max(0, Math.min(160, pct));
    if(p < 40)  return "#22c55e"; // vert
    if(p < 70)  return "#a3e635"; // vert-jaune
    if(p < 90)  return "#facc15"; // jaune
    if(p < 105) return "#fb923c"; // orange
    if(p < 125) return "#ef4444"; // rouge
    return "#a855f7";             // violet
  }

  function renderTrainCars({ cars, capPerCar, perCarPassengers, title }){
    const el = document.getElementById("trainViz");
    const leg = document.getElementById("trainLegend");
    if(!el || !leg) return;

    const wCar = 150, hCar = 62, gap = 10, pad = 14;
    const width = pad*2 + cars*wCar + (cars-1)*gap;
    const height = 122;

    const arr = (perCarPassengers.length === cars)
      ? perCarPassengers
      : Array.from({length: cars}, (_,i)=> perCarPassengers[i] ?? 0);

    const loads = arr.map(v => capPerCar > 0 ? (100*v/capPerCar) : 0);

    const noseW = 28; // petit nez stylis√©
    const topY = 34;
    const railY = 104;

    let svg = `
    <svg width="${width + noseW}" height="${height}" viewBox="0 0 ${width + noseW} ${height}" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="shine" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0" stop-color="rgba(255,255,255,.22)"/>
          <stop offset="1" stop-color="rgba(255,255,255,0)"/>
        </linearGradient>
        <filter id="softShadow" x="-20%" y="-20%" width="140%" height="140%">
          <feDropShadow dx="0" dy="6" stdDeviation="6" flood-color="rgba(0,0,0,.35)"/>
        </filter>
      </defs>

      <text x="10" y="20" fill="rgba(233,238,252,.9)" font-family="system-ui, -apple-system, Segoe UI, Roboto, Arial"
            font-size="12" font-weight="800">${escapeHtml(title)}</text>

      <!-- rails -->
      <line x1="10" y1="${railY}" x2="${width + noseW - 10}" y2="${railY}" stroke="rgba(168,179,214,.25)" stroke-width="3"/>
      <line x1="10" y1="${railY+10}" x2="${width + noseW - 10}" y2="${railY+10}" stroke="rgba(168,179,214,.15)" stroke-width="2"/>

      <!-- nose (c√¥t√© droite) -->
      <path d="M ${width + pad} ${topY} 
               Q ${width + noseW} ${topY + hCar/2} ${width + pad} ${topY + hCar}
               L ${width + pad} ${topY}"
            fill="rgba(59,130,246,.55)" stroke="rgba(255,255,255,.15)" stroke-width="2" filter="url(#softShadow)"/>
    `;

    for(let i=0;i<cars;i++){
      const x = pad + i*(wCar + gap);
      const y = topY;
      const pct = loads[i];
      const fill = loadToColor(pct);

      // roues
      const wheelY = y + hCar + 10;
      const wheel1 = x + 32;
      const wheel2 = x + wCar - 32;

      svg += `
        <g filter="url(#softShadow)">
          <rect x="${x}" y="${y}" width="${wCar}" height="${hCar}" rx="14"
                fill="${fill}" stroke="rgba(255,255,255,.22)" stroke-width="2"/>
          <rect x="${x}" y="${y}" width="${wCar}" height="${hCar}" rx="14"
                fill="url(#shine)"/>
          <!-- fen√™tres -->
          <rect x="${x+18}" y="${y+16}" width="${wCar-36}" height="16" rx="6" fill="rgba(11,18,32,.45)"/>
          <!-- portes -->
          <rect x="${x+10}" y="${y+12}" width="14" height="${hCar-24}" rx="5" fill="rgba(11,18,32,.25)"/>
          <rect x="${x+wCar-24}" y="${y+12}" width="14" height="${hCar-24}" rx="5" fill="rgba(11,18,32,.25)"/>

          <!-- label -->
          <text x="${x + 10}" y="${y - 8}" fill="rgba(233,238,252,.8)" font-family="system-ui, -apple-system, Segoe UI, Roboto, Arial"
                font-size="11" font-weight="800">Voiture ${i+1}</text>

          <text x="${x + 18}" y="${y + 52}" fill="rgba(11,18,32,.85)" font-family="system-ui, -apple-system, Segoe UI, Roboto, Arial"
                font-size="12" font-weight="900">${Math.round(pct)}%</text>
          <text x="${x + 62}" y="${y + 52}" fill="rgba(11,18,32,.75)" font-family="system-ui, -apple-system, Segoe UI, Roboto, Arial"
                font-size="11" font-weight="800">${arr[i]} / ${capPerCar}</text>

          <!-- roues -->
          <circle cx="${wheel1}" cy="${wheelY}" r="7" fill="rgba(168,179,214,.35)"/>
          <circle cx="${wheel2}" cy="${wheelY}" r="7" fill="rgba(168,179,214,.35)"/>
        </g>
      `;
    }

    svg += `</svg>`;
    el.innerHTML = svg;

    // L√©gende
    leg.innerHTML = `
      <div class="legendItem"><span class="swatch" style="background:#22c55e"></span> <span>&lt; 40% (cool)</span></div>
      <div class="legendItem"><span class="swatch" style="background:#facc15"></span> <span>70‚Äì90% (ok)</span></div>
      <div class="legendItem"><span class="swatch" style="background:#fb923c"></span> <span>90‚Äì105% (debout)</span></div>
      <div class="legendItem"><span class="swatch" style="background:#ef4444"></span> <span>105‚Äì125% (chaud)</span></div>
      <div class="legendItem"><span class="swatch" style="background:#a855f7"></span> <span>&gt; 125% (sardines)</span></div>
    `;
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ---------------- UI ----------------
  const $ = (id) => document.getElementById(id);

  const peakBoost = $("peakBoost");
  const noisePct = $("noisePct");

  peakBoost.addEventListener("input", ()=> $("peakBoostVal").textContent = peakBoost.value);
  noisePct.addEventListener("input", ()=> $("noisePctVal").textContent = noisePct.value);

  function readCfg(){
    const cars = parseInt($("formation").value, 10);
    return {
      time: $("time").value || "07:20",
      dayType: $("dayType").value,
      season: $("season").value,
      cars,
      capPerCar: parseInt($("capPerCar").value, 10) || 160,
      baseDemand: parseInt($("baseDemand").value, 10) || 220,
      peakBoost: parseFloat($("peakBoost").value),
      noisePct: parseInt($("noisePct").value, 10),
      shareNM: parseFloat($("shareNM").value),
      shareML: parseFloat($("shareML").value),
    };
  }

  // ---------------- Charts ----------------
  let lineChart, barChart;

  function initCharts(){
    const ctx1 = $("lineChart").getContext("2d");
    const ctx2 = $("barChart").getContext("2d");

    lineChart = new Chart(ctx1, {
      type: 'line',
      data: {
        labels: ["Nancy ‚Üí Metz", "Metz ‚Üí Luxembourg"],
        datasets: [{
          label: "Passagers √† bord (segment)",
          data: [0,0],
          tension: 0.25
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { labels: { color: "#e9eefc" } } },
        scales: {
          x: { ticks: { color: "#a8b3d6" }, grid: { color: "rgba(38,52,85,.6)" } },
          y: { ticks: { color: "#a8b3d6" }, grid: { color: "rgba(38,52,85,.6)" }, beginAtZero:true }
        }
      }
    });

    barChart = new Chart(ctx2, {
      type: 'bar',
      data: {
        labels: [],
        datasets: [{
          label: "Occupation voiture (segment le + charg√©) ‚Äî %",
          data: []
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { labels: { color: "#e9eefc" } } },
        scales: {
          x: { ticks: { color: "#a8b3d6" }, grid: { color: "rgba(38,52,85,.6)" } },
          y: { ticks: { color: "#a8b3d6" }, grid: { color: "rgba(38,52,85,.6)" }, beginAtZero:true, suggestedMax: 140 }
        }
      }
    });
  }

  function renderResult(cfg, res, modeLabel){
    $("kpiTotal").textContent = `${res.total} voyageurs`;
    const maxSeg = res.onboardML >= res.onboardNM ? "Metz‚ÜíLux" : "Nancy‚ÜíMetz";
    $("kpiMaxLoad").textContent = `${Math.round(res.loadPctMax)}% (${maxSeg})`;

    // update line
    lineChart.data.datasets[0].data = [res.onboardNM, res.onboardML];
    lineChart.update();

    // choose most loaded segment for per-car display
    const perCar = (res.onboardML >= res.onboardNM) ? res.perCarML : res.perCarNM;
    barChart.data.labels = Array.from({length: cfg.cars}, (_,i)=>`Voiture ${i+1}`);
    barChart.data.datasets[0].data = perCar.map(x => (cfg.capPerCar>0 ? Math.round(100*x/cfg.capPerCar) : 0));
    barChart.update();

    // render train SVG
    renderTrainCars({
      cars: cfg.cars,
      capPerCar: cfg.capPerCar,
      perCarPassengers: perCar,
      title: `${modeLabel} ‚Äî segment affich√©: ${maxSeg}`
    });

    const maxPct = res.loadPctMax;
    let msg;
    if(maxPct < 55) msg = "Confort tranquille : tu peux choisir ta place sans n√©gocier avec ton sac.";
    else if(maxPct < 85) msg = "Charge correcte : √ßa discute, √ßa vit, mais √ßa passe.";
    else if(maxPct < 105) msg = "Zone orange : debout probable, ambiance ‚Äúquai de gare en rush‚Äù.";
    else msg = "Saturation probable : mode sardines 2 √©tages. (On calibrera √ßa au r√©el üòÖ)";

    $("diagnostic").innerHTML =
      `<b>${modeLabel}</b> ‚Äî Capacit√© train: <b>${res.capTrain}</b> (=${cfg.capPerCar}√ó${cfg.cars}). ` +
      `Segment max: <b>${Math.max(res.onboardNM,res.onboardML)}</b> voyageurs.<br>${msg}`;
  }

  // ---------------- Buttons ----------------
  $("runOnce").addEventListener("click", ()=>{
    const cfg = readCfg();
    const res = simulateOnce(cfg);
    renderResult(cfg, res, "Simulation 1 tirage");
  });

  $("run100").addEventListener("click", ()=>{
    const cfg = readCfg();
    const res = meanSim(cfg, 100);
    renderResult(cfg, res, "Simulation moyenne (100 tirages)");
  });

  $("randomize").addEventListener("click", ()=>{
    const bd = parseInt($("baseDemand").value,10)||220;
    $("baseDemand").value = clamp(Math.round(bd * (0.85 + 0.3*Math.random())), 0, 5000);

    const pb = parseFloat($("peakBoost").value);
    $("peakBoost").value = clamp((pb + (Math.random()-0.5)*0.8).toFixed(1), 1, 6);
    $("peakBoostVal").textContent = $("peakBoost").value;

    const np = parseInt($("noisePct").value,10);
    $("noisePct").value = clamp(np + Math.round((Math.random()-0.5)*8), 0, 30);
    $("noisePctVal").textContent = $("noisePct").value;

    // refresh preview quickly
    const cfg = readCfg();
    const res = meanSim(cfg, 40);
    renderResult(cfg, res, "Pr√©visualisation (40 tirages)");
  });

  // ---------------- init ----------------
  initCharts();
  (() => {
    const cfg = readCfg();
    const res = meanSim(cfg, 60);
    renderResult(cfg, res, "Pr√©visualisation (60 tirages)");
  })();
</script>
</body>
      </html>
