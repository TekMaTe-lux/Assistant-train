<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Liste des trains arrivant à Luxembourg</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0a0e1a;
      color: #e0f0ff;
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }
    select, button {
      padding: 8px;
      font-size: 1rem;
      margin-top: 10px;
      width: 100%;
      max-width: 400px;
    }
    .train-details {
      margin-top: 20px;
      background: linear-gradient(145deg, #101828, #0a0e1a);
      border: 2px solid #00f0ff55;
      box-shadow: 0 0 12px #00f0ff88, 0 0 30px #00ffff44 inset;
      border-radius: 20px;
      padding: 24px;
      font-family: 'Orbitron', sans-serif;
      font-size: 1.1rem;
    }
  </style>
</head>
<body>
  <h1>Trains arrivant à Luxembourg (jour en cours)</h1>
  <select id="trainSelect">
    <option value="">-- Chargement des trains... --</option>
  </select>

  <div id="trainDetails" class="train-details">Sélectionnez un train pour voir les détails.</div>

  <script>
    const API_KEY = '242fac11-6d98-45fb-93df-28174d362447';
    const STOP_AREA = 'stop_area:SNCF:82001000';

    // Obtenir la date au format YYYYMMDDTHHmmss
    function getDateTimeNow() {
      const now = new Date();
      // YYYYMMDDTHHMMSS
      const yyyy = now.getFullYear().toString();
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const dd = String(now.getDate()).padStart(2, '0');
      const hh = String(now.getHours()).padStart(2, '0');
      const min = String(now.getMinutes()).padStart(2, '0');
      const ss = String(now.getSeconds()).padStart(2, '0');
      return `${yyyy}${mm}${dd}T${hh}${min}${ss}`;
    }

    // Parse date au format API SNCF (YYYYMMDDTHHmmss)
    function parseSNCFDate(dateStr) {
      const y = dateStr.slice(0,4);
      const m = dateStr.slice(4,6);
      const d = dateStr.slice(6,8);
      const H = dateStr.slice(9,11);
      const M = dateStr.slice(11,13);
      const S = dateStr.slice(13,15);
      return new Date(`${y}-${m}-${d}T${H}:${M}:${S}`);
    }

    function formatTime(date) {
      return date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
    }

    // Fonction qui tente de récupérer un label/numéro pertinent du train
    function getTrainLabel(train) {
      if (!train.vehicle_journey) return 'N/A';
      if (train.vehicle_journey.label) return train.vehicle_journey.label;
      if (train.vehicle_journey.route && train.vehicle_journey.route.name) return train.vehicle_journey.route.name;
      if (train.vehicle_journey.headsign) return train.vehicle_journey.headsign;
      if (train.vehicle_journey.id) return train.vehicle_journey.id;
      return 'N/A';
    }

    async function fetchTrains() {
      const datetime = getDateTimeNow();
      const url = `https://api.sncf.com/v1/coverage/sncf/stop_areas/${STOP_AREA}/arrivals?datetime=${datetime}&duration=86400&count=100`;

      try {
        const response = await fetch(url, {
          headers: {
            'Authorization': 'Basic ' + btoa(API_KEY + ':')
          }
        });
        if (!response.ok) throw new Error(`Erreur API: ${response.status}`);
        const data = await response.json();
        return data.arrivals || [];
      } catch (error) {
        console.error('Erreur récupération trains:', error);
        return [];
      }
    }

    function populateTrainSelect(trains) {
      const select = document.getElementById('trainSelect');
      select.innerHTML = '<option value="">-- Choisir un train --</option>';

      trains.forEach(train => {
        const trainId = train.vehicle_journey ? train.vehicle_journey.id : 'inconnu';
        const trainLabel = getTrainLabel(train);
        const arrivalDateTime = parseSNCFDate(train.stop_date_time.arrival_date_time);
        const timeStr = formatTime(arrivalDateTime);
        const option = document.createElement('option');
        option.value = trainId;
        option.textContent = `Train ${trainLabel} - Arrivée à ${timeStr}`;
        select.appendChild(option);
      });
    }

    function showTrainDetails(train) {
      const container = document.getElementById('trainDetails');
      if (!train) {
        container.textContent = 'Sélectionnez un train pour voir les détails.';
        return;
      }
      const trainLabel = getTrainLabel(train);
      const arrivalDateTime = parseSNCFDate(train.stop_date_time.arrival_date_time);
      const timeStr = formatTime(arrivalDateTime);
      const destination = train.vehicle_journey ? (train.vehicle_journey.destination || 'Inconnu') : 'Inconnu';

      container.innerHTML = `
        <strong>Train ${trainLabel}</strong><br>
        Arrivée prévue à : <strong>${timeStr}</strong><br>
        Destination : <strong>${destination}</strong>
      `;
    }

    let trainsGlobal = [];

    document.getElementById('trainSelect').addEventListener('change', (e) => {
      const selectedId = e.target.value;
      if (!selectedId) {
        showTrainDetails(null);
        return;
      }
      const selectedTrain = trainsGlobal.find(t => t.vehicle_journey && t.vehicle_journey.id === selectedId);
      showTrainDetails(selectedTrain);
    });

    // Chargement initial
    (async function init() {
      const trains = await fetchTrains();
      trainsGlobal = trains;
      populateTrainSelect(trains);
      showTrainDetails(null);
    })();

  </script>
</body>
</html>
