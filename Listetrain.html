<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Trains arrivant à Luxembourg (24h)</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #101828;
    color: #e0f0ff;
    max-width: 800px;
    margin: 2em auto;
    padding: 1em;
  }
  h1 {
    color: #00ffff;
    text-shadow: 0 0 10px #00f0ff;
  }
  select {
    width: 100%;
    padding: 0.5em;
    font-size: 1.1rem;
    margin-bottom: 1em;
    border-radius: 6px;
    border: 2px solid #00f0ff55;
    background: #001122;
    color: #00ffff;
    box-shadow: 0 0 12px #00f0ff88 inset;
  }
  option {
    background: #001122;
    color: #00ffff;
  }
  #trainDetails {
    border: 1px solid #00f0ff55;
    padding: 1em;
    border-radius: 10px;
    background: linear-gradient(145deg, #101828, #0a0e1a);
    box-shadow: 0 0 20px #00ffff44 inset;
    font-family: 'Orbitron', monospace;
  }
  .train-number {
    font-weight: bold;
    font-size: 1.2rem;
    color: #00ffff;
  }
  .train-time {
    font-style: italic;
    margin-top: 0.3em;
  }
</style>
</head>
<body>

<h1>Trains arrivant à Luxembourg (24h)</h1>

<label for="trainSelect">Sélectionner un train :</label>
<select id="trainSelect" disabled>
  <option>Chargement des trains...</option>
</select>

<div id="trainDetails">
  <p>Sélectionnez un train pour voir les détails.</p>
</div>

<script>
const apiKey = '242fac11-6d98-45fb-93df-28174d362447';

// Convertit une date SNCF au format "YYYYMMDDTHHMMSS" en objet Date JS
function parseSNCFDate(sncfDateStr) {
  // ex: "20250711T072200"
  const datePart = sncfDateStr.substr(0,8);
  const timePart = sncfDateStr.substr(9,6);
  const year = parseInt(datePart.substr(0,4),10);
  const month = parseInt(datePart.substr(4,2),10)-1;
  const day = parseInt(datePart.substr(6,2),10);
  const hour = parseInt(timePart.substr(0,2),10);
  const minute = parseInt(timePart.substr(2,2),10);
  const second = parseInt(timePart.substr(4,2),10);
  return new Date(year, month, day, hour, minute, second);
}

// Formate un objet Date en HH:MM (heure locale FR)
function formatTime(date) {
  return date.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
}

// Renvoie la date du jour à minuit au format SNCF YYYYMMDDT000000
function getTodayDatetime() {
  const now = new Date();
  const y = now.getFullYear();
  const m = String(now.getMonth()+1).padStart(2,'0');
  const d = String(now.getDate()).padStart(2,'0');
  return `${y}${m}${d}T000000`;
}

// Récupère la liste des arrivées sur 24h
async function fetchArrivals() {
  const stopAreaId = 'stop_area:SNCF:82001000'; // Luxembourg
  const datetime = getTodayDatetime();
  const duration = 86400; // 24h en secondes
  const url = `https://api.sncf.com/v1/coverage/sncf/stop_areas/${stopAreaId}/arrivals?datetime=${datetime}&duration=${duration}&count=100`;

  try {
    const resp = await fetch(url, {
      headers: { 'Authorization': 'Basic ' + btoa(apiKey + ':') }
    });
    if(!resp.ok) throw new Error(`Erreur API: ${resp.status}`);
    const data = await resp.json();
    return data.arrivals || [];
  } catch(err) {
    console.error(err);
    return [];
  }
}

// Remplit le menu déroulant avec les trains
function populateSelect(trains) {
  const select = document.getElementById('trainSelect');
  select.innerHTML = '';
  if(trains.length === 0) {
    select.innerHTML = '<option>Aucun train trouvé</option>';
    select.disabled = true;
    return;
  }
  select.disabled = false;
  const defaultOption = document.createElement('option');
  defaultOption.value = '';
  defaultOption.textContent = '-- Choisir un train --';
  select.appendChild(defaultOption);

  trains.sort((a,b) => {
    const d1 = parseSNCFDate(a.stop_date_time.arrival_date_time);
    const d2 = parseSNCFDate(b.stop_date_time.arrival_date_time);
    return d1 - d2;
  });

  trains.forEach(train => {
    const info = train.display_informations || {};
    const label = info.label || info.headsign || info.direction || (train.route ? train.route.id : 'N° inconnu');
    const arrival = parseSNCFDate(train.stop_date_time.arrival_date_time);
    const timeStr = formatTime(arrival);

    const option = document.createElement('option');
    option.value = train.trip ? train.trip.id : label;
    option.textContent = `Train ${label} - Arrivée à ${timeStr}`;
    select.appendChild(option);
  });
}

// Affiche les détails du train sélectionné
function showDetails(train) {
  const container = document.getElementById('trainDetails');
  if(!train) {
    container.innerHTML = '<p>Sélectionnez un train pour voir les détails.</p>';
    return;
  }
  const info = train.display_informations || {};
  const trainNumber = info.label || info.headsign || info.direction || 'N/A';
  const destination = info.direction || 'Inconnue';
  const arrivalDate = parseSNCFDate(train.stop_date_time.arrival_date_time);
  const arrivalTime = formatTime(arrivalDate);
  const departureDateStr = train.stop_date_time.departure_date_time;
  const departureDate = departureDateStr ? parseSNCFDate(departureDateStr) : null;
  const departureTime = departureDate ? formatTime(departureDate) : 'N/A';

  container.innerHTML = `
    <div>
      <div class="train-number">Train ${trainNumber}</div>
      <div>Destination : <strong>${destination}</strong></div>
      <div class="train-time">Arrivée prévue à : ${arrivalTime}</div>
      <div class="train-time">Départ prévu à : ${departureTime}</div>
    </div>
  `;
}

// Script principal
(async function(){
  const trains = await fetchArrivals();
  populateSelect(trains);

  const select = document.getElementById('trainSelect');
  select.addEventListener('change', () => {
    const selectedId = select.value;
    if(!selectedId) {
      showDetails(null);
      return;
    }
    const selectedTrain = trains.find(t => t.trip && t.trip.id === selectedId);
    showDetails(selectedTrain || null);
  });
})();
</script>

</body>
</html>
