<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Trains arrivant à Luxembourg (24h)</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  select { padding: 5px; font-size: 16px; }
  #trainDetails { margin-top: 20px; white-space: pre-wrap; }
</style>
</head>
<body>

<h2>Trains arrivant à Luxembourg (24h)</h2>

<label for="trainSelect">Sélectionner un train :</label><br />
<select id="trainSelect">
  <option value="">Sélectionnez un train</option>
</select>

<div id="trainDetails">Sélectionnez un train pour voir les détails.</div>

<script>
const apiKey = '242fac11-6d98-45fb-93df-28174d362447';

// Retourne la date au format "YYYYMMDDTHHmmss" pour maintenant (timezone Europe/Paris)
function getTodayDatetime() {
  const now = new Date();
  // Décalage horaire Paris (CET/CEST)
  const tzOffset = now.getTimezoneOffset() * 60000;
  const localTime = new Date(now.getTime() - tzOffset);

  const year = localTime.getFullYear();
  const month = String(localTime.getMonth() + 1).padStart(2, '0');
  const day = String(localTime.getDate()).padStart(2, '0');
  const hours = String(localTime.getHours()).padStart(2, '0');
  const minutes = String(localTime.getMinutes()).padStart(2, '0');
  const seconds = String(localTime.getSeconds()).padStart(2, '0');

  return `${year}${month}${day}T${hours}${minutes}${seconds}`;
}

// Récupère les arrivées 24h à Luxembourg
async function fetchArrivals() {
  const stopAreaId = 'stop_area:SNCF:82001000'; // Luxembourg
  const datetime = getTodayDatetime();
  const duration = 86400; // 24h en secondes
  const url = `https://api.sncf.com/v1/coverage/sncf/stop_areas/${stopAreaId}/arrivals?datetime=${datetime}&duration=${duration}&count=100`;

  try {
    const response = await fetch(url, {
      headers: {
        'Authorization': 'Basic ' + btoa(apiKey + ':')
      }
    });
    if (!response.ok) throw new Error(`Erreur HTTP ${response.status}`);

    const data = await response.json();
    return data.arrivals || [];
  } catch (error) {
    console.error("Erreur API SNCF:", error);
    document.getElementById('trainDetails').textContent = "Erreur lors du chargement des trains.";
    return [];
  }
}

function formatDate(dateStr) {
  if (!dateStr) return "";
  // Format "YYYYMMDDTHHmmss" -> "JJ/MM/YYYY HH:mm:ss"
  const year = dateStr.slice(0,4);
  const month = dateStr.slice(4,6);
  const day = dateStr.slice(6,8);
  const hour = dateStr.slice(9,11);
  const min = dateStr.slice(11,13);
  const sec = dateStr.slice(13,15);
  return `${day}/${month}/${year} ${hour}:${min}:${sec}`;
}

function showTrainDetails(train) {
  const info = train.display_informations || {};
  const stopTime = train.stop_date_time || {};
  const route = train.route || {};
  const stopPoint = train.stop_point || {};

  const html = `
    <h3>Détails du train ${info.headsign || "N/A"}</h3>
    <p><strong>Ligne :</strong> ${route.name || "N/A"}</p>
    <p><strong>Direction :</strong> ${info.direction || "N/A"}</p>
    <p><strong>Arrivée prévue :</strong> ${formatDate(stopTime.arrival_date_time) || "N/A"}</p>
    <p><strong>Départ prévu :</strong> ${formatDate(stopTime.departure_date_time) || "N/A"}</p>
    <p><strong>Gare :</strong> ${stopPoint.name || "N/A"}</p>
  `;

  document.getElementById('trainDetails').innerHTML = html;
}

async function main() {
  const arrivals = await fetchArrivals();
  const select = document.getElementById('trainSelect');

  // Vider la liste
  select.innerHTML = '<option value="">Sélectionnez un train</option>';

  arrivals.forEach(train => {
    const info = train.display_informations || {};
    const headsign = info.headsign || info.label || "Train inconnu";
    const vehicleLink = train.links.find(l => l.type === "vehicle_journey");
    const vehicleId = vehicleLink ? vehicleLink.id : "";

    if(vehicleId) {
      const option = document.createElement('option');
      option.value = vehicleId;
      option.textContent = `${headsign} (${info.direction || "?"})`;
      select.appendChild(option);
    }
  });

  select.addEventListener('change', () => {
    const selectedId = select.value;
    if (!selectedId) {
      document.getElementById('trainDetails').textContent = "Sélectionnez un train pour voir les détails.";
      return;
    }
    const selectedTrain = arrivals.find(t =>
      t.links.some(l => l.type === "vehicle_journey" && l.id === selectedId)
    );
    if (selectedTrain) {
      showTrainDetails(selectedTrain);
    } else {
      document.getElementById('trainDetails').textContent = "Détails non trouvés.";
    }
  });
}

// Lancement au chargement
main();
</script>

</body>
</html>
