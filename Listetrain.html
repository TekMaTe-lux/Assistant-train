<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Trains arrivant à Luxembourg (24h)</title>
<style>
  /* mêmes styles que précédemment */
  body {
    font-family: Arial, sans-serif;
    background: #101828;
    color: #e0f0ff;
    max-width: 800px;
    margin: 2em auto;
    padding: 1em;
  }
  h1 {
    color: #00ffff;
    text-shadow: 0 0 10px #00f0ff;
  }
  select {
    width: 100%;
    padding: 0.5em;
    font-size: 1.1rem;
    margin-bottom: 1em;
    border-radius: 6px;
    border: 2px solid #00f0ff55;
    background: #001122;
    color: #00ffff;
    box-shadow: 0 0 12px #00f0ff88 inset;
  }
  option {
    background: #001122;
    color: #00ffff;
  }
  #trainDetails {
    border: 1px solid #00f0ff55;
    padding: 1em;
    border-radius: 10px;
    background: linear-gradient(145deg, #101828, #0a0e1a);
    box-shadow: 0 0 20px #00ffff44 inset;
    font-family: 'Orbitron', monospace;
    white-space: pre-wrap;
  }
  .train-number {
    font-weight: bold;
    font-size: 1.2rem;
    color: #00ffff;
  }
  .train-time {
    font-style: italic;
    margin-top: 0.3em;
  }
  .alert-suppression {
    color: #ff5555;
    font-weight: bold;
  }
  .alert-retard {
    color: #ffaa00;
    font-weight: bold;
  }
</style>
</head>
<body>

<h1>Trains arrivant à Luxembourg (24h)</h1>

<label for="trainSelect">Sélectionner un train :</label>
<select id="trainSelect" disabled>
  <option>Chargement des trains...</option>
</select>

<div id="trainDetails">
  <p>Sélectionnez un train pour voir les détails.</p>
</div>

<script>
const apiKey = '242fac11-6d98-45fb-93df-28174d362447';

// Parse la date SNCF "YYYYMMDDTHHMMSS" en Date JS
function parseSNCFDate(sncfDateStr) {
  if (!sncfDateStr) return null;
  const datePart = sncfDateStr.substr(0,8);
  const timePart = sncfDateStr.substr(9,6);
  const year = parseInt(datePart.substr(0,4),10);
  const month = parseInt(datePart.substr(4,2),10)-1;
  const day = parseInt(datePart.substr(6,2),10);
  const hour = parseInt(timePart.substr(0,2),10);
  const minute = parseInt(timePart.substr(2,2),10);
  const second = parseInt(timePart.substr(4,2),10);
  return new Date(year, month, day, hour, minute, second);
}

// Format HH:MM
function formatTime(date) {
  if (!date) return 'N/A';
  return date.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
}

// Date du jour minuit au format SNCF
function getTodayDatetime() {
  const now = new Date();
  const y = now.getFullYear();
  const m = String(now.getMonth()+1).padStart(2,'0');
  const d = String(now.getDate()).padStart(2,'0');
  return `${y}${m}${d}T000000`;
}

// Récupère les arrivées 24h
async function fetchArrivals() {
  const stopAreaId = 'stop_area:SNCF:82001000'; // Luxembourg
  const datetime = getTodayDatetime();
  const duration = 86400; // 24h en secondes
  const url = `https://api.sncf.com/v1/coverage/sncf/stop_areas/${stopAreaId}/arrivals?datetime=${datetime}&duration=${duration}&count=100`;

  try {
    const resp = await fetch(url, {
      headers: { 'Authorization': 'Basic ' + btoa(apiKey + ':') }
    });
    if(!resp.ok) throw new Error(`Erreur API: ${resp.status}`);
    const data = await resp.json();
    return data.arrivals || [];
  } catch(err) {
    console.error(err);
    return [];
  }
}

// Remplit le menu déroulant avec le numéro de train (headsign)
function populateSelect(trains) {
  const select = document.getElementById('trainSelect');
  select.innerHTML = '';
  if(trains.length === 0) {
    select.innerHTML = '<option>Aucun train trouvé</option>';
    select.disabled = true;
    return;
  }
  select.disabled = false;
  const defaultOption = document.createElement('option');
  defaultOption.value = '';
  defaultOption.textContent = '-- Choisir un train --';
  select.appendChild(defaultOption);

  trains.sort((a,b) => {
    const d1 = parseSNCFDate(a.stop_date_time.arrival_date_time);
    const d2 = parseSNCFDate(b.stop_date_time.arrival_date_time);
    return d1 - d2;
  });

  trains.forEach((train, index) => {
    const info = train.display_informations || {};
    const headsign = info.headsign || 'N° inconnu';
    const arrival = parseSNCFDate(train.stop_date_time.arrival_date_time);
    const timeStr = formatTime(arrival);

    const option = document.createElement('option');
    option.value = index;  // on met l'index
    option.textContent = `Train ${headsign} - Arrivée à ${timeStr}`;
    select.appendChild(option);
  });
}

// Affiche les détails importants du train sélectionné
function showDetails(train) {
  const container = document.getElementById('trainDetails');
  if(!train) {
    container.innerHTML = '<p>Sélectionnez un train pour voir les détails.</p>';
    return;
  }

  const info = train.display_informations || {};
  const trainNumber = info.headsign || 'N/A';
  const direction = info.direction || 'Inconnue';

  const arrivalDateStr = train.stop_date_time.arrival_date_time;
  const arrivalDate = parseSNCFDate(arrivalDateStr);

  // Retards et statut suppression
  const arrivalStatus = train.stop_date_time.arrival_status || 'scheduled'; // ex: 'delayed', 'cancelled'
  const departureStatus = train.stop_date_time.departure_status || 'scheduled';

  // Causes des perturbations (si présentes)
  let cause = '';
  if (train.cause) cause = train.cause;
  else if(train.messages && train.messages.length) {
    cause = train.messages.map(m => m.text).join('\n');
  }

  let alertHTML = '';
  if(arrivalStatus === 'cancelled' || departureStatus === 'cancelled') {
    alertHTML = `<div class="alert-suppression">⚠️ Train supprimé</div>`;
  } else if(arrivalStatus === 'delayed' || departureStatus === 'delayed') {
    alertHTML = `<div class="alert-retard">⏰ Train en retard</div>`;
  }

  // Ne plus afficher "(scheduled)" ni la ligne départ prévue
  // Affiche uniquement l'heure d'arrivée sans statut quand c'est "scheduled"
  let arrivalText = formatTime(arrivalDate);
  if(arrivalStatus !== 'scheduled') {
    arrivalText += ` (${arrivalStatus})`;
  }

  container.innerHTML = `
    <div>
      <div class="train-number">Train n° ${trainNumber}</div>
      <div>Direction : <strong>${direction}</strong></div>
      <div class="train-time">Arrivée prévue : ${arrivalText}</div>
      ${alertHTML}
      ${cause ? `<pre>${cause}</pre>` : ''}
    </div>
  `;
}

// Script principal
(async function(){
  const trains = await fetchArrivals();
  populateSelect(trains);

  const select = document.getElementById('trainSelect');
  select.addEventListener('change', () => {
    const idx = parseInt(select.value, 10);
    if(isNaN(idx)) {
      showDetails(null);
      return;
    }
    const selectedTrain = trains[idx];
    showDetails(selectedTrain || null);
  });
})();
</script>

</body>
</html>
