<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>APISNCF – retards_carte.json</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: light dark;
    }
    body {
      margin: 0;
      padding: 0;
      background: #020617;
      color: #e5e7eb;
    }
    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem;
    }
    h1 {
      font-size: 1.4rem;
      margin-bottom: 0.25rem;
    }
    .subtitle {
      font-size: 0.85rem;
      color: #9ca3af;
      margin-bottom: 1rem;
    }
    .card {
      background: #020617;
      border-radius: 0.75rem;
      padding: 1rem 1.25rem;
      box-shadow: 0 10px 20px rgba(0,0,0,0.3);
      margin-bottom: 1rem;
      border: 1px solid #1f2937;
    }
    .stats-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      font-size: 0.85rem;
      color: #9ca3af;
      margin-top: 0.5rem;
    }
    .stat {
      display: inline-flex;
      gap: 0.35rem;
      align-items: baseline;
    }
    .stat strong {
      color: #e5e7eb;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-top: 0.5rem;
      font-size: 0.8rem;
      color: #9ca3af;
      align-items: center;
    }
    .controls label {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      cursor: pointer;
    }
    select {
      background: #020617;
      border-radius: 999px;
      border: 1px solid #374151;
      padding: 0.2rem 0.6rem;
      color: #e5e7eb;
      font-size: 0.8rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.85rem;
    }
    thead {
      position: sticky;
      top: 0;
      background: #020617;
      z-index: 1;
    }
    th, td {
      padding: 0.45rem 0.5rem;
      text-align: left;
      border-bottom: 1px solid #1f2937;
      vertical-align: top;
    }
    th {
      font-weight: 600;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #9ca3af;
    }
    tbody tr:nth-child(odd) { background: rgba(15,23,42,0.5); }
    tbody tr:nth-child(even) { background: rgba(15,23,42,0.2); }

    .train-number {
      font-weight: 600;
      font-size: 0.95rem;
    }
    .train-id {
      font-size: 0.7rem;
      color: #6b7280;
      word-break: break-all;
    }
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.1rem 0.55rem;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.9);
      white-space: nowrap;
    }
    .status-badge .dot {
      width: 0.5rem;
      height: 0.5rem;
      border-radius: 999px;
      background: #4ade80;
    }
    .status-delayed .dot { background: #fbbf24; }
    .status-cancelled .dot { background: #f97373; }

    .max-delay {
      font-weight: 600;
    }
    .max-delay.ok { color: #bbf7d0; }
    .max-delay.neutral { color: #fef3c7; }
    .max-delay.bad { color: #fecaca; }

    .stops {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem 0.5rem;
    }
    .stop-chip {
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,0.8);
      background: rgba(15,23,42,0.9);
      font-size: 0.75rem;
      white-space: nowrap;
    }
    .stop-chip.bad {
      border-color: rgba(248,113,113,0.9);
      background: rgba(127,29,29,0.3);
    }
    .stop-chip.neutral {
      border-color: rgba(234,179,8,0.9);
      background: rgba(113,63,18,0.4);
    }
    .delay-value {
      font-weight: 600;
      margin-left: 0.1rem;
    }
    .error {
      color: #fecaca;
      font-size: 0.85rem;
      margin-top: 0.5rem;
    }
    @media (max-width: 900px) {
      th:nth-child(4), td:nth-child(4) { display:none; } /* cache colonne brute sur mobile */
    }
  </style>
</head>
<body>
<div class="page">
  <h1>APISNCF – retards_carte.json</h1>
  <div class="subtitle">
    Vue debug des retards / suppressions pour les trains de la carte
    à partir de <code>retards_carte.json</code>.
  </div>

  <div class="card">
    <div id="summary-generated" style="font-size:0.8rem; color:#9ca3af;">
      Chargement…
    </div>
    <div class="stats-row" id="summary-stats"></div>
    <div class="controls">
      <div>
        Tri :
        <select id="sort-select">
          <option value="number">Par numéro de train</option>
          <option value="maxdelay">Par retard max décroissant</option>
          <option value="status">Par statut (retardés d’abord)</option>
        </select>
      </div>
      <label>
        <input type="checkbox" id="filter-delayed">
        Afficher uniquement les trains impactés
      </label>
    </div>
    <div id="error-zone" class="error" style="display:none;"></div>
  </div>

  <div class="card" style="max-height:70vh; overflow:auto;">
    <table>
      <thead>
      <tr>
        <th>Train</th>
        <th>Statut &amp; retard max</th>
        <th>Retards par gare (min)</th>
        <th>Détails bruts</th>
      </tr>
      </thead>
      <tbody id="trains-tbody">
      <tr><td colspan="4">Chargement des données SNCF…</td></tr>
      </tbody>
    </table>
  </div>

  <div style="font-size:0.7rem; color:#6b7280; margin-top:0.25rem;">
    Pour la carte, tu peux réutiliser directement la structure :
    <code>data.trains[train_number].stops[&quot;Nom gare&quot;] = minutes</code>.
  </div>
</div>

<script>
(function(){
  const API_URL = 'https://vps.labetaillere.fr/gtfs/retards_carte.json';

  const summaryGeneratedEl = document.getElementById('summary-generated');
  const summaryStatsEl = document.getElementById('summary-stats');
  const errorZoneEl = document.getElementById('error-zone');
  const sortSelectEl = document.getElementById('sort-select');
  const filterDelayedEl = document.getElementById('filter-delayed');
  const tbodyEl = document.getElementById('trains-tbody');

  let trainsArray = [];

  function escapeHTML(str){
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function maxDelayForStops(stops){
    let max = 0;
    if (!stops) return 0;
    for (const v of Object.values(stops)){
      const n = Number(v) || 0;
      if (n > max) max = n;
    }
    return max;
  }

  function classifyStatus(status){
    const s = String(status || '').toUpperCase();
    if (s.includes('CANCEL')) return 'cancelled';
    if (s === 'ON_TIME') return 'ontime';
    if (s === 'DELAYED') return 'delayed';
    return 'other';
  }

  function renderSummary(data){
    summaryGeneratedEl.textContent =
      'Généré à (UTC) : ' + (data.generated_at || 'inconnu') +
      ' — source : ' + (data.source || 'n/a');

    const counters = data.counters || {};
    const total = Number(data.count) ||
      (data.trains ? Object.keys(data.trains).length : 0) || 0;
    const ontime   = Number(counters.ON_TIME || 0);
    const delayed  = Number(counters.DELAYED || 0);
    const cancelled = Number(
      counters.CANCELLED || counters.CANCELED || counters.SUPPRESSED || 0
    );

    summaryStatsEl.innerHTML = '';
    function addStat(label, value){
      const span = document.createElement('span');
      span.className = 'stat';
      span.innerHTML =
        '<strong>' + escapeHTML(value) + '</strong>' +
        '<span>' + escapeHTML(label) + '</span>';
      summaryStatsEl.appendChild(span);
    }

    addStat('trains au total', total);
    addStat('à l’heure', ontime);
    addStat('retardés', delayed);
    addStat('supprimés (si présent)', cancelled);
  }

  function renderTable(){
    if (!trainsArray.length){
      tbodyEl.innerHTML = '<tr><td colspan="4">Aucun train dans le flux.</td></tr>';
      return;
    }

    const sortMode = sortSelectEl.value;
    const onlyAffected = filterDelayedEl.checked;

    let rows = trainsArray.slice();
    if (onlyAffected){
      rows = rows.filter(t =>
        t.statusClass === 'delayed' ||
        t.statusClass === 'cancelled' ||
        t.maxDelay > 0
      );
    }

    rows.sort((a, b) => {
      if (sortMode === 'maxdelay'){
        const dA = a.maxDelay || 0;
        const dB = b.maxDelay || 0;
        if (dB !== dA) return dB - dA;
        return String(a.train_number).localeCompare(String(b.train_number));
      }
      if (sortMode === 'status'){
        const order = { delayed: 0, cancelled: 1, other: 2, ontime: 3 };
        const sA = order[a.statusClass] ?? 99;
        const sB = order[b.statusClass] ?? 99;
        if (sA !== sB) return sA - sB;
        const dA = a.maxDelay || 0;
        const dB = b.maxDelay || 0;
        if (dB !== dA) return dB - dA;
        return String(a.train_number).localeCompare(String(b.train_number));
      }
      // default: par numéro
      const nA = Number(a.train_number);
      const nB = Number(b.train_number);
      if (!isNaN(nA) && !isNaN(nB)) return nA - nB;
      return String(a.train_number).localeCompare(String(b.train_number));
    });

    if (!rows.length){
      tbodyEl.innerHTML = '<tr><td colspan="4">Aucun train correspondant au filtre.</td></tr>';
      return;
    }

    const frag = document.createDocumentFragment();

    for (const t of rows){
      const tr = document.createElement('tr');

      // Col 1 : train
      const tdTrain = document.createElement('td');
      tdTrain.innerHTML =
        '<div class="train-number">' +
          escapeHTML(t.train_number || t.key || '?') +
        '</div>' +
        '<div class="train-id">' +
          escapeHTML(t.train_id || '') +
        '</div>';
      tr.appendChild(tdTrain);

      // Col 2 : statut + retard max
      const tdStatus = document.createElement('td');

      let label = t.status || 'UNKNOWN';
      if (t.status === 'ON_TIME') label = 'À l’heure';
      else if (t.status === 'DELAYED') label = 'Retardé';
      else if (t.status && t.status.toUpperCase().includes('CANCEL')) {
        label = 'Supprimé / partiellement supprimé';
      }

      let maxDelayText = t.maxDelay + ' min';
      let maxDelayClass = 'ok';
      if (t.statusClass === 'cancelled'){
        maxDelayText = 'Trajet supprimé / modifié';
        maxDelayClass = 'bad';
      } else if (t.maxDelay > 0){
        maxDelayText = '+' + t.maxDelay + ' min';
        maxDelayClass = (t.maxDelay >= 10) ? 'bad' : 'neutral';
      } else {
        maxDelayText = '0 min';
        maxDelayClass = 'ok';
      }

      const badgeClasses = ['status-badge'];
      if (t.statusClass === 'delayed') badgeClasses.push('status-delayed');
      if (t.statusClass === 'cancelled') badgeClasses.push('status-cancelled');

      tdStatus.innerHTML =
        '<div class="' + badgeClasses.join(' ') + '">' +
          '<span class="dot"></span>' +
          '<span>' + escapeHTML(label) + '</span>' +
        '</div>' +
        '<div style="margin-top:0.3rem; font-size:0.8rem;">' +
          'Retard max : <span class="max-delay ' + maxDelayClass + '">' +
          escapeHTML(maxDelayText) +
          '</span>' +
        '</div>';
      tr.appendChild(tdStatus);

      // Col 3 : retards par gare (chips)
      const tdStops = document.createElement('td');
      const stopsEntries = Object.entries(t.stops || {});
      if (!stopsEntries.length){
        tdStops.innerHTML = '<span style="color:#6b7280;">—</span>';
      } else {
        const div = document.createElement('div');
        div.className = 'stops';
        for (const [name, val] of stopsEntries){
          const n = Number(val) || 0;
          let cls = 'stop-chip';
          if (n > 0) cls += (n >= 10 ? ' bad' : ' neutral');
          const span = document.createElement('span');
          span.className = cls;
          span.innerHTML =
            escapeHTML(name) +
            ' <span class="delay-value">+' + n + '′</span>';
          div.appendChild(span);
        }
        tdStops.appendChild(div);
      }
      tr.appendChild(tdStops);

      // Col 4 : brut
      const tdRaw = document.createElement('td');
      if (!stopsEntries.length){
        tdRaw.innerHTML = '<span style="color:#6b7280;">—</span>';
      } else {
        tdRaw.textContent = stopsEntries
          .map(([name, val]) => `${name}: +${val}′`)
          .join(' · ');
      }
      tr.appendChild(tdRaw);

      frag.appendChild(tr);
    }

    tbodyEl.innerHTML = '';
    tbodyEl.appendChild(frag);
  }

  async function loadData(){
    try {
      const resp = await fetch(API_URL, { cache: 'no-store' });
      if (!resp.ok) throw new Error('HTTP ' + resp.status + ' ' + resp.statusText);

      const data = await resp.json();

      const trainsObj = data.trains || {};
      trainsArray = Object.keys(trainsObj).map(key => {
        const t = trainsObj[key] || {};
        const stops = t.stops || {};
        const maxDelay = maxDelayForStops(stops);
        const statusClass = classifyStatus(t.status);
        return {
          key,
          train_id: t.train_id || '',
          train_number: t.train_number || key,
          status: t.status || 'UNKNOWN',
          statusClass,
          stops,
          maxDelay
        };
      });

      renderSummary(data);
      renderTable();
    } catch (e){
      console.error('Erreur chargement retards_carte.json', e);
      errorZoneEl.style.display = 'block';
      errorZoneEl.textContent =
        'Erreur lors du chargement de ' + API_URL + ' : ' + e;
      tbodyEl.innerHTML =
        '<tr><td colspan="4">Impossible de charger les données.</td></tr>';
    }
  }

  sortSelectEl.addEventListener('change', renderTable);
  filterDelayedEl.addEventListener('change', renderTable);

  loadData();
})();
</script>
</body>
</html>
