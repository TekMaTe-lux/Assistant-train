<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>APISNCF – retards_carte.json</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      margin: 0; padding: 0;
      background: #0f172a;
      color: #e2e8f0;
      font-family: system-ui, sans-serif;
    }
    h1 {
      margin: 20px 0 5px;
      font-size: 22px;
      text-align: center;
    }
    .subtitle {
      text-align: center;
      margin-bottom: 20px;
      color: #94a3b8;
      font-size: 14px;
    }
    .page {
      max-width: 1300px;
      margin: 0 auto;
      padding: 20px;
    }
    table {
      width: 100%; border-collapse: collapse;
      background: #1e293b;
      border-radius: 10px; overflow: hidden;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #334155;
    }
    th {
      background: #0f1a30;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.05em;
      color: #94a3b8;
    }
    tr:nth-child(even) { background: #162033; }
    .delay-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 12px;
      background: #334155;
      color: #f1f5f9;
    }
    .delay-red { background: #7f1d1d; }
    .delay-yellow { background: #78350f; }
  </style>
</head>
<body>

<h1>APISNCF – Disruptions retards_carte.json</h1>
<div class="subtitle">
  Lecture des disruptions SNCF (retards + messages) depuis <code>retards_carte.json</code>
</div>

<div class="page">
  <table>
    <thead>
      <tr>
        <th>Train</th>
        <th>Retard max</th>
        <th>Retards par gare</th>
        <th>Message</th>
      </tr>
    </thead>

    <tbody id="trains-tbody">
      <tr><td colspan="4">Chargement…</td></tr>
    </tbody>
  </table>
</div>

<script>
const URL_JSON = "https://vps.labetaillere.fr/gtfs/retards_carte.json";

async function loadData(){
  const tbody = document.getElementById("trains-tbody");
  tbody.innerHTML = "<tr><td colspan='4'>Chargement…</td></tr>";

  try{
    const resp = await fetch(URL_JSON + "?t=" + Date.now(), {cache:"no-store"});
    if(!resp.ok) throw new Error("HTTP " + resp.status);
    const root = await resp.json();

    const trainsObj = root.trains || {};
    const rows = [];

    for(const key of Object.keys(trainsObj)){
      const trainBlock = trainsObj[key];
      const data = trainBlock.data || {};

      const vj = (data.vehicle_journeys && data.vehicle_journeys[0]) || null;
      if(!vj) continue;

      const trainNumber = vj.name || key;

      // --- MESSAGE ---
      let message = "—";
      if (Array.isArray(data.disruptions) && data.disruptions.length){
        const d = data.disruptions[0];
        if (Array.isArray(d.messages) && d.messages.length){
          message = d.messages[0].text || "—";
        }
      }

      // --- RETARDS PAR GARE ---
      let delays = {}; // { gare: minutes }

      if (Array.isArray(data.disruptions)){
        for (const d of data.disruptions){
          if (!Array.isArray(d.impacted_objects)) continue;
          for (const obj of d.impacted_objects){
            if (!Array.isArray(obj.impacted_stops)) continue;
            for (const st of obj.impacted_stops){

              const base = st.base_arrival_time;
              const amended = st.amended_arrival_time;

              if (base && amended && base.length >= 4 && amended.length >= 4){
                const b = parseInt(base.slice(0,2))*60 + parseInt(base.slice(2,4));
                const a = parseInt(amended.slice(0,2))*60 + parseInt(amended.slice(2,4));
                const diff = a - b;

                if (diff > 0){
                  const name = (st.stop_point && st.stop_point.name) || "Gare inconnue";
                  delays[name] = Math.max(delays[name] || 0, diff);
                }
              }
            }
          }
        }
      }

      // --- RETARD MAX ---
      let maxDelay = 0;
      for(const g of Object.keys(delays)){
        if (delays[g] > maxDelay) maxDelay = delays[g];
      }

      rows.push({
        trainNumber,
        maxDelay,
        delays,
        message
      });
    }

    render(rows);

  } catch(e){
    console.error(e);
    tbody.innerHTML = "<tr><td colspan='4'>Erreur : "+e+"</td></tr>";
  }
}

function render(rows){
  const tbody = document.getElementById("trains-tbody");
  tbody.innerHTML = "";

  if(!rows.length){
    tbody.innerHTML = "<tr><td colspan='4'>Aucun train</td></tr>";
    return;
  }

  for(const r of rows){
    const delaysHTML = Object.keys(r.delays).length
      ? Object.keys(r.delays).map(g =>
          `<div>${g} <span class="delay-badge">${"+"+r.delays[g]+"′"}</span></div>`
        ).join("")
      : "—";

    const maxClass =
      r.maxDelay >= 10 ? "delay-red" :
      r.maxDelay >= 5 ? "delay-yellow" :
      "";

    tbody.innerHTML += `
      <tr>
        <td><b>${r.trainNumber}</b></td>
        <td>
          <span class="delay-badge ${maxClass}">
            ${r.maxDelay ? "+"+r.maxDelay+"′" : "0"}
          </span>
        </td>
        <td>${delaysHTML}</td>
        <td>${r.message}</td>
      </tr>
    `;
  }
}

loadData();
</script>

</body>
</html>
