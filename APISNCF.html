<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Debug API SNCF – retards_carte.json</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: light dark;
    }
    body {
      margin: 0;
      padding: 0;
      background: #111827;
      color: #e5e7eb;
    }
    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem;
    }
    h1 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }
    .subtitle {
      font-size: 0.9rem;
      color: #9ca3af;
      margin-bottom: 1rem;
    }
    .card {
      background: #020617;
      border-radius: 0.75rem;
      padding: 1rem 1.25rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.35);
      margin-bottom: 1rem;
      border: 1px solid #1f2937;
    }
    .card-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 0.5rem;
      align-items: baseline;
      margin-bottom: 0.5rem;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      border-radius: 999px;
      padding: 0.15rem 0.7rem;
      font-size: 0.75rem;
      border: 1px solid rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.85);
    }
    .pill span.dot {
      width: 0.5rem;
      height: 0.5rem;
      border-radius: 999px;
      background: #4ade80;
    }
    .pill.bad span.dot {
      background: #f97373;
    }
    .pill.neutral span.dot {
      background: #facc15;
    }

    .stats-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      font-size: 0.85rem;
      color: #9ca3af;
    }
    .stat {
      display: inline-flex;
      align-items: baseline;
      gap: 0.35rem;
    }
    .stat strong {
      font-size: 0.9rem;
      color: #e5e7eb;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.85rem;
    }
    thead {
      position: sticky;
      top: 0;
      background: #020617;
      z-index: 1;
    }
    th, td {
      padding: 0.45rem 0.5rem;
      text-align: left;
      border-bottom: 1px solid #1f2937;
      vertical-align: top;
    }
    th {
      font-weight: 600;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #9ca3af;
    }
    tbody tr:nth-child(odd) {
      background: rgba(15,23,42,0.5);
    }
    tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.2);
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.1rem 0.55rem;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.9);
      white-space: nowrap;
    }
    .status-badge .dot {
      width: 0.5rem;
      height: 0.5rem;
      border-radius: 999px;
      background: #4ade80;
    }
    .status-delayed .dot {
      background: #fbbf24;
    }
    .status-cancelled .dot {
      background: #f97373;
    }

    .train-number {
      font-weight: 600;
      font-size: 0.95rem;
    }
    .train-id {
      font-size: 0.7rem;
      color: #6b7280;
      word-break: break-all;
    }

    .stops {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem 0.5rem;
    }
    .stop-chip {
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,0.8);
      background: rgba(15,23,42,0.9);
      font-size: 0.75rem;
      white-space: nowrap;
    }
    .stop-chip.bad {
      border-color: rgba(248,113,113,0.9);
      background: rgba(127,29,29,0.3);
    }
    .stop-chip.neutral {
      border-color: rgba(234,179,8,0.9);
      background: rgba(113,63,18,0.4);
    }
    .delay-value {
      font-weight: 600;
      margin-left: 0.1rem;
    }

    .max-delay {
      font-weight: 600;
    }
    .max-delay.bad {
      color: #fecaca;
    }
    .max-delay.neutral {
      color: #fef3c7;
    }
    .max-delay.ok {
      color: #bbf7d0;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin: 0.5rem 0 0.25rem;
      font-size: 0.8rem;
      color: #9ca3af;
      align-items: center;
    }
    .controls label {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      cursor: pointer;
    }
    select {
      background: #020617;
      border-radius: 999px;
      border: 1px solid #374151;
      padding: 0.2rem 0.6rem;
      color: #e5e7eb;
      font-size: 0.8rem;
    }

    .error {
      color: #fecaca;
      font-size: 0.85rem;
      margin-top: 0.5rem;
    }

    @media (max-width: 800px) {
      th:nth-child(4), td:nth-child(4) {
        display: none; /* cache colonne "Liste des gares" sur mobile */
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>API SNCF – Vue debug <code>retards_carte.json</code></h1>
    <div class="subtitle">
      Lecture directe du cache GTFS-RT SNCF pour les trains de la carte
      (<code>https://vps.labetaillere.fr/gtfs/retards_carte.json</code>).
    </div>

    <div class="card" id="summary-card">
      <div class="card-header">
        <div>
          <div style="font-size:0.9rem; font-weight:500;">Résumé du flux</div>
          <div id="summary-generated" style="font-size:0.8rem; color:#9ca3af;"></div>
        </div>
        <div id="summary-pill" class="pill">
          <span class="dot"></span>
          <span id="summary-pill-text">Chargement…</span>
        </div>
      </div>
      <div class="stats-row" id="summary-stats"></div>
      <div class="controls">
        <div>
          Tri :
          <select id="sort-select">
            <option value="number">Par numéro de train</option>
            <option value="maxdelay">Par retard maximum décroissant</option>
            <option value="status">Par statut (retardés d’abord)</option>
          </select>
        </div>
        <label>
          <input type="checkbox" id="filter-delayed">
          Afficher uniquement les trains en retard / supprimés
        </label>
      </div>
      <div id="error-zone" class="error" style="display:none;"></div>
    </div>

    <div class="card" style="max-height: 70vh; overflow:auto;">
      <table id="trains-table">
        <thead>
          <tr>
            <th>Train</th>
            <th>Statut &amp; retard max</th>
            <th>Retards par gare</th>
            <th>Liste des gares (brut)</th>
          </tr>
        </thead>
        <tbody id="trains-tbody">
          <tr><td colspan="4">Chargement des données SNCF…</td></tr>
        </tbody>
      </table>
    </div>

    <div style="font-size:0.7rem; color:#6b7280; margin-top:0.25rem;">
      Astuce: cette page est purement côté client, tu peux la modifier librement pour tester
      l’intégration avec <code>retards_carte_status.html</code> (disruptions, PARTIAL_CANCELLATION, etc.).
    </div>
  </div>

  <script>
  (function(){
    const API_URL = 'https://vps.labetaillere.fr/gtfs/retards_carte.json';

    const summaryGeneratedEl = document.getElementById('summary-generated');
    const summaryStatsEl = document.getElementById('summary-stats');
    const summaryPillEl = document.getElementById('summary-pill');
    const summaryPillTextEl = document.getElementById('summary-pill-text');
    const errorZoneEl = document.getElementById('error-zone');

    const sortSelectEl = document.getElementById('sort-select');
    const filterDelayedEl = document.getElementById('filter-delayed');
    const tbodyEl = document.getElementById('trains-tbody');

    let trainsArray = [];

    function escapeHTML(str){
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function formatLocalDate(isoString){
      if (!isoString) return '—';
      try {
        const d = new Date(isoString);
        if (Number.isNaN(d.getTime())) return isoString;
        return d.toLocaleString('fr-FR', {
          dateStyle: 'short',
          timeStyle: 'medium'
        });
      } catch(e){
        return isoString;
      }
    }

    function maxDelayForTrain(stopsObj){
      let max = 0;
      if (!stopsObj) return 0;
      for (const val of Object.values(stopsObj)){
        const n = Number(val) || 0;
        if (n > max) max = n;
      }
      return max;
    }

    function classifyStatus(status){
      const norm = String(status || '').toUpperCase();
      if (norm === 'DELAYED') return 'delayed';
      if (norm === 'CANCELLED' || norm === 'CANCELED' || norm === 'SUPPRESSED') return 'cancelled';
      if (norm === 'PARTIALLY_CANCELLED' || norm === 'PARTIAL') return 'cancelled';
      return 'ontime';
    }

    function refreshSummary(data){
      summaryGeneratedEl.textContent =
        'Généré à (UTC) : ' + (data.generated_at || 'inconnu') +
        ' — Local : ' + formatLocalDate(data.generated_at);

      const counters = data.counters || {};
      const total = Number(data.count) || (data.trains ? Object.keys(data.trains).length : 0) || 0;
      const delayed = Number(counters.DELAYED || 0);
      const ontime = Number(counters.ON_TIME || 0);
      const canceled = Number(counters.CANCELLED || counters.CANCELED || counters.SUPPRESSED || 0);

      summaryStatsEl.innerHTML = '';
      const addStat = (label, value) => {
        const span = document.createElement('span');
        span.className = 'stat';
        span.innerHTML = '<strong>' + escapeHTML(value) + '</strong><span>' + escapeHTML(label) + '</span>';
        summaryStatsEl.appendChild(span);
      };

      addStat('trains au total', total);
      addStat('à l’heure', ontime);
      addStat('retardés', delayed);
      addStat('supprimés (si dispo)', canceled);

      // couleur générale
      summaryPillEl.classList.remove('bad', 'neutral');
      if (delayed + canceled === 0) {
        summaryPillTextEl.textContent = 'Trafic fluide (aucun retard dans ce snapshot)';
      } else if (delayed + canceled <= 2) {
        summaryPillEl.classList.add('neutral');
        summaryPillTextEl.textContent = 'Quelques retards / suppressions';
      } else {
        summaryPillEl.classList.add('bad');
        summaryPillTextEl.textContent = 'Plusieurs trains impactés';
      }
    }

    function renderTable(){
      if (!trainsArray || !trainsArray.length){
        tbodyEl.innerHTML = '<tr><td colspan="4">Aucun train dans le flux.</td></tr>';
        return;
      }

      const sortMode = sortSelectEl.value;
      const filterDelayedOnly = filterDelayedEl.checked;

      let rows = trainsArray.slice();

      if (filterDelayedOnly){
        rows = rows.filter(t => classifyStatus(t.status) !== 'ontime');
      }

      rows.sort((a, b) => {
        if (sortMode === 'maxdelay'){
          const dA = a._maxDelay || 0;
          const dB = b._maxDelay || 0;
          if (dB !== dA) return dB - dA;
          return (Number(a.train_number) || 0) - (Number(b.train_number) || 0);
        }
        if (sortMode === 'status'){
          const order = { delayed: 0, cancelled: 1, ontime: 2 };
          const sA = order[classifyStatus(a.status)] ?? 99;
          const sB = order[classifyStatus(b.status)] ?? 99;
          if (sA !== sB) return sA - sB;
          const dA = a._maxDelay || 0;
          const dB = b._maxDelay || 0;
          if (dB !== dA) return dB - dA;
          return (Number(a.train_number) || 0) - (Number(b.train_number) || 0);
        }
        // default: train number asc
        const nA = Number(a.train_number);
        const nB = Number(b.train_number);
        if (!Number.isNaN(nA) && !Number.isNaN(nB)) return nA - nB;
        return String(a.train_number).localeCompare(String(b.train_number));
      });

      if (!rows.length){
        tbodyEl.innerHTML = '<tr><td colspan="4">Aucun train correspondant au filtre.</td></tr>';
        return;
      }

      const frag = document.createDocumentFragment();

      for (const t of rows){
        const tr = document.createElement('tr');

        const statusClass = classifyStatus(t.status);
        const maxDelay = t._maxDelay || 0;
        let maxDelayLabel = '';
        let maxDelayClass = 'ok';
        if (statusClass === 'cancelled'){
          maxDelayLabel = 'Trajet supprimé';
          maxDelayClass = 'bad';
        } else if (maxDelay > 0){
          maxDelayLabel = '+' + maxDelay + ' min';
          maxDelayClass = (maxDelay >= 10) ? 'bad' : 'neutral';
        } else {
          maxDelayLabel = '0 min';
          maxDelayClass = 'ok';
        }

        // Col 1: train
        const tdTrain = document.createElement('td');
        tdTrain.innerHTML =
          '<div class="train-number">TER ' + escapeHTML(t.train_number || '?') + '</div>' +
          '<div class="train-id">' + escapeHTML(t.train_id || '') + '</div>';
        tr.appendChild(tdTrain);

        // Col 2: statut + max delay
        const tdStatus = document.createElement('td');
        const statusLabel = (() => {
          const s = String(t.status || '').toUpperCase();
          if (s === 'ON_TIME') return 'À l’heure';
          if (s === 'DELAYED') return 'Retardé';
          if (s === 'CANCELLED' || s === 'CANCELED' || s === 'SUPPRESSED') return 'Supprimé';
          if (s === 'PARTIALLY_CANCELLED' || s === 'PARTIAL') return 'Partiellement supprimé';
          return s || 'Inconnu';
        })();

        const badgeClasses = ['status-badge'];
        if (statusClass === 'delayed') badgeClasses.push('status-delayed');
        if (statusClass === 'cancelled') badgeClasses.push('status-cancelled');

        tdStatus.innerHTML =
          '<div class="' + badgeClasses.join(' ') + '">' +
            '<span class="dot"></span>' +
            '<span>' + escapeHTML(statusLabel) + '</span>' +
          '</div>' +
          '<div style="margin-top:0.3rem; font-size:0.8rem;">' +
            'Retard max : <span class="max-delay ' + maxDelayClass + '">' + escapeHTML(maxDelayLabel) + '</span>' +
          '</div>';

        tr.appendChild(tdStatus);

        // Col 3: retards par gare (chips)
        const tdStops = document.createElement('td');
        const stops = t.stops || {};
        const entries = Object.entries(stops);
        if (!entries.length){
          tdStops.innerHTML = '<span style="color:#6b7280;">—</span>';
        } else {
          const div = document.createElement('div');
          div.className = 'stops';
          for (const [name, val] of entries){
            const n = Number(val) || 0;
            const chip = document.createElement('span');
            let cls = 'stop-chip';
            if (n > 0) cls += (n >= 10 ? ' bad' : ' neutral');
            chip.className = cls;
            chip.innerHTML =
              escapeHTML(name) +
              ' <span class="delay-value">+' + n + '′</span>';
            div.appendChild(chip);
          }
          tdStops.appendChild(div);
        }
        tr.appendChild(tdStops);

        // Col 4: liste brute (texte)
        const tdRaw = document.createElement('td');
        if (!entries || !entries.length){
          tdRaw.innerHTML = '<span style="color:#6b7280;">—</span>';
        } else {
          const text = entries
            .map(([name, val]) => `${name}: ${val}′`)
            .join(' · ');
          tdRaw.textContent = text;
        }
        tr.appendChild(tdRaw);

        frag.appendChild(tr);
      }

      tbodyEl.innerHTML = '';
      tbodyEl.appendChild(frag);
    }

    async function loadData(){
      try {
        const resp = await fetch(API_URL, { cache: 'no-store' });
        if (!resp.ok){
          throw new Error('HTTP ' + resp.status + ' ' + resp.statusText);
        }
        const data = await resp.json();

        // structure attendue:
        // {
        //   generated_at: "...",
        //   source: "sncf-gtfs-rt-trip-updates",
        //   count: 20,
        //   counters: { ON_TIME: 19, DELAYED: 1 },
        //   trains: {
        //     "88513": { train_id, train_number, status, stops: { "Nancy": 0, ... } },
        //     ...
        //   }
        // }
        const trainsObj = data.trains || {};
        trainsArray = Object.keys(trainsObj).map(key => {
          const t = trainsObj[key] || {};
          const clone = {
            key,
            train_id: t.train_id || '',
            train_number: t.train_number || key,
            status: t.status || 'UNKNOWN',
            stops: t.stops || {}
          };
          clone._maxDelay = maxDelayForTrain(clone.stops);
          return clone;
        });

        refreshSummary(data);
        renderTable();
      } catch (e){
        console.error('Erreur chargement API SNCF', e);
        errorZoneEl.style.display = 'block';
        errorZoneEl.textContent = 'Erreur lors du chargement de ' + API_URL + ' : ' + e;
        tbodyEl.innerHTML =
          '<tr><td colspan="4">Impossible de charger les données (' + escapeHTML(String(e)) + ').</td></tr>';
      }
    }

    sortSelectEl.addEventListener('change', renderTable);
    filterDelayedEl.addEventListener('change', renderTable);

    loadData();
  })();
  </script>
</body>
</html>
