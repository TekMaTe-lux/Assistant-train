<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stats SNCF ‚Äì Local (06‚Üí09 jan 2026)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; line-height: 1.35; }
    .box { border: 1px dashed #aaa; padding: 18px; border-radius: 12px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin-top: 12px; }
    input[type="date"] { padding: 8px 10px; border-radius: 10px; border: 1px solid #ccc; }
    button { padding: 10px 14px; border: 1px solid #ccc; border-radius: 12px; background: #fff; cursor: pointer; }
    button:disabled { opacity: .5; cursor: not-allowed; }

    .kpi { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin-top: 16px; }
    .card { border: 1px solid #ddd; border-radius: 14px; padding: 14px; }
    .label { font-size: 13px; opacity: .75; }
    .value { font-size: 28px; font-weight: 700; margin-top: 6px; }

    .log { white-space: pre-wrap; background: #f7f7f7; border: 1px solid #eee; border-radius: 12px; padding: 12px; margin-top: 16px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }

    .hint { opacity:.8; font-size: 13px; margin-top: 8px; }

    .details { margin-top: 18px; }
    .details h2 { margin: 8px 0 10px; }
    .details-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; }
    .dcard { border: 1px solid #ddd; border-radius: 14px; padding: 14px; }
    .dhead { display:flex; align-items: baseline; justify-content: space-between; gap: 10px; }
    .dtitle { font-weight: 700; }
    .dcount { opacity: .75; font-size: 13px; }
    .trainlist { margin-top: 10px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px; white-space: pre-wrap; background: #fafafa; border: 1px solid #eee; border-radius: 10px; padding: 10px; max-height: 180px; overflow:auto; }
    .muted { opacity:.7; }
  </style>
</head>
<body>
  <h1>Stats SNCF (local) ‚Äì recherche par date</h1>
  <p>Charge une fois le fichier <b>sncf_history.jsonl.gz</b>, puis change la date (06‚Üí09 janvier 2026).</p>

  <div id="drop" class="box">
    <b>D√©pose ton fichier ici</b> ou s√©lectionne-le :
    <div class="row">
      <input id="file" type="file" accept=".gz,.jsonl,.json" />
      <label>
        Date :
        <input id="date" type="date" min="2026-01-06" max="2026-01-09" value="2026-01-09" />
      </label>
      <button id="run" disabled>Calculer</button>
      <button id="runAll" disabled>Calculer 06‚Üí09</button>
    </div>
    <div class="hint">
      <div>R√®gles :</div>
      <ul>
        <li><b>Retard√©</b> = <code>final_delay_min &gt; 0</code></li>
        <li><b>Partiel</b> = <code>partially_cancelled === true</code></li>
        <li><b>Supprim√©</b> = <code>cancelled === true</code> OU disruption <code>trip canceled</code> / <code>NO_SERVICE</code></li>
        <li><b>Pas √† l'heure</b> = union (retard√© ‚à™ partiel ‚à™ supprim√©) sans double-compte</li>
      </ul>
      <div class="muted">Note : un train peut √™tre √† la fois ‚Äúretard√©‚Äù et ‚Äúpartiellement supprim√©‚Äù. Les compteurs ‚ÄúRetard√©s/Supprim√©s/Partiels‚Äù sont ind√©pendants.
        Le ‚ÄúPas √† l‚Äôheure‚Äù est une union (sans double-compte).</div>
    </div>
  </div>

  <div class="kpi" id="kpis" style="display:none;">
    <div class="card"><div class="label">Date</div><div class="value" id="k_date">‚Äî</div></div>
    <div class="card"><div class="label">Total trains</div><div class="value" id="total">‚Äî</div></div>
    <div class="card"><div class="label">Retard√©s</div><div class="value" id="delayed">‚Äî</div></div>
    <div class="card"><div class="label">Supprim√©s</div><div class="value" id="cancelled">‚Äî</div></div>
    <div class="card"><div class="label">Partiellement supprim√©s</div><div class="value" id="partial">‚Äî</div></div>
    <div class="card"><div class="label">Pas √† l‚Äôheure</div><div class="value" id="notOnTime">‚Äî</div></div>
    <div class="card"><div class="label">% pas √† l‚Äôheure</div><div class="value" id="pct">‚Äî</div></div>
  </div>

  <!-- D√©tails par cat√©gories (jour s√©lectionn√© uniquement) -->
  <div class="details" id="details" style="display:none;">
    <h2>D√©tails du jour s√©lectionn√©</h2>
    <div class="details-grid">
      <div class="dcard">
        <div class="dhead">
          <div class="dtitle">Retards (5 √† 9 min)</div>
          <div class="dcount" id="c_5_9">0</div>
        </div>
        <div class="trainlist" id="l_5_9">‚Äî</div>
      </div>

      <div class="dcard">
        <div class="dhead">
          <div class="dtitle">Retards (10 √† 19 min)</div>
          <div class="dcount" id="c_10_19">0</div>
        </div>
        <div class="trainlist" id="l_10_19">‚Äî</div>
      </div>

      <div class="dcard">
        <div class="dhead">
          <div class="dtitle">Retards (20 √† 39 min)</div>
          <div class="dcount" id="c_20_39">0</div>
        </div>
        <div class="trainlist" id="l_20_39">‚Äî</div>
      </div>

      <div class="dcard">
        <div class="dhead">
          <div class="dtitle">Retards (‚â• 40 min)</div>
          <div class="dcount" id="c_40p">0</div>
        </div>
        <div class="trainlist" id="l_40p">‚Äî</div>
      </div>

      <div class="dcard">
        <div class="dhead">
          <div class="dtitle">Suppressions</div>
          <div class="dcount" id="c_cancel">0</div>
        </div>
        <div class="trainlist" id="l_cancel">‚Äî</div>
      </div>

      <div class="dcard">
        <div class="dhead">
          <div class="dtitle">Suppressions partielles</div>
          <div class="dcount" id="c_partial">0</div>
        </div>
        <div class="trainlist" id="l_partial">‚Äî</div>
      </div>
    </div>
  </div>

  <div class="log" id="log">Log‚Ä¶</div>

  <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>

  <script>
    const $ = (id) => document.getElementById(id);
    const drop = $("drop");
    const fileInput = $("file");
    const runBtn = $("run");
    const runAllBtn = $("runAll");
    const logEl = $("log");
    const kpis = $("kpis");
    const details = $("details");

    let currentFile = null;
    let cachedObjectsByDate = null; // Map(date -> obj)
    let parsingInProgress = false;

    function log(msg) { logEl.textContent = msg; }

    function hasCancelDisruption(trainObj) {
      const dis = trainObj?.disruptions || [];
      return dis.some(d => d?.severity === "trip canceled" || d?.effect === "NO_SERVICE");
    }

    function setKPIs({date, total, delayed, cancelled, partial, notOnTime, pct}) {
      $("k_date").textContent = date || "‚Äî";
      $("total").textContent = total ?? "‚Äî";
      $("delayed").textContent = delayed ?? "‚Äî";
      $("cancelled").textContent = cancelled ?? "‚Äî";
      $("partial").textContent = partial ?? "‚Äî";
      $("notOnTime").textContent = notOnTime ?? "‚Äî";
      $("pct").textContent = (isFinite(pct) ? pct.toFixed(2) : "0.00") + " %";
      kpis.style.display = "";
    }

    function fmtList(arr) {
      if (!arr || arr.length === 0) return "‚Äî";
      // Tri ‚Äúnum√©rique‚Äù si possible
      const sorted = [...arr].sort((a,b) => (Number(a)-Number(b)));
      // Une ligne lisible
      return sorted.join(", ");
    }

    function setDetailsBuckets(b) {
      // b = {r5_9, r10_19, r20_39, r40p, cancels, partials}
      const map = [
        ["c_5_9", "l_5_9", b.r5_9],
        ["c_10_19", "l_10_19", b.r10_19],
        ["c_20_39", "l_20_39", b.r20_39],
        ["c_40p", "l_40p", b.r40p],
        ["c_cancel", "l_cancel", b.cancels],
        ["c_partial", "l_partial", b.partials],
      ];
      for (const [cid, lid, arr] of map) {
        $(cid).textContent = (arr?.length ?? 0) + " train(s)";
        $(lid).textContent = fmtList(arr);
      }
      details.style.display = "";
    }

    async function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = () => reject(r.error);
        r.readAsArrayBuffer(file);
      });
    }

    function decodeUTF8(uint8) {
      return new TextDecoder("utf-8").decode(uint8);
    }

    function splitJsonl(text) {
      return text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
    }

    function dateRangeISO(startISO, endISO) {
      const out = [];
      const start = new Date(startISO + "T00:00:00");
      const end = new Date(endISO + "T00:00:00");
      for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        const iso = d.toISOString().slice(0,10);
        out.push(iso);
      }
      return out;
    }

    async function parseFileOnce(file) {
      if (cachedObjectsByDate || parsingInProgress) return;
      parsingInProgress = true;

      log("Lecture du fichier‚Ä¶");
      const buf = await readFileAsArrayBuffer(file);

      let text = "";
      if (file.name.endsWith(".gz")) {
        log("D√©compression .gz‚Ä¶");
        const uint8 = new Uint8Array(buf);
        const inflated = window.pako.inflate(uint8);
        text = decodeUTF8(inflated);
      } else {
        text = decodeUTF8(new Uint8Array(buf));
      }

      const map = new Map();
      const lines = splitJsonl(text);

      if (lines.length > 1) {
        log(`Parsing JSONL‚Ä¶ (${lines.length} lignes)`);
        let ok = 0, bad = 0;
        for (const line of lines) {
          try {
            const obj = JSON.parse(line);
            if (obj && obj.date) {
              // Si plusieurs snapshots m√™me jour, on garde le dernier (souvent le 23:59)
              map.set(obj.date, obj);
            }
            ok++;
          } catch (e) {
            bad++;
          }
        }
        cachedObjectsByDate = map;
        log(`‚úÖ Fichier pars√©. Lignes OK=${ok}, lignes ignor√©es=${bad}. Jours trouv√©s: ${[...map.keys()].sort().join(", ") || "aucun"}`);
      } else {
        // JSON complet
        log("Pas vraiment JSONL ‚Üí tentative JSON complet‚Ä¶");
        const obj = JSON.parse(text);
        if (obj?.date) map.set(obj.date, obj);
        cachedObjectsByDate = map;
        log(`‚úÖ JSON charg√©. Jours trouv√©s: ${[...map.keys()].sort().join(", ") || "aucun"}`);
      }

      parsingInProgress = false;
    }

    function computeForDay(dayObj) {
      const trains = dayObj?.trains || {};
      const ids = Object.keys(trains);
      const total = ids.length;

      let delayed = 0, cancelled = 0, partial = 0;
      const notOnTimeSet = new Set();

      // Buckets demand√©s
      const buckets = {
        r5_9: [],
        r10_19: [],
        r20_39: [],
        r40p: [],
        cancels: [],
        partials: [],
      };

      for (const tid of ids) {
        const t = trains[tid];
        if (t && t.found === false) continue;

        const d = Number(t?.final_delay_min || 0);
        const isDelayed = d > 0;

        const isPartial = t?.partially_cancelled === true;
        const isCancelled = t?.cancelled === true || hasCancelDisruption(t);

        // Compteurs KPI
        if (isDelayed) delayed++;
        if (isPartial) partial++;
        if (isCancelled) cancelled++;

        // Union ‚Äúpas √† l‚Äôheure‚Äù
        if (isDelayed || isPartial || isCancelled) notOnTimeSet.add(tid);

        // Buckets retards (uniquement si retard > 0)
        if (isDelayed) {
          if (d >= 5 && d <= 9) buckets.r5_9.push(tid);
          else if (d >= 10 && d <= 19) buckets.r10_19.push(tid);
          else if (d >= 20 && d <= 39) buckets.r20_39.push(tid);
          else if (d >= 40) buckets.r40p.push(tid);
          // (0-4 min non affich√©s)
        }

        // Buckets suppressions
        if (isCancelled) buckets.cancels.push(tid);
        if (isPartial) buckets.partials.push(tid);
      }

      const notOnTime = notOnTimeSet.size;
      const pct = total ? (notOnTime / total) * 100 : 0;

      return { total, delayed, cancelled, partial, notOnTime, pct, buckets };
    }

    function enableButtons() {
      const ready = !!currentFile;
      runBtn.disabled = !ready;
      runAllBtn.disabled = !ready;
    }

    async function runOne() {
      const targetDate = $("date").value;
      if (!currentFile) return;

      runBtn.disabled = true;
      runAllBtn.disabled = true;

      try {
        await parseFileOnce(currentFile);

        const dayObj = cachedObjectsByDate.get(targetDate);
        if (!dayObj) {
          log(`‚ùå Aucun objet trouv√© pour ${targetDate}. (Le fichier contient: ${[...cachedObjectsByDate.keys()].sort().join(", ") || "rien"})`);
          setKPIs({date: targetDate, total:0, delayed:0, cancelled:0, partial:0, notOnTime:0, pct:0});
          details.style.display = "none";
          return;
        }

        const res = computeForDay(dayObj);
        setKPIs({date: targetDate, ...res});
        setDetailsBuckets(res.buckets);

        log(
          `‚úÖ ${targetDate} (generated_at=${dayObj.generated_at || "?"})\n` +
          `Total=${res.total} | Retard√©s=${res.delayed} | Supprim√©s=${res.cancelled} | Partiels=${res.partial}\n` +
          `Pas √† l'heure=${res.notOnTime} (${res.pct.toFixed(2)}%)\n\n` +
          `D√©tails (listes) affich√©s en bas.`
        );
      } catch (e) {
        console.error(e);
        log("‚ùå Erreur: " + (e?.message || String(e)));
      } finally {
        enableButtons();
      }
    }

    async function runAll() {
      if (!currentFile) return;

      runBtn.disabled = true;
      runAllBtn.disabled = true;

      try {
        await parseFileOnce(currentFile);

        const days = dateRangeISO("2026-01-06", "2026-01-09");
        let out = `üìÖ R√©sum√© 06‚Üí09 janvier 2026\n\n`;
        for (const d of days) {
          const obj = cachedObjectsByDate.get(d);
          if (!obj) {
            out += `${d} : ‚ùå pas trouv√© dans le fichier\n`;
            continue;
          }
          const res = computeForDay(obj);
          out += `${d} : Total=${res.total}, Retard√©s=${res.delayed}, Supprim√©s=${res.cancelled}, Partiels=${res.partial}, Pas √† l'heure=${res.notOnTime} (${res.pct.toFixed(2)}%)\n`;
        }
        out += `\n(Le d√©tail par cat√©gories n‚Äôest affich√© que pour le jour s√©lectionn√©.)\n`;
        log(out);
      } catch (e) {
        console.error(e);
        log("‚ùå Erreur: " + (e?.message || String(e)));
      } finally {
        enableButtons();
      }
    }

    // Drag & drop
    drop.addEventListener("dragover", (e) => { e.preventDefault(); drop.style.borderColor = "#333"; });
    drop.addEventListener("dragleave", () => { drop.style.borderColor = "#aaa"; });
    drop.addEventListener("drop", async (e) => {
      e.preventDefault();
      drop.style.borderColor = "#aaa";
      const f = e.dataTransfer.files?.[0];
      if (f) {
        currentFile = f;
        cachedObjectsByDate = null;
        details.style.display = "none";
        kpis.style.display = "none";
        log(`Fichier s√©lectionn√©: ${f.name} (${Math.round(f.size/1024)} Ko)\n‚û°Ô∏è Clique ‚ÄúCalculer‚Äù (jour choisi) ou ‚ÄúCalculer 06‚Üí09‚Äù.`);
        enableButtons();
      }
    });

    fileInput.addEventListener("change", () => {
      const f = fileInput.files?.[0];
      if (f) {
        currentFile = f;
        cachedObjectsByDate = null;
        details.style.display = "none";
        kpis.style.display = "none";
        log(`Fichier s√©lectionn√©: ${f.name} (${Math.round(f.size/1024)} Ko)\n‚û°Ô∏è Clique ‚ÄúCalculer‚Äù (jour choisi) ou ‚ÄúCalculer 06‚Üí09‚Äù.`);
        enableButtons();
      }
    });

    runBtn.addEventListener("click", runOne);
    runAllBtn.addEventListener("click", runAll);

    enableButtons();
    log("Pr√™t. Charge un fichier pour commencer.");
  </script>
</body>
</html>
