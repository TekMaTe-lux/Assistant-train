<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Départs SNCF - Metz (retards et suppressions)</title>
</head>
<body>
  <h1>Trains retardés ou annulés depuis Metz</h1>
  <div id="resultat">Chargement en cours...</div>

  <script>
    const apiKey = '242fac11-6d98-45fb-93df-28174d362447';
    const encodedApiKey = btoa(apiKey + ":");
    const url = "https://api.sncf.com/v1/coverage/sncf/stop_areas/stop_area:SNCF:87192039/departures?datetime=20250423T221322";

    fetch(url, {
      method: 'GET',
      headers: {
        "Authorization": "Basic " + encodedApiKey
      }
    })
    .then(response => {
      if (!response.ok) throw new Error("Erreur HTTP : " + response.status);
      return response.json();
    })
    .then(data => {
      const departures = data.departures;

      const filtered = departures.filter(dep => {
        const base = dep.stop_date_time?.base_departure_date_time;
        const real = dep.stop_date_time?.departure_date_time;
        return (base && real && base !== real);
      });

      if (filtered.length === 0) {
        document.getElementById("resultat").innerText = "Aucun train retardé ou annulé.";
        return;
      }

      let html = '<ul>';
      filtered.forEach(dep => {
        const train = dep.display_informations?.headsign || 'Train inconnu';

        // Recherche de la destination correcte
        let destination = 'Destination inconnue';
        if (dep.display_informations?.destination) {
          destination = dep.display_informations.destination;
        } else if (dep.display_informations?.via) {
          destination = dep.display_informations.via;
        }

        const realTime = dep.stop_date_time?.departure_date_time;
        const baseTime = dep.stop_date_time?.base_departure_date_time;

        // Heure de départ théorique (base)
        let heureBase = baseTime
          ? baseTime.slice(9, 11) + 'h' + baseTime.slice(11, 13)
          : 'heure inconnue';

        let retard = '';
        let causeRetard = '';

        // Calcul du retard
        if (realTime && baseTime && realTime !== baseTime) {
          const h1 = parseInt(baseTime.slice(9, 11)) * 60 + parseInt(baseTime.slice(11, 13));
          const h2 = parseInt(realTime.slice(9, 11)) * 60 + parseInt(realTime.slice(11, 13));
          const diff = h2 - h1;
          if (diff > 0) {
            retard = ` (+${diff} min)`;
          }
        }

        // Cause du retard ou de l'annulation
        causeRetard = dep.display_informations?.cancelled_message || dep.display_informations?.cause || 'Cause inconnue';

        html += `<li>Train ${train} à ${heureBase} — Destination : ${destination} — Retard : ${retard} — Cause : ${causeRetard}</li>`;
      });
      html += '</ul>';

      document.getElementById("resultat").innerHTML = html;
    })
    .catch(error => {
      document.getElementById("resultat").textContent = "Erreur : " + error.message;
    });
  </script>
</body>
</html>
