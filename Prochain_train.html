<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Départs SNCF Nancy</title>
</head>
<body>
  <h1>Départs SNCF Nancy</h1>
  <div id="resultat">Chargement des départs...</div>

  <script>
    const apiKey = '242fac11-6d98-45fb-93df-28174d362447';
    const encodedApiKey = btoa(apiKey + ":");
    const url = "https://api.sncf.com/v1/coverage/sncf/stop_areas/stop_area:SNCF:82001000/departures?datetime=20250423T221322";

    fetch(url, {
      method: 'GET',
      headers: {
        "Authorization": "Basic " + encodedApiKey
      }
    })
    .then(response => {
      if (!response.ok) throw new Error("Erreur HTTP : " + response.status);
      return response.json();
    })
    .then(data => {
      const departures = data.departures;

      const filtered = departures.filter(dep =>
        dep.status === 'DELAYED' || dep.status === 'CANCELLED'
      );

      if (filtered.length === 0) {
        document.getElementById("resultat").innerText = "Aucun train en retard ou supprimé.";
        return;
      }

      let html = '<ul>';
      filtered.forEach(dep => {
        const train = dep.display_informations.headsign;
        const status = dep.status;

        const rawTime = dep.stop_date_time?.departure_date_time;
        const baseTime = dep.stop_date_time?.base_departure_date_time;

        let heure = rawTime
          ? rawTime.slice(9, 11) + 'h' + rawTime.slice(11, 13)
          : 'heure inconnue';

        let retard = '';

        if (rawTime && baseTime && rawTime !== baseTime) {
          const h1 = parseInt(baseTime.slice(9, 11)) * 60 + parseInt(baseTime.slice(11, 13));
          const h2 = parseInt(rawTime.slice(9, 11)) * 60 + parseInt(rawTime.slice(11, 13));
          const diff = h2 - h1;
          if (diff > 0) {
            retard = ` (+${diff} min)`;
          }
        }

        html += `<li>Train ${train} à ${heure}${retard} — Statut : ${status}</li>`;
      });
      html += '</ul>';

      document.getElementById("resultat").innerHTML = html;
    })
    .catch(error => {
      document.getElementById("resultat").textContent = "Erreur : " + error.message;
    });
  </script>
</body>
</html>
