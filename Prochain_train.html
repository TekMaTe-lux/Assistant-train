<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Départs SNCF - Metz</title>
</head>
<body>
  <h1>Départs depuis Metz</h1>
  <div id="resultat">Chargement en cours...</div>

  <script>
    const apiKey = '242fac11-6d98-45fb-93df-28174d362447';
    const encodedApiKey = btoa(apiKey + ":");

    // ✅ Metz : code SNCF 87192039
    const url = "https://api.sncf.com/v1/coverage/sncf/stop_areas/stop_area:SNCF:87192039/departures?datetime=20250423T221322";

    fetch(url, {
      method: 'GET',
      headers: {
        "Authorization": "Basic " + encodedApiKey
      }
    })
    .then(response => {
      if (!response.ok) throw new Error("Erreur HTTP : " + response.status);
      return response.json();
    })
    .then(data => {
      const departures = data.departures;

      if (departures.length === 0) {
        document.getElementById("resultat").innerText = "Aucun départ trouvé.";
        return;
      }

      let html = '<ul>';
      departures.forEach(dep => {
        const train = dep.display_informations?.headsign || 'Train inconnu';
        const status = dep.status || 'ON_TIME';

        const realTime = dep.stop_date_time?.departure_date_time;
        const baseTime = dep.stop_date_time?.base_departure_date_time;

        let heure = realTime
          ? realTime.slice(9, 11) + 'h' + realTime.slice(11, 13)
          : 'heure inconnue';

        let retard = '';
        if (realTime && baseTime && realTime !== baseTime) {
          const h1 = parseInt(baseTime.slice(9, 11)) * 60 + parseInt(baseTime.slice(11, 13));
          const h2 = parseInt(realTime.slice(9, 11)) * 60 + parseInt(realTime.slice(11, 13));
          const diff = h2 - h1;
          if (diff > 0) {
            retard = ` (+${diff} min)`;
          }
        }

        html += `<li>Train ${train} à ${heure}${retard} — Statut : ${status}</li>`;
      });
      html += '</ul>';

      document.getElementById("resultat").innerHTML = html;
    })
    .catch(error => {
      document.getElementById("resultat").textContent = "Erreur : " + error.message;
    });
  </script>
</body>
</html>
