<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Recherche Trains par Numéro et ID</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, button { padding: 8px; font-size: 16px; margin: 5px 0; }
    .train { border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 5px; }
  </style>
</head>
<body>
  <h2>🔎 Rechercher un train par numéro (ID véhicule)</h2>
  <p>Exemple : <code>88700 88702 88704</code></p>
  <input id="trainInput" placeholder="Entrez les numéros de trains..." style="width: 100%;">
  <button onclick="fetchTrainDetails()">Rechercher</button>
  <div id="results"></div>

  <script>
    const apiKey = '242fac11-6d98-45fb-93df-28174d362447'; // Ta clé API SNCF
    const region = 'sncf'; // Nom de la région, ici pour SNCF

    // Fonction pour récupérer l'ID du voyageur du véhicule via le numéro de train
    async function fetchVehicleJourneyId(trainNumber) {
      const now = new Date();
      const dateStr = now.toISOString().split('T')[0]; // Date actuelle en format YYYY-MM-DD

      const url = `https://api.sncf.com/v1/coverage/${region}/vehicle_journeys?filter=vehicle_journey_name=${trainNumber}&datetime=${dateStr}T000000`;

      try {
        const response = await fetch(url, {
          headers: {
            Authorization: apiKey
          }
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const data = await response.json();
        if (data.vehicle_journeys.length === 0) return null;

        // Récupère l'ID du premier voyageur du véhicule
        const vehicleJourneyId = data.vehicle_journeys[0].id;
        return vehicleJourneyId;
      } catch (error) {
        console.error(error);
        return null;
      }
    }

    // Fonction pour récupérer les détails du train via son ID
    async function fetchTrainDetails() {
      const input = document.getElementById('trainInput').value.trim();
      const trainNumbers = input.split(/\s+/); // Séparation des numéros de train par espaces
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '⏳ Recherche en cours...';

      const results = await Promise.all(trainNumbers.map(async (trainNumber) => {
        const vehicleJourneyId = await fetchVehicleJourneyId(trainNumber);
        if (!vehicleJourneyId) {
          return { error: `🚫 Train ${trainNumber} non trouvé.` };
        }

        // Utilise l'ID pour récupérer les détails via l'API
        const url = `https://api.sncf.com/v1/coverage/${region}/vehicle_journeys/${vehicleJourneyId}`;
        const response = await fetch(url, {
          headers: { Authorization: apiKey }
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const trainDetails = await response.json();
        if (!trainDetails) {
          return { error: `🚫 Détails non trouvés pour le train ${trainNumber}.` };
        }

        const train = trainDetails.vehicle_journey;
        return {
          number: train.name,
          departure: train.stop_times[0]?.departure_time || 'inconnue',
          arrival: train.stop_times.at(-1)?.arrival_time || 'inconnue',
          from: train.stop_times[0]?.stop_point?.name,
          to: train.stop_times.at(-1)?.stop_point?.name,
          status: train.status || 'prévu'
        };
      }));

      resultsDiv.innerHTML = results.map(res => {
        if (res.error) return `<div class="train">${res.error}</div>`;
        return `
          <div class="train">
            🚆 <strong>${res.number}</strong><br>
            🕒 Départ : ${res.departure} de ${res.from}<br>
            🕒 Arrivée : ${res.arrival} à ${res.to}<br>
            📌 Statut : ${res.status}
          </div>
        `;
      }).join('');
    }
  </script>
</body>
</html>
