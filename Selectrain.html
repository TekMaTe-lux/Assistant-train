<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sélection des trains</title>
<style>
  body {
    background: #101828;
    color: #e0f0ff;
    font-family: 'Orbitron', sans-serif;
    padding: 2em;
  }
  h1 {
    text-align: center;
    color: #00ffff;
    text-shadow: 0 0 10px #00f0ff;
  }
  .train-list {
    display: flex;
    flex-wrap: wrap;
    gap: 1em;
    justify-content: center;
  }
  .train-card {
    background: linear-gradient(145deg, #0a0e1a, #101828);
    border: 2px solid #00f0ff55;
    box-shadow: 0 0 20px #00ffff44 inset;
    border-radius: 10px;
    padding: 1em;
    width: 250px;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .train-card:hover {
    transform: scale(1.05);
    box-shadow: 0 0 30px #00ffffaa;
  }
  .selected {
    border-color: #ff00ff;
    box-shadow: 0 0 30px #ff00ffaa;
  }
</style>
</head>
<body>

<h1>Sélectionnez vos trains</h1>

<div class="train-list" id="trainList">
  Chargement des trains...
</div>

<script>
const apiKey = '242fac11-6d98-45fb-93df-28174d362447';

async function fetchAPI(url) {
  const resp = await fetch(url, { headers: { 'Authorization': 'Basic ' + btoa(apiKey + ':') } });
  if (!resp.ok) throw new Error("Erreur API: " + resp.status);
  return await resp.json();
}

function parseDate(sncfDateStr) {
  if (!sncfDateStr) return null;
  const year = parseInt(sncfDateStr.substr(0,4));
  const month = parseInt(sncfDateStr.substr(4,2))-1;
  const day = parseInt(sncfDateStr.substr(6,2));
  const hour = parseInt(sncfDateStr.substr(9,2));
  const min = parseInt(sncfDateStr.substr(11,2));
  return new Date(year, month, day, hour, min);
}

function formatTime(date) {
  return date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
}

async function getVehicleJourney(vehicle_journey_id) {
  const url = `https://api.sncf.com/v1/coverage/sncf/vehicle_journeys/${vehicle_journey_id}`;
  const data = await fetchAPI(url);
  return data.vehicle_journeys[0];
}

async function loadTrains() {
  const now = new Date();
  const dateStr = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}T000000`;

  const stopArea = 'stop_area:SNCF:82001000'; // Luxembourg
  const baseUrl = `https://api.sncf.com/v1/coverage/sncf/stop_areas/${stopArea}/departures?datetime=${dateStr}&duration=86400&count=100`;

  const data = await fetchAPI(baseUrl);
  const departures = data.departures || [];

  const allowedRoutes = ['C40+', 'C50', 'C50+'];
  const filtered = departures.filter(dep => dep.route && allowedRoutes.includes(dep.route.name));

  const trainList = document.getElementById('trainList');
  trainList.innerHTML = '';

  for (const dep of filtered) {
    const info = dep.display_informations || {};
    const vj = await getVehicleJourney(info.vehicle_journey.id);
    const stops = vj.stop_times;

    const originStop = stops[0];
    const destStop = stops[stops.length - 1];

    const trainNumber = info.headsign || '???';
    const origin = originStop.stop_point.name || 'Inconnu';
    const destination = destStop.stop_point.name || 'Inconnu';

    const departureDate = parseDate(originStop.departure_time);
    const arrivalDate = parseDate(destStop.arrival_time);

    const card = document.createElement('div');
    card.className = 'train-card';
    card.innerHTML = `
      <h3>Train ${trainNumber}</h3>
      <p>${origin} ➔ ${destination}</p>
      <p>Départ : ${formatTime(departureDate)}</p>
      <p>Arrivée : ${formatTime(arrivalDate)}</p>
    `;
    card.addEventListener('click', () => {
      card.classList.toggle('selected');
    });
    trainList.appendChild(card);
  }
}

loadTrains();
</script>

</body>
</html>
