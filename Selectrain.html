<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Trains vers/de Luxembourg</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #121212;
    color: #eee;
    padding: 20px;
  }
  label, select, button {
    font-size: 1rem;
    margin: 0 10px 20px 0;
  }
  .train-card {
    background: #222;
    border: 1px solid #444;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 12px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  .train-card:hover {
    background-color: #333;
  }
  .train-card.selected {
    background-color: #0078d7;
    border-color: #00aaff;
    color: #fff;
  }
  #selectedTrains {
    margin-top: 20px;
    padding: 10px;
    background: #222;
    border-radius: 8px;
    min-height: 40px;
  }
  .nogare {
    color: #f33;
    font-style: italic;
  }
</style>
</head>
<body>

<h1>Consultation trains vers / depuis Luxembourg</h1>

<div>
  <label for="selectDirection">Sens :</label>
  <select id="selectDirection">
    <option value="vers">Vers Luxembourg</option>
    <option value="depuis">Depuis Luxembourg</option>
  </select>

  <label for="selectGare">Gare :</label>
  <select id="selectGare">
    <option value="tous">Toutes (Nancy, Metz, Thionville)</option>
    <option value="nancy">Nancy</option>
    <option value="metz">Metz</option>
    <option value="thionville">Thionville</option>
  </select>

  <button id="btnCharger">Charger les trains</button>
</div>

<div id="trainContainer"></div>

<h2>Trains sélectionnés :</h2>
<div id="selectedTrains"><p>Aucun train sélectionné.</p></div>

<button id="btnValider">Valider la sélection</button>

<script>
// Codes des gares
const codesGares = {
  nancy: "87141002",
  metz: "87192039",
  thionville: "87191007",
  luxembourg: "8098103"
};

const apiBase = "https://api.sncf.com/v1/coverage/sncf/";

// Clé API à remplacer par la vôtre
const apiKey = "votre_clef_api_sncfn";

// Utilitaire formatage heure
function parseSNCFDate(dateTimeStr) {
  return new Date(dateTimeStr);
}
function formatTime(date) {
  return date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});
}

// Charger les trains en fonction des critères
async function chargerTrains(direction, gare) {
  const container = document.getElementById('trainContainer');
  container.innerHTML = "<p>Chargement en cours...</p>";
  let url = "";

  if(direction === "vers"){
    // Depuis les gares sélectionnées vers Luxembourg
    // Si tous, on fait plusieurs fetch en parallèle et concatène
    let garesOrigine = [];
    if(gare === "tous"){
      garesOrigine = [codesGares.nancy, codesGares.metz, codesGares.thionville];
    } else {
      garesOrigine = [codesGares[gare]];
    }

    const promesses = garesOrigine.map(codeGare =>
      fetch(`${apiBase}stop_areas/${codeGare}/departures?to=${codesGares.luxembourg}&count=50`, {
        headers: {Authorization: apiKey}
      }).then(r => r.json())
    );

    const results = await Promise.all(promesses);
    // Fusionner toutes les données
    let allDepartures = [];
    results.forEach(r => {
      if(r.departures) allDepartures = allDepartures.concat(r.departures);
    });

    // Filtrer uniquement les trains (mode = train) et non TGV
    allDepartures = allDepartures.filter(d => d.display_informations && d.display_informations.network === "TER" && d.display_informations.commercial_mode === "TER");

    // On ajoute la gare d'origine dans chaque objet pour affichage
    allDepartures.forEach(dep => {
      dep.gareDepart = dep.stop_point ? dep.stop_point.name : "";
    });

    afficherCartesVersLux(allDepartures);

  } else if(direction === "depuis"){
    // Depuis Luxembourg vers gares sélectionnées
    let garesDest = [];
    if(gare === "tous"){
      garesDest = [codesGares.nancy, codesGares.metz, codesGares.thionville];
    } else {
      garesDest = [codesGares[gare]];
    }

    // Ici on récupère tous les départs de Luxembourg et on filtre côté client
    const response = await fetch(`${apiBase}stop_areas/${codesGares.luxembourg}/departures?count=100`, {
      headers: {Authorization: apiKey}
    });
    const data = await response.json();

    let departures = data.departures || [];
    // Filtrer trains TER uniquement
    departures = departures.filter(d => d.display_informations && d.display_informations.network === "TER" && d.display_informations.commercial_mode === "TER");

    // Garder uniquement ceux dont la destination est dans garesDest
    departures = departures.filter(d => {
      const destCode = d.display_informations && d.display_informations.coordonnée_gare_destination; // Parfois ce champ n'existe pas
      const destName = d.display_informations && d.display_informations.direction;
      // Ici on filtre avec le nom plutôt que le code, car le code de gare destination n'est pas toujours dans l'objet
      if(!destName) return false;
      if(gare === "tous"){
        return ["Nancy", "Metz", "Thionville"].some(n => destName.includes(n));
      } else {
        // Comparaison insensible
        return destName.toLowerCase().includes(gare);
      }
    });

    afficherCartes(departures, "depuis");
  }
}

// Affiche les trains vers Luxembourg (groupés par numéro de train)
function afficherCartesVersLux(trains) {
  const container = document.getElementById("trainContainer");
  container.innerHTML = '';

  if(trains.length === 0){
    container.innerHTML = `<p class="nogare">Aucun train trouvé pour ces critères.</p>`;
    return;
  }

  // Regrouper par numéro de train (headsign)
  const grouped = {};
  trains.forEach(train => {
    const info = train.display_informations || {};
    const trainNumber = info.headsign || 'Inconnu';

    if(!grouped[trainNumber]){
      grouped[trainNumber] = {
        trainNumber,
        horaires: [],
        direction: info.direction || '',
      };
    }

    // Récupérer la gare d'origine et l'heure de départ
    const heureDepart = parseSNCFDate(train.stop_date_time.departure_date_time);
    const timeDepart = formatTime(heureDepart);
    grouped[trainNumber].horaires.push({
      gare: train.gareDepart,
      heure: timeDepart
    });
  });

  // Création des cartes
  for(const trainNum in grouped){
    const train = grouped[trainNum];
    const card = document.createElement('div');
    card.className = 'train-card';
    card.dataset.train = trainNum;

    let html = `<h3>Train ${train.trainNumber}</h3>`;
    html += `<p><strong>Direction:</strong> ${train.direction}</p>`;
    html += '<ul>';
    train.horaires.forEach(h => {
      html += `<li>${h.gare} - Départ: ${h.heure}</li>`;
    });
    html += '</ul>';

    card.innerHTML = html;

    card.addEventListener('click', () => {
      card.classList.toggle('selected');
      mettreAJourSelection();
    });

    container.appendChild(card);
  }

  document.getElementById('selectedTrains').innerHTML = '<p>Aucun train sélectionné.</p>';
}

// Affichage simple pour trains depuis Luxembourg
function afficherCartes(trains, type) {
  const container = document.getElementById("trainContainer");
  container.innerHTML = '';

  if(trains.length === 0){
    container.innerHTML = `<p class="nogare">Aucun train trouvé pour ces critères.</p>`;
    return;
  }

  trains.forEach(train => {
    const info = train.display_informations || {};
    const card = document.createElement('div');
    card.className = 'train-card';
    card.dataset.train = info.headsign || 'Inconnu';

    const depTime = formatTime(parseSNCFDate(train.stop_date_time.departure_date_time));
    const arrTime = formatTime(parseSNCFDate(train.stop_date_time.arrival_date_time));

    let html = `<h3>Train ${info.headsign || '???'}</h3>`;
    html += `<p><strong>Destination :</strong> ${info.direction || '???'}</p>`;
    html += `<p><strong>Départ :</strong> ${depTime}</p>`;
    html += `<p><strong>Arrivée estimée :</strong> ${arrTime}</p>`;

    card.innerHTML = html;

    card.addEventListener('click', () => {
      card.classList.toggle('selected');
      mettreAJourSelection();
    });

    container.appendChild(card);
  });

  document.getElementById('selectedTrains').innerHTML = '<p>Aucun train sélectionné.</p>';
}

// Met à jour la liste des trains sélectionnés
function mettreAJourSelection() {
  const selected = [...document.querySelectorAll('.train-card.selected')];
  const container = document.getElementById('selectedTrains');
  if(selected.length === 0){
    container.innerHTML = '<p>Aucun train sélectionné.</p>';
    return;
  }
  let html = '<ul>';
  selected.forEach(card => {
    html += `<li>${card.dataset.train}</li>`;
  });
  html += '</ul>';
  container.innerHTML = html;
}

// Validation sélection
function validerSelection() {
  const selected = [...document.querySelectorAll('.train-card.selected')];
  if(selected.length === 0){
    alert('Veuillez sélectionner au moins un train.');
    return;
  }
  const trainsSelectionnes = selected.map(card => card.dataset.train);
  alert('Trains sélectionnés :\n' + trainsSelectionnes.join('\n'));
}

// Gestion du clic sur bouton charger
document.getElementById('btnCharger').addEventListener('click', () => {
  const direction = document.getElementById('selectDirection').value;
  const gare = document.getElementById('selectGare').value;
  chargerTrains(direction, gare);
});

// Bouton valider
document.getElementById('btnValider').addEventListener('click', validerSelection);

</script>

</body>
</html>
