<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bétaillères arrivant et partant de Luxembourg</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #101828;
    color: #e0f0ff;
    max-width: 1000px;
    margin: 2em auto;
    padding: 1em;
  }
  h1 {
    color: #00ffff;
    text-shadow: 0 0 10px #00f0ff;
    text-align: center;
  }
  .columns {
    display: flex;
    gap: 2em;
    flex-wrap: wrap;
    justify-content: center;
  }
  .column {
    flex: 1 1 450px;
  }
  .train-card {
    background: linear-gradient(145deg, #101828, #0a0e1a);
    border: 1px solid #00f0ff55;
    border-radius: 10px;
    box-shadow: 0 0 20px #00ffff44 inset;
    margin: 1em 0;
    padding: 1em;
    font-family: 'Orbitron', monospace;
  }
  .train-number {
    font-weight: bold;
    font-size: 1.2rem;
    color: #00ffff;
  }
  .train-info {
    margin-top: 0.5em;
  }
</style>
</head>
<body>

<h1>Bétaillères arrivant et partant de Luxembourg</h1>

<div class="columns">
  <div class="column">
    <h2>Arrivées à Luxembourg</h2>
    <div id="arrivalsContainer"></div>
  </div>
  <div class="column">
    <h2>Départs de Luxembourg</h2>
    <div id="departuresContainer"></div>
  </div>
</div>

<script>
const apiKey = '242fac11-6d98-45fb-93df-28174d362447';

// Parse la date SNCF "YYYYMMDDTHHMMSS" en Date JS
function parseSNCFDate(sncfDateStr) {
  if (!sncfDateStr) return null;
  const datePart = sncfDateStr.substr(0,8);
  const timePart = sncfDateStr.substr(9,6);
  const year = parseInt(datePart.substr(0,4),10);
  const month = parseInt(datePart.substr(4,2),10)-1;
  const day = parseInt(datePart.substr(6,2),10);
  const hour = parseInt(timePart.substr(0,2),10);
  const minute = parseInt(timePart.substr(2,2),10);
  const second = parseInt(timePart.substr(4,2),10);
  return new Date(year, month, day, hour, minute, second);
}

// Format HH:MM
function formatTime(date) {
  if (!date) return 'N/A';
  return date.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
}

// Date du jour minuit au format SNCF
function getTodayDatetime() {
  const now = new Date();
  const y = now.getFullYear();
  const m = String(now.getMonth()+1).padStart(2,'0');
  const d = String(now.getDate()).padStart(2,'0');
  return `${y}${m}${d}T000000`;
}

async function fetchTrains(url) {
  try {
    const resp = await fetch(url, {
      headers: { 'Authorization': 'Basic ' + btoa(apiKey + ':') }
    });
    if(!resp.ok) throw new Error(`Erreur API: ${resp.status}`);
    const data = await resp.json();
    return data.arrivals || data.departures || [];
  } catch(err) {
    console.error(err);
    return [];
  }
}

function filterTrainsByRouteName(trains) {
  const allowedRoutes = ['C40+', 'C50', 'C50+'];
  return trains.filter(train => train.route && allowedRoutes.includes(train.route.name));
}

function createTrainCard(train, isArrival) {
  const info = train.display_informations || {};
  const trainNumber = info.headsign || 'N/A';
  const origin = info.origin || 'Origine inconnue';
  const destination = info.destination || 'Terminus inconnu';

  const arrivalDate = parseSNCFDate(train.stop_date_time.arrival_date_time);
  const departureDate = parseSNCFDate(train.stop_date_time.departure_date_time);

  const arrivalText = arrivalDate ? formatTime(arrivalDate) : 'N/A';
  const departureText = departureDate ? formatTime(departureDate) : 'N/A';

  return `
    <div class="train-card">
      <div class="train-number">Train ${trainNumber}</div>
      <div class="train-info">Origine : <strong>${origin}</strong></div>
      <div class="train-info">Terminus : <strong>${destination}</strong></div>
      <div class="train-info">Départ : ${departureText}</div>
      <div class="train-info">Arrivée : ${arrivalText}</div>
    </div>
  `;
}

(async function(){
  const datetime = getTodayDatetime();
  const stopAreaId = 'stop_area:SNCF:82001000'; // Luxembourg
  const baseUrl = `https://api.sncf.com/v1/coverage/sncf/stop_areas/${stopAreaId}`;

  // Fetch arrivals
  let arrivals = await fetchTrains(`${baseUrl}/arrivals?datetime=${datetime}&duration=86400&count=100`);
  arrivals = filterTrainsByRouteName(arrivals);
  arrivals.sort((a,b) => parseSNCFDate(a.stop_date_time.arrival_date_time) - parseSNCFDate(b.stop_date_time.arrival_date_time));

  const arrivalsContainer = document.getElementById('arrivalsContainer');
  arrivals.forEach(train => {
    arrivalsContainer.innerHTML += createTrainCard(train, true);
  });

  // Fetch departures
  let departures = await fetchTrains(`${baseUrl}/departures?datetime=${datetime}&duration=86400&count=100`);
  departures = filterTrainsByRouteName(departures);
  departures.sort((a,b) => parseSNCFDate(a.stop_date_time.departure_date_time) - parseSNCFDate(b.stop_date_time.departure_date_time));

  const departuresContainer = document.getElementById('departuresContainer');
  departures.forEach(train => {
    departuresContainer.innerHTML += createTrainCard(train, false);
  });

})();
</script>

</body>
</html>
