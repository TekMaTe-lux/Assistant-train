<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Arrêts CFL proches</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #1e1e1e; color: #eee; }
  input, select, button { margin: 5px 0; padding: 5px; }
  #map { height: 400px; margin-top: 10px; border: 2px solid #444; }
  .stop { padding: 5px; border-bottom: 1px solid #444; }
  .distance { color: #0f0; }
  .type { color: #0af; margin-left: 10px; font-weight: bold; }
</style>
</head>
<body>
<h1>Arrêts CFL proches</h1>

<label>Ville : 
  <select id="city">
    <option value="49.6117,6.13">Luxembourg</option>
    <option value="49.516513,6.10168">Bettembourg</option>
    <option value="49.4950,6.0740">Dudelange</option>
    <option value="49.5094,6.1094">Noertzange</option>
    <option value="49.6025,6.1330">Berchem</option>
    <option value="49.5039,6.4650">Esch-sur-Alzette</option>
    <option value="49.5234,6.0673">Differdange</option>
    <option value="49.5252,6.0832">Schifflange</option>
    <option value="49.8476,6.1167">Ettelbruck</option>
    <option value="49.8672,6.1667">Diekirch</option>
  </select>
</label><br>

<label>Rayon (m) : <input type="number" id="radius" value="10000"></label><br>

<label>Filtrer par type : 
  <select id="transportType">
    <option value="all">Tous</option>
    <option value="train">Gares / Trains</option>
    <option value="bus">Bus</option>
    <option value="tram">Tram</option>
  </select>
</label><br>

<button id="searchBtn">Rechercher les arrêts proches</button>

<h2>Résultats :</h2>
<div id="results"></div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const accessId = "58ef9a71-6837-4405-bd5d-23beaf92864c";

// Initialisation de la carte
let map = L.map('map').setView([49.6117, 6.13], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '© OpenStreetMap contributors'
}).addTo(map);

async function fetchStops(lat, lon, radius) {
  const apiUrl = `https://cdt.hafas.de/opendata/apiserver/location.nearbystops?accessId=${accessId}&originCoordLat=${lat}&originCoordLong=${lon}&r=${radius}&maxNo=100&format=json`;
  const corsUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(apiUrl)}`;
  const response = await fetch(corsUrl);
  return response.json();
}

document.getElementById("searchBtn").addEventListener("click", async () => {
  const cityVal = document.getElementById("city").value.split(",");
  const lat = parseFloat(cityVal[0]);
  const lon = parseFloat(cityVal[1]);
  const radius = parseInt(document.getElementById("radius").value);
  const type = document.getElementById("transportType").value;

  const resultsDiv = document.getElementById("results");
  resultsDiv.innerHTML = "<p>Chargement...</p>";

  try {
    const data = await fetchStops(lat, lon, radius);
    const stops = data.stopLocationOrCoordLocation || [];

    const stopLocations = stops.filter(item => item.StopLocation).map(item => item.StopLocation);

    // Filtrage par type
    const filtered = stopLocations.filter(stop => {
      if (!stop.products) return false;
      if (type === "all") return true;
      if (type === "train") return stop.products < 30;
      if (type === "bus") return stop.products === 32;
      if (type === "tram") return stop.products === 256;
      return false;
    });

    // Filtrage par rayon réel côté client
    const filteredByRadius = filtered.filter(stop => stop.dist <= radius);

    resultsDiv.innerHTML = "";
    map.eachLayer(layer => {
      if (layer instanceof L.Marker) map.removeLayer(layer);
    });

    // Marker pour la ville sélectionnée
    L.marker([lat, lon], {title: "Point central"}).addTo(map).bindPopup("Point central").openPopup();
    map.setView([lat, lon], 13);

    if (filteredByRadius.length === 0) {
      resultsDiv.innerHTML = "<p>Aucun arrêt trouvé pour ces paramètres.</p>";
      return;
    }

    filteredByRadius.sort((a, b) => a.dist - b.dist);

    filteredByRadius.forEach(stop => {
      let stopType = "Gare";
      if (stop.products === 32) stopType = "Bus";
      if (stop.products === 256) stopType = "Tram";

      // Affichage dans la liste
      const div = document.createElement("div");
      div.className = "stop";
      div.innerHTML = `<strong>${stop.name}</strong> <span class="distance">(${stop.dist} m)</span> <span class="type">${stopType}</span>`;
      resultsDiv.appendChild(div);

      // Marker sur la carte
      L.marker([stop.lat, stop.lon], {title: stop.name})
        .addTo(map)
        .bindPopup(`<strong>${stop.name}</strong><br>${stopType}<br>${stop.dist} m`);
    });

  } catch (err) {
    console.error(err);
    resultsDiv.innerHTML = "<p>Erreur lors de la récupération des données.</p>";
  }
});
</script>
</body>
</html>
