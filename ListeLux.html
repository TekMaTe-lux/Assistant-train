<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Arrêts CFL proches</title>
<style>
  body { font-family: Arial; margin: 20px; background: #1e1e1e; color: #eee; }
  input, select, button { margin: 5px 0; padding: 5px; }
  .stop { padding: 5px; border-bottom: 1px solid #444; }
  .distance { color: #0f0; }
  .type { color: #0af; margin-left: 10px; font-weight: bold; }
</style>
</head>
<body>
<h1>Arrêts CFL proches</h1>

<label>Latitude : <input type="number" step="0.0001" id="lat" value="49.5251"></label><br>
<label>Longitude : <input type="number" step="0.0001" id="lon" value="6.1107"></label><br>
<label>Rayon (m) : <input type="number" id="radius" value="10000"></label><br>

<label>Filtrer par type : 
  <select id="transportType">
    <option value="all">Tous</option>
    <option value="train">Gares / Trains</option>
    <option value="bus">Bus</option>
    <option value="tram">Tram</option>
  </select>
</label><br>

<button id="searchBtn">Rechercher les arrêts proches</button>

<h2>Résultats :</h2>
<div id="results"></div>

<script>
const accessId = "58ef9a71-6837-4405-bd5d-23beaf92864c";

document.getElementById("searchBtn").addEventListener("click", async () => {
  const lat = parseFloat(document.getElementById("lat").value);
  const lon = parseFloat(document.getElementById("lon").value);
  const radius = parseInt(document.getElementById("radius").value);
  const type = document.getElementById("transportType").value;

  const apiUrl = `https://cdt.hafas.de/opendata/apiserver/location.nearbystops?accessId=${accessId}&originCoordLat=${lat}&originCoordLong=${lon}&r=${radius}&maxNo=100&format=json`;
  const corsUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(apiUrl)}`;

  try {
    const res = await fetch(corsUrl);
    const text = await res.json();
    const data = JSON.parse(text.contents); // AllOrigins renvoie le JSON dans contents
    const stops = data.StopLocation || [];

    const filtered = stops.filter(stop => {
      if (type === "all") return true;
      if (type === "train") return stop.products < 30;
      if (type === "bus") return stop.products === 32;
      if (type === "tram") return stop.products === 256;
      return false;
    });

    const resultsDiv = document.getElementById("results");
    resultsDiv.innerHTML = "";
    if (filtered.length === 0) {
      resultsDiv.innerHTML = "<p>Aucun arrêt trouvé.</p>";
      return;
    }

    filtered.sort((a, b) => a.dist - b.dist);

    filtered.forEach(stop => {
      let stopType = "Gare";
      if (stop.products === 32) stopType = "Bus";
      if (stop.products === 256) stopType = "Tram";

      const div = document.createElement("div");
      div.className = "stop";
      div.innerHTML = `<strong>${stop.name}</strong> <span class="distance">(${stop.dist} m)</span> <span class="type">${stopType}</span>`;
      resultsDiv.appendChild(div);
    });
  } catch (error) {
    console.error("Erreur lors de la récupération des données :", error);
    document.getElementById("results").innerHTML = "<p>Erreur lors de la récupération des données.</p>";
  }
});
</script>
</body>
</html>
